
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<meta name="theme-color" content="#2E7D5E"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<meta name="description" content="Golfeados Golf Club - Tournament Manager"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="default"/>
<meta name="apple-mobile-web-app-title" content="Golfeados"/>
<link rel="manifest" href="manifest.json"/>
<link rel="apple-touch-icon" href="Logo_Golfeados.png"/>
<title>Golfeados Â· Golf Club</title>

<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-storage-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#F0F4F2;
  --bg2:#E8EEEB;
  --card:#FFFFFF;
  --cardL:#F5F9F7;
  --border:#D0DDD8;
  --border2:#B8CEC7;
  --green:#2E7D5E;
  --greenL:#3DA07A;
  --greenPale:#E8F5F0;
  --blue:#1A6B8A;
  --blueL:#2589AD;
  --bluePale:#E3F2F8;
  --teal:#0D7377;
  --text:#1A2E27;
  --text2:#3D5A50;
  --muted:#7A9A8E;
  --white:#FFFFFF;
  --red:#D32F2F;
  --redPale:#FFEBEE;
  --gold:#C49A00;
  --goldPale:#FFF8E1;
  --shadow:0 1px 6px rgba(46,125,94,0.08);
  --shadow-md:0 4px 16px rgba(46,125,94,0.12);
}
html,body{background:var(--bg);color:var(--text);font-family:'Trebuchet MS',sans-serif;min-height:100dvh;}
button{cursor:pointer;font-family:inherit;}
input,select,textarea{font-family:inherit;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

/* â”€â”€ LOADING â”€â”€ */
#loading{position:fixed;inset:0;background:var(--white);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:14px;z-index:999;}
.spin{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--green);border-radius:50%;animation:spin 0.8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* â”€â”€ LOGIN â”€â”€ */
#loginScreen{min-height:100dvh;display:flex;align-items:center;justify-content:center;padding:24px;
  background:linear-gradient(160deg,#E8F5F0 0%,#E3F2F8 50%,#F0F4F2 100%);}
.login-card{width:100%;max-width:380px;background:var(--white);border-radius:20px;border:1px solid var(--border);padding:40px 32px;box-shadow:var(--shadow-md);}
.login-logo{text-align:center;margin-bottom:28px;}
.login-logo img{width:90px;height:90px;object-fit:contain;}
.login-title{font-size:22px;font-weight:800;color:var(--green);font-family:Georgia,serif;letter-spacing:1px;margin-top:10px;}
.login-sub{font-size:11px;color:var(--muted);letter-spacing:3px;text-transform:uppercase;margin-top:3px;}
.field{margin-bottom:16px;}
.field label{font-size:11px;color:var(--text2);font-weight:700;letter-spacing:1px;text-transform:uppercase;display:block;margin-bottom:6px;}
.field input{width:100%;padding:11px 14px;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;color:var(--text);font-size:15px;outline:none;transition:border-color 0.2s;}
.field input:focus{border-color:var(--green);background:var(--white);}
.btn-login{width:100%;padding:13px;border-radius:10px;border:none;background:var(--green);color:#fff;font-weight:700;font-size:16px;font-family:Georgia,serif;letter-spacing:1px;box-shadow:0 4px 14px rgba(46,125,94,0.3);transition:opacity 0.2s;margin-top:4px;}
.btn-login:disabled{opacity:0.6;cursor:not-allowed;}
.btn-link{background:none;border:none;color:var(--muted);font-size:13px;text-align:center;display:block;width:100%;margin-top:14px;}
.error-box{background:var(--redPale);border:1px solid #FFCDD2;border-radius:8px;padding:10px 14px;color:var(--red);font-size:13px;margin-bottom:12px;}
.login-footer{position:fixed;bottom:20px;left:0;right:0;text-align:center;color:var(--muted);font-size:11px;letter-spacing:2px;}

/* â”€â”€ HEADER â”€â”€ */
#header{background:var(--white);border-bottom:1px solid var(--border);padding:0 20px;display:flex;align-items:center;justify-content:space-between;height:56px;position:sticky;top:0;z-index:100;box-shadow:var(--shadow);}
.header-logo{display:flex;align-items:center;gap:10px;}
.header-logo img{width:38px;height:38px;object-fit:contain;}
.header-title{font-size:15px;font-weight:800;color:var(--green);font-family:Georgia,serif;letter-spacing:1px;}
.header-sub{font-size:9px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;}
.header-right{display:flex;align-items:center;gap:10px;}
.badge-admin{font-size:10px;color:var(--white);font-weight:700;letter-spacing:1px;background:var(--green);padding:3px 8px;border-radius:10px;}
.header-user{font-size:11px;color:var(--muted);max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.btn-logout{background:none;border:1px solid var(--border);border-radius:6px;color:var(--muted);padding:5px 10px;font-size:11px;}

/* â”€â”€ NAV â”€â”€ */
#nav{background:var(--white);border-bottom:1px solid var(--border);display:flex;padding:0 12px;overflow-x:auto;position:sticky;top:56px;z-index:99;}
#nav::-webkit-scrollbar{height:0;}
.nav-btn{padding:11px 14px;background:transparent;border:none;border-bottom:2px solid transparent;color:var(--muted);font-weight:400;font-size:13px;display:flex;align-items:center;gap:5px;white-space:nowrap;transition:all 0.15s;}
.nav-btn.active{border-bottom-color:var(--green);color:var(--green);font-weight:700;}

/* â”€â”€ CONTENT â”€â”€ */
#content{padding:20px;max-width:900px;margin:0 auto;padding-bottom:40px;}

/* â”€â”€ CARDS â”€â”€ */
.card{background:var(--white);border-radius:14px;border:1px solid var(--border);overflow:hidden;margin-bottom:16px;box-shadow:var(--shadow);}
.card-header{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:var(--cardL);}
.card-title{font-size:12px;font-weight:700;color:var(--green);letter-spacing:1px;text-transform:uppercase;}
.card-body{padding:20px;}

/* â”€â”€ HERO â”€â”€ */
.hero{background:linear-gradient(135deg,var(--green) 0%,var(--teal) 60%,var(--blue) 100%);border-radius:16px;padding:24px 28px;border:none;position:relative;overflow:hidden;margin-bottom:16px;box-shadow:var(--shadow-md);}
.hero::after{content:'';position:absolute;top:-40px;right:-40px;width:220px;height:220px;border-radius:50%;background:rgba(255,255,255,0.06);}
.hero-label{font-size:11px;color:rgba(255,255,255,0.75);font-weight:600;letter-spacing:2px;text-transform:uppercase;margin-bottom:6px;}
.hero-title{font-size:22px;font-weight:700;color:#fff;font-family:Georgia,serif;}
.hero-stats{display:flex;gap:24px;margin-top:16px;flex-wrap:wrap;}
.hero-stat label{font-size:10px;color:rgba(255,255,255,0.65);letter-spacing:1px;text-transform:uppercase;display:block;}
.hero-stat span{font-size:15px;font-weight:600;color:#fff;margin-top:2px;display:block;}

/* â”€â”€ AVATAR â”€â”€ */
.avatar{border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-family:Georgia,serif;flex-shrink:0;color:#fff;}

/* â”€â”€ BADGES â”€â”€ */
.badge{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;}
.badge::before{content:'';width:6px;height:6px;border-radius:50%;background:currentColor;flex-shrink:0;}
.badge-oficial{background:#E8F5E9;color:#2E7D32;}
.badge-validar{background:#FFF8E1;color:#F57F17;}
.badge-attest{background:#EDE7F6;color:#5E35B1;}
.badge-planificada{background:#E3F2FD;color:#1565C0;}
.badge-enjuego{background:#FBE9E7;color:#BF360C;}
.badge-activo{background:#E8F5E9;color:#2E7D32;}

/* â”€â”€ RANKING â”€â”€ */
.rank-row{display:grid;grid-template-columns:40px 1fr 50px 55px 50px;gap:8px;padding:12px 16px;border-bottom:1px solid var(--border);align-items:center;}
.rank-row.top{background:var(--greenPale);}
.rank-head{display:grid;grid-template-columns:40px 1fr 50px 55px 50px;gap:8px;padding:8px 16px;border-bottom:1px solid var(--border);background:var(--cardL);}
.rank-head span{font-size:10px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:1px;}

/* â”€â”€ JORNADA CARD â”€â”€ */
.jornada-card{background:var(--white);border-radius:12px;border:1px solid var(--border);overflow:hidden;margin-bottom:10px;box-shadow:var(--shadow);}
.jornada-header{padding:14px 18px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;user-select:none;transition:background 0.15s;}
.jornada-header:hover{background:var(--cardL);}
.jornada-body{padding:0 18px 18px;border-top:1px solid var(--border);}
.jornada-actions{display:flex;gap:8px;padding:12px 0;flex-wrap:wrap;}

/* â”€â”€ RESULT ROW â”€â”€ */
.result-row{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:10px;background:var(--cardL);margin-bottom:6px;border:1px solid var(--border);}

/* â”€â”€ FORM â”€â”€ */
.form-label{font-size:11px;color:var(--text2);font-weight:700;letter-spacing:1px;text-transform:uppercase;display:block;margin-bottom:6px;}
.form-input{width:100%;padding:10px 14px;background:var(--bg);border:1.5px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;outline:none;transition:border-color 0.2s;}
.form-input:focus{border-color:var(--green);background:var(--white);}
.form-select{padding:8px 12px;background:var(--bg);border:1.5px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;outline:none;transition:border-color 0.2s;}
.form-select:focus{border-color:var(--green);}
.form-check{accent-color:var(--green);width:16px;height:16px;}

/* â”€â”€ BUTTONS â”€â”€ */
.btn-green{padding:9px 18px;border-radius:8px;border:none;background:var(--green);color:#fff;font-weight:700;font-size:13px;box-shadow:0 2px 8px rgba(46,125,94,0.25);}
.btn-blue{padding:9px 18px;border-radius:8px;border:none;background:var(--blue);color:#fff;font-weight:700;font-size:13px;}
.btn-teal{padding:9px 18px;border-radius:8px;border:none;background:var(--teal);color:#fff;font-weight:700;font-size:13px;}
.btn-attest{padding:8px 18px;border-radius:8px;border:1px solid #9C27B0;background:#F3E5F5;color:#7B1FA2;font-weight:700;font-size:13px;}
.btn-approve{padding:8px 18px;border-radius:8px;border:none;background:#E8F5E9;color:#2E7D32;font-weight:700;font-size:13px;border:1px solid #A5D6A7;}
.btn-outline{padding:8px 18px;border-radius:8px;border:1px solid var(--border2);background:var(--white);color:var(--text2);font-weight:600;font-size:13px;}
.btn-danger{padding:6px 10px;border-radius:8px;border:1px solid #FFCDD2;background:var(--redPale);color:var(--red);font-size:12px;font-weight:600;}
.btn-save{width:100%;padding:14px;border-radius:12px;border:none;background:var(--green);color:#fff;font-weight:800;font-size:16px;font-family:Georgia,serif;letter-spacing:1px;box-shadow:0 4px 14px rgba(46,125,94,0.3);margin-top:8px;}
.btn-back{background:none;border:none;color:var(--muted);font-size:22px;padding:0 8px 0 0;}
/* keep btn-primary as alias */
.btn-primary{padding:9px 18px;border-radius:8px;border:none;background:var(--green);color:#fff;font-weight:700;font-size:13px;box-shadow:0 2px 8px rgba(46,125,94,0.2);}

/* â”€â”€ CARGAR â”€â”€ */
.cargar-row{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
.pts-box{width:50px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:18px;border:1.5px solid var(--border);}

/* â”€â”€ INFO / SUCCESS â”€â”€ */
.info-attest{background:var(--bluePale);border:1px solid #B3D9E8;border-radius:10px;padding:12px 16px;font-size:12px;color:var(--blue);margin-bottom:16px;}
.success-box{background:var(--greenPale);border:1px solid #A5D6A7;border-radius:14px;padding:32px;text-align:center;}

/* â”€â”€ TABLE â”€â”€ */
.breakdown-table{width:100%;border-collapse:collapse;font-size:12px;}
.breakdown-table td{padding:8px;border-top:1px solid var(--border);}

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:200;display:flex;align-items:center;justify-content:center;padding:20px;}
.modal-box{background:var(--white);border-radius:16px;width:100%;max-width:460px;box-shadow:0 16px 48px rgba(0,0,0,0.2);overflow:hidden;max-height:90vh;overflow-y:auto;}
.modal-header{padding:18px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:var(--cardL);}
.modal-title{font-size:15px;font-weight:700;color:var(--green);}
.modal-body{padding:24px;}
.modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end;}

/* â”€â”€ UTILS â”€â”€ */
.flex{display:flex;}.flex-1{flex:1;}.gap-8{gap:8px;}.gap-12{gap:12px;}.gap-16{gap:16px;}
.items-center{align-items:center;}.justify-between{justify-content:space-between;}
.text-green{color:var(--green);}.text-muted{color:var(--muted);}.text-dark{color:var(--text);}
.font-bold{font-weight:700;}.font-georgia{font-family:Georgia,serif;}
.text-11{font-size:11px;}.text-12{font-size:12px;}.text-13{font-size:13px;}.text-14{font-size:14px;}.text-15{font-size:15px;}
.mb-8{margin-bottom:8px;}.mb-12{margin-bottom:12px;}.mb-16{margin-bottom:16px;}
.mt-8{margin-top:8px;}.mt-12{margin-top:12px;}.mt-16{margin-top:16px;}
.overflow-x{overflow-x:auto;}
.section-gap{margin-bottom:20px;}
/* â”€â”€ FOTOS â”€â”€ */
.photo-upload-box{border:2px dashed var(--border2);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all 0.2s;background:var(--cardL);}
.photo-upload-box:hover{border-color:var(--green);background:var(--greenPale);}
.photo-upload-box input[type=file]{display:none;}
.photo-preview{width:100%;height:140px;object-fit:cover;border-radius:10px;border:1px solid var(--border);}
.photo-preview-sm{width:60px;height:60px;object-fit:cover;border-radius:8px;border:1px solid var(--border);}
.photo-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px;}
.photo-grid-item{position:relative;aspect-ratio:1;}
.photo-grid-item img{width:100%;height:100%;object-fit:cover;border-radius:8px;border:1px solid var(--border);}
.photo-grid-item .del-photo{position:absolute;top:3px;right:3px;background:rgba(0,0,0,0.6);color:#fff;border:none;border-radius:50%;width:20px;height:20px;font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.upload-progress{height:4px;background:var(--border);border-radius:2px;margin-top:8px;overflow:hidden;display:none;}
.upload-progress-bar{height:100%;background:var(--green);width:0%;transition:width 0.3s;border-radius:2px;}
.foto-perfil-circle{width:64px;height:64px;border-radius:50%;object-fit:cover;border:2px solid var(--border);flex-shrink:0;}


/* â”€â”€ AUTH EXTRA â”€â”€ */
.login-divider{display:flex;align-items:center;gap:10px;margin:14px 0;}
.login-divider::before,.login-divider::after{content:'';flex:1;height:1px;background:var(--border);}
.login-divider span{font-size:11px;color:var(--muted);white-space:nowrap;}
.verify-option{border:1.5px solid var(--border);border-radius:12px;padding:16px;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:14px;}
.verify-option:hover,.verify-option.selected{border-color:var(--green);background:var(--greenPale);}
.verify-option-icon{font-size:28px;flex-shrink:0;}
.otp-inputs{display:flex;gap:10px;justify-content:center;margin:20px 0;}
.otp-input{width:46px;height:56px;border:2px solid var(--border);border-radius:10px;text-align:center;font-size:24px;font-weight:700;color:var(--text);background:var(--bg);outline:none;transition:border-color 0.2s;}
.otp-input:focus{border-color:var(--green);}
.strength-bar{height:4px;border-radius:2px;transition:all 0.3s;margin-top:6px;}
.input-icon-wrap{position:relative;}
.input-icon-wrap input{padding-right:40px;}
.input-icon-wrap .toggle-pass{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px;}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading">
  <div class="spin"></div>
  <div style="font-size:12px;color:var(--muted);letter-spacing:2px;">CARGANDO...</div>
</div>

<!-- LOGIN SCREEN â€” multiple views -->
<div id="loginScreen" style="display:none;">
  <div class="login-card" style="max-width:400px;">

    <!-- LOGO (shared) -->
    <div class="login-logo">
      <img src="Logo_Golfeados.png" alt="Golfeados"/>
      <div class="login-title">GOLFEADOS</div>
      <div class="login-sub">Golf Club Â· Tournament Manager</div>
    </div>

    <!-- â‘  LOGIN -->
    <div id="loginView">
      <div id="loginError" class="error-box" style="display:none;"></div>
      <div class="field">
        <label>Email, usuario o telÃ©fono</label>
        <input type="text" id="loginIdentifier" placeholder="email / @usuario / +58414..." autocomplete="username"
          oninput="updateLoginHint(this)"/>
        <div id="loginHint" style="font-size:11px;color:var(--muted);margin-top:4px;"></div>
      </div>
      <div class="field">
        <label>ContraseÃ±a</label>
        <div class="input-icon-wrap">
          <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"/>
          <button class="toggle-pass" type="button" onclick="togglePass('loginPassword',this)">ğŸ‘</button>
        </div>
      </div>
      <button class="btn-login" id="loginBtn" onclick="handleLogin()">Entrar al Club</button>
      <div class="login-divider"><span>Â¿No tienes cuenta?</span></div>
      <button class="btn-login" style="background:transparent;border:2px solid var(--green);color:var(--green);box-shadow:none;" onclick="showRegister()">Crear cuenta</button>
      <button class="btn-link" onclick="showReset()">Â¿Olvidaste tu contraseÃ±a?</button>
    </div>

    <!-- â‘¡ REGISTRO -->
    <div id="registerView" style="display:none;">
      <div style="font-size:15px;font-weight:700;color:var(--green);margin-bottom:16px;">Crear cuenta</div>
      <div id="registerError" class="error-box" style="display:none;"></div>
      <div class="field">
        <label>Nombre completo *</label>
        <input type="text" id="regNombre" placeholder="Ej: Daniel Badell"/>
      </div>
      <div class="field">
        <label>Nombre de usuario *</label>
        <div class="input-icon-wrap">
          <input type="text" id="regUsername" placeholder="@badell" oninput="formatUsername(this)"/>
        </div>
        <div id="usernameHint" style="font-size:11px;color:var(--muted);margin-top:4px;">Solo letras, nÃºmeros y guiÃ³n bajo</div>
      </div>
      <div class="field">
        <label>Email *</label>
        <input type="email" id="regEmail" placeholder="tu@email.com" autocomplete="email"/>
      </div>
      <div class="field">
        <label>TelÃ©fono (opcional pero recomendado)</label>
        <div style="display:flex;gap:8px;">
          <select class="form-select" id="regPaisCodigo" style="width:110px;">
            <option value="+58">ğŸ‡»ğŸ‡ª +58</option>
            <option value="+1">ğŸ‡ºğŸ‡¸ +1</option>
            <option value="+34">ğŸ‡ªğŸ‡¸ +34</option>
            <option value="+52">ğŸ‡²ğŸ‡½ +52</option>
            <option value="+57">ğŸ‡¨ğŸ‡´ +57</option>
            <option value="+51">ğŸ‡µğŸ‡ª +51</option>
            <option value="+54">ğŸ‡¦ğŸ‡· +54</option>
            <option value="+56">ğŸ‡¨ğŸ‡± +56</option>
            <option value="+55">ğŸ‡§ğŸ‡· +55</option>
          </select>
          <input class="form-input" id="regTelefono" type="tel" placeholder="4141234567" style="flex:1;"
            oninput="this.value=this.value.replace(/[^0-9]/g,'')"/>
        </div>
      </div>
      <div class="field">
        <label>ContraseÃ±a *</label>
        <div class="input-icon-wrap">
          <input type="password" id="regPassword" placeholder="MÃ­n. 6 caracteres" oninput="checkStrength(this)"/>
          <button class="toggle-pass" type="button" onclick="togglePass('regPassword',this)">ğŸ‘</button>
        </div>
        <div class="strength-bar" id="strengthBar" style="background:var(--border);width:0%;"></div>
        <div id="strengthLabel" style="font-size:11px;color:var(--muted);margin-top:4px;"></div>
      </div>
      <button class="btn-login" id="regBtn" onclick="handleRegister()">Continuar â†’</button>
      <button class="btn-link" onclick="showLogin()">â† Ya tengo cuenta</button>
    </div>

    <!-- â‘¢ ELEGIR VERIFICACIÃ“N -->
    <div id="verifyChoiceView" style="display:none;">
      <div style="font-size:15px;font-weight:700;color:var(--green);margin-bottom:6px;">Verificar tu cuenta</div>
      <div style="font-size:13px;color:var(--muted);margin-bottom:20px;">Verifica al menos uno para activar tu cuenta.</div>
      <div id="verifyChoiceError" class="error-box" style="display:none;"></div>
      <div class="verify-option mb-12" id="optEmail" onclick="chooseVerify('email')">
        <div class="verify-option-icon">ğŸ“§</div>
        <div>
          <div style="font-weight:700;font-size:14px;">Verificar por Email</div>
          <div id="verifyEmailAddr" style="font-size:12px;color:var(--muted);">Gratis e instantÃ¡neo</div>
        </div>
      </div>
      <div class="verify-option" id="optSMS" onclick="chooseVerify('sms')">
        <div class="verify-option-icon">ğŸ“±</div>
        <div>
          <div style="font-weight:700;font-size:14px;">Verificar por SMS</div>
          <div id="verifyPhoneNum" style="font-size:12px;color:var(--muted);">RecibirÃ¡s un cÃ³digo de 6 dÃ­gitos</div>
        </div>
      </div>
      <div id="recaptcha-container" style="margin-top:12px;"></div>
      <button class="btn-login" style="margin-top:16px;" id="btnSendVerify" onclick="sendVerification()">Enviar cÃ³digo</button>
      <button class="btn-link" onclick="skipVerify()">Verificar mÃ¡s tarde</button>
    </div>

    <!-- â‘£ CÃ“DIGO SMS -->
    <div id="smsCodeView" style="display:none;">
      <div style="text-align:center;margin-bottom:20px;">
        <div style="font-size:36px;margin-bottom:10px;">ğŸ“±</div>
        <div style="font-size:15px;font-weight:700;color:var(--green);">CÃ³digo enviado</div>
        <div id="smsSentTo" style="font-size:13px;color:var(--muted);margin-top:4px;"></div>
      </div>
      <div id="smsError" class="error-box" style="display:none;"></div>
      <div class="otp-inputs">
        <input class="otp-input" id="otp0" maxlength="1" oninput="otpNext(this,0)" onkeydown="otpBack(event,0)"/>
        <input class="otp-input" id="otp1" maxlength="1" oninput="otpNext(this,1)" onkeydown="otpBack(event,1)"/>
        <input class="otp-input" id="otp2" maxlength="1" oninput="otpNext(this,2)" onkeydown="otpBack(event,2)"/>
        <input class="otp-input" id="otp3" maxlength="1" oninput="otpNext(this,3)" onkeydown="otpBack(event,3)"/>
        <input class="otp-input" id="otp4" maxlength="1" oninput="otpNext(this,4)" onkeydown="otpBack(event,4)"/>
        <input class="otp-input" id="otp5" maxlength="1" oninput="otpNext(this,5)" onkeydown="otpBack(event,5)"/>
      </div>
      <button class="btn-login" id="btnConfirmSMS" onclick="confirmSMS()">Confirmar cÃ³digo</button>
      <button class="btn-link" onclick="showVerifyChoice()">â† Cambiar mÃ©todo</button>
      <button class="btn-link" id="btnResendSMS" onclick="resendSMS()" style="display:none;">Reenviar cÃ³digo</button>
    </div>

    <!-- â‘¤ EMAIL ENVIADO -->
    <div id="emailSentView" style="display:none;">
      <div style="text-align:center;padding:10px 0 20px;">
        <div style="font-size:48px;margin-bottom:12px;">ğŸ“§</div>
        <div style="font-size:16px;font-weight:700;color:var(--green);">Â¡Revisa tu email!</div>
        <div id="emailSentAddr" style="font-size:13px;color:var(--muted);margin-top:6px;line-height:1.5;"></div>
      </div>
      <button class="btn-login" onclick="recheckEmail()">Ya verifiquÃ© mi email âœ“</button>
      <button class="btn-link" onclick="resendEmail()">Reenviar email</button>
      <button class="btn-link" onclick="skipVerify()">Verificar mÃ¡s tarde</button>
    </div>

    <!-- â‘¥ VERIFICACIÃ“N PENDIENTE (usuario ya registrado pero no verificÃ³) -->
    <div id="pendingVerifyView" style="display:none;">
      <div style="text-align:center;padding:10px 0 20px;">
        <div style="font-size:48px;margin-bottom:12px;">âš ï¸</div>
        <div style="font-size:15px;font-weight:700;color:var(--gold);">Cuenta pendiente de verificaciÃ³n</div>
        <div style="font-size:13px;color:var(--muted);margin-top:8px;line-height:1.5;">Debes verificar tu email o telÃ©fono para acceder.</div>
      </div>
      <button class="btn-login" onclick="showVerifyChoice()">Verificar ahora</button>
      <button class="btn-link" onclick="handleLogout()">Cerrar sesiÃ³n</button>
    </div>

    <!-- â‘¦ RESET PASSWORD -->
    <div id="resetView" style="display:none;">
      <div style="font-size:13px;color:var(--muted);margin-bottom:14px;">Ingresa tu email para recibir un enlace de recuperaciÃ³n.</div>
      <div id="resetError" class="error-box" style="display:none;"></div>
      <div id="resetSuccess" style="display:none;text-align:center;padding:20px 0;">
        <div style="font-size:40px;margin-bottom:10px;">ğŸ“§</div>
        <div style="color:var(--text);font-size:14px;">Email de recuperaciÃ³n enviado.</div>
      </div>
      <div id="resetForm">
        <div class="field"><label>Email</label><input type="email" id="resetEmail" placeholder="tu@email.com"/></div>
        <button class="btn-login" onclick="handleReset()">Enviar Email</button>
      </div>
      <button class="btn-link" onclick="showLogin()">â† Volver al login</button>
    </div>

  </div>
  <div class="login-footer">PLAY Â· RELAX Â· ENJOY Â· SINCE 2024</div>
</div>

<!-- BANNER ACTUALIZACIÃ“N -->
<div id="updateBanner" style="display:none;position:fixed;bottom:0;left:0;right:0;z-index:500;
  background:linear-gradient(135deg,var(--green),var(--teal));
  padding:14px 20px;display:flex;align-items:center;justify-content:space-between;
  box-shadow:0 -4px 20px rgba(0,0,0,0.2);gap:12px;">
  <div>
    <div style="color:#fff;font-weight:700;font-size:14px;">ğŸ”„ Nueva versiÃ³n disponible</div>
    <div style="color:rgba(255,255,255,0.8);font-size:12px;margin-top:2px;" id="updateBannerSub">Nueva versiÃ³n disponible</div>
  </div>
  <button onclick="forceUpdate()" style="background:#fff;color:var(--green);border:none;border-radius:8px;
    padding:10px 18px;font-weight:800;font-size:13px;white-space:nowrap;cursor:pointer;">
    Actualizar
  </button>
</div>

<!-- APP -->
<div id="app" style="display:none;">
  <div id="header">
    <div class="header-logo">
      <img src="Logo_Golfeados.png" alt="Golfeados"/>
      <div>
        <div class="header-title">GOLFEADOS</div>
        <div class="header-sub">Golf Club</div>
      </div>
    </div>
    <div class="header-right">
      <span id="adminBadge" class="badge-admin" style="display:none;">ADMIN</span>
      <div id="connPill" title="Estado de conexiÃ³n" style="display:flex;align-items:center;gap:4px;padding:3px 8px;border-radius:20px;font-size:10px;font-weight:700;letter-spacing:0.5px;background:#E8F5E9;color:#2E7D32;border:1px solid #A5D6A7;transition:all 0.4s;">
        <span id="connDot" style="width:6px;height:6px;border-radius:50%;background:#4CAF50;display:inline-block;"></span>
        <span id="connLabel">EN VIVO</span>
      </div>
      <span id="headerUser" class="header-user"></span>
      <button class="btn-logout" onclick="handleLogout()">Salir</button>
    </div>
  </div>

  <div id="nav">
    <button class="nav-btn active" data-tab="dashboard" onclick="goTab('dashboard')">ğŸ  Inicio</button>
    <button class="nav-btn" data-tab="mistorneos" onclick="goTab('mistorneos')">ğŸ† Mis Torneos</button>
    <button class="nav-btn" data-tab="ranking" onclick="goTab('ranking')">ğŸ“Š Ranking</button>
    <button class="nav-btn" data-tab="jornadas" onclick="goTab('jornadas')">ğŸ“… Jornadas</button>
    <button class="nav-btn" data-tab="jugadores" onclick="goTab('jugadores')">ğŸ‘¤ Jugadores</button>
    <button class="nav-btn" data-tab="clubes" onclick="goTab('clubes')">ğŸŒï¸ Clubes</button>
  </div>

  <div id="content">
    <div id="tab-dashboard"></div>
    <div id="tab-mistorneos" style="display:none;"></div>
    <div id="tab-ranking" style="display:none;"></div>
    <div id="tab-jornadas" style="display:none;"></div>
    <div id="tab-jugadores" style="display:none;"></div>
    <div id="tab-clubes" style="display:none;"></div>
    <div id="tab-cargar" style="display:none;"></div>
  </div>
</div>

<!-- MODAL JORNADA -->
<div id="modalJornada" class="modal-overlay" style="display:none;" onclick="closeModalJornada()">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="modalJornadaTitle">Nueva Jornada</div>
      <button onclick="closeModalJornada()" style="background:none;border:none;font-size:20px;color:var(--muted);cursor:pointer;">âœ•</button>
    </div>
    <div class="modal-body">
      <div id="modalJornadaError" class="error-box" style="display:none;"></div>
      <div style="display:flex;flex-direction:column;gap:14px;">
        <div>
          <label class="form-label">Club / Sede *</label>
          <select class="form-select" id="jornadaClub" style="width:100%;"></select>
        </div>
        <div style="display:flex;gap:12px;">
          <div style="flex:1;">
            <label class="form-label">Fecha *</label>
            <input type="date" class="form-input" id="jornadaFecha"/>
          </div>
          <div style="width:100px;">
            <label class="form-label">Estado</label>
            <select class="form-select" id="jornadaEstado" style="width:100%;">
              <option value="Planificada">Planificada</option>
              <option value="En Juego">En Juego</option>
              <option value="Pendiente Attest">Pendiente Attest</option>
              <option value="Por Validar">Por Validar</option>
              <option value="Oficial">Oficial</option>
            </select>
          </div>
        </div>
        <div style="display:flex;gap:12px;">
          <div style="flex:1;">
            <label class="form-label">Tee Time</label>
            <input type="time" class="form-input" id="jornadaTeeTime"/>
          </div>
          <div style="flex:2;">
            <label class="form-label">Notas (opcional)</label>
            <input type="text" class="form-input" id="jornadaNotas" placeholder="Ej: Scramble, 18 hoyos..."/>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--cardL);border-radius:10px;border:1px solid var(--border);">
          <input type="checkbox" id="jornadaCuentaRanking" checked style="width:18px;height:18px;cursor:pointer;accent-color:var(--green);"/>
          <div>
            <label for="jornadaCuentaRanking" style="font-weight:700;font-size:13px;cursor:pointer;">Cuenta para el ranking</label>
            <div style="font-size:11px;color:var(--muted);">Desactiva para jornadas de prÃ¡ctica o exhibiciÃ³n (ğŸš«)</div>
          </div>
        </div>
      </div>
      <div style="margin-top:14px;">
        <label class="form-label">Fotos del dÃ­a (mÃ¡x 3)</label>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:6px;" id="jornadaFotoGrid">
          <div class="photo-upload-box" style="height:80px;padding:8px;" id="jornadaFotoSlot0" onclick="document.getElementById('jornadaFotoInput0').click()">
            <div style="font-size:22px;">ğŸ“·</div><div style="font-size:10px;color:var(--muted);">Foto 1</div>
            <input type="file" id="jornadaFotoInput0" accept="image/*" style="display:none;" onchange="previewJornadaFoto(this,0)"/>
          </div>
          <div class="photo-upload-box" style="height:80px;padding:8px;" id="jornadaFotoSlot1" onclick="document.getElementById('jornadaFotoInput1').click()">
            <div style="font-size:22px;">ğŸ“·</div><div style="font-size:10px;color:var(--muted);">Foto 2</div>
            <input type="file" id="jornadaFotoInput1" accept="image/*" style="display:none;" onchange="previewJornadaFoto(this,1)"/>
          </div>
          <div class="photo-upload-box" style="height:80px;padding:8px;" id="jornadaFotoSlot2" onclick="document.getElementById('jornadaFotoInput2').click()">
            <div style="font-size:22px;">ğŸ“·</div><div style="font-size:10px;color:var(--muted);">Foto 3</div>
            <input type="file" id="jornadaFotoInput2" accept="image/*" style="display:none;" onchange="previewJornadaFoto(this,2)"/>
          </div>
        </div>
        <div class="upload-progress"><div class="upload-progress-bar" id="jornadaFotoProgress"></div></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-outline" onclick="closeModalJornada()">Cancelar</button>
      <button class="btn-green" id="btnGuardarJornada" onclick="saveJornada()">Guardar Jornada</button>
    </div>
  </div>
</div>


<!-- MODAL CLUB -->
<div id="modalClub" class="modal-overlay" style="display:none;" onclick="closeModalClub()">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="modalClubTitle">Nuevo Club</div>
      <button onclick="closeModalClub()" style="background:none;border:none;font-size:20px;color:var(--muted);cursor:pointer;">âœ•</button>
    </div>
    <div class="modal-body">
      <div id="modalClubError" class="error-box" style="display:none;"></div>
      <div style="display:flex;flex-direction:column;gap:14px;">
        <div><label class="form-label">Nombre del Club *</label><input class="form-input" id="clubNombre" placeholder="Ej: Izcaragua Country Club"/></div>
        <div><label class="form-label">Ciudad</label><input class="form-input" id="clubCiudad" placeholder="Ej: Caracas"/></div>
        <div style="display:flex;gap:12px;">
          <div style="width:80px;"><label class="form-label">Iniciales</label><input class="form-input" id="clubIniciales" placeholder="IC" maxlength="3"/></div>
          <div style="flex:1;"><label class="form-label">Color avatar</label>
            <select class="form-select" id="clubColor" style="width:100%;">
              <option value="#2E7D5E">Verde</option>
              <option value="#1A6B8A">Azul</option>
              <option value="#0D7377">Teal</option>
              <option value="#7B1FA2">Morado</option>
              <option value="#C49A00">Dorado</option>
              <option value="#D32F2F">Rojo</option>
            </select>
          </div>
        </div>
        <div>
          <label class="form-label">Foto del Club (opcional)</label>
          <div class="photo-upload-box" onclick="document.getElementById('clubFotoInput').click()">
            <img id="clubFotoPreview" style="display:none;width:100%;height:120px;object-fit:cover;border-radius:8px;margin-bottom:8px;"/>
            <div id="clubFotoPlaceholder">ğŸ“· Toca para subir foto</div>
            <input type="file" id="clubFotoInput" accept="image/*" onchange="previewPhoto(this,'clubFotoPreview','clubFotoPlaceholder')"/>
          </div>
          <div class="upload-progress"><div class="upload-progress-bar" id="clubFotoProgress"></div></div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-outline" onclick="closeModalClub()">Cancelar</button>
      <button class="btn-green" id="btnGuardarClub" onclick="saveClub()">Guardar Club</button>
    </div>
  </div>
</div>

<!-- MODAL JUGADOR EDIT -->
<div id="modalJugador" class="modal-overlay" style="display:none;" onclick="closeModalJugador()">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title">Editar Jugador</div>
      <button onclick="closeModalJugador()" style="background:none;border:none;font-size:20px;color:var(--muted);cursor:pointer;">âœ•</button>
    </div>
    <div class="modal-body">
      <div id="modalJugadorError" class="error-box" style="display:none;"></div>
      <div style="display:flex;flex-direction:column;gap:14px;">
        <div style="display:flex;align-items:center;gap:16px;">
          <div style="position:relative;flex-shrink:0;">
            <img id="jugadorFotoPreview" src="" style="display:none;" class="foto-perfil-circle"/>
            <div id="jugadorFotoFallback" style="width:64px;height:64px;border-radius:50%;background:var(--green);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:20px;">ğŸ‘¤</div>
            <button type="button" onclick="document.getElementById('jugadorFotoInput').click()" 
              style="position:absolute;bottom:0;right:0;background:var(--green);border:none;border-radius:50%;width:22px;height:22px;color:#fff;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;">âœï¸</button>
            <input type="file" id="jugadorFotoInput" accept="image/*" style="display:none;" onchange="previewPhoto(this,'jugadorFotoPreview','jugadorFotoFallback')"/>
          </div>
          <div style="flex:1;"><label class="form-label">Nombre Completo *</label><input class="form-input" id="editNombre" placeholder="Nombre completo"/></div>
        </div>
        <div style="display:flex;gap:12px;">
          <div style="flex:1;"><label class="form-label">Alias</label><input class="form-input" id="editAlias" placeholder="Alias o apodo"/></div>
          <div style="width:80px;"><label class="form-label">Iniciales</label><input class="form-input" id="editFoto" placeholder="DB" maxlength="2"/></div>
        </div>
        <div><label class="form-label">Handicap</label><input class="form-input" id="editHandicap" type="number" min="0" max="54" placeholder="0" style="width:100px;"/></div>
        <div>
          <label class="form-label">TelÃ©fono / WhatsApp</label>
          <div style="display:flex;gap:8px;align-items:center;">
            <select class="form-select" id="editPaisCodigo" style="width:110px;">
              <option value="+58">ğŸ‡»ğŸ‡ª +58</option>
              <option value="+1">ğŸ‡ºğŸ‡¸ +1</option>
              <option value="+34">ğŸ‡ªğŸ‡¸ +34</option>
              <option value="+52">ğŸ‡²ğŸ‡½ +52</option>
              <option value="+57">ğŸ‡¨ğŸ‡´ +57</option>
              <option value="+51">ğŸ‡µğŸ‡ª +51</option>
              <option value="+54">ğŸ‡¦ğŸ‡· +54</option>
              <option value="+56">ğŸ‡¨ğŸ‡± +56</option>
              <option value="+55">ğŸ‡§ğŸ‡· +55</option>
              <option value="+507">ğŸ‡µğŸ‡¦ +507</option>
            </select>
            <input class="form-input" id="editTelefono" type="tel" placeholder="4141234567" style="flex:1;" oninput="validarTelefono(this)"/>
          </div>
          <div id="telefonoHint" style="font-size:11px;color:var(--muted);margin-top:4px;">Solo nÃºmeros, sin espacios ni guiones. Ej: 4141234567</div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-outline" onclick="closeModalJugador()">Cancelar</button>
      <button class="btn-green" id="btnGuardarJugador" onclick="saveJugador()">Guardar</button>
    </div>
  </div>
</div>


<!-- MODAL TORNEO â€” Crear / Editar -->
<div id="modalTorneo" class="modal-overlay" style="display:none;" onclick="closeModalTorneo(event)">
  <div class="modal-box" style="max-width:500px;max-height:90vh;overflow-y:auto;" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="modalTorneoTitle">Nuevo Torneo</div>
      <button onclick="closeModalTorneo()" style="background:none;border:none;font-size:20px;color:var(--muted);cursor:pointer;">âœ•</button>
    </div>
    <div class="modal-body" style="display:flex;flex-direction:column;gap:16px;">
      <div id="modalTorneoError" class="error-box" style="display:none;"></div>

      <!-- INFO BÃSICA -->
      <div style="background:var(--cardL);border-radius:10px;padding:14px;border:1px solid var(--border);">
        <div class="text-12 font-bold text-muted" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:12px;">ğŸ“‹ InformaciÃ³n</div>
        <div style="display:flex;flex-direction:column;gap:12px;">
          <div><label class="form-label">Nombre del Torneo *</label>
            <input class="form-input" id="tNombre" placeholder="Ej: Torneo Apertura 2026"/></div>
          <div style="display:flex;gap:12px;">
            <div style="flex:1;"><label class="form-label">Fecha inicio</label>
              <input type="date" class="form-input" id="tFechaInicio"/></div>
            <div style="flex:1;"><label class="form-label">Fecha fin</label>
              <input type="date" class="form-input" id="tFechaFin"/></div>
          </div>
          <div style="display:flex;gap:12px;">
            <div style="flex:1;"><label class="form-label">NÂ° Jornadas</label>
              <input type="number" class="form-input" id="tJornadasTotal" min="1" max="52" placeholder="8"/></div>
            <div style="flex:1;"><label class="form-label">Estado</label>
              <select class="form-select" id="tEstado" style="width:100%;">
                <option value="Borrador">Borrador</option>
                <option value="Activo" selected>Activo</option>
                <option value="Finalizado">Finalizado</option>
              </select></div>
          </div>
          <div><label class="form-label">DescripciÃ³n (opcional)</label>
            <input class="form-input" id="tDescripcion" placeholder="DescripciÃ³n del torneo..."/></div>
          <div style="display:flex;gap:12px;">
            <div style="flex:1;"><label class="form-label">Visibilidad</label>
              <select class="form-select" id="tVisibilidad" style="width:100%;">
                <option value="privado">ğŸ”’ Privado</option>
                <option value="publico">ğŸŒ PÃºblico</option>
              </select></div>
            <div style="flex:1;"><label class="form-label">Â¿QuiÃ©n carga?</label>
              <select class="form-select" id="tQuienCarga" style="width:100%;">
                <option value="admins">Solo admins</option>
                <option value="cualquiera">Cualquier jugador</option>
              </select></div>
          </div>
        </div>
      </div>

      <!-- REGLAS DE PUNTUACIÃ“N -->
      <div style="background:var(--cardL);border-radius:10px;padding:14px;border:1px solid var(--border);">
        <div class="text-12 font-bold text-muted" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:12px;">âš™ï¸ Reglas de PuntuaciÃ³n</div>

        <!-- Puntos por posiciÃ³n -->
        <div style="margin-bottom:14px;">
          <label class="form-label">Puntos por posiciÃ³n</label>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:6px;">
            <div style="text-align:center;">
              <div style="font-size:18px;margin-bottom:4px;">ğŸ¥‡</div>
              <input type="number" class="form-input" id="rPts1" oninput="updateEmpateEjemplo()" value="4" min="0" style="text-align:center;padding:8px 4px;"/>
            </div>
            <div style="text-align:center;">
              <div style="font-size:18px;margin-bottom:4px;">ğŸ¥ˆ</div>
              <input type="number" class="form-input" id="rPts2" oninput="updateEmpateEjemplo()" value="3" min="0" style="text-align:center;padding:8px 4px;"/>
            </div>
            <div style="text-align:center;">
              <div style="font-size:18px;margin-bottom:4px;">ğŸ¥‰</div>
              <input type="number" class="form-input" id="rPts3" value="2" min="0" style="text-align:center;padding:8px 4px;"/>
            </div>
            <div style="text-align:center;">
              <div style="font-size:18px;margin-bottom:4px;">ğŸŒï¸</div>
              <div style="font-size:10px;color:var(--muted);margin-bottom:4px;">Resto</div>
              <input type="number" class="form-input" id="rPtsResto" value="1" min="0" style="text-align:center;padding:8px 4px;"/>
            </div>
          </div>
        </div>

        <!-- Bonus / Penales -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
          <div>
            <label class="form-label">âœ… Bonus asistencia</label>
            <div style="display:flex;align-items:center;gap:6px;">
              <input type="number" class="form-input" id="rBonus" value="0" min="0" style="text-align:center;width:70px;"/>
              <span class="text-12 text-muted">pts extra</span>
            </div>
          </div>
          <div>
            <label class="form-label">âŒ Penal no asistencia</label>
            <div style="display:flex;align-items:center;gap:6px;">
              <input type="number" class="form-input" id="rPenalNoAsist" value="0" style="text-align:center;width:70px;"/>
              <span class="text-12 text-muted">pts</span>
            </div>
          </div>
          <div>
            <label class="form-label">ğŸš« Penal DQ</label>
            <div style="display:flex;align-items:center;gap:6px;">
              <input type="number" class="form-input" id="rPenalDQ" value="0" style="text-align:center;width:70px;"/>
              <span class="text-12 text-muted">pts</span>
            </div>
          </div>
          <div>
            <label class="form-label">ğŸ—‘ï¸ Descartes</label>
            <div style="display:flex;align-items:center;gap:6px;">
              <input type="number" class="form-input" id="rDescartes" value="0" min="0" style="text-align:center;width:70px;"/>
              <span class="text-12 text-muted">jornadas</span>
            </div>
          </div>
        </div>

        <!-- Empates -->
        <div>
          <label class="form-label">ğŸ¤ Empates</label>
          <select class="form-select" id="rEmpates" style="width:100%;margin-top:6px;" onchange="updateEmpateEjemplo()" oninput="updateEmpateEjemplo()">
            <option value="comparten">Comparten puntos â€” promedio de posiciones empatadas</option>
            <option value="posicion_anterior">PosiciÃ³n anterior â€” ambos toman la misma posiciÃ³n</option>
          </select>
          <div id="empateEjemplo" style="margin-top:6px;font-size:11px;color:var(--muted);padding:8px 10px;background:var(--bg);border-radius:6px;"></div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-outline" onclick="closeModalTorneo()">Cancelar</button>
      <button class="btn-green" id="btnGuardarTorneo" onclick="saveModalTorneo()">Guardar Torneo</button>
    </div>
  </div>
</div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VERSIÃ“N â€” cambia este nÃºmero cada vez que subas cambios
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const APP_VERSION = '2.2.0';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig = {
  apiKey:            "AIzaSyCu98_7auFGd3nJJmYDRCM7KaM5OdtCBx4",
  authDomain:        "golfeados-660b3.firebaseapp.com",
  projectId:         "golfeados-660b3",
  storageBucket:     "golfeados-660b3.firebasestorage.app",
  messagingSenderId: "417996522021",
  appId:             "1:417996522021:web:67871e33758befec81f5cc"
};
firebase.initializeApp(firebaseConfig);
const auth    = firebase.auth();
const db      = firebase.firestore();
const storage = firebase.storage();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ESTADO GLOBAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let STATE = {
  user:null, profile:null,
  torneo:null,          // legacy single-torneo (kept for compatibility)
  torneos:[],           // all torneos
  jugadores:[], jornadas:[], resultados:[], clubes:[],
  currentTab:'dashboard', cargarJornadaId:null,
  expandedJornada:null, expandedTorneo:null,
  chartInstance:null, editingJornadaId:null,
  activeTorneoId:null,  // torneo being viewed in detail
  unsubs:[]
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH â€” Multi-method login + Registration + Verification
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Show/hide login views
function showLoginView(id){
  ['loginView','registerView','verifyChoiceView','smsCodeView',
   'emailSentView','pendingVerifyView','resetView'].forEach(v=>{
    const el=document.getElementById(v);
    if(el) el.style.display=v===id?'block':'none';
  });
}
function showLogin(){ showLoginView('loginView'); }
function showRegister(){ showLoginView('registerView'); }
function showVerifyChoice(){ showLoginView('verifyChoiceView'); }

// â”€â”€â”€ onAuthStateChanged â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
auth.onAuthStateChanged(async user=>{
  if(user){
    STATE.user=user;
    const snap=await db.collection('users').doc(user.uid).get();
    if(snap.exists){ STATE.profile=snap.data(); }
    else{
      const p={email:user.email,nombre:user.displayName||user.email,
               role:'jugador',jugador_id:null,verified:false,username:''};
      await db.collection('users').doc(user.uid).set(p);
      STATE.profile=p;
    }
    // Check if verified
    await user.reload();
    const emailVerif=user.emailVerified;
    const phoneVerif=STATE.profile?.phoneVerified||false;
    const isLegacy=STATE.profile?.legacy||false; // admin-created accounts skip verification
    if(!emailVerif&&!phoneVerif&&!isLegacy){
      // Not verified â€” show pending
      showLogin_();
      document.getElementById('loginScreen').style.display='flex';
      // Pre-fill verifyChoice
      document.getElementById('verifyEmailAddr').textContent=user.email||'';
      const tc=STATE.profile?.telefonoCompleto;
      if(tc) document.getElementById('verifyPhoneNum').textContent=tc;
      showLoginView('pendingVerifyView');
    } else {
      showApp_(); initListeners();
    }
  } else {
    STATE.user=null; STATE.profile=null;
    stopListeners(); showLogin_();
  }
});

function showLogin_(){
  document.getElementById('loading').style.display='none';
  document.getElementById('loginScreen').style.display='flex';
  document.getElementById('app').style.display='none';
  showLoginView('loginView');
}

function showApp_(){
  document.getElementById('loading').style.display='none';
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('app').style.display='block';
  document.getElementById('headerUser').textContent=STATE.profile?.nombre||STATE.user?.email||'';
  document.getElementById('adminBadge').style.display=STATE.profile?.role==='admin'?'inline':'none';
  initConnectionMonitor();
  initUpdateChecker();
}

// Keep showApp as alias
function showApp(){ showApp_(); }

// â”€â”€â”€ LOGIN: email / username / phone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateLoginHint(input){
  const v=input.value.trim();
  const hint=document.getElementById('loginHint');
  if(!v){ hint.textContent=''; return; }
  if(v.includes('@')&&v.includes('.')){ hint.textContent='ğŸ“§ Entrando con email'; }
  else if(/^[+0-9]/.test(v)){ hint.textContent='ğŸ“± Entrando con telÃ©fono'; }
  else { hint.textContent='ğŸ‘¤ Entrando con usuario'; }
}

async function resolveEmail(identifier){
  // Returns email for any identifier type
  if(identifier.includes('@')&&identifier.includes('.')) return identifier;
  // Search Firestore users
  let snap;
  if(/^[+0-9]/.test(identifier)){
    // Phone: normalize
    const normalized=identifier.replace(/[^0-9+]/g,'');
    snap=await db.collection('users').where('telefonoCompleto','==',normalized).limit(1).get();
    if(snap.empty){
      // Try without country code variants
      snap=await db.collection('users').where('telefono','==',normalized.replace(/^\+[0-9]{1,3}/,'')).limit(1).get();
    }
  } else {
    // Username: strip leading @
    const uname=identifier.replace(/^@/,'').toLowerCase();
    snap=await db.collection('users').where('username','==',uname).limit(1).get();
  }
  if(!snap||snap.empty) return null;
  return snap.docs[0].data().email||null;
}

async function handleLogin(){
  const identifier=document.getElementById('loginIdentifier').value.trim();
  const pass=document.getElementById('loginPassword').value;
  const btn=document.getElementById('loginBtn');
  const err=document.getElementById('loginError');
  err.style.display='none'; btn.disabled=true; btn.textContent='Entrando...';
  try{
    const email=await resolveEmail(identifier);
    if(!email){ err.textContent='Usuario no encontrado.'; err.style.display='block'; return; }
    await auth.signInWithEmailAndPassword(email,pass);
  }catch(e){
    const m={
      'auth/user-not-found':'Usuario no encontrado.',
      'auth/wrong-password':'ContraseÃ±a incorrecta.',
      'auth/invalid-credential':'Credenciales incorrectas.',
      'auth/too-many-requests':'Demasiados intentos. Espera un momento.'
    };
    err.textContent=m[e.code]||'Error: '+e.message; err.style.display='block';
  } finally{ btn.disabled=false; btn.textContent='Entrar al Club'; }
}

// â”€â”€â”€ REGISTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function formatUsername(input){
  input.value=input.value.toLowerCase().replace(/[^a-z0-9_]/g,'');
  const hint=document.getElementById('usernameHint');
  if(input.value.length>0&&input.value.length<3){
    hint.textContent='âš ï¸ MÃ­nimo 3 caracteres'; hint.style.color='var(--red)';
  } else if(input.value.length>=3){
    hint.textContent='âœ… @'+input.value; hint.style.color='var(--green)';
  } else { hint.textContent='Solo letras, nÃºmeros y guiÃ³n bajo'; hint.style.color='var(--muted)'; }
}

function checkStrength(input){
  const v=input.value;
  const bar=document.getElementById('strengthBar');
  const lbl=document.getElementById('strengthLabel');
  let score=0;
  if(v.length>=6)score++;
  if(v.length>=10)score++;
  if(/[A-Z]/.test(v))score++;
  if(/[0-9]/.test(v))score++;
  if(/[^A-Za-z0-9]/.test(v))score++;
  const levels=[
    {w:'0%',bg:'var(--border)',t:''},
    {w:'25%',bg:'var(--red)',t:'Muy dÃ©bil'},
    {w:'50%',bg:'#FF9800',t:'DÃ©bil'},
    {w:'75%',bg:'#2196F3',t:'Buena'},
    {w:'100%',bg:'var(--green)',t:'Muy segura'},
  ];
  const lv=levels[Math.min(score,4)];
  bar.style.width=lv.w; bar.style.background=lv.bg;
  lbl.textContent=lv.t; lbl.style.color=lv.bg;
}

function togglePass(id,btn){
  const inp=document.getElementById(id);
  if(inp.type==='password'){ inp.type='text'; btn.textContent='ğŸ™ˆ'; }
  else { inp.type='password'; btn.textContent='ğŸ‘'; }
}

async function handleRegister(){
  const nombre=document.getElementById('regNombre').value.trim();
  const username=document.getElementById('regUsername').value.trim().toLowerCase();
  const email=document.getElementById('regEmail').value.trim();
  const tel=document.getElementById('regTelefono').value.trim();
  const codigo=document.getElementById('regPaisCodigo').value;
  const pass=document.getElementById('regPassword').value;
  const err=document.getElementById('registerError');
  const btn=document.getElementById('regBtn');
  err.style.display='none';

  if(!nombre){ err.textContent='El nombre es obligatorio.'; err.style.display='block'; return; }
  if(!username||username.length<3){ err.textContent='El usuario debe tener mÃ­nimo 3 caracteres.'; err.style.display='block'; return; }
  if(!email||!email.includes('@')){ err.textContent='Email invÃ¡lido.'; err.style.display='block'; return; }
  if(pass.length<6){ err.textContent='La contraseÃ±a debe tener mÃ­nimo 6 caracteres.'; err.style.display='block'; return; }

  btn.disabled=true; btn.textContent='Creando cuenta...';
  try{
    // Check username availability
    const usnap=await db.collection('users').where('username','==',username).limit(1).get();
    if(!usnap.empty){ err.textContent='Ese nombre de usuario ya estÃ¡ tomado.'; err.style.display='block'; return; }

    // Create Firebase Auth user
    const cred=await auth.createUserWithEmailAndPassword(email,pass);
    await cred.user.updateProfile({displayName:nombre});

    // Save profile to Firestore
    const telNorm=normalizeTelVE(tel,codigo);
    const telefonoCompleto=telNorm?(codigo+telNorm):'';
    const profile={
      email, nombre, username, role:'jugador', jugador_id:null,
      telefono:tel||'', codigoPais:tel?codigo:'', telefonoCompleto,
      verified:false, phoneVerified:false, legacy:false,
      creado:firebase.firestore.FieldValue.serverTimestamp()
    };
    await db.collection('users').doc(cred.user.uid).set(profile);
    STATE.profile=profile;

    // Go to verification choice
    document.getElementById('verifyEmailAddr').textContent=email;
    if(telefonoCompleto) document.getElementById('verifyPhoneNum').textContent=telefonoCompleto;
    else document.getElementById('optSMS').style.opacity='0.4';
    showVerifyChoice();
  }catch(e){
    const m={
      'auth/email-already-in-use':'Ese email ya tiene una cuenta.',
      'auth/invalid-email':'Email invÃ¡lido.',
      'auth/weak-password':'ContraseÃ±a muy dÃ©bil.'
    };
    err.textContent=m[e.code]||'Error: '+e.message; err.style.display='block';
  } finally{ btn.disabled=false; btn.textContent='Continuar â†’'; }
}

// â”€â”€â”€ VERIFICATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let verifyMethod=null;
let confirmationResult=null;
let appVerifier=null;

function chooseVerify(method){
  verifyMethod=method;
  document.getElementById('optEmail').classList.toggle('selected',method==='email');
  document.getElementById('optSMS').classList.toggle('selected',method==='sms');
}

async function sendVerification(){
  const err=document.getElementById('verifyChoiceError');
  const btn=document.getElementById('btnSendVerify');
  err.style.display='none';
  if(!verifyMethod){ err.textContent='Selecciona un mÃ©todo.'; err.style.display='block'; return; }
  btn.disabled=true; btn.textContent='Enviando...';

  try{
    if(verifyMethod==='email'){
      await auth.currentUser.sendEmailVerification({
        url:window.location.origin+window.location.pathname
      });
      document.getElementById('emailSentAddr').textContent=
        'Enviamos un link a '+auth.currentUser.email+'. Ãbrelo y luego vuelve aquÃ­.';
      showLoginView('emailSentView');
    } else {
      // SMS via Firebase Phone Auth
      const profile=STATE.profile||(await db.collection('users').doc(auth.currentUser.uid).get()).data();
      const phone=profile?.telefonoCompleto;
      if(!phone){ err.textContent='No tienes telÃ©fono registrado. Elige email.'; err.style.display='block'; return; }

      if(!appVerifier){
        appVerifier=new firebase.auth.RecaptchaVerifier('recaptcha-container',{
          size:'invisible',
          callback:()=>{}
        });
      }
      confirmationResult=await auth.signInWithPhoneNumber(phone,appVerifier);
      document.getElementById('smsSentTo').textContent='CÃ³digo enviado a '+phone;
      // Clear OTP inputs
      [0,1,2,3,4,5].forEach(i=>{ const el=document.getElementById('otp'+i); if(el)el.value=''; });
      showLoginView('smsCodeView');
      document.getElementById('otp0').focus();
      // Show resend after 30s
      setTimeout(()=>{ const b=document.getElementById('btnResendSMS'); if(b)b.style.display='block'; },30000);
    }
  }catch(e){
    err.textContent='Error: '+e.message; err.style.display='block';
    if(appVerifier){ try{appVerifier.clear();}catch(ex){} appVerifier=null; }
  } finally{ btn.disabled=false; btn.textContent='Enviar cÃ³digo'; }
}

// OTP input helpers
function otpNext(input,i){
  input.value=input.value.replace(/[^0-9]/g,'');
  if(input.value&&i<5) document.getElementById('otp'+(i+1)).focus();
  // Auto-confirm when all 6 filled
  const code=[0,1,2,3,4,5].map(n=>document.getElementById('otp'+n).value).join('');
  if(code.length===6) confirmSMS();
}
function otpBack(e,i){
  if(e.key==='Backspace'&&!e.target.value&&i>0) document.getElementById('otp'+(i-1)).focus();
}

async function confirmSMS(){
  const code=[0,1,2,3,4,5].map(i=>document.getElementById('otp'+i).value).join('');
  const err=document.getElementById('smsError');
  const btn=document.getElementById('btnConfirmSMS');
  err.style.display='none';
  if(code.length<6){ err.textContent='Ingresa los 6 dÃ­gitos.'; err.style.display='block'; return; }
  btn.disabled=true; btn.textContent='Verificando...';
  try{
    // Get phone credential and link to current user
    const credential=firebase.auth.PhoneAuthProvider.credential(
      confirmationResult.verificationId, code
    );
    await auth.currentUser.linkWithCredential(credential);
    // Mark verified in Firestore
    await db.collection('users').doc(auth.currentUser.uid).update({
      phoneVerified:true, verified:true,
      verifiedAt:firebase.firestore.FieldValue.serverTimestamp()
    });
    STATE.profile.phoneVerified=true; STATE.profile.verified=true;
    showApp_(); initListeners();
  }catch(e){
    const m={'auth/invalid-verification-code':'CÃ³digo incorrecto.','auth/code-expired':'CÃ³digo expirado, reenvÃ­a.'};
    err.textContent=m[e.code]||'Error: '+e.message; err.style.display='block';
  } finally{ btn.disabled=false; btn.textContent='Confirmar cÃ³digo'; }
}

async function resendSMS(){
  if(appVerifier){ try{appVerifier.clear();}catch(e){} appVerifier=null; }
  confirmationResult=null;
  showVerifyChoice();
  verifyMethod='sms';
  chooseVerify('sms');
}

async function recheckEmail(){
  await auth.currentUser.reload();
  if(auth.currentUser.emailVerified){
    await db.collection('users').doc(auth.currentUser.uid).update({verified:true,verifiedAt:firebase.firestore.FieldValue.serverTimestamp()});
    STATE.profile.verified=true;
    showApp_(); initListeners();
  } else {
    const err=document.getElementById('verifyChoiceError');
    showLoginView('emailSentView');
    alert('El email aÃºn no ha sido verificado. Por favor abre el link en tu correo.');
  }
}

async function resendEmail(){
  try{ await auth.currentUser.sendEmailVerification({url:window.location.origin+window.location.pathname}); }
  catch(e){ alert('Error al reenviar: '+e.message); }
}

function skipVerify(){
  // Allow limited access â€” can be restricted later
  showApp_(); initListeners();
}

async function handleLogout(){ await auth.signOut(); }

async function handleReset(){
  const email=document.getElementById('resetEmail').value.trim();
  const err=document.getElementById('resetError'); err.style.display='none';
  try{
    await auth.sendPasswordResetEmail(email);
    document.getElementById('resetForm').style.display='none';
    document.getElementById('resetSuccess').style.display='block';
  }catch{ err.textContent='No se encontrÃ³ ese email.'; err.style.display='block'; }
}

function showReset(){
  showLoginView('resetView');
  document.getElementById('resetForm').style.display='block';
  document.getElementById('resetSuccess').style.display='none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIRESTORE LISTENERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initListeners(){
  stopListeners();
  // Load ALL torneos (sorted: active first, then by creation date)
  STATE.unsubs.push(db.collection('torneos').orderBy('creado','desc')
    .onSnapshot(s=>{
      STATE.torneos=s.docs.map(d=>({id:d.id,...d.data()}));
      // Legacy: keep STATE.torneo as the first active one
      STATE.torneo=STATE.torneos.find(t=>t.estado==='Activo'||t.estado==='activo')||STATE.torneos[0]||null;
      if(!STATE.activeTorneoId&&STATE.torneo) STATE.activeTorneoId=STATE.torneo.id;
      if(STATE._connSetOnline)STATE._connSetOnline();
      renderCurrentTab();
    }));
  STATE.unsubs.push(db.collection('jugadores').orderBy('nombre')
    .onSnapshot(s=>{ STATE.jugadores=s.docs.map(d=>({id:d.id,...d.data()})); renderCurrentTab(); }));
  STATE.unsubs.push(db.collection('jornadas').orderBy('fecha')
    .onSnapshot(s=>{ STATE.jornadas=s.docs.map(d=>({id:d.id,...d.data()})); renderCurrentTab(); }));
  STATE.unsubs.push(db.collection('resultados')
    .onSnapshot(s=>{ STATE.resultados=s.docs.map(d=>({id:d.id,...d.data()})); if(STATE._connSetOnline)STATE._connSetOnline(); renderCurrentTab(); }));
  STATE.unsubs.push(db.collection('clubes').orderBy('nombre')
    .onSnapshot(s=>{ STATE.clubes=s.docs.map(d=>({id:d.id,...d.data()})); renderCurrentTab(); }));
}
function stopListeners(){ STATE.unsubs.forEach(u=>u()); STATE.unsubs=[]; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MONITOR DE CONEXIÃ“N EN TIEMPO REAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initConnectionMonitor(){
  // Firestore network state via .info/connected (uses Realtime DB trick via Firestore itself)
  // We use a heartbeat approach: check if snapshots arrive within expected time
  let lastUpdate=Date.now();
  let connTimer=null;
  const pill=document.getElementById('connPill');
  const dot=document.getElementById('connDot');
  const label=document.getElementById('connLabel');

  function setOnline(){
    lastUpdate=Date.now();
    if(pill){
      pill.style.background='#E8F5E9';pill.style.color='#2E7D32';pill.style.borderColor='#A5D6A7';
      dot.style.background='#4CAF50';dot.style.animation='';
      label.textContent='EN VIVO';
    }
  }
  function setOffline(){
    if(pill){
      pill.style.background='#FFF8E1';pill.style.color='#F57F17';pill.style.borderColor='#FFE082';
      dot.style.background='#FFC107';dot.style.animation='pulse-dot 1s infinite';
      label.textContent='RECONECTANDO';
    }
  }
  function setSyncing(){
    if(pill){
      pill.style.background='#E3F2FD';pill.style.color='#1565C0';pill.style.borderColor='#90CAF9';
      dot.style.background='#2196F3';
      label.textContent='SINCRONIZANDO';
    }
    setTimeout(setOnline,1500);
  }

  // Patch initListeners to call setSyncing on each snapshot
  const _origInit=initListeners;

  // Monitor: if no update in 15s, show reconnecting
  function heartbeat(){
    const elapsed=Date.now()-lastUpdate;
    if(elapsed>15000) setOffline();
    else setOnline();
  }
  connTimer=setInterval(heartbeat,5000);

  // Listen to window online/offline events
  window.addEventListener('online',()=>{
    setSyncing();
    // Re-init listeners on reconnect
    initListeners();
  });
  window.addEventListener('offline',setOffline);

  // Firestore automatically reconnects â€” track with a lightweight doc listener
  db.collection('torneos').limit(1).onSnapshot(
    ()=>{ lastUpdate=Date.now(); },
    ()=>{ setOffline(); }
  );

  // Expose setOnline so snapshot callbacks can call it
  STATE._connSetOnline=setOnline;
  STATE._connSetSyncing=setSyncing;
}

// CSS for pulsing dot
(function(){
  const s=document.createElement('style');
  s.textContent='@keyframes pulse-dot{0%,100%{opacity:1;transform:scale(1);}50%{opacity:0.5;transform:scale(0.8);}}';
  document.head.appendChild(s);
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVEGACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goTab(tab){
  STATE.currentTab=tab; STATE.cargarJornadaId=null;
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.toggle('active',b.dataset.tab===tab));
  ['dashboard','mistorneos','ranking','jornadas','jugadores','clubes','cargar'].forEach(t=>{
    const el=document.getElementById('tab-'+t);
    if(el) el.style.display=t===tab?'block':'none';
  });
  renderCurrentTab();
}
function goCargar(jornadaId){
  STATE.cargarJornadaId=jornadaId; STATE.currentTab='cargar';
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  ['dashboard','ranking','jornadas','jugadores','clubes'].forEach(t=>document.getElementById('tab-'+t).style.display='none');
  document.getElementById('tab-cargar').style.display='block';
  renderCargar();
}
function renderCurrentTab(){
  if(STATE.currentTab==='dashboard') renderDashboard();
  else if(STATE.currentTab==='mistorneos') renderMisTorneos();
  else if(STATE.currentTab==='ranking') renderRanking();
  else if(STATE.currentTab==='jornadas') renderJornadas();
  else if(STATE.currentTab==='jugadores') renderJugadores();
  else if(STATE.currentTab==='clubes') renderClubes();
  else if(STATE.currentTab==='cargar') renderCargar();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Reglas por defecto del torneo
function getReglas(torneoId){
  const t=STATE.torneos.find(t=>t.id===torneoId)||STATE.torneo;
  return Object.assign({
    puntos:{1:4,2:3,3:2,resto:1},
    bonusAsistencia:0,
    penalNoAsistencia:0,
    penalDQ:0,
    descartes:0,
    empates:'comparten'
  }, t?.reglas||{});
}

// Puntos por posiciÃ³n segÃºn reglas del torneo
function getPtsPosicion(pos, reglas){
  if(!reglas) reglas=getReglas(STATE.activeTorneoId);
  const p=reglas.puntos||{};
  return p[pos]!==undefined ? p[pos] : (p.resto!==undefined ? p.resto : 1);
}

// Legacy getPts (backward compat with cargar resultados)
function getPts(pos,asist,torneoId){
  if(!asist) return 0;
  const reglas=getReglas(torneoId||STATE.activeTorneoId);
  return getPtsPosicion(pos, reglas);
}

// â”€â”€â”€ calcRankingTorneo: with empates y descartes â”€â”€â”€â”€â”€
function calcRankingTorneo(torneoId){
  const reglas=getReglas(torneoId);
  const jornadasT=STATE.jornadas.filter(j=>
    (!torneoId||(j.torneo_id===torneoId||(!j.torneo_id&&torneoId===STATE.torneo?.id)))
    && j.cuentaRanking!==false
  );
  const jugados=jornadasT.filter(j=>j.estado!=='Planificada');
  const oficiales=jornadasT.filter(j=>j.estado==='Oficial');

  // 1. Calculate raw points per player per jornada
  const rawData=STATE.jugadores.map(jugador=>{
    const jornadaPts=jugados.map(jn=>{
      const r=STATE.resultados.find(r=>r.jornada_id===jn.id&&r.jugador_id===jugador.id);
      if(!r) return null;
      // Base points from position in jornada result
      let pts=r.pts||0;
      // Apply bonuses/penalties
      if(r.asistencia) pts+=(reglas.bonusAsistencia||0);
      if(!r.asistencia) pts+=(reglas.penalNoAsistencia||0);
      if(r.dq) pts+=(reglas.penalDQ||0);
      return{jornada_id:jn.id,pts,asistencia:r.asistencia,dq:r.dq||false};
    }).filter(Boolean);

    // Apply descartes: remove N lowest scoring jornadas
    let ptsList=[...jornadaPts];
    if(reglas.descartes>0&&ptsList.length>reglas.descartes){
      ptsList.sort((a,b)=>a.pts-b.pts);
      const descartados=ptsList.slice(0,reglas.descartes).map(p=>p.jornada_id);
      ptsList=ptsList.filter(p=>!descartados.includes(p.jornada_id));
    }

    const ptsT=ptsList.reduce((a,r)=>a+(r.pts||0),0);
    const ptsOf=ptsList.filter(r=>{
      const jn=oficiales.find(j=>j.id===r.jornada_id);
      return !!jn;
    }).reduce((a,r)=>a+(r.pts||0),0);
    const asist=jornadaPts.filter(r=>r.asistencia).length;

    return{...jugador,ptsT,ptsOf,asist,jornadaPts};
  });

  // 2. Sort by ptsT desc
  rawData.sort((a,b)=>b.ptsT-a.ptsT);

  // 3. Apply empate logic: 'comparten' = promedio de puntos de posiciones compartidas
  // Note: pos here is the ranking position, not the in-jornada position
  if(reglas.empates==='comparten'){
    let i=0;
    while(i<rawData.length){
      // Find all players with same ptsT
      let j=i;
      while(j<rawData.length&&rawData[j].ptsT===rawData[i].ptsT) j++;
      // Positions i+1 to j (1-indexed)
      const count=j-i;
      const posInicial=i+1;
      if(count>1){
        // Sum points for positions i+1..j using torneo rules
        let sumPts=0;
        for(let k=posInicial;k<=j;k++) sumPts+=getPtsPosicion(k,reglas);
        // Not applicable here â€” pos in ranking doesn't map to ranking points
        // Just assign same position to all tied players
        for(let k=i;k<j;k++) rawData[k].pos=posInicial;
      } else {
        rawData[i].pos=posInicial;
      }
      i=j;
    }
  } else {
    rawData.forEach((j,i)=>j.pos=i+1);
  }

  return rawData;
}

// Legacy calcRanking uses active torneo
function calcRanking(){ return calcRankingTorneo(STATE.activeTorneoId||STATE.torneo?.id); }
function avatarBg(pos){
  if(pos===1)return'#C49A00'; if(pos===2)return'#78909C'; if(pos===3)return'#8D6E63';
  return'var(--green)';
}
function medal(pos){
  if(pos===1)return'ğŸ¥‡'; if(pos===2)return'ğŸ¥ˆ'; if(pos===3)return'ğŸ¥‰';
  return`<span style="color:var(--muted);font-weight:700;font-size:14px;width:22px;display:inline-block;text-align:center;">${pos}</span>`;
}
function badgeHTML(estado){
  const m={'Oficial':'badge-oficial','Por Validar':'badge-validar','Pendiente Attest':'badge-attest','Planificada':'badge-planificada','En Juego':'badge-enjuego','Activo':'badge-activo'};
  return`<span class="badge ${m[estado]||'badge-planificada'}">${estado}</span>`;
}
function avatarHTML(foto,pos,size='md'){
  const bg=avatarBg(pos);
  const sz=size==='sm'?'32px;font-size:11px':size==='lg'?'42px;font-size:15px':'36px;font-size:13px';
  const shadow=pos===1?'box-shadow:0 0 0 3px rgba(196,154,0,0.25);':'';
  return`<div class="avatar" style="width:${sz};background:${bg};${shadow}">${foto||'?'}</div>`;
}
function fmtFecha(dateStr){
  if(!dateStr) return 'â€”';
  const d=new Date(dateStr+'T12:00:00');
  return d.toLocaleDateString('es-ES',{day:'numeric',month:'short',year:'numeric'});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD â€” Multi-torneo
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function torneoCardHTML(torneo, compact=false){
  const tid=torneo.id;
  const reglas=getReglas(tid);
  const jornadasT=STATE.jornadas.filter(j=>j.torneo_id===tid||(!j.torneo_id&&tid===STATE.torneo?.id));
  const jugadas=jornadasT.filter(j=>j.estado!=='Planificada').length;
  const total=torneo.jornadas_total||jornadasT.length||'?';
  const proxima=[...jornadasT].sort((a,b)=>new Date(a.fecha)-new Date(b.fecha))
    .find(j=>j.estado==='Planificada'&&j.fecha>=new Date().toISOString().slice(0,10));

  // My position
  const rk=calcRankingTorneo(tid);
  const myJugadorId=STATE.profile?.jugador_id;
  const myPos=rk.find(r=>r.id===myJugadorId);
  const isAdmin=STATE.profile?.role==='admin'||(torneo.admins||[]).includes(STATE.user?.uid)||torneo.adminId===STATE.user?.uid;

  const estadoColor={'Activo':'var(--green)','activo':'var(--green)','Finalizado':'var(--muted)','finalizado':'var(--muted)','Borrador':'var(--gold)','borrador':'var(--gold)'}[torneo.estado]||'var(--blue)';

  return`
  <div class="card" style="margin-bottom:12px;overflow:hidden;">
    <div style="background:linear-gradient(135deg,var(--green),var(--teal));padding:16px 20px;cursor:pointer;"
      onclick="toggleTorneoDash('${tid}')">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div>
          <div style="color:rgba(255,255,255,0.7);font-size:10px;letter-spacing:2px;text-transform:uppercase;margin-bottom:4px;">
            ${torneo.estado?.toUpperCase()||'ACTIVO'}
          </div>
          <div style="color:#fff;font-size:17px;font-weight:800;font-family:Georgia,serif;">${torneo.nombre}</div>
        </div>
        ${myPos?`<div style="text-align:right;">
          <div style="color:rgba(255,255,255,0.7);font-size:10px;">Mi posiciÃ³n</div>
          <div style="color:#fff;font-size:22px;font-weight:800;">#${myPos.pos}</div>
          <div style="color:rgba(255,255,255,0.7);font-size:11px;">${myPos.ptsT} pts</div>
        </div>`:''}
      </div>
      <div style="display:flex;gap:20px;margin-top:12px;">
        <div><div style="color:rgba(255,255,255,0.6);font-size:9px;text-transform:uppercase;letter-spacing:1px;">Jornadas</div>
          <div style="color:#fff;font-size:14px;font-weight:700;">${jugadas}/${total}</div></div>
        <div><div style="color:rgba(255,255,255,0.6);font-size:9px;text-transform:uppercase;letter-spacing:1px;">Jugadores</div>
          <div style="color:#fff;font-size:14px;font-weight:700;">${rk.length}</div></div>
        <div><div style="color:rgba(255,255,255,0.6);font-size:9px;text-transform:uppercase;letter-spacing:1px;">PrÃ³xima</div>
          <div style="color:#fff;font-size:13px;font-weight:600;">${proxima?fmtFecha(proxima.fecha):'â€”'}</div></div>
      </div>
    </div>

    ${STATE.expandedTorneo===tid?`
    <div style="padding:0;">
      <!-- Mini ranking top 3 -->
      <div style="padding:14px 20px 8px;">
        <div class="text-11 text-muted font-bold" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">ğŸ† Podio</div>
        ${rk.slice(0,3).map(j=>`
          <div class="result-row" style="margin-bottom:8px;">
            ${medal(j.pos)}
            ${j.fotoURL?`<img src="${j.fotoURL}" style="width:32px;height:32px;border-radius:50%;object-fit:cover;flex-shrink:0;"/>`:avatarHTML(j.foto,j.pos,'sm')}
            <div class="flex-1 text-13 font-bold">${j.nombre}</div>
            <div style="font-size:16px;font-weight:800;color:${j.pos===1?'var(--gold)':'var(--text)'};">${j.ptsT}<span class="text-10 text-muted"> pts</span></div>
          </div>`).join('')}
      </div>
      <!-- PrÃ³ximas jornadas -->
      ${jornadasT.filter(j=>j.estado==='Planificada').slice(0,2).length?`
      <div style="border-top:1px solid var(--border);padding:12px 20px 8px;">
        <div class="text-11 text-muted font-bold" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;">ğŸ“… PrÃ³ximas</div>
        ${jornadasT.filter(j=>j.estado==='Planificada').slice(0,2).map(jn=>`
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
            ${clubAvatarHTML(jn.sede)}
            <div class="flex-1">
              <div class="text-13 font-bold">${jn.sede||'Sin sede'}</div>
              <div class="text-11 text-muted">${fmtFecha(jn.fecha)}${jn.teeTime?' Â· â° '+jn.teeTime:''}</div>
            </div>
          </div>`).join('')}
      </div>`:''}
      <!-- Actions -->
      <div style="border-top:1px solid var(--border);padding:12px 20px;display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn-outline" style="font-size:12px;padding:7px 14px;" onclick="verTorneoCompleto('${tid}')">Ver ranking completo â†’</button>
        ${isAdmin?`<button class="btn-green" style="font-size:12px;padding:7px 14px;" onclick="openModalJornada(null,'${tid}')">+ Jornada</button>`:''}
      </div>
    </div>`:``}
  </div>`;
}

function toggleTorneoDash(torneoId){
  STATE.expandedTorneo=STATE.expandedTorneo===torneoId?null:torneoId;
  renderDashboard();
}

function verTorneoCompleto(torneoId){
  STATE.activeTorneoId=torneoId;
  goTab('mistorneos');
  STATE.expandedTorneo=torneoId;
}

function renderDashboard(){
  const el=document.getElementById('tab-dashboard');
  const isAdmin=STATE.profile?.role==='admin';
  const torneos=STATE.torneos;
  const MAX_DASH=3; // max cards on dashboard

  // Sort: active first, then by creation
  const sorted=[...torneos].sort((a,b)=>{
    const order={activo:0,Activo:0,borrador:1,Borrador:1,finalizado:2,Finalizado:2};
    return (order[a.estado]||1)-(order[b.estado]||1);
  });
  const visible=sorted.slice(0,MAX_DASH);
  const hasMore=sorted.length>MAX_DASH;

  if(torneos.length===0){
    el.innerHTML=`
      <div class="hero">
        <div class="hero-label">Bienvenido a Golfeados</div>
        <div class="hero-title">No hay torneos activos</div>
        <div style="color:rgba(255,255,255,0.8);font-size:13px;margin-top:8px;">Crea tu primer torneo para comenzar</div>
      </div>
      ${isAdmin?`<div class="card"><div class="card-body" style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn-green" onclick="openModalJornada()">+ Jornada</button>
        <button class="btn-blue" onclick="goTab('jugadores')">+ Jugador</button>
        ${STATE.jugadores.length===0?`<button class="btn-teal" onclick="seedDatos()">ğŸŒ± Cargar Datos Iniciales</button>`:''}
      </div><div id="seedMsg" style="display:none;padding:10px 20px;font-size:13px;color:var(--green);"></div></div>`:''}
    `;
    return;
  }

  el.innerHTML=`
    ${visible.map(t=>torneoCardHTML(t)).join('')}
    ${hasMore?`
      <div style="text-align:center;margin:4px 0 16px;">
        <button class="btn-outline" onclick="goTab('mistorneos')" style="width:100%;padding:12px;font-size:13px;">
          Ver todos mis torneos (${torneos.length}) â†’
        </button>
      </div>`:''}
    ${isAdmin?`
    <div class="card">
      <div class="card-header"><span class="card-title">âš™ï¸ Admin</span></div>
      <div class="card-body" style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn-green" onclick="openModalTorneo()">+ Torneo</button>
        <button class="btn-blue" onclick="openModalJornada()">+ Jornada</button>
        <button class="btn-outline" onclick="goTab('jugadores')">+ Jugador</button>
        ${STATE.jugadores.length===0?`<button class="btn-teal" onclick="seedDatos()">ğŸŒ± Cargar Datos Iniciales</button>`:''}
      </div>
      <div id="seedMsg" style="display:none;padding:10px 20px;font-size:13px;color:var(--green);"></div>
    </div>`:''}
  `;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MIS TORNEOS â€” Lista completa con detalle expandible
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMisTorneos(){
  const el=document.getElementById('tab-mistorneos');
  const isAdmin=STATE.profile?.role==='admin';
  const torneos=[...STATE.torneos].sort((a,b)=>{
    const order={activo:0,Activo:0,borrador:1,Borrador:1,finalizado:2,Finalizado:2};
    return (order[a.estado]||1)-(order[b.estado]||1);
  });

  el.innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <div>
        <div class="text-15 font-bold" style="font-family:Georgia,serif;">Mis Torneos</div>
        <div class="text-12 text-muted">${torneos.length} torneo${torneos.length!==1?'s':''}</div>
      </div>
      <button class="btn-green" style="font-size:13px;padding:8px 16px;" onclick="openModalTorneo()">+ Nuevo</button>
    </div>
    ${torneos.length===0?`<div class="card"><div class="card-body" style="text-align:center;color:var(--muted);padding:40px;">
      <div style="font-size:48px;margin-bottom:12px;">â›³</div>
      <div style="margin-bottom:16px;">No tienes torneos aÃºn.</div>
      <button class="btn-green" onclick="openModalTorneo()">+ Crear primer torneo</button>
    </div></div>`:''}
    ${torneos.map(t=>{
      const tid=t.id;
      const isExpanded=STATE.expandedTorneo===tid;
      const rk=calcRankingTorneo(tid);
      const jornadasT=STATE.jornadas.filter(j=>j.torneo_id===tid||(!j.torneo_id&&tid===STATE.torneo?.id));
      const jugadas=jornadasT.filter(j=>j.estado!=='Planificada').length;
      const total=t.jornadas_total||jornadasT.length||'?';
      const myJugadorId=STATE.profile?.jugador_id;
      const myPos=rk.find(r=>r.id===myJugadorId);
      const isAdminT=isAdmin||(t.admins||[]).includes(STATE.user?.uid)||t.adminId===STATE.user?.uid;

      return`
      <div class="card" style="margin-bottom:12px;">
        <!-- Card header -->
        <div style="padding:16px 20px;cursor:pointer;display:flex;align-items:center;gap:14px;"
          onclick="toggleTorneoMis('${tid}')">
          <div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,var(--green),var(--teal));
            display:flex;align-items:center;justify-content:center;color:#fff;font-size:18px;flex-shrink:0;">â›³</div>
          <div class="flex-1">
            <div class="text-15 font-bold">${t.nombre}</div>
            <div class="text-12 text-muted">${jugadas}/${total} jornadas Â· ${rk.length} jugadores</div>
            ${myPos?`<div class="text-11" style="color:var(--green);margin-top:2px;">Tu posiciÃ³n: #${myPos.pos} Â· ${myPos.ptsT} pts</div>`:''}
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
            ${badgeHTML(t.estado||'Activo')}
            <span style="color:var(--muted);font-size:13px;">${isExpanded?'â–²':'â–¼'}</span>
          </div>
        </div>

        ${isExpanded?`
        <!-- Ranking completo -->
        <div style="border-top:1px solid var(--border);">
          <div style="padding:14px 20px 4px;">
            <div class="text-11 text-muted font-bold" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">ğŸ“Š Ranking</div>
            <div class="rank-head"><span>#</span><span>Jugador</span><span>Asist.</span><span>Total</span></div>
            ${rk.map(j=>`
              <div class="rank-row ${j.pos<=3?'top':''}">
                <div>${medal(j.pos)}</div>
                <div class="flex items-center gap-8">
                  ${j.fotoURL?`<img src="${j.fotoURL}" style="width:28px;height:28px;border-radius:50%;object-fit:cover;flex-shrink:0;"/>`:avatarHTML(j.foto,j.pos,'sm')}
                  <div><div class="text-13 font-bold">${j.nombre}</div><div class="text-11 text-muted">${j.alias||''}</div></div>
                </div>
                <div class="text-13 text-muted">${j.asist}âœ“</div>
                <div style="font-size:15px;font-weight:800;color:${j.pos===1?'var(--gold)':'var(--text)'};">${j.ptsT}</div>
              </div>`).join('')}
          </div>

          <!-- Jornadas del torneo -->
          <div style="border-top:1px solid var(--border);padding:14px 20px 8px;">
            <div class="text-11 text-muted font-bold" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">ğŸ“… Jornadas</div>
            ${jornadasT.length===0?`<div class="text-13 text-muted">Sin jornadas aÃºn.</div>`:''}
            ${[...jornadasT].sort((a,b)=>new Date(a.fecha)-new Date(b.fecha)).map(jn=>`
              <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                ${clubAvatarHTML(jn.sede)}
                <div class="flex-1">
                  <div class="text-13 font-bold">${jn.sede||'Sin sede'}${jn.cuentaRanking===false?' ğŸš«':''}</div>
                  <div class="text-11 text-muted">${fmtFecha(jn.fecha)}${jn.teeTime?' Â· â° '+jn.teeTime:''}</div>
                </div>
                ${badgeHTML(jn.estado)}
              </div>`).join('')}
          </div>

          <!-- Reglas del torneo -->
          <div style="border-top:1px solid var(--border);padding:14px 20px 8px;">
            <div class="text-11 text-muted font-bold" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">ğŸ“‹ Reglas</div>
            ${reglasResumenHTML(t)}
          </div>

          <!-- Acciones -->
          <div style="border-top:1px solid var(--border);padding:12px 20px;display:flex;gap:8px;flex-wrap:wrap;">
            ${isAdminT?`<button class="btn-green" style="font-size:12px;padding:7px 14px;" onclick="openModalJornada(null,'${tid}')">+ Jornada</button>`:''}
            ${isAdminT?`<button class="btn-outline" style="font-size:12px;padding:7px 14px;" onclick="openModalEditTorneo('${tid}')">âœï¸ Editar torneo</button>`:''}
          </div>
        </div>`:``}
      </div>`;
    }).join('')}
  `;
}

function toggleTorneoMis(torneoId){
  STATE.expandedTorneo=STATE.expandedTorneo===torneoId?null:torneoId;
  STATE.activeTorneoId=torneoId;
  renderMisTorneos();
}

function reglasResumenHTML(torneo){
  const r=torneo.reglas||{};
  const pts=r.puntos||{1:4,2:3,3:2,resto:1};
  const items=[
    `Puntos: 1Â°=${pts[1]||4} Â· 2Â°=${pts[2]||3} Â· 3Â°=${pts[3]||2} Â· Resto=${pts.resto||1}`,
    r.bonusAsistencia?`Bonus asistencia: +${r.bonusAsistencia} pts`:'',
    r.penalNoAsistencia?`Penal no asistencia: ${r.penalNoAsistencia} pts`:'',
    r.penalDQ?`Penal DQ: ${r.penalDQ} pts`:'',
    r.descartes?`Descartes: ${r.descartes} peor(es) jornada(s) no cuentan`:'',
    `Empates: ${r.empates==='comparten'?'Comparten puntos promedio':'PosiciÃ³n anterior'}`,
  ].filter(Boolean);
  return`<div style="display:flex;flex-direction:column;gap:4px;">
    ${items.map(i=>`<div class="text-12 text-muted">â€¢ ${i}</div>`).join('')}
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL TORNEO â€” Crear / Editar
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editingTorneoId = null;

function openModalTorneo(torneoId=null){
  editingTorneoId=torneoId;
  document.getElementById('modalTorneoError').style.display='none';
  const t=torneoId?STATE.torneos.find(t=>t.id===torneoId):null;
  document.getElementById('modalTorneoTitle').textContent=torneoId?'Editar Torneo':'Nuevo Torneo';

  // Info bÃ¡sica
  document.getElementById('tNombre').value=t?.nombre||'';
  document.getElementById('tFechaInicio').value=t?.fechaInicio||'';
  document.getElementById('tFechaFin').value=t?.fechaFin||'';
  document.getElementById('tJornadasTotal').value=t?.jornadas_total||'';
  document.getElementById('tEstado').value=t?.estado||'Activo';
  document.getElementById('tDescripcion').value=t?.descripcion||'';
  document.getElementById('tVisibilidad').value=t?.visibilidad||'privado';
  document.getElementById('tQuienCarga').value=t?.quienCargaResultados||'admins';

  // Reglas
  const r=t?.reglas||{};
  const pts=r.puntos||{};
  document.getElementById('rPts1').value=pts[1]!==undefined?pts[1]:4;
  document.getElementById('rPts2').value=pts[2]!==undefined?pts[2]:3;
  document.getElementById('rPts3').value=pts[3]!==undefined?pts[3]:2;
  document.getElementById('rPtsResto').value=pts.resto!==undefined?pts.resto:1;
  document.getElementById('rBonus').value=r.bonusAsistencia||0;
  document.getElementById('rPenalNoAsist').value=r.penalNoAsistencia||0;
  document.getElementById('rPenalDQ').value=r.penalDQ||0;
  document.getElementById('rDescartes').value=r.descartes||0;
  document.getElementById('rEmpates').value=r.empates||'comparten';

  updateEmpateEjemplo();
  document.getElementById('modalTorneo').style.display='flex';
}

// Alias for edit button
function openModalEditTorneo(torneoId){ openModalTorneo(torneoId); }

function closeModalTorneo(event){
  if(event&&event.currentTarget!==event.target)return;
  document.getElementById('modalTorneo').style.display='none';
  editingTorneoId=null;
}

function updateEmpateEjemplo(){
  const tipo=document.getElementById('rEmpates').value;
  const pts1=Number(document.getElementById('rPts1').value)||4;
  const pts2=Number(document.getElementById('rPts2').value)||3;
  const el=document.getElementById('empateEjemplo');
  if(tipo==='comparten'){
    const avg=((pts1+pts2)/2).toFixed(1);
    el.textContent=`Ej: 2 empatados en 1Â° â†’ cada uno recibe ${avg} pts ((${pts1}+${pts2})/2). El siguiente toma 3Â°.`;
  } else {
    el.textContent=`Ej: 2 empatados en 1Â° â†’ ambos reciben ${pts1} pts. El siguiente toma 3Â°.`;
  }
}

async function saveModalTorneo(){
  const nombre=document.getElementById('tNombre').value.trim();
  const err=document.getElementById('modalTorneoError');
  const btn=document.getElementById('btnGuardarTorneo');
  err.style.display='none';

  if(!nombre){ err.textContent='El nombre es obligatorio.'; err.style.display='block'; return; }

  btn.disabled=true; btn.textContent='Guardando...';
  try{
    const data={
      nombre,
      fechaInicio:document.getElementById('tFechaInicio').value||'',
      fechaFin:document.getElementById('tFechaFin').value||'',
      jornadas_total:Number(document.getElementById('tJornadasTotal').value)||0,
      estado:document.getElementById('tEstado').value,
      descripcion:document.getElementById('tDescripcion').value.trim(),
      visibilidad:document.getElementById('tVisibilidad').value,
      quienCargaResultados:document.getElementById('tQuienCarga').value,
      reglas:{
        puntos:{
          1:Number(document.getElementById('rPts1').value)||4,
          2:Number(document.getElementById('rPts2').value)||3,
          3:Number(document.getElementById('rPts3').value)||2,
          resto:Number(document.getElementById('rPtsResto').value)||1,
        },
        bonusAsistencia:Number(document.getElementById('rBonus').value)||0,
        penalNoAsistencia:Number(document.getElementById('rPenalNoAsist').value)||0,
        penalDQ:Number(document.getElementById('rPenalDQ').value)||0,
        descartes:Number(document.getElementById('rDescartes').value)||0,
        empates:document.getElementById('rEmpates').value||'comparten',
      }
    };

    if(editingTorneoId){
      data.updated_at=firebase.firestore.FieldValue.serverTimestamp();
      await db.collection('torneos').doc(editingTorneoId).update(data);
    } else {
      data.adminId=STATE.user.uid;
      data.admins=[STATE.user.uid];
      data.creado=firebase.firestore.FieldValue.serverTimestamp();
      const ref=await db.collection('torneos').add(data);
      STATE.activeTorneoId=ref.id;
    }
    closeModalTorneo();
    goTab('mistorneos');
  }catch(e){
    err.textContent='Error: '+e.message; err.style.display='block';
  }finally{
    btn.disabled=false; btn.textContent='Guardar Torneo';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RANKING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRanking(){
  const el=document.getElementById('tab-ranking');
  const rk=calcRanking();
  const ofic=STATE.jornadas.filter(j=>j.estado==='Oficial');
  const jugadasAll=STATE.jornadas.filter(j=>j.estado!=='Planificada');

  el.innerHTML=`
    <div class="card">
      <div class="card-header"><span class="card-title">Tabla de Posiciones</span><span class="text-11 text-muted">${ofic.length} jornadas oficiales</span></div>
      <div class="rank-head"><span>#</span><span>Jugador</span><span>Ofic.</span><span>Total</span><span>Asist.</span></div>
      ${rk.map(j=>`
        <div class="rank-row ${j.pos<=3?'top':''}">
          <div>${medal(j.pos)}</div>
          <div class="flex items-center gap-8">${j.fotoURL?`<img src="${j.fotoURL}" style="width:32px;height:32px;border-radius:50%;object-fit:cover;flex-shrink:0;border:2px solid ${j.pos===1?'var(--gold)':'var(--border)'}"/>`:avatarHTML(j.foto,j.pos,'sm')}<div><div class="text-13 font-bold">${j.nombre}</div><div class="text-11 text-muted">${j.alias||''}</div></div></div>
          <div class="text-14 font-bold">${j.ptsOf}</div>
          <div style="font-size:15px;font-weight:800;color:${j.pos===1?'var(--gold)':'var(--text)'};">${j.ptsT}</div>
          <div class="text-13 text-muted">${j.asist}âœ“</div>
        </div>`).join('')}
    </div>

    <div class="card">
      <div class="card-header"><span class="card-title">Desglose por Jornada</span></div>
      <div class="card-body overflow-x" style="padding:12px;">
        <table class="breakdown-table">
          <tr>
            <td style="padding:6px 8px;color:var(--muted);font-weight:700;">Jugador</td>
            ${jugadasAll.map(jn=>`<td style="padding:6px 8px;text-align:center;color:var(--muted);font-weight:700;white-space:nowrap;">${jn.sede}<br/>${badgeHTML(jn.estado)}</td>`).join('')}
            <td style="padding:6px 8px;text-align:center;color:var(--green);font-weight:700;">TOTAL</td>
          </tr>
          ${rk.map(j=>`
            <tr>
              <td style="padding:8px;font-weight:600;white-space:nowrap;">${j.nombre}</td>
              ${jugadasAll.map(jn=>{const r=STATE.resultados.find(r=>r.jornada_id===jn.id&&r.jugador_id===j.id);const val=r?(r.asistencia?r.pts:'â€”'):'?';const col=r&&r.pts>=4?'var(--gold)':'var(--text)';return`<td style="padding:8px;text-align:center;color:${r?col:'var(--muted)'};">${val}</td>`;}).join('')}
              <td style="padding:8px;text-align:center;font-weight:800;color:${j.pos===1?'var(--gold)':'var(--text)'};">${j.ptsT}</td>
            </tr>`).join('')}
        </table>
      </div>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JORNADAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Helper: club avatar for jornada list
function clubAvatarHTML(sede){
  const cl=STATE.clubes.find(c=>c.nombre===sede);
  const bg=cl?.color||'#2E7D5E';
  const ini=cl?.iniciales||sede?.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,3)||'â›³';
  if(cl?.fotoURL) return`<img src="${cl.fotoURL}" style="width:42px;height:42px;border-radius:10px;object-fit:cover;flex-shrink:0;border:1px solid var(--border);"/>`;
  return`<div style="width:42px;height:42px;border-radius:10px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:12px;color:#fff;background:${bg};">${ini}</div>`;
}

function renderJornadas(){
  const el=document.getElementById('tab-jornadas');
  const isAdmin=STATE.profile?.role==='admin';
  const jornadasOrdenadas=[...STATE.jornadas].sort((a,b)=>{
    if(!a.fecha)return 1;if(!b.fecha)return -1;
    return new Date(a.fecha)-new Date(b.fecha);
  });

  el.innerHTML=`
    ${isAdmin?`<div style="display:flex;justify-content:flex-end;margin-bottom:16px;">
      <button class="btn-green" onclick="openModalJornada()">+ Nueva Jornada</button>
    </div>`:''}
    ${jornadasOrdenadas.length===0?`<div class="card"><div class="card-body" style="text-align:center;color:var(--muted);padding:40px;">No hay jornadas creadas aÃºn.</div></div>`:''}
    ${jornadasOrdenadas.map(jn=>{
      const res=STATE.resultados.filter(r=>r.jornada_id===jn.id).sort((a,b)=>a.pos-b.pos);
      const isOpen=STATE.expandedJornada===jn.id;
      const cargador=STATE.jugadores.find(j=>j.id===jn.cargado_por);
      const attestador=STATE.jugadores.find(j=>j.id===jn.attest_por);
      const myJugadorId=STATE.profile?.jugador_id;
      const canAttest=jn.estado==='Pendiente Attest'&&jn.cargado_por!==myJugadorId&&STATE.resultados.some(r=>r.jornada_id===jn.id&&r.jugador_id===myJugadorId);

      return`
        <div class="jornada-card">
          <div class="jornada-header" onclick="toggleJornada('${jn.id}')">
            <div class="flex items-center gap-12">
              ${clubAvatarHTML(jn.sede)}
              <div>
                <div class="text-15 font-bold">${jn.sede||'Sin sede'}</div>
                <div class="text-12 text-muted">${fmtFecha(jn.fecha)}${jn.teeTime?' Â· â° '+jn.teeTime:''}${jn.notas?' Â· '+jn.notas:''}</div>
              </div>
            </div>
            <div class="flex items-center gap-8">
              ${badgeHTML(jn.estado)}
              ${isAdmin?`<button class="btn-outline" style="padding:4px 10px;font-size:12px;" onclick="event.stopPropagation();openModalJornada('${jn.id}')">âœï¸</button>`:''}
              <span style="color:var(--muted);font-size:13px;">${isOpen?'â–²':'â–¼'}</span>
            </div>
          </div>
          ${isOpen?`
            <div class="jornada-body">
              <div class="jornada-actions">
                ${(jn.estado==='Planificada'||jn.estado==='En Juego')?`<button class="btn-primary" onclick="goCargar('${jn.id}')">ğŸ“‹ Cargar Resultados</button>`:''}
                ${canAttest?`<button class="btn-attest" onclick="handleAttest('${jn.id}')">âœï¸ Attest (Confirmar)</button>`:''}
                ${isAdmin&&jn.estado==='Por Validar'?`<button class="btn-approve" onclick="handleAprobar('${jn.id}')">âœ… Aprobar Oficial</button>`:''}
                ${jn.estado!=='Planificada'?`<button class="btn-outline" onclick="goCargar('${jn.id}')">âœï¸ Editar resultados</button>`:''}
                ${isAdmin?`<button class="btn-danger" onclick="deleteJornada('${jn.id}')">ğŸ—‘ï¸ Eliminar</button>`:''}
              </div>
              ${res.length>0?`
                ${res.map(r=>{const jug=STATE.jugadores.find(j=>j.id===r.jugador_id);return`
                  <div class="result-row">
                    <span style="font-size:18px;">${medal(r.pos)}</span>
                    ${avatarHTML(jug?.foto||'?',r.pos,'sm')}
                    <div class="flex-1 text-13 font-bold">${jug?.nombre||'Desconocido'}</div>
                    <div class="text-11" style="color:${r.asistencia?'var(--muted)':'var(--red)'};">${r.asistencia?'JugÃ³':'No asistiÃ³'}</div>
                    <div style="font-size:16px;font-weight:800;color:${r.pos===1?'var(--gold)':'var(--text)'};">${r.pts}<span class="text-11 text-muted"> pts</span></div>
                  </div>`;}).join('')}
                <div style="margin-top:10px;padding:8px 12px;background:var(--cardL);border-radius:8px;font-size:11px;color:var(--muted);border:1px solid var(--border);">
                  ${cargador?`ğŸ“‹ Cargado por <strong style="color:var(--text);">${cargador.nombre}</strong>`:''}
                  ${attestador?` Â· âœï¸ Attest: <strong style="color:#7B1FA2;">${attestador.nombre}</strong>`:''}
                </div>
                ${jn.fotos&&jn.fotos.length>0?`
                <div style="margin-top:12px;">
                  <div class="text-11 text-muted font-bold" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;">ğŸ“¸ Fotos del dÃ­a</div>
                  <div style="display:grid;grid-template-columns:repeat(${Math.min(jn.fotos.length,3)},1fr);gap:8px;">
                    ${jn.fotos.map(url=>`<img src="${url}" style="width:100%;aspect-ratio:1;object-fit:cover;border-radius:10px;border:1px solid var(--border);cursor:pointer;" onclick="window.open('${url}','_blank')"/>`).join('')}
                  </div>
                </div>`:''}`
              :`<div style="padding:20px 0;text-align:center;color:var(--muted);font-size:13px;">
                ${jn.estado==='Planificada'?'â³ Pendiente Â· Presiona "Cargar Resultados" al finalizar':'Sin resultados cargados'}
              </div>`}
            </div>`:``}
        </div>`;
    }).join('')}
  `;
}

function toggleJornada(id){ STATE.expandedJornada=STATE.expandedJornada===id?null:id; renderJornadas(); }

async function handleAttest(jornadaId){
  await db.collection('jornadas').doc(jornadaId).update({
    estado:'Por Validar', attest_por:STATE.profile?.jugador_id||STATE.user.uid,
    attest_at:firebase.firestore.FieldValue.serverTimestamp()
  });
}
async function handleAprobar(jornadaId){
  await db.collection('jornadas').doc(jornadaId).update({
    estado:'Oficial', aprobado_por:STATE.user.uid,
    aprobado_at:firebase.firestore.FieldValue.serverTimestamp()
  });
}
async function deleteJornada(id){
  if(!confirm('Â¿Eliminar esta jornada y sus resultados?'))return;
  const batch=db.batch();
  batch.delete(db.collection('jornadas').doc(id));
  STATE.resultados.filter(r=>r.jornada_id===id).forEach(r=>batch.delete(db.collection('resultados').doc(r.id)));
  await batch.commit();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL JORNADA â€” Crear / Editar
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModalJornada(jornadaId=null, torneoId=null){
  STATE.editingJornadaId=jornadaId;
  if(torneoId) STATE._modalTorneoId=torneoId;
  else STATE._modalTorneoId=STATE.activeTorneoId||STATE.torneo?.id||null;
  const modal=document.getElementById('modalJornada');
  const title=document.getElementById('modalJornadaTitle');
  const err=document.getElementById('modalJornadaError');
  err.style.display='none';

  // Populate club select
  const sel=document.getElementById('jornadaClub');
  sel.innerHTML=`<option value="">â€” Selecciona un club â€”</option>`+
    STATE.clubes.map(c=>`<option value="${c.nombre}">${c.nombre}</option>`).join('');

  if(jornadaId){
    title.textContent='Editar Jornada';
    const jn=STATE.jornadas.find(j=>j.id===jornadaId);
    if(jn){
      document.getElementById('jornadaClub').value=jn.sede||'';
      document.getElementById('jornadaFecha').value=jn.fecha||'';
      document.getElementById('jornadaEstado').value=jn.estado||'Planificada';
      document.getElementById('jornadaNotas').value=jn.notas||'';
      document.getElementById('jornadaTeeTime').value=jn.teeTime||'';
    }
  } else {
    title.textContent='Nueva Jornada';
    document.getElementById('jornadaClub').value='';
    document.getElementById('jornadaFecha').value='';
    document.getElementById('jornadaEstado').value='Planificada';
    document.getElementById('jornadaNotas').value='';
    document.getElementById('jornadaTeeTime').value='';
  }
  modal.style.display='flex';
}


function resetJornadaFotoSlot(i){
  const slot=document.getElementById('jornadaFotoSlot'+i);
  if(!slot)return;
  slot.innerHTML=`
    <div class="photo-upload-box" style="height:80px;padding:8px;" onclick="document.getElementById('jornadaFotoInput${i}').click()">
      <div style="font-size:22px;">ğŸ“·</div>
      <div style="font-size:10px;color:var(--muted);">Foto ${i+1}</div>
      <input type="file" id="jornadaFotoInput${i}" accept="image/*" onchange="previewJornadaFoto(this,${i})"/>
    </div>`.replace(/\${i}/g,i).replace(/\${i\+1}/g,i+1);
}

function setJornadaFotoSlot(i,url){
  const slot=document.getElementById('jornadaFotoSlot'+i);
  if(!slot)return;
  slot.innerHTML=`
    <img src="${url}" style="width:100%;height:80px;object-fit:cover;border-radius:8px;border:1px solid var(--border);"/>
    <button class="del-photo" onclick="delJornadaFoto(${i})">âœ•</button>`;
}

function previewJornadaFoto(input,i){
  const file=input.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    const slot=document.getElementById('jornadaFotoSlot'+i);
    if(slot) slot.innerHTML=`
      <img src="${e.target.result}" style="width:100%;height:80px;object-fit:cover;border-radius:8px;border:1px solid var(--border);"/>
      <button class="del-photo" onclick="delJornadaFoto(${i})">âœ•</button>
      <input type="file" id="jornadaFotoInput${i}" accept="image/*" style="display:none;" onchange="previewJornadaFoto(this,${i})"/>`;
  };
  reader.readAsDataURL(file);
}

function delJornadaFoto(i){
  if(STATE._jornadaFotosExistentes) STATE._jornadaFotosExistentes[i]=null;
  resetJornadaFotoSlot(i);
}

function closeModalJornada(event){
  if(event&&event.currentTarget!==event.target)return;
  document.getElementById('modalJornada').style.display='none';
  STATE.editingJornadaId=null;
}

async function saveJornada(){
  const club=document.getElementById('jornadaClub').value.trim();
  const fecha=document.getElementById('jornadaFecha').value;
  const estado=document.getElementById('jornadaEstado').value;
  const notas=document.getElementById('jornadaNotas').value.trim();
  const teeTime=document.getElementById('jornadaTeeTime').value;
  const err=document.getElementById('modalJornadaError');
  const btn=document.getElementById('btnGuardarJornada');
  err.style.display='none';

  if(!club){err.textContent='Selecciona un club.';err.style.display='block';return;}
  if(!fecha){err.textContent='La fecha es obligatoria.';err.style.display='block';return;}

  btn.disabled=true; btn.textContent='Guardando...';
  try{
    // Upload new photos (slots with new files)
    let fotos=[...(STATE._jornadaFotosExistentes||[])];
    for(let i=0;i<3;i++){
      const fi=document.getElementById('jornadaFotoInput'+i);
      if(fi&&fi.files&&fi.files[0]){
        const jid=STATE.editingJornadaId||'new_'+Date.now();
        const compressed=await resizeAndCompress(fi.files[0],1200,0.82);
        const url=await uploadPhoto(compressed,`jornadas/${jid}_foto${i}.jpg`,'jornadaFotoProgress');
        fotos[i]=url;
      }
    }
    fotos=fotos.filter(Boolean);

    if(STATE.editingJornadaId){
      await db.collection('jornadas').doc(STATE.editingJornadaId).update({
        sede:club, fecha, estado, notas, teeTime, fotos,
        updated_at:firebase.firestore.FieldValue.serverTimestamp()
      });
    } else {
      const numero=(STATE.jornadas.length>0?Math.max(...STATE.jornadas.map(j=>j.numero||0)):0)+1;
      await db.collection('jornadas').add({
        numero, nombre:`J${numero}`, sede:club, fecha, estado, notas, teeTime, fotos, torneo_id:STATE._modalTorneoId||STATE.torneo?.id||'',
        torneo_id:STATE.torneo?.id||'',
        creado:firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    document.getElementById('modalJornada').style.display='none';
    STATE.editingJornadaId=null;
  } catch(e){
    err.textContent='Error al guardar: '+e.message; err.style.display='block';
  } finally{ btn.disabled=false; btn.textContent='Guardar Jornada'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLUBES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editingClubId=null;

function renderClubes(){
  const el=document.getElementById('tab-clubes');
  const isAdmin=STATE.profile?.role==='admin';
  el.innerHTML=`
    ${isAdmin?`<div style="display:flex;justify-content:flex-end;margin-bottom:16px;">
      <button class="btn-green" onclick="openModalClub()">+ Agregar Club</button>
    </div>`:''}
    ${STATE.clubes.length===0?`<div class="card"><div class="card-body" style="text-align:center;color:var(--muted);padding:40px;">No hay clubes registrados.</div></div>`:''}
    <div style="display:flex;flex-direction:column;gap:10px;">
      ${STATE.clubes.map(club=>{
        const bg=club.color||'#2E7D5E';
        const ini=club.iniciales||club.nombre.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,3);
        const avatarEl=club.fotoURL
          ?`<img src="${club.fotoURL}" style="width:44px;height:44px;border-radius:10px;object-fit:cover;flex-shrink:0;border:1px solid var(--border);"/>`
          :`<div style="width:44px;height:44px;border-radius:10px;background:${bg};display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:13px;flex-shrink:0;">${ini}</div>`;
        return`
        <div class="card" style="margin-bottom:0;">
          <div style="padding:14px 18px;display:flex;align-items:center;gap:14px;">
            ${avatarEl}
            <div class="flex-1">
              <div class="text-14 font-bold">${club.nombre}</div>
              <div class="text-12 text-muted">${club.ciudad||'â€”'}</div>
            </div>
            ${isAdmin?`
              <button class="btn-outline" style="padding:5px 12px;font-size:12px;" onclick="openModalClub('${club.id}')">âœï¸ Editar</button>
              <button class="btn-danger" onclick="deleteClub('${club.id}','${club.nombre}')">Eliminar</button>
            `:''}
          </div>
        </div>`}).join('')}
    </div>
  `;
}

function openModalClub(clubId=null){
  editingClubId=clubId;
  document.getElementById('modalClubError').style.display='none';
  if(clubId){
    document.getElementById('modalClubTitle').textContent='Editar Club';
    const club=STATE.clubes.find(c=>c.id===clubId);
    if(club){
      document.getElementById('clubNombre').value=club.nombre||'';
      document.getElementById('clubCiudad').value=club.ciudad||'';
      document.getElementById('clubIniciales').value=club.iniciales||'';
      document.getElementById('clubColor').value=club.color||'#2E7D5E';
    }
  } else {
    document.getElementById('modalClubTitle').textContent='Nuevo Club';
    document.getElementById('clubNombre').value='';
    document.getElementById('clubCiudad').value='';
    document.getElementById('clubIniciales').value='';
    document.getElementById('clubColor').value='#2E7D5E';
  }
  document.getElementById('modalClub').style.display='flex';
}

function closeModalClub(){ document.getElementById('modalClub').style.display='none'; editingClubId=null; }

async function saveClub(){
  const nombre=document.getElementById('clubNombre').value.trim();
  const ciudad=document.getElementById('clubCiudad').value.trim();
  const iniciales=document.getElementById('clubIniciales').value.trim().toUpperCase().slice(0,3);
  const color=document.getElementById('clubColor').value;
  const err=document.getElementById('modalClubError');
  const btn=document.getElementById('btnGuardarClub');
  if(!nombre){err.textContent='El nombre es obligatorio.';err.style.display='block';return;}
  btn.disabled=true; btn.textContent='Guardando...';
  try{
    const ini=iniciales||nombre.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,3);
    const data={nombre,ciudad,iniciales:ini,color};
    // Upload photo if selected
    const fileInput=document.getElementById('clubFotoInput');
    if(fileInput.files&&fileInput.files[0]){
      const compressed=await resizeAndCompress(fileInput.files[0],800);
      const path='clubes/'+(editingClubId||Date.now())+'.jpg';
      data.fotoURL=await uploadPhoto(compressed,path,'clubFotoProgress');
    }
    if(editingClubId){
      data.updated_at=firebase.firestore.FieldValue.serverTimestamp();
      await db.collection('clubes').doc(editingClubId).update(data);
    } else {
      data.creado=firebase.firestore.FieldValue.serverTimestamp();
      await db.collection('clubes').add(data);
    }
    closeModalClub();
  }catch(e){err.textContent='Error: '+e.message;err.style.display='block';}
  finally{btn.disabled=false;btn.textContent='Guardar Club';}
}

async function deleteClub(id,nombre){
  if(!confirm(`Â¿Eliminar el club "${nombre}"?`))return;
  await db.collection('clubes').doc(id).delete();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARGAR RESULTADOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cargarEntries=[];

function renderCargar(){
  const el=document.getElementById('tab-cargar');
  const jornadaId=STATE.cargarJornadaId;
  const jornada=STATE.jornadas.find(j=>j.id===jornadaId);
  if(!jornada){el.innerHTML='<p style="color:var(--muted);padding:20px;">Jornada no encontrada.</p>';return;}

  const existentes=STATE.resultados.filter(r=>r.jornada_id===jornadaId);
  if(cargarEntries.length===0||cargarEntries[0]?._jid!==jornadaId){
    cargarEntries=STATE.jugadores.map((j,i)=>{
      const ex=existentes.find(r=>r.jugador_id===j.id);
      return{_jid:jornadaId,jugador_id:j.id,jugador:j,pos:ex?.pos??(i+1),pts:ex?.pts??1,asistencia:ex?.asistencia??true};
    });
  }

  el.innerHTML=`
    <div class="flex items-center gap-8 mb-16">
      <button class="btn-back" onclick="backFromCargar()">â†</button>
      <div>
        <div class="text-15 font-bold font-georgia">${jornada.sede} â€” ${fmtFecha(jornada.fecha)}</div>
        <div class="text-12 text-muted">${badgeHTML(jornada.estado)}</div>
      </div>
    </div>

    <div class="info-attest">âœï¸ <strong>Flujo:</strong> TÃº cargas â†’ otro jugador confirma (Attest) â†’ Admin aprueba como Oficial.</div>

    <div class="card mb-16">
      <div class="card-header"><span class="card-title">Resultados</span><span class="text-11 text-muted">Puntos automÃ¡ticos por posiciÃ³n</span></div>
      ${cargarEntries.map(e=>`
        <div class="cargar-row">
          ${avatarHTML(e.jugador.foto,99,'sm')}
          <div style="flex:1;min-width:100px;">
            <div class="text-13 font-bold">${e.jugador.nombre}</div>
            <div class="text-11 text-muted">${e.jugador.alias||''}</div>
          </div>
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);cursor:pointer;">
            <input type="checkbox" class="form-check" ${e.asistencia?'checked':''} onchange="updateEntry('${e.jugador_id}','asistencia',this.checked)"/>JugÃ³
          </label>
          <div style="display:flex;align-items:center;gap:6px;">
            <span class="text-11 text-muted">Pos.</span>
            <select class="form-select" ${!e.asistencia?'disabled':''} onchange="updateEntry('${e.jugador_id}','pos',parseInt(this.value))">
              ${STATE.jugadores.map((_,pi)=>`<option value="${pi+1}" ${e.pos===pi+1?'selected':''}>${pi+1}Â°</option>`).join('')}
            </select>
          </div>
          <div class="pts-box" style="background:${e.asistencia?(e.pos===1?'var(--goldPale)':'var(--greenPale)'):'var(--bg)'};color:${e.asistencia?(e.pos===1?'var(--gold)':'var(--green)'):'var(--muted)'};">
            ${e.pts}
          </div>
        </div>`).join('')}
    </div>

    <div id="cargarError" class="error-box" style="display:none;"></div>
    <button class="btn-save" id="btnSave" onclick="saveResultados()">ğŸ’¾ Guardar y Enviar a Attest</button>
  `;
}

function updateEntry(jugadorId,field,value){
  const e=cargarEntries.find(e=>e.jugador_id===jugadorId);
  if(!e)return;
  e[field]=value;
  if(field==='pos'||field==='asistencia') e.pts=getPts(field==='pos'?value:e.pos,field==='asistencia'?value:e.asistencia);
  renderCargar();
}

async function saveResultados(){
  const jornadaId=STATE.cargarJornadaId;
  const btn=document.getElementById('btnSave');
  const err=document.getElementById('cargarError');
  err.style.display='none'; btn.disabled=true; btn.textContent='Guardando...';
  try{
    const batch=db.batch();
    cargarEntries.forEach(e=>{
      batch.set(db.collection('resultados').doc(`${jornadaId}_${e.jugador_id}`),{
        jornada_id:jornadaId,jugador_id:e.jugador_id,pos:e.pos,pts:e.pts,asistencia:e.asistencia,
        cargado_por:STATE.profile?.jugador_id||STATE.user?.email,
        updated_at:firebase.firestore.FieldValue.serverTimestamp()
      });
    });
    batch.update(db.collection('jornadas').doc(jornadaId),{
      estado:'Pendiente Attest',cargado_por:STATE.profile?.jugador_id||null,
      cargado_at:firebase.firestore.FieldValue.serverTimestamp()
    });
    await batch.commit();
    cargarEntries=[];
    document.getElementById('tab-cargar').innerHTML=`
      <div class="success-box">
        <div style="font-size:48px;margin-bottom:14px;">âœ…</div>
        <div style="color:var(--green);font-size:18px;font-weight:700;">Â¡Resultados guardados!</div>
        <div style="color:var(--muted);font-size:13px;margin-top:8px;">Pendiente de Attest por otro jugador.</div>
        <button class="btn-primary" style="margin-top:20px;" onclick="backFromCargar()">â† Volver a Jornadas</button>
      </div>`;
  }catch(e){
    err.textContent='Error: '+e.message; err.style.display='block';
    btn.disabled=false; btn.textContent='ğŸ’¾ Guardar y Enviar a Attest';
  }
}
function backFromCargar(){ cargarEntries=[]; goTab('jornadas'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JUGADORES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let showAddJugador=false;
let editingJugadorId=null;

function renderJugadores(){
  const el=document.getElementById('tab-jugadores');
  const isAdmin=STATE.profile?.role==='admin';
  const myJugadorId=STATE.profile?.jugador_id;

  el.innerHTML=`
    ${isAdmin?`
      <button class="btn-green mb-16" onclick="toggleAddJugador()">${showAddJugador?'âœ• Cancelar':'+ Agregar Jugador'}</button>
      ${showAddJugador?`
        <div class="card mb-16">
          <div class="card-header"><span class="card-title">Nuevo Jugador</span></div>
          <div class="card-body" style="display:flex;flex-direction:column;gap:12px;">
            <div><label class="form-label">Nombre Completo *</label><input class="form-input" id="newNombre" placeholder="Ej: Daniel Badell"/></div>
            <div style="display:flex;gap:12px;">
              <div style="flex:1;"><label class="form-label">Alias</label><input class="form-input" id="newAlias" placeholder="Ej: Badell"/></div>
              <div style="width:90px;"><label class="form-label">Iniciales</label><input class="form-input" id="newFoto" placeholder="DB" maxlength="2"/></div>
            </div>
            <div>
              <label class="form-label">TelÃ©fono / WhatsApp</label>
              <div style="display:flex;gap:8px;align-items:center;">
                <select class="form-select" id="newPaisCodigo" style="width:110px;">
                  <option value="+58">ğŸ‡»ğŸ‡ª +58</option>
                  <option value="+1">ğŸ‡ºğŸ‡¸ +1</option>
                  <option value="+34">ğŸ‡ªğŸ‡¸ +34</option>
                  <option value="+52">ğŸ‡²ğŸ‡½ +52</option>
                  <option value="+57">ğŸ‡¨ğŸ‡´ +57</option>
                  <option value="+51">ğŸ‡µğŸ‡ª +51</option>
                  <option value="+54">ğŸ‡¦ğŸ‡· +54</option>
                  <option value="+56">ğŸ‡¨ğŸ‡± +56</option>
                  <option value="+55">ğŸ‡§ğŸ‡· +55</option>
                  <option value="+507">ğŸ‡µğŸ‡¦ +507</option>
                </select>
                <input class="form-input" id="newTelefono" type="tel" placeholder="4141234567" style="flex:1;" oninput="validarTelefonoNew(this)"/>
              </div>
              <div id="newTelefonoHint" style="font-size:11px;color:var(--muted);margin-top:4px;">Opcional Â· Solo nÃºmeros, sin espacios ni guiones</div>
            </div>
            <div id="addJugadorError" class="error-box" style="display:none;"></div>
            <button class="btn-green" onclick="addJugador()">Agregar al Club</button>
          </div>
        </div>`:''}
    `:''}
    <div style="display:flex;flex-direction:column;gap:10px;">
      ${STATE.jugadores.map(j=>{
        const canEdit=isAdmin||(myJugadorId===j.id);
        const rk=calcRanking().find(r=>r.id===j.id);
        return`
        <div class="card" style="margin-bottom:0;">
          <div style="padding:14px 18px;display:flex;align-items:center;gap:14px;">
            ${j.fotoURL
              ?`<img src="${j.fotoURL}" class="foto-perfil-circle" style="width:42px;height:42px;"/>`
              :avatarHTML(j.foto,rk?.pos||99,'lg')}
            <div class="flex-1">
              <div class="text-14 font-bold">${j.nombre}</div>
              <div class="text-12 text-muted">${j.alias||'â€”'}${j.handicap!==undefined?' Â· HCP '+j.handicap:''}</div>
              ${j.telefonoCompleto?`<div class="text-11 text-muted" style="margin-top:2px;">ğŸ“± ${j.telefonoCompleto}</div>`:``}
            </div>
            <div style="text-align:right;min-width:40px;">
              <div style="font-size:18px;font-weight:800;color:${rk?.pos===1?'var(--gold)':'var(--text)'};">${rk?.ptsT||0}</div>
              <div class="text-10 text-muted">pts</div>
            </div>
            ${canEdit?`<button class="btn-outline" style="padding:5px 12px;font-size:12px;" onclick="openModalJugador('${j.id}')">âœï¸</button>`:''}
            ${isAdmin?`<button class="btn-danger" onclick="deleteJugador('${j.id}','${j.nombre}')">Eliminar</button>`:''}
          </div>
        </div>`;}).join('')}
    </div>
  `;
}

function toggleAddJugador(){ showAddJugador=!showAddJugador; renderJugadores(); }

function openModalJugador(jugadorId){
  editingJugadorId=jugadorId;
  document.getElementById('modalJugadorError').style.display='none';
  const j=STATE.jugadores.find(j=>j.id===jugadorId);
  if(j){
    document.getElementById('editNombre').value=j.nombre||'';
    document.getElementById('editAlias').value=j.alias||'';
    document.getElementById('editFoto').value=j.foto||'';
    document.getElementById('editHandicap').value=j.handicap??'';
    if(j.fotoURL){
      document.getElementById('jugadorFotoPreview').src=j.fotoURL;
      document.getElementById('jugadorFotoPreview').style.display='block';
      document.getElementById('jugadorFotoFallback').style.display='none';
    } else {
      document.getElementById('jugadorFotoPreview').style.display='none';
      document.getElementById('jugadorFotoFallback').style.display='flex';
    }
    document.getElementById('jugadorFotoInput').value='';
    const tel=j.telefono||'';
    const codigoPais=j.codigoPais||'+58';
    document.getElementById('editPaisCodigo').value=codigoPais;
    document.getElementById('editTelefono').value=tel;
    document.getElementById('telefonoHint').textContent='Sin el 0 inicial con +58. Ej: 4141234567 (no 04141234567)';
    document.getElementById('telefonoHint').style.color='var(--muted)';
  }
  document.getElementById('modalJugador').style.display='flex';
}

function closeModalJugador(){ document.getElementById('modalJugador').style.display='none'; editingJugadorId=null; }

function validarFormatoTel(num, codigo){
  if(!/^\d{7,15}$/.test(num)) return false;
  if(codigo==='+58'){
    // Accept with leading 0: 0412... (10 digits)
    // OR without leading 0: 412...  (10 digits, international style)
    return /^(04|02)\d{8}$/.test(num) || /^(4|2)\d{9}$/.test(num);
  }
  return num.length>=7&&num.length<=15;
}

function normalizeTelVE(num, codigo){
  // Remove leading 0 for international storage: 04122746658 â†’ 4122746658
  if(codigo==='+58' && /^0(4|2)/.test(num)) return num.slice(1);
  return num;
}

function validarTelefonoNew(input){
  const hint=document.getElementById('newTelefonoHint');
  const codigo=document.getElementById('newPaisCodigo').value;
  const val=input.value.replace(/\D/g,'');
  input.value=val;
  if(!val){hint.textContent='Opcional Â· Solo nÃºmeros, sin espacios ni guiones';hint.style.color='var(--muted)';return;}
  if(validarFormatoTel(val,codigo)){
    hint.textContent='âœ… Formato vÃ¡lido Â· '+codigo+val;
    hint.style.color='var(--green)';
    input.style.borderColor='var(--green)';
  } else {
    const tip=codigo==='+58'?'Sin 0 inicial: 4xxxxxxxxx o 2xxxxxxxxx (10 dÃ­gitos)':'Entre 7 y 15 dÃ­gitos numÃ©ricos';
    hint.textContent='âš ï¸ '+tip;
    hint.style.color='var(--red)';
    input.style.borderColor='var(--red)';
  }
}

function validarTelefono(input){
  const hint=document.getElementById('telefonoHint');
  const codigo=document.getElementById('editPaisCodigo').value;
  const val=input.value.replace(/\D/g,'');
  input.value=val; // strip non-digits live
  if(!val){hint.textContent='Solo nÃºmeros, sin espacios ni guiones. Ej: 4141234567';hint.style.color='var(--muted)';return;}
  if(validarFormatoTel(val,codigo)){
    hint.textContent='âœ… Formato vÃ¡lido Â· '+codigo+val;
    hint.style.color='var(--green)';
    input.style.borderColor='var(--green)';
  } else {
    const tip=codigo==='+58'?'Sin 0 inicial: 4xxxxxxxxx o 2xxxxxxxxx (10 dÃ­gitos)':'Entre 7 y 15 dÃ­gitos numÃ©ricos';
    hint.textContent='âš ï¸ '+tip;
    hint.style.color='var(--red)';
    input.style.borderColor='var(--red)';
  }
}

async function saveJugador(){
  const nombre=document.getElementById('editNombre').value.trim();
  const alias=document.getElementById('editAlias').value.trim();
  const foto=document.getElementById('editFoto').value.trim().toUpperCase().slice(0,2);
  const handicap=document.getElementById('editHandicap').value;
  let telefono=document.getElementById('editTelefono').value.trim().replace(/\D/g,'');
  const codigoPais=document.getElementById('editPaisCodigo').value;
  telefono=normalizeTelVE(telefono,codigoPais);
  const err=document.getElementById('modalJugadorError');
  // Validate phone
  if(telefono&&!validarFormatoTel(telefono,codigoPais)){
    err.textContent='Formato de telÃ©fono invÃ¡lido. Solo nÃºmeros, entre 7 y 15 dÃ­gitos.';
    err.style.display='block';return;
  }
  const btn=document.getElementById('btnGuardarJugador');
  if(!nombre){err.textContent='El nombre es obligatorio.';err.style.display='block';return;}
  btn.disabled=true; btn.textContent='Guardando...';
  try{
    const upd={nombre,alias:alias||nombre.split(' ')[0],foto:foto||nombre.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2),updated_at:firebase.firestore.FieldValue.serverTimestamp()};
    if(handicap!=='')upd.handicap=Number(handicap);
    if(telefono){upd.telefono=telefono;upd.codigoPais=codigoPais;upd.telefonoCompleto=codigoPais+telefono;}
    const fotoFile=document.getElementById('jugadorFotoInput').files[0];
    if(fotoFile){
      const compressed=await resizeAndCompress(fotoFile,400,0.85);
      upd.fotoURL=await uploadPhoto(compressed,'jugadores/'+editingJugadorId+'.jpg');
    }
    await db.collection('jugadores').doc(editingJugadorId).update(upd);
    closeModalJugador();
  }catch(e){err.textContent='Error: '+e.message;err.style.display='block';}
  finally{btn.disabled=false;btn.textContent='Guardar';}
}

async function addJugador(){
  const nombre=document.getElementById('newNombre').value.trim();
  const alias=document.getElementById('newAlias').value.trim();
  const foto=document.getElementById('newFoto').value.trim().toUpperCase().slice(0,2);
  let telefono=document.getElementById('newTelefono').value.trim().replace(/\D/g,'');
  const codigoPais=document.getElementById('newPaisCodigo').value;
  telefono=normalizeTelVE(telefono,codigoPais);
  const err=document.getElementById('addJugadorError');
  if(!nombre){err.textContent='El nombre es obligatorio.';err.style.display='block';return;}
  if(telefono&&!validarFormatoTel(telefono,codigoPais)){
    err.textContent='Formato de telÃ©fono invÃ¡lido.';err.style.display='block';return;
  }
  const initials=foto||nombre.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
  const id=nombre.toLowerCase().replace(/\s+/g,'_')+'_'+Date.now();
  const data={nombre,alias:alias||nombre.split(' ')[0],foto:initials,creado:firebase.firestore.FieldValue.serverTimestamp()};
  if(telefono){data.telefono=telefono;data.codigoPais=codigoPais;data.telefonoCompleto=codigoPais+telefono;}
  await db.collection('jugadores').doc(id).set(data);
  showAddJugador=false;
}

async function deleteJugador(id,nombre){
  if(!confirm(`Â¿Eliminar a ${nombre}?`))return;
  await db.collection('jugadores').doc(id).delete();
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE â€” Subir fotos
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function uploadPhoto(file, path, progressBarId=null){
  return new Promise((resolve,reject)=>{
    const ref=storage.ref(path);
    const task=ref.put(file);
    task.on('state_changed',
      snap=>{
        if(progressBarId){
          const pct=Math.round((snap.bytesTransferred/snap.totalBytes)*100);
          const bar=document.getElementById(progressBarId);
          if(bar){bar.parentElement.style.display='block';bar.style.width=pct+'%';}
        }
      },
      err=>reject(err),
      async ()=>{
        const url=await task.snapshot.ref.getDownloadURL();
        if(progressBarId){
          const bar=document.getElementById(progressBarId);
          if(bar){bar.parentElement.style.display='none';bar.style.width='0%';}
        }
        resolve(url);
      }
    );
  });
}

function resizeAndCompress(file, maxW=800, quality=0.82){
  return new Promise(resolve=>{
    const img=new Image();
    const url=URL.createObjectURL(file);
    img.onload=()=>{
      const ratio=Math.min(1,maxW/img.width);
      const canvas=document.createElement('canvas');
      canvas.width=img.width*ratio; canvas.height=img.height*ratio;
      canvas.getContext('2d').drawImage(img,0,0,canvas.width,canvas.height);
      canvas.toBlob(b=>{ URL.revokeObjectURL(url); resolve(new File([b],file.name,{type:'image/jpeg'})); },'image/jpeg',quality);
    };
    img.src=url;
  });
}

function previewPhoto(input, imgId, fallbackId=null){
  const file=input.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    const img=document.getElementById(imgId);
    if(img){img.src=e.target.result;img.style.display='block';}
    if(fallbackId){const fb=document.getElementById(fallbackId);if(fb)fb.style.display='none';}
  };
  reader.readAsDataURL(file);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTUALIZACIONES AUTOMÃTICAS â€” iOS compatible
// iOS ignora reload(true), usamos navegaciÃ³n con cache-bust
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initUpdateChecker(){
  // Si llegamos con ?bust= en la URL, limpiar y guardar versiÃ³n
  const url=new URL(window.location.href);
  if(url.searchParams.get('bust')){
    localStorage.setItem('golfeados_version', APP_VERSION);
    url.searchParams.delete('bust');
    window.history.replaceState(null,'',url.toString());
  }

  // Si la versiÃ³n guardada no coincide â†’ navegar con cache-bust (recarga real en iOS)
  const stored=localStorage.getItem('golfeados_version');
  if(stored && stored !== APP_VERSION){
    localStorage.setItem('golfeados_version', APP_VERSION);
    doHardReload();
    return;
  }
  localStorage.setItem('golfeados_version', APP_VERSION);

  // Chequeo periÃ³dico: descarga el HTML y compara versiÃ³n
  async function checkForUpdate(){
    try{
      const res=await fetch(window.location.pathname+'?nc='+Date.now(),{
        cache:'no-store',
        headers:{'Cache-Control':'no-cache','Pragma':'no-cache'}
      });
      const text=await res.text();
      const match=text.match(/APP_VERSION\s*=\s*['"]([^'"]+)['"]/);
      if(match && match[1] && match[1] !== APP_VERSION){
        showUpdateBanner(match[1]);
      }
    }catch(e){ /* sin conexiÃ³n, silencioso */ }
  }

  // Chequear 4s despuÃ©s de entrar, luego cada 3 minutos
  setTimeout(checkForUpdate, 4000);
  setInterval(checkForUpdate, 3*60*1000);

  // Chequear al volver de segundo plano (iOS PWA)
  document.addEventListener('visibilitychange',()=>{
    if(document.visibilityState==='visible') setTimeout(checkForUpdate,1500);
  });

  // Chequear al recuperar conexiÃ³n
  window.addEventListener('online', ()=>setTimeout(checkForUpdate,2000));
}

function showUpdateBanner(newVer){
  const banner=document.getElementById('updateBanner');
  const sub=banner.querySelector('div div:last-child');
  if(sub) sub.textContent='VersiÃ³n '+newVer+' disponible â€” toca para instalar';
  banner.style.display='flex';
}

function doHardReload(){
  // iOS-compatible: navegar a la misma URL con parÃ¡metro nuevo (bypassa cachÃ©)
  const url=new URL(window.location.href);
  url.searchParams.set('bust', Date.now());
  window.location.replace(url.toString());
}

function forceUpdate(){
  // Limpiar cachÃ© del navegador si estÃ¡ disponible
  if('caches' in window){
    caches.keys().then(names=>{
      names.forEach(n=>caches.delete(n));
      // DespuÃ©s de limpiar, navegar
      setTimeout(doHardReload, 300);
    });
  } else {
    doHardReload();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function seedDatos(){
  const msg=document.getElementById('seedMsg');
  msg.style.display='block'; msg.textContent='â³ Cargando datos iniciales...';
  try{
    const batch=db.batch();
    batch.set(db.collection('torneos').doc('apertura2026'),{nombre:'Torneo Apertura 2026',estado:'Activo',jornadas_total:8,temporada:'2026',creado:firebase.firestore.FieldValue.serverTimestamp()});
    [
      {id:'badell',nombre:'Daniel Badell',alias:'Badell',foto:'DB'},
      {id:'jimeno',nombre:'Javi Jimeno',alias:'Jimeno',foto:'JJ'},
      {id:'padron',nombre:'Loor PadrÃ³n',alias:'Loor',foto:'LP'},
      {id:'kolman',nombre:'Juan Kolman',alias:'Kolman',foto:'JK'},
      {id:'aguiar',nombre:'JesÃºs Aguiar',alias:'J. Aguiar',foto:'JA'},
      {id:'soto',nombre:'Mauricio Soto',alias:'Soto',foto:'MS'},
      {id:'aguiar_r',nombre:'JesÃºs Aguiar Romero',alias:'Aguiar R.',foto:'JR'},
    ].forEach(j=>{const{id,...d}=j;batch.set(db.collection('jugadores').doc(id),{...d,creado:firebase.firestore.FieldValue.serverTimestamp()});});
    await batch.commit();
    const clubesSeed=[
      {nombre:'Izcaragua Country Club',ciudad:'Caracas'},
      {nombre:'Junko Golf Club',ciudad:'Caracas'},
      {nombre:'Lagunita Country Club',ciudad:'Caracas'},
      {nombre:'Valle Arriba Golf Club',ciudad:'Caracas'},
      {nombre:'Guataparo Country Club',ciudad:'Valencia'},
    ];
    for(const c of clubesSeed){
      await db.collection('clubes').add({...c,creado:firebase.firestore.FieldValue.serverTimestamp()});
    }
    msg.textContent='âœ… Â¡Datos cargados! Jugadores, jornadas y clubes creados.';
  }catch(e){ msg.style.color='var(--red)'; msg.textContent='âŒ Error: '+e.message; }
}
</script>
</body>
</html>
