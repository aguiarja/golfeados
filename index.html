
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<meta name="theme-color" content="#2E7D5E"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<meta name="description" content="Golfeados Golf Club - Tournament Manager"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="default"/>
<meta name="apple-mobile-web-app-title" content="Golfeados"/>
<link rel="manifest" href="manifest.json"/>
<link rel="apple-touch-icon" href="Logo_Golfeados.png"/>
<title>Golfeados Â· Golf Club</title>

<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-storage-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#F0F4F2;
  --bg2:#E8EEEB;
  --card:#FFFFFF;
  --cardL:#F5F9F7;
  --border:#D0DDD8;
  --border2:#B8CEC7;
  --green:#2E7D5E;
  --greenL:#3DA07A;
  --greenPale:#E8F5F0;
  --blue:#1A6B8A;
  --blueL:#2589AD;
  --bluePale:#E3F2F8;
  --teal:#0D7377;
  --text:#1A2E27;
  --text2:#3D5A50;
  --muted:#7A9A8E;
  --white:#FFFFFF;
  --red:#D32F2F;
  --redPale:#FFEBEE;
  --gold:#C49A00;
  --goldPale:#FFF8E1;
  --shadow:0 1px 6px rgba(46,125,94,0.08);
  --shadow-md:0 4px 16px rgba(46,125,94,0.12);
}
html,body{background:var(--bg);color:var(--text);font-family:'Trebuchet MS',sans-serif;min-height:100dvh;}
button{cursor:pointer;font-family:inherit;}
input,select,textarea{font-family:inherit;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

/* â”€â”€ LOADING â”€â”€ */
#loading{position:fixed;inset:0;background:var(--white);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:14px;z-index:999;}
.spin{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--green);border-radius:50%;animation:spin 0.8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* â”€â”€ LOGIN â”€â”€ */
#loginScreen{min-height:100dvh;display:flex;align-items:center;justify-content:center;padding:24px;
  background:linear-gradient(160deg,#E8F5F0 0%,#E3F2F8 50%,#F0F4F2 100%);}
.login-card{width:100%;max-width:380px;background:var(--white);border-radius:20px;border:1px solid var(--border);padding:40px 32px;box-shadow:var(--shadow-md);}
.login-logo{text-align:center;margin-bottom:28px;}
.login-logo img{width:90px;height:90px;object-fit:contain;}
.login-title{font-size:22px;font-weight:800;color:var(--green);font-family:Georgia,serif;letter-spacing:1px;margin-top:10px;}
.login-sub{font-size:11px;color:var(--muted);letter-spacing:3px;text-transform:uppercase;margin-top:3px;}
.field{margin-bottom:16px;}
.field label{font-size:11px;color:var(--text2);font-weight:700;letter-spacing:1px;text-transform:uppercase;display:block;margin-bottom:6px;}
.field input{width:100%;padding:11px 14px;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;color:var(--text);font-size:15px;outline:none;transition:border-color 0.2s;}
.field input:focus{border-color:var(--green);background:var(--white);}
.btn-login{width:100%;padding:13px;border-radius:10px;border:none;background:var(--green);color:#fff;font-weight:700;font-size:16px;font-family:Georgia,serif;letter-spacing:1px;box-shadow:0 4px 14px rgba(46,125,94,0.3);transition:opacity 0.2s;margin-top:4px;}
.btn-google{width:100%;padding:12px;border-radius:10px;border:2px solid #e0e0e0;background:#fff;color:#3c4043;font-weight:600;font-size:15px;font-family:Georgia,serif;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;margin-top:10px;box-shadow:0 1px 4px rgba(0,0,0,0.1);}
.btn-google:hover{background:#f8f8f8;border-color:#dadce0;}
.btn-google:active{background:#f0f0f0;}
.login-or{display:flex;align-items:center;gap:10px;margin:14px 0;color:var(--muted);font-size:12px;}
.login-or::before,.login-or::after{content:'';flex:1;height:1px;background:var(--border);}
.btn-login:disabled{opacity:0.6;cursor:not-allowed;}
.btn-link{background:none;border:none;color:var(--muted);font-size:13px;text-align:center;display:block;width:100%;margin-top:14px;}
.error-box{background:var(--redPale);border:1px solid #FFCDD2;border-radius:8px;padding:10px 14px;color:var(--red);font-size:13px;margin-bottom:12px;}
.login-footer{position:fixed;bottom:20px;left:0;right:0;text-align:center;color:var(--muted);font-size:11px;letter-spacing:2px;}

/* â”€â”€ HEADER â”€â”€ */
#header{background:var(--white);border-bottom:1px solid var(--border);padding:0 20px;display:flex;align-items:center;justify-content:space-between;height:56px;position:sticky;top:0;z-index:100;box-shadow:var(--shadow);}
.header-logo{display:flex;align-items:center;gap:10px;}
.header-logo img{width:38px;height:38px;object-fit:contain;}
.header-title{font-size:15px;font-weight:800;color:var(--green);font-family:Georgia,serif;letter-spacing:1px;}
.header-sub{font-size:9px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;}
.header-right{display:flex;align-items:center;gap:10px;}
.badge-admin{font-size:10px;color:var(--white);font-weight:700;letter-spacing:1px;background:var(--green);padding:3px 8px;border-radius:10px;}
.header-user{font-size:11px;color:var(--muted);max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.btn-logout{background:none;border:1px solid var(--border);border-radius:6px;color:var(--muted);padding:5px 10px;font-size:11px;}

/* â”€â”€ NAV â”€â”€ */
#nav{background:var(--white);border-bottom:1px solid var(--border);display:flex;padding:0 12px;overflow-x:auto;position:sticky;top:56px;z-index:99;}
#nav::-webkit-scrollbar{height:0;}
.nav-btn{padding:11px 14px;background:transparent;border:none;border-bottom:2px solid transparent;color:var(--muted);font-weight:400;font-size:13px;display:flex;align-items:center;gap:5px;white-space:nowrap;transition:all 0.15s;}
.nav-btn.active{border-bottom-color:var(--green);color:var(--green);font-weight:700;}

/* â”€â”€ CONTENT â”€â”€ */
#content{padding:20px;max-width:900px;margin:0 auto;padding-bottom:40px;}

/* â”€â”€ CARDS â”€â”€ */
.card{background:var(--white);border-radius:14px;border:1px solid var(--border);overflow:hidden;margin-bottom:16px;box-shadow:var(--shadow);}
.card-header{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:var(--cardL);}
.card-title{font-size:12px;font-weight:700;color:var(--green);letter-spacing:1px;text-transform:uppercase;}
.card-body{padding:20px;}

/* â”€â”€ HERO â”€â”€ */
.hero{background:linear-gradient(135deg,var(--green) 0%,var(--teal) 60%,var(--blue) 100%);border-radius:16px;padding:24px 28px;border:none;position:relative;overflow:hidden;margin-bottom:16px;box-shadow:var(--shadow-md);}
.hero::after{content:'';position:absolute;top:-40px;right:-40px;width:220px;height:220px;border-radius:50%;background:rgba(255,255,255,0.06);}
.hero-label{font-size:11px;color:rgba(255,255,255,0.75);font-weight:600;letter-spacing:2px;text-transform:uppercase;margin-bottom:6px;}
.hero-title{font-size:22px;font-weight:700;color:#fff;font-family:Georgia,serif;}
.hero-stats{display:flex;gap:24px;margin-top:16px;flex-wrap:wrap;}
.hero-stat label{font-size:10px;color:rgba(255,255,255,0.65);letter-spacing:1px;text-transform:uppercase;display:block;}
.hero-stat span{font-size:15px;font-weight:600;color:#fff;margin-top:2px;display:block;}

/* â”€â”€ AVATAR â”€â”€ */
.avatar{border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-family:Georgia,serif;flex-shrink:0;color:#fff;}

/* â”€â”€ BADGES â”€â”€ */
.badge{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;}
.badge::before{content:'';width:6px;height:6px;border-radius:50%;background:currentColor;flex-shrink:0;}
.badge-oficial{background:#E8F5E9;color:#2E7D32;}
.badge-validar{background:#FFF8E1;color:#F57F17;}
.badge-attest{background:#EDE7F6;color:#5E35B1;}
.badge-planificada{background:#E3F2FD;color:#1565C0;}
.badge-enjuego{background:#FBE9E7;color:#BF360C;}
.badge-activo{background:#E8F5E9;color:#2E7D32;}

/* â”€â”€ RANKING â”€â”€ */
.rank-row{display:grid;grid-template-columns:40px 1fr 50px 55px 50px;gap:8px;padding:12px 16px;border-bottom:1px solid var(--border);align-items:center;}
.rank-row.top{background:var(--greenPale);}
.rank-head{display:grid;grid-template-columns:40px 1fr 50px 55px 50px;gap:8px;padding:8px 16px;border-bottom:1px solid var(--border);background:var(--cardL);}
.rank-head span{font-size:10px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:1px;}

/* â”€â”€ JORNADA CARD â”€â”€ */
.partida-card{background:var(--white);border-radius:12px;border:1px solid var(--border);overflow:hidden;margin-bottom:10px;box-shadow:var(--shadow);}
.partida-header{padding:14px 18px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;user-select:none;transition:background 0.15s;}
.partida-header:hover{background:var(--cardL);}
.partida-body{padding:0 18px 18px;border-top:1px solid var(--border);}
.partida-actions{display:flex;gap:8px;padding:12px 0;flex-wrap:wrap;}

/* â”€â”€ RESULT ROW â”€â”€ */
.result-row{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:10px;background:var(--cardL);margin-bottom:6px;border:1px solid var(--border);}

/* â”€â”€ FORM â”€â”€ */
.form-label{font-size:11px;color:var(--text2);font-weight:700;letter-spacing:1px;text-transform:uppercase;display:block;margin-bottom:6px;}
.form-input{width:100%;padding:10px 14px;background:var(--bg);border:1.5px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;outline:none;transition:border-color 0.2s;}
.form-input:focus{border-color:var(--green);background:var(--white);}
.form-select{padding:8px 12px;background:var(--bg);border:1.5px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;outline:none;transition:border-color 0.2s;}
.form-select:focus{border-color:var(--green);}
.form-check{accent-color:var(--green);width:16px;height:16px;}

/* â”€â”€ BUTTONS â”€â”€ */
.btn-green{padding:9px 18px;border-radius:8px;border:none;background:var(--green);color:#fff;font-weight:700;font-size:13px;box-shadow:0 2px 8px rgba(46,125,94,0.25);}
.btn-blue{padding:9px 18px;border-radius:8px;border:none;background:var(--blue);color:#fff;font-weight:700;font-size:13px;}
.btn-teal{padding:9px 18px;border-radius:8px;border:none;background:var(--teal);color:#fff;font-weight:700;font-size:13px;}
.btn-attest{padding:8px 18px;border-radius:8px;border:1px solid #9C27B0;background:#F3E5F5;color:#7B1FA2;font-weight:700;font-size:13px;}
.btn-approve{padding:8px 18px;border-radius:8px;border:none;background:#E8F5E9;color:#2E7D32;font-weight:700;font-size:13px;border:1px solid #A5D6A7;}
.btn-outline{padding:8px 18px;border-radius:8px;border:1px solid var(--border2);background:var(--white);color:var(--text2);font-weight:600;font-size:13px;}
.btn-danger{padding:6px 10px;border-radius:8px;border:1px solid #FFCDD2;background:var(--redPale);color:var(--red);font-size:12px;font-weight:600;}
.btn-save{width:100%;padding:14px;border-radius:12px;border:none;background:var(--green);color:#fff;font-weight:800;font-size:16px;font-family:Georgia,serif;letter-spacing:1px;box-shadow:0 4px 14px rgba(46,125,94,0.3);margin-top:8px;}
.btn-back{background:none;border:none;color:var(--muted);font-size:22px;padding:0 8px 0 0;}
/* keep btn-primary as alias */
.btn-primary{padding:9px 18px;border-radius:8px;border:none;background:var(--green);color:#fff;font-weight:700;font-size:13px;box-shadow:0 2px 8px rgba(46,125,94,0.2);}

/* â”€â”€ CARGAR â”€â”€ */
.cargar-row{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
.pts-box{width:50px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:18px;border:1.5px solid var(--border);}

/* â”€â”€ INFO / SUCCESS â”€â”€ */
.info-attest{background:var(--bluePale);border:1px solid #B3D9E8;border-radius:10px;padding:12px 16px;font-size:12px;color:var(--blue);margin-bottom:16px;}
.success-box{background:var(--greenPale);border:1px solid #A5D6A7;border-radius:14px;padding:32px;text-align:center;}

/* â”€â”€ TABLE â”€â”€ */
.breakdown-table{width:100%;border-collapse:collapse;font-size:12px;}
.breakdown-table td{padding:8px;border-top:1px solid var(--border);}

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:200;display:flex;align-items:flex-end;justify-content:center;padding:0;}@media(min-width:520px){.modal-overlay{align-items:center;padding:20px;}}
.modal-box{background:var(--white);border-radius:20px 20px 0 0;width:100%;max-width:500px;box-shadow:0 -4px 30px rgba(0,0,0,0.2);overflow:hidden;max-height:92vh;overflow-y:auto;}@media(min-width:520px){.modal-box{border-radius:16px;max-height:88vh;}}
.modal-header{padding:18px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:var(--cardL);}
.modal-title{font-size:15px;font-weight:700;color:var(--green);}
.modal-body{padding:24px;}
.modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end;}

/* â”€â”€ UTILS â”€â”€ */
.flex{display:flex;}.flex-1{flex:1;}.gap-8{gap:8px;}.gap-12{gap:12px;}.gap-16{gap:16px;}
.items-center{align-items:center;}.justify-between{justify-content:space-between;}
.text-green{color:var(--green);}.text-muted{color:var(--muted);}.text-dark{color:var(--text);}
.font-bold{font-weight:700;}.font-georgia{font-family:Georgia,serif;}
.text-11{font-size:11px;}.text-12{font-size:12px;}.text-13{font-size:13px;}.text-14{font-size:14px;}.text-15{font-size:15px;}
.mb-8{margin-bottom:8px;}.mb-12{margin-bottom:12px;}.mb-16{margin-bottom:16px;}
.mt-8{margin-top:8px;}.mt-12{margin-top:12px;}.mt-16{margin-top:16px;}
.overflow-x{overflow-x:auto;}
.section-gap{margin-bottom:20px;}
/* â”€â”€ FOTOS â”€â”€ */
.photo-upload-box{border:2px dashed var(--border2);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all 0.2s;background:var(--cardL);}
.photo-upload-box:hover{border-color:var(--green);background:var(--greenPale);}
.photo-upload-box input[type=file]{display:none;}
.photo-preview{width:100%;height:140px;object-fit:cover;border-radius:10px;border:1px solid var(--border);}
.photo-preview-sm{width:60px;height:60px;object-fit:cover;border-radius:8px;border:1px solid var(--border);}
.photo-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px;}
.photo-grid-item{position:relative;aspect-ratio:1;}
.photo-grid-item img{width:100%;height:100%;object-fit:cover;border-radius:8px;border:1px solid var(--border);}
.photo-grid-item .del-photo{position:absolute;top:3px;right:3px;background:rgba(0,0,0,0.6);color:#fff;border:none;border-radius:50%;width:20px;height:20px;font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.upload-progress{height:4px;background:var(--border);border-radius:2px;margin-top:8px;overflow:hidden;display:none;}
.upload-progress-bar{height:100%;background:var(--green);width:0%;transition:width 0.3s;border-radius:2px;}
.foto-perfil-circle{width:64px;height:64px;border-radius:50%;object-fit:cover;border:2px solid var(--border);flex-shrink:0;}


/* â”€â”€ AUTH EXTRA â”€â”€ */
.login-divider{display:flex;align-items:center;gap:10px;margin:14px 0;}
.login-divider::before,.login-divider::after{content:'';flex:1;height:1px;background:var(--border);}
.login-divider span{font-size:11px;color:var(--muted);white-space:nowrap;}
.verify-option{border:1.5px solid var(--border);border-radius:12px;padding:16px;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:14px;}
.verify-option:hover,.verify-option.selected{border-color:var(--green);background:var(--greenPale);}
.verify-option-icon{font-size:28px;flex-shrink:0;}
.otp-inputs{display:flex;gap:10px;justify-content:center;margin:20px 0;}
.otp-input{width:46px;height:56px;border:2px solid var(--border);border-radius:10px;text-align:center;font-size:24px;font-weight:700;color:var(--text);background:var(--bg);outline:none;transition:border-color 0.2s;}
.otp-input:focus{border-color:var(--green);}
.strength-bar{height:4px;border-radius:2px;transition:all 0.3s;margin-top:6px;}
.input-icon-wrap{position:relative;}
.input-icon-wrap input{padding-right:40px;}
.input-icon-wrap .toggle-pass{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px;}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading">
  <div class="spin"></div>
  <div style="font-size:12px;color:var(--muted);letter-spacing:2px;">CARGANDO...</div>
</div>

<!-- LOGIN SCREEN â€” multiple views -->
<div id="loginScreen" style="display:none;">
  <div class="login-card" style="max-width:400px;">

    <!-- LOGO (shared) -->
    <div class="login-logo">
      <img src="Logo_Golfeados.png" alt="Golfeados"/>
      <div class="login-title">GOLFEADOS</div>
      <div class="login-sub">Golf Club Â· Tournament Manager</div>
    </div>

    <!-- â‘  LOGIN -->
    <div id="loginView">
      <div id="loginError" class="error-box" style="display:none;"></div>
      <div class="field">
        <label>Email, usuario o telÃ©fono</label>
        <input type="text" id="loginIdentifier" placeholder="email / @usuario / +58414..." autocomplete="username"
          oninput="updateLoginHint(this)"/>
        <div id="loginHint" style="font-size:11px;color:var(--muted);margin-top:4px;"></div>
      </div>
      <div class="field">
        <label>ContraseÃ±a</label>
        <div class="input-icon-wrap">
          <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"/>
          <button class="toggle-pass" type="button" onclick="togglePass('loginPassword',this)">ğŸ‘</button>
        </div>
      </div>
      <button class="btn-login" id="loginBtn" onclick="handleLogin()">Entrar al Club</button>
      <div class="login-or">o</div>
      <button class="btn-google" onclick="handleGoogleSignIn()">
        <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.08 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.35-8.16 2.35-6.26 0-11.57-3.59-13.46-8.83l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
        Continuar con Google
      </button>
      <div class="login-divider"><span>Â¿No tienes cuenta?</span></div>
      <button class="btn-login" style="background:transparent;border:2px solid var(--green);color:var(--green);box-shadow:none;" onclick="showRegister()">Crear cuenta</button>
      <button class="btn-link" onclick="showReset()">Â¿Olvidaste tu contraseÃ±a?</button>
    </div>

    <!-- â‘¡ REGISTRO -->
    <div id="registerView" style="display:none;">
      <div style="font-size:15px;font-weight:700;color:var(--green);margin-bottom:16px;">Crear cuenta</div>
      <div id="registerError" class="error-box" style="display:none;"></div>
      <div class="field">
        <label>Nombre completo *</label>
        <input type="text" id="regNombre" placeholder="Ej: Daniel Badell"/>
      </div>
      <div class="field">
        <label>Nombre de usuario *</label>
        <div class="input-icon-wrap">
          <input type="text" id="regUsername" placeholder="@badell" oninput="formatUsername(this)"/>
        </div>
        <div id="usernameHint" style="font-size:11px;color:var(--muted);margin-top:4px;">Solo letras, nÃºmeros y guiÃ³n bajo</div>
      </div>
      <div class="field">
        <label>Email *</label>
        <input type="email" id="regEmail" placeholder="tu@email.com" autocomplete="email"/>
      </div>
      <div class="field">
        <label>TelÃ©fono (opcional pero recomendado)</label>
        <div style="display:flex;gap:8px;">
          <select class="form-select" id="regPaisCodigo" style="width:110px;">
            <option value="+58">ğŸ‡»ğŸ‡ª +58</option>
            <option value="+1">ğŸ‡ºğŸ‡¸ +1</option>
            <option value="+34">ğŸ‡ªğŸ‡¸ +34</option>
            <option value="+52">ğŸ‡²ğŸ‡½ +52</option>
            <option value="+57">ğŸ‡¨ğŸ‡´ +57</option>
            <option value="+51">ğŸ‡µğŸ‡ª +51</option>
            <option value="+54">ğŸ‡¦ğŸ‡· +54</option>
            <option value="+56">ğŸ‡¨ğŸ‡± +56</option>
            <option value="+55">ğŸ‡§ğŸ‡· +55</option>
          </select>
          <input class="form-input" id="regTelefono" type="tel" placeholder="4141234567" style="flex:1;"
            oninput="this.value=this.value.replace(/[^0-9]/g,'')"/>
        </div>
      </div>
      <div class="field">
        <label>ContraseÃ±a *</label>
        <div class="input-icon-wrap">
          <input type="password" id="regPassword" placeholder="MÃ­n. 6 caracteres" oninput="checkStrength(this)"/>
          <button class="toggle-pass" type="button" onclick="togglePass('regPassword',this)">ğŸ‘</button>
        </div>
        <div class="strength-bar" id="strengthBar" style="background:var(--border);width:0%;"></div>
        <div id="strengthLabel" style="font-size:11px;color:var(--muted);margin-top:4px;"></div>
      </div>
      <button class="btn-login" id="regBtn" onclick="handleRegister()">Continuar â†’</button>
      <div class="login-or">o regÃ­strate con</div>
      <button class="btn-google" onclick="handleGoogleSignIn()">
        <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.08 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.35-8.16 2.35-6.26 0-11.57-3.59-13.46-8.83l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
        Continuar con Google
      </button>
      <button class="btn-link" onclick="showLogin()">â† Ya tengo cuenta</button>
    </div>

    <!-- â‘¢ ELEGIR VERIFICACIÃ“N -->
    <div id="verifyChoiceView" style="display:none;">
      <div style="font-size:15px;font-weight:700;color:var(--green);margin-bottom:6px;">Verificar tu cuenta</div>
      <div style="font-size:13px;color:var(--muted);margin-bottom:20px;">Verifica al menos uno para activar tu cuenta.</div>
      <div id="verifyChoiceError" class="error-box" style="display:none;"></div>
      <div class="verify-option mb-12" id="optEmail" onclick="chooseVerify('email')">
        <div class="verify-option-icon">ğŸ“§</div>
        <div>
          <div style="font-weight:700;font-size:14px;">Verificar por Email</div>
          <div id="verifyEmailAddr" style="font-size:12px;color:var(--muted);">Gratis e instantÃ¡neo</div>
        </div>
      </div>
      <div class="verify-option" id="optSMS" onclick="chooseVerify('sms')">
        <div class="verify-option-icon">ğŸ“±</div>
        <div>
          <div style="font-weight:700;font-size:14px;">Verificar por SMS</div>
          <div id="verifyPhoneNum" style="font-size:12px;color:var(--muted);">RecibirÃ¡s un cÃ³digo de 6 dÃ­gitos</div>
        </div>
      </div>
      <div id="recaptcha-container" style="margin-top:12px;"></div>
      <button class="btn-login" style="margin-top:16px;" id="btnSendVerify" onclick="sendVerification()">Enviar cÃ³digo</button>
      <button class="btn-link" onclick="skipVerify()">Verificar mÃ¡s tarde</button>
    </div>

    <!-- â‘£ CÃ“DIGO SMS -->
    <div id="smsCodeView" style="display:none;">
      <div style="text-align:center;margin-bottom:20px;">
        <div style="font-size:36px;margin-bottom:10px;">ğŸ“±</div>
        <div style="font-size:15px;font-weight:700;color:var(--green);">CÃ³digo enviado</div>
        <div id="smsSentTo" style="font-size:13px;color:var(--muted);margin-top:4px;"></div>
      </div>
      <div id="smsError" class="error-box" style="display:none;"></div>
      <div class="otp-inputs">
        <input class="otp-input" id="otp0" maxlength="1" oninput="otpNext(this,0)" onkeydown="otpBack(event,0)"/>
        <input class="otp-input" id="otp1" maxlength="1" oninput="otpNext(this,1)" onkeydown="otpBack(event,1)"/>
        <input class="otp-input" id="otp2" maxlength="1" oninput="otpNext(this,2)" onkeydown="otpBack(event,2)"/>
        <input class="otp-input" id="otp3" maxlength="1" oninput="otpNext(this,3)" onkeydown="otpBack(event,3)"/>
        <input class="otp-input" id="otp4" maxlength="1" oninput="otpNext(this,4)" onkeydown="otpBack(event,4)"/>
        <input class="otp-input" id="otp5" maxlength="1" oninput="otpNext(this,5)" onkeydown="otpBack(event,5)"/>
      </div>
      <button class="btn-login" id="btnConfirmSMS" onclick="confirmSMS()">Confirmar cÃ³digo</button>
      <button class="btn-link" onclick="showVerifyChoice()">â† Cambiar mÃ©todo</button>
      <button class="btn-link" id="btnResendSMS" onclick="resendSMS()" style="display:none;">Reenviar cÃ³digo</button>
    </div>

    <!-- â‘¤ EMAIL ENVIADO -->
    <div id="emailSentView" style="display:none;">
      <div style="text-align:center;padding:10px 0 20px;">
        <div style="font-size:48px;margin-bottom:12px;">ğŸ“§</div>
        <div style="font-size:16px;font-weight:700;color:var(--green);">Â¡Revisa tu email!</div>
        <div id="emailSentAddr" style="font-size:13px;color:var(--muted);margin-top:6px;line-height:1.5;"></div>
      </div>
      <button class="btn-login" onclick="recheckEmail()">Ya verifiquÃ© mi email âœ“</button>
      <button class="btn-link" onclick="resendEmail()">Reenviar email</button>
      <button class="btn-link" onclick="skipVerify()">Verificar mÃ¡s tarde</button>
    </div>

    <!-- â‘¥ VERIFICACIÃ“N PENDIENTE (usuario ya registrado pero no verificÃ³) -->
    <!-- VINCULAR CUENTA CON CÃ“DIGO DE INVITACIÃ“N -->
    <div id="vincularView" style="display:none;">
      <div style="text-align:center;padding:10px 0 20px;">
        <div style="font-size:48px;margin-bottom:12px;">â›³</div>
        <div style="font-size:16px;font-weight:700;color:var(--green);margin-bottom:8px;">Â¡Bienvenido al club!</div>
        <div style="font-size:13px;color:var(--muted);line-height:1.5;">Si el administrador ya cargÃ³ tu perfil de jugador,<br/>ingresa tu cÃ³digo de invitaciÃ³n para vincularte.</div>
      </div>
      <div id="vincularError" class="error-box" style="display:none;margin-bottom:12px;"></div>
      <div class="field">
        <label>CÃ³digo de invitaciÃ³n</label>
        <input type="text" id="vincularCodigo" placeholder="GOLF-XXXX" 
          style="text-transform:uppercase;letter-spacing:2px;font-size:18px;text-align:center;font-weight:700;"
          oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9-]/g,'')"/>
      </div>
      <button class="btn-login" id="vincularBtn" onclick="handleVincular()">Vincular mi perfil ğŸŒï¸</button>
      <button class="btn-link" style="margin-top:10px;" onclick="skipVincular()">Saltar por ahora â†’</button>
    </div>

    <div id="pendingVerifyView" style="display:none;">
      <div style="text-align:center;padding:10px 0 20px;">
        <div style="font-size:48px;margin-bottom:12px;">âš ï¸</div>
        <div style="font-size:15px;font-weight:700;color:var(--gold);">Cuenta pendiente de verificaciÃ³n</div>
        <div style="font-size:13px;color:var(--muted);margin-top:8px;line-height:1.5;">Debes verificar tu email o telÃ©fono para acceder.</div>
      </div>
      <button class="btn-login" onclick="showVerifyChoice()">Verificar ahora</button>
      <button class="btn-link" onclick="handleLogout()">Cerrar sesiÃ³n</button>
    </div>

    <!-- â‘¦ RESET PASSWORD -->
    <div id="resetView" style="display:none;">
      <div style="font-size:13px;color:var(--muted);margin-bottom:14px;">Ingresa tu email para recibir un enlace de recuperaciÃ³n.</div>
      <div id="resetError" class="error-box" style="display:none;"></div>
      <div id="resetSuccess" style="display:none;text-align:center;padding:20px 0;">
        <div style="font-size:40px;margin-bottom:10px;">ğŸ“§</div>
        <div style="color:var(--text);font-size:14px;">Email de recuperaciÃ³n enviado.</div>
      </div>
      <div id="resetForm">
        <div class="field"><label>Email</label><input type="email" id="resetEmail" placeholder="tu@email.com"/></div>
        <button class="btn-login" onclick="handleReset()">Enviar Email</button>
      </div>
      <button class="btn-link" onclick="showLogin()">â† Volver al login</button>
    </div>

  </div>
  <div class="login-footer">PLAY Â· RELAX Â· ENJOY Â· SINCE 2024</div>
</div>

<!-- BANNER ACTUALIZACIÃ“N -->
<div id="updateBanner" style="display:none;position:fixed;bottom:0;left:0;right:0;z-index:500;
  background:linear-gradient(135deg,var(--green),var(--teal));
  padding:14px 20px;display:flex;align-items:center;justify-content:space-between;
  box-shadow:0 -4px 20px rgba(0,0,0,0.2);gap:12px;">
  <div>
    <div style="color:#fff;font-weight:700;font-size:14px;">ğŸ”„ Nueva versiÃ³n disponible</div>
    <div style="color:rgba(255,255,255,0.8);font-size:12px;margin-top:2px;" id="updateBannerSub">Nueva versiÃ³n disponible</div>
  </div>
  <button onclick="forceUpdate()" style="background:#fff;color:var(--green);border:none;border-radius:8px;
    padding:10px 18px;font-weight:800;font-size:13px;white-space:nowrap;cursor:pointer;">
    Actualizar
  </button>
</div>

<!-- APP -->
<div id="app" style="display:none;">
  <div id="header">
    <div class="header-logo">
      <img src="Logo_Golfeados.png" alt="Golfeados"/>
      <div>
        <div class="header-title">GOLFEADOS</div>
        <div class="header-sub">Golf Club</div>
      </div>
    </div>
    <div class="header-right">
      <span id="adminBadge" class="badge-admin" style="display:none;">ADMIN</span>
      <div id="connPill" title="Estado de conexiÃ³n" style="display:flex;align-items:center;gap:4px;padding:3px 8px;border-radius:20px;font-size:10px;font-weight:700;letter-spacing:0.5px;background:#E8F5E9;color:#2E7D32;border:1px solid #A5D6A7;transition:all 0.4s;">
        <span id="connDot" style="width:6px;height:6px;border-radius:50%;background:#4CAF50;display:inline-block;"></span>
        <span id="connLabel">EN VIVO</span>
      </div>
      <span id="headerUser" class="header-user"></span>
      <button class="btn-logout" onclick="handleLogout()">Salir</button>
    </div>
  </div>

  <div id="nav">
    <button class="nav-btn active" data-tab="dashboard" onclick="goTab('dashboard')">ğŸ  Inicio</button>
    <button class="nav-btn" data-tab="mistorneos" onclick="goTab('mistorneos')">ğŸ† Mis Torneos</button>
    <button class="nav-btn" data-tab="jornadas" onclick="goTab('jornadas')">ğŸŒï¸ Partidas</button>
    <button class="nav-btn" data-tab="jugadores" onclick="goTab('jugadores')">ğŸ‘¤ Jugadores</button>
    <button class="nav-btn" data-tab="clubes" onclick="goTab('clubes')">â›³ Clubes</button>
  </div>

  <div id="content">
    <div id="tab-dashboard"></div>
    <div id="tab-mistorneos" style="display:none;"></div>
    <div id="tab-jornadas" style="display:none;"></div>
    <div id="tab-jugadores" style="display:none;"></div>
    <div id="tab-clubes" style="display:none;"></div>
    <div id="tab-cargar" style="display:none;"></div>
  </div>
</div>

<!-- MODAL JORNADA -->
<div id="modalJornada" class="modal-overlay" style="display:none;" onclick="closeModalJornada()">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="modalJornadaTitle">Nueva Partida</div>
      <button onclick="closeModalJornada()" style="background:none;border:none;font-size:20px;color:var(--muted);cursor:pointer;">âœ•</button>
    </div>
    <div class="modal-body">
      <div id="modalJornadaError" class="error-box" style="display:none;"></div>
      <div style="display:flex;flex-direction:column;gap:14px;">
        <div>
          <label class="form-label">Club / Sede *</label>
          <select class="form-select" id="jornadaClub" style="width:100%;"></select>
        </div>
        <div>
          <label class="form-label">Fecha *</label>
          <input type="date" class="form-input" id="jornadaFecha"/>
        </div>
        <div style="display:flex;gap:12px;">
          <div style="flex:1;">
            <label class="form-label">Tee Time</label>
            <div style="display:flex;gap:6px;align-items:center;">
              <select class="form-select" id="teeHH" style="width:75px;">
                <option value="05">05</option>
                <option value="06">06</option>
                <option value="07">07</option>
                <option value="08">08</option>
                <option value="09">09</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
                <option value="15">15</option>
                <option value="16">16</option>
                <option value="17">17</option>
                <option value="18">18</option>
                <option value="19">19</option>
                <option value="20">20</option>
                <option value="21">21</option>
              </select>
              <span style="font-weight:700;color:var(--text);">:</span>
              <select class="form-select" id="teeMM" style="width:75px;">
                <option value="00">00</option>
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="30">30</option>
                <option value="40">40</option>
                <option value="50">50</option>
              </select>
            </div>
          </div>
          <div style="flex:2;">
            <label class="form-label">Notas (opcional)</label>
            <input type="text" class="form-input" id="jornadaNotas" placeholder="Ej: Scramble, 18 hoyos..."/>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--cardL);border-radius:10px;border:1px solid var(--border);">
            <input type="checkbox" id="jornadaCuentaRanking" checked style="width:18px;height:18px;cursor:pointer;accent-color:var(--green);"/>
            <div>
              <label for="jornadaCuentaRanking" style="font-weight:700;font-size:13px;cursor:pointer;">Cuenta para el ranking</label>
              <div style="font-size:11px;color:var(--muted);">Desactiva para partidas de prÃ¡ctica o exhibiciÃ³n (ğŸš«)</div>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--cardL);border-radius:10px;border:1px solid var(--border);">
            <input type="checkbox" id="jornadaReglasEspeciales" style="width:18px;height:18px;cursor:pointer;accent-color:var(--blue);"
              onchange="document.getElementById('reglasEspecialesPanel').style.display=this.checked?'block':'none'"/>
            <div>
              <label for="jornadaReglasEspeciales" style="font-weight:700;font-size:13px;cursor:pointer;">âš™ï¸ Reglas especiales para esta partida</label>
              <div style="font-size:11px;color:var(--muted);">Anulan las reglas del torneo solo para esta partida</div>
            </div>
          </div>
          <div id="reglasEspecialesPanel" style="display:none;background:var(--cardL);border-radius:10px;padding:14px;border:1px solid var(--border);">
            <div class="text-11 text-muted font-bold" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">Puntos por posiciÃ³n</div>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px;">
              <div style="text-align:center;"><div style="font-size:16px;">ğŸ¥‡</div><input type="number" class="form-input" id="jrPts1" placeholder="4" min="0" style="text-align:center;padding:6px 4px;"/></div>
              <div style="text-align:center;"><div style="font-size:16px;">ğŸ¥ˆ</div><input type="number" class="form-input" id="jrPts2" placeholder="3" min="0" style="text-align:center;padding:6px 4px;"/></div>
              <div style="text-align:center;"><div style="font-size:16px;">ğŸ¥‰</div><input type="number" class="form-input" id="jrPts3" placeholder="2" min="0" style="text-align:center;padding:6px 4px;"/></div>
              <div style="text-align:center;"><div style="font-size:11px;color:var(--muted);margin-bottom:4px;">Resto</div><input type="number" class="form-input" id="jrPtsResto" placeholder="1" min="0" style="text-align:center;padding:6px 4px;"/></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <div><label class="form-label">âœ… Bonus asistencia</label>
                <div style="display:flex;align-items:center;gap:6px;"><input type="number" class="form-input" id="jrBonus" value="0" min="0" style="width:65px;text-align:center;"/><span class="text-11 text-muted">pts</span></div></div>
              <div><label class="form-label">âŒ Penal no asistencia</label>
                <div style="display:flex;align-items:center;gap:6px;"><input type="number" class="form-input" id="jrPenalNoAsist" value="0" style="width:65px;text-align:center;"/><span class="text-11 text-muted">pts</span></div></div>
              <div><label class="form-label">ğŸš« Penal DQ</label>
                <div style="display:flex;align-items:center;gap:6px;"><input type="number" class="form-input" id="jrPenalDQ" value="0" style="width:65px;text-align:center;"/><span class="text-11 text-muted">pts</span></div></div>
            </div>
          </div>
        </div>
      </div>
<!-- fotos se cargan en pantalla de resultados -->
    </div>
    <div class="modal-footer">
      <button class="btn-outline" onclick="closeModalJornada()">Cancelar</button>
      <button class="btn-green" id="btnGuardarJornada" onclick="saveJornada()">Guardar Partida</button>
    </div>
  </div>
</div>


<!-- MODAL CLUB -->
<div id="modalClub" class="modal-overlay" style="display:none;" onclick="closeModalClub()">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="modalClubTitle">Nuevo Club</div>
      <button onclick="closeModalClub()" style="background:none;border:none;font-size:20px;color:var(--muted);cursor:pointer;">âœ•</button>
    </div>
    <div class="modal-body">
      <div id="modalClubError" class="error-box" style="display:none;"></div>
      <div style="display:flex;flex-direction:column;gap:14px;">
        <div><label class="form-label">Nombre del Club *</label><input class="form-input" id="clubNombre" placeholder="Ej: Izcaragua Country Club"/></div>
        <div><label class="form-label">Ciudad</label><input class="form-input" id="clubCiudad" placeholder="Ej: Caracas"/></div>
        <div style="display:flex;gap:12px;">
          <div style="width:80px;"><label class="form-label">Iniciales</label><input class="form-input" id="clubIniciales" placeholder="IC" maxlength="3"/></div>
          <div style="flex:1;"><label class="form-label">Color avatar</label>
            <select class="form-select" id="clubColor" style="width:100%;">
              <option value="#2E7D5E">Verde</option>
              <option value="#1A6B8A">Azul</option>
              <option value="#0D7377">Teal</option>
              <option value="#7B1FA2">Morado</option>
              <option value="#C49A00">Dorado</option>
              <option value="#D32F2F">Rojo</option>
            </select>
          </div>
        </div>
        <div>
          <label class="form-label">Foto del Club (opcional)</label>
          <div class="photo-upload-box" onclick="document.getElementById('clubFotoInput').click()">
            <img id="clubFotoPreview" style="display:none;width:100%;height:120px;object-fit:cover;border-radius:8px;margin-bottom:8px;"/>
            <div id="clubFotoPlaceholder">ğŸ“· Toca para subir foto</div>
            <input type="file" id="clubFotoInput" accept="image/*" onchange="previewPhoto(this,'clubFotoPreview','clubFotoPlaceholder')"/>
          </div>
          <div class="upload-progress"><div class="upload-progress-bar" id="clubFotoProgress"></div></div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-outline" onclick="closeModalClub()">Cancelar</button>
      <button class="btn-green" id="btnGuardarClub" onclick="saveClub()">Guardar Club</button>
    </div>
  </div>
</div>

<!-- MODAL JUGADOR EDIT -->
<div id="modalJugador" class="modal-overlay" style="display:none;" onclick="closeModalJugador()">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title">Editar Jugador</div>
      <button onclick="closeModalJugador()" style="background:none;border:none;font-size:20px;color:var(--muted);cursor:pointer;">âœ•</button>
    </div>
    <div class="modal-body">
      <div id="modalJugadorError" class="error-box" style="display:none;"></div>
      <div style="display:flex;flex-direction:column;gap:14px;">
        <div style="display:flex;align-items:center;gap:16px;">
          <div style="position:relative;flex-shrink:0;">
            <img id="jugadorFotoPreview" src="" style="display:none;" class="foto-perfil-circle"/>
            <div id="jugadorFotoFallback" style="width:64px;height:64px;border-radius:50%;background:var(--green);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:20px;">ğŸ‘¤</div>
            <button type="button" onclick="document.getElementById('jugadorFotoInput').click()" 
              style="position:absolute;bottom:0;right:0;background:var(--green);border:none;border-radius:50%;width:22px;height:22px;color:#fff;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;">âœï¸</button>
            <input type="file" id="jugadorFotoInput" accept="image/*" style="display:none;" onchange="previewPhoto(this,'jugadorFotoPreview','jugadorFotoFallback')"/>
          </div>
          <div style="flex:1;"><label class="form-label">Nombre Completo *</label><input class="form-input" id="editNombre" placeholder="Nombre completo"/></div>
        </div>
        <div style="display:flex;gap:12px;">
          <div style="flex:1;"><label class="form-label">Alias</label><input class="form-input" id="editAlias" placeholder="Alias o apodo"/></div>
          <div style="width:80px;"><label class="form-label">Iniciales</label><input class="form-input" id="editFoto" placeholder="DB" maxlength="2"/></div>
        </div>
        <div><label class="form-label">Handicap</label><input class="form-input" id="editHandicap" type="number" min="0" max="54" placeholder="0" style="width:100px;"/></div>
        <div>
          <label class="form-label">TelÃ©fono / WhatsApp</label>
          <div style="display:flex;gap:8px;align-items:center;">
            <select class="form-select" id="editPaisCodigo" style="width:110px;">
              <option value="+58">ğŸ‡»ğŸ‡ª +58</option>
              <option value="+1">ğŸ‡ºğŸ‡¸ +1</option>
              <option value="+34">ğŸ‡ªğŸ‡¸ +34</option>
              <option value="+52">ğŸ‡²ğŸ‡½ +52</option>
              <option value="+57">ğŸ‡¨ğŸ‡´ +57</option>
              <option value="+51">ğŸ‡µğŸ‡ª +51</option>
              <option value="+54">ğŸ‡¦ğŸ‡· +54</option>
              <option value="+56">ğŸ‡¨ğŸ‡± +56</option>
              <option value="+55">ğŸ‡§ğŸ‡· +55</option>
              <option value="+507">ğŸ‡µğŸ‡¦ +507</option>
            </select>
            <input class="form-input" id="editTelefono" type="tel" placeholder="4141234567" style="flex:1;" oninput="validarTelefono(this)"/>
          </div>
          <div id="telefonoHint" style="font-size:11px;color:var(--muted);margin-top:4px;">Solo nÃºmeros, sin espacios ni guiones. Ej: 4141234567</div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-outline" onclick="closeModalJugador()">Cancelar</button>
      <button class="btn-green" id="btnGuardarJugador" onclick="saveJugador()">Guardar</button>
    </div>
  </div>
</div>


<!-- MODAL TORNEO â€” Crear / Editar -->
<div id="modalTorneo" class="modal-overlay" style="display:none;" onclick="closeModalTorneo(event)">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="modalTorneoTitle">Nuevo Torneo</div>
      <button onclick="closeModalTorneo()" style="background:none;border:none;font-size:20px;color:var(--muted);cursor:pointer;">âœ•</button>
    </div>
    <div class="modal-body" style="display:flex;flex-direction:column;gap:16px;">
      <div id="modalTorneoError" class="error-box" style="display:none;"></div>

      <!-- INFO BÃSICA -->
      <div style="background:var(--cardL);border-radius:10px;padding:14px;border:1px solid var(--border);">
        <div class="text-12 font-bold text-muted" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:12px;">ğŸ“‹ InformaciÃ³n</div>
        <div style="display:flex;flex-direction:column;gap:12px;">
          <div><label class="form-label">Nombre del Torneo *</label>
            <input class="form-input" id="tNombre" placeholder="Ej: Torneo Apertura 2026"/></div>
<!-- fechas: se gestionan por partidas -->
          <div style="display:flex;gap:12px;">
            <div style="flex:1;"><label class="form-label">NÂ° Partidas</label>
              <input type="number" class="form-input" id="tJornadasTotal" min="1" max="52" placeholder="8"/></div>
            <div style="flex:1;"><label class="form-label">Estado</label>
              <select class="form-select" id="tEstado" style="width:100%;">
                <option value="Borrador">Borrador</option>
                <option value="Activo" selected>Activo</option>
                <option value="Finalizado">Finalizado</option>
              </select></div>
          </div>
          <div>
            <label class="form-label">DescripciÃ³n (opcional)</label>
            <textarea class="form-input" id="tDescripcion" placeholder="DescripciÃ³n del torneo..." rows="3" style="resize:vertical;"></textarea>
          </div>
                      <div>
            <label class="form-label">Documento / imagen (opcional)</label>
            <div onclick="document.getElementById('tDocInput').click()" id="tDocBox"
              style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--cardL);border-radius:10px;border:2px dashed var(--border);cursor:pointer;min-height:52px;">
              <span style="font-size:22px;flex-shrink:0;">ğŸ“</span>
              <div style="flex:1;min-width:0;">
                <div id="tDocLabel" style="font-size:12px;color:var(--muted);line-height:1.3;">Subir PDF o imagen</div>
              </div>
              <img id="tDocPreview" style="display:none;width:44px;height:44px;object-fit:cover;border-radius:6px;flex-shrink:0;"/>
              <input type="file" id="tDocInput" accept="image/*,application/pdf" style="display:none;" onchange="previewTorneoDoc(this)"/>
            </div>
            <div id="tDocExisting" style="display:none;margin-top:8px;display:flex;align-items:center;gap:8px;">
              <a id="tDocLink" href="#" target="_blank" style="font-size:12px;color:var(--blue);">ğŸ“ Ver documento actual</a>
              <button onclick="clearTorneoDoc()" style="background:none;border:none;color:var(--muted);font-size:12px;cursor:pointer;">âœ• Quitar</button>
            </div>
            <div class="upload-progress"><div class="upload-progress-bar" id="tDocProgress"></div></div>
          </div>
          <div style="display:flex;gap:12px;">
            <div style="flex:1;"><label class="form-label">Visibilidad</label>
              <select class="form-select" id="tVisibilidad" style="width:100%;">
                <option value="privado">ğŸ”’ Privado</option>
                <option value="publico">ğŸŒ PÃºblico</option>
              </select></div>
            <div style="flex:1;"><label class="form-label">Â¿QuiÃ©n carga?</label>
              <select class="form-select" id="tQuienCarga" style="width:100%;">
                <option value="admins">Solo admins</option>
                <option value="cualquiera">Cualquier jugador</option>
              </select></div>
          </div>
        </div>
      </div>

      <!-- REGLAS DE PUNTUACIÃ“N -->
      <div style="background:var(--cardL);border-radius:10px;padding:14px;border:1px solid var(--border);">
        <div class="text-12 font-bold text-muted" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:12px;">âš™ï¸ Reglas de PuntuaciÃ³n</div>

        <!-- Puntos por posiciÃ³n -->
        <div style="margin-bottom:14px;">
          <label class="form-label">Puntos por posiciÃ³n</label>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:6px;">
            <div style="text-align:center;">
              <div style="font-size:18px;margin-bottom:4px;">ğŸ¥‡</div>
              <input type="number" class="form-input" id="rPts1" oninput="updateEmpateEjemplo()" value="4" min="0" style="text-align:center;padding:8px 4px;"/>
            </div>
            <div style="text-align:center;">
              <div style="font-size:18px;margin-bottom:4px;">ğŸ¥ˆ</div>
              <input type="number" class="form-input" id="rPts2" oninput="updateEmpateEjemplo()" value="3" min="0" style="text-align:center;padding:8px 4px;"/>
            </div>
            <div style="text-align:center;">
              <div style="font-size:18px;margin-bottom:4px;">ğŸ¥‰</div>
              <input type="number" class="form-input" id="rPts3" oninput="updateEmpateEjemplo()" value="2" min="0" style="text-align:center;padding:8px 4px;"/>
            </div>
            <div style="text-align:center;">
              <div style="font-size:18px;margin-bottom:4px;">ğŸŒï¸</div>
              <div style="font-size:10px;color:var(--muted);margin-bottom:4px;">Resto</div>
              <input type="number" class="form-input" id="rPtsResto" value="1" min="0" style="text-align:center;padding:8px 4px;"/>
            </div>
          </div>
        </div>

        <!-- Bonus / Penales -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
          <div>
            <label class="form-label">âœ… Bonus asistencia</label>
            <div style="display:flex;align-items:center;gap:6px;">
              <input type="number" class="form-input" id="rBonus" value="0" min="0" style="text-align:center;width:70px;"/>
              <span class="text-12 text-muted">pts extra</span>
            </div>
          </div>
          <div>
            <label class="form-label">âŒ Penal no asistencia</label>
            <div style="display:flex;align-items:center;gap:6px;">
              <input type="number" class="form-input" id="rPenalNoAsist" value="0" style="text-align:center;width:70px;"/>
              <span class="text-12 text-muted">pts</span>
            </div>
          </div>
          <div>
            <label class="form-label">ğŸš« Penal DQ</label>
            <div style="display:flex;align-items:center;gap:6px;">
              <input type="number" class="form-input" id="rPenalDQ" value="0" style="text-align:center;width:70px;"/>
              <span class="text-12 text-muted">pts</span>
            </div>
          </div>
          <div>
            <label class="form-label">ğŸ—‘ï¸ Descartes</label>
            <div style="display:flex;align-items:center;gap:6px;">
              <input type="number" class="form-input" id="rDescartes" value="0" min="0" style="text-align:center;width:70px;"/>
              <span class="text-12 text-muted">partidas</span>
            </div>
          </div>
        </div>

        <!-- Empates -->
        <div>
          <label class="form-label">ğŸ¤ Empates</label>
          <select class="form-select" id="rEmpates" style="width:100%;margin-top:6px;" onchange="updateEmpateEjemplo()" oninput="updateEmpateEjemplo()">
            <option value="comparten">Comparten puntos â€” promedio de posiciones empatadas</option>
            <option value="posicion_anterior">PosiciÃ³n anterior â€” ambos toman la misma posiciÃ³n</option>
          </select>
          <div id="empateEjemplo" style="margin-top:6px;font-size:11px;color:var(--muted);padding:8px 10px;background:var(--bg);border-radius:6px;"></div>
        </div>
      </div>


      <!-- DELEGAR ADMINS -->
      <div style="background:var(--cardL);border-radius:10px;padding:14px;border:1px solid var(--border);" id="seccionAdmins">
        <div class="text-12 font-bold text-muted" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:12px;">ğŸ‘¥ Co-Administradores</div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:10px;">Pueden cargar partidas, editar y gestionar el torneo.</div>
        <div id="adminsList" style="display:flex;flex-direction:column;gap:8px;margin-bottom:10px;"></div>
        <div style="display:flex;gap:8px;">
          <input class="form-input" id="addAdminInput" placeholder="Email o @usuario del jugador" style="flex:1;"/>
          <button class="btn-outline" style="white-space:nowrap;padding:8px 14px;" onclick="addCoAdmin()">+ Agregar</button>
        </div>
        <div id="addAdminError" style="font-size:11px;color:var(--red);margin-top:6px;display:none;"></div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-outline" onclick="closeModalTorneo()">Cancelar</button>
      <button class="btn-green" id="btnGuardarTorneo" onclick="saveModalTorneo()">Guardar Torneo</button>
    </div>
  </div>
</div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VERSIÃ“N â€” cambia este nÃºmero cada vez que subas cambios
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const APP_VERSION = '3.8.6';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig = {
  apiKey:            "AIzaSyCu98_7auFGd3nJJmYDRCM7KaM5OdtCBx4",
  authDomain:        "golfeados-660b3.firebaseapp.com",
  projectId:         "golfeados-660b3",
  storageBucket:     "golfeados-660b3.firebasestorage.app",
  messagingSenderId: "417996522021",
  appId:             "1:417996522021:web:67871e33758befec81f5cc"
};
firebase.initializeApp(firebaseConfig);
const auth    = firebase.auth();
const db      = firebase.firestore();
const storage = firebase.storage();

// Handle Google redirect result (fires after page reloads from Google auth)
auth.getRedirectResult().then(result=>{
  // result.user will be null if no redirect in progress
  // onAuthStateChanged handles the actual login flow
}).catch(e=>{
  if(e.code&&e.code!=='auth/no-current-user'){
    console.error('Google redirect error:',e.message);
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ESTADO GLOBAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let STATE = {
  user:null, profile:null,
  torneo:null,          // legacy single-torneo (kept for compatibility)
  torneos:[],           // all torneos
  jugadores:[], partidas:[], resultados:[], clubes:[],
  currentTab:'dashboard', cargarJornadaId:null,
  expandedJornada:null, expandedTorneo:null,
  expandedJornadaMT:null,  // partida expanded inside Mis Torneos
  chartInstance:null, editingJornadaId:null,
  activeTorneoId:null,  // torneo being viewed in detail
  unsubs:[]
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH â€” Multi-method login + Registration + Verification
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Show/hide login views
// â”€â”€ Google Sign-In â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleGoogleSignIn(){
  try{
    const provider=new firebase.auth.GoogleAuthProvider();
    provider.addScope('email');
    provider.addScope('profile');
    // Use redirect (works on all mobile browsers including Safari)
    await auth.signInWithRedirect(provider);
    // Page will reload â€” onAuthStateChanged handles the result
  }catch(e){
    const err=document.getElementById('loginError')||document.getElementById('registerError');
    if(err){ err.textContent='Error con Google: '+e.message; err.style.display='block'; }
  }
}

// â”€â”€ Invite Code (Vincular cuenta) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showVincular(){
  showLoginView('vincularView');
}
function skipVincular(){
  // User skips â€” goes to main app without jugador linked
  // Mark as skipped so we don't ask again every login
  if(STATE.user) db.collection('users').doc(STATE.user.uid).update({vincular_skipped:true}).catch(()=>{});
  if(STATE.profile) STATE.profile.vincular_skipped=true;
  showApp_();
  initListeners();
}
async function handleVincular(){
  const code=document.getElementById('vincularCodigo').value.trim().toUpperCase();
  const err=document.getElementById('vincularError');
  const btn=document.getElementById('vincularBtn');
  err.style.display='none';
  if(!code||code.length<6){ err.textContent='Ingresa el cÃ³digo de invitaciÃ³n.'; err.style.display='block'; return; }
  btn.disabled=true; btn.textContent='Verificando...';
  try{
    // Find jugador with this invite_code
    const snap=await db.collection('jugadores').where('invite_code','==',code).limit(1).get();
    if(snap.empty){ err.textContent='CÃ³digo invÃ¡lido. Verifica con tu administrador.'; err.style.display='block'; btn.disabled=false; btn.textContent='Vincular mi perfil ğŸŒï¸'; return; }
    const jugDoc=snap.docs[0];
    if(jugDoc.data().user_uid){ err.textContent='Este cÃ³digo ya fue usado.'; err.style.display='block'; btn.disabled=false; btn.textContent='Vincular mi perfil ğŸŒï¸'; return; }
    // Link: update jugador + user profile
    const uid=STATE.user.uid;
    await db.collection('jugadores').doc(jugDoc.id).update({ user_uid:uid });
    await db.collection('users').doc(uid).update({ jugador_id:jugDoc.id, vincular_skipped:false });
    STATE.profile.jugador_id=jugDoc.id;
    STATE.profile.vincular_skipped=false;
    // Enter app
    showApp_();
    initListeners();
  }catch(e){
    err.textContent='Error: '+e.message; err.style.display='block';
    btn.disabled=false; btn.textContent='Vincular mi perfil ğŸŒï¸';
  }
}

// â”€â”€ Generate invite code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateInviteCode(){
  const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // no confusing chars (0,O,1,I)
  let code='GOLF-';
  for(let i=0;i<4;i++) code+=chars[Math.floor(Math.random()*chars.length)];
  return code;
}

function showLoginView(id){
  ['loginView','registerView','verifyChoiceView','smsCodeView',
   'emailSentView','pendingVerifyView','resetView','vincularView'].forEach(v=>{
    const el=document.getElementById(v);
    if(el) el.style.display=v===id?'block':'none';
  });
}
function showLogin(){ showLoginView('loginView'); }
function showRegister(){ showLoginView('registerView'); }
function showVerifyChoice(){ showLoginView('verifyChoiceView'); }

// â”€â”€â”€ onAuthStateChanged â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
auth.onAuthStateChanged(async user=>{
  if(user){
    STATE.user=user;
    const snap=await db.collection('users').doc(user.uid).get();
    if(snap.exists){ STATE.profile=snap.data(); }
    else{
      const p={email:user.email,nombre:user.displayName||user.email,
               role:'jugador',jugador_id:null,verified:false,username:''};
      await db.collection('users').doc(user.uid).set(p);
      STATE.profile=p;
    }
    // Google sign-in: user is auto-verified, set verified flag
    if(STATE.user.providerData&&STATE.user.providerData[0]&&STATE.user.providerData[0].providerId==='google.com'){
      if(!STATE.profile.verified){
        await db.collection('users').doc(STATE.user.uid).update({verified:true});
        STATE.profile.verified=true;
      }
    }
    // If user has no jugador_id â†’ show vincular screen (skip for admins and users who already skipped)
    if(!STATE.profile.jugador_id && STATE.profile.role!=='admin' && !STATE.profile.vincular_skipped){
      document.getElementById('app').style.display='none';
      document.getElementById('loginScreen').style.display='flex';
      showLoginView('vincularView');
      return;
    }

    // Check if verified
    await user.reload();
    const emailVerif=user.emailVerified;
    const phoneVerif=STATE.profile?.phoneVerified||false;
    const isLegacy=STATE.profile?.legacy||false; // admin-created accounts skip verification
    if(!emailVerif&&!phoneVerif&&!isLegacy){
      // Not verified â€” show pending
      showLogin_();
      document.getElementById('loginScreen').style.display='flex';
      // Pre-fill verifyChoice
      document.getElementById('verifyEmailAddr').textContent=user.email||'';
      const tc=STATE.profile?.telefonoCompleto;
      if(tc) document.getElementById('verifyPhoneNum').textContent=tc;
      showLoginView('pendingVerifyView');
    } else {
      showApp_(); initListeners();
    }
  } else {
    STATE.user=null; STATE.profile=null;
    stopListeners(); showLogin_();
  }
});

function showLogin_(){
  document.getElementById('loading').style.display='none';
  document.getElementById('loginScreen').style.display='flex';
  document.getElementById('app').style.display='none';
  showLoginView('loginView');
}

function showApp_(){
  document.getElementById('loading').style.display='none';
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('app').style.display='block';
  document.getElementById('headerUser').textContent=STATE.profile?.nombre||STATE.user?.email||'';
  document.getElementById('adminBadge').style.display=STATE.profile?.role==='admin'?'inline':'none';
  initConnectionMonitor();
  initUpdateChecker();
}

// Keep showApp as alias
function showApp(){ showApp_(); }

// â”€â”€â”€ LOGIN: email / username / phone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateLoginHint(input){
  const v=input.value.trim();
  const hint=document.getElementById('loginHint');
  if(!v){ hint.textContent=''; return; }
  if(v.includes('@')&&v.includes('.')){ hint.textContent='ğŸ“§ Entrando con email'; }
  else if(/^[+0-9]/.test(v)){ hint.textContent='ğŸ“± Entrando con telÃ©fono'; }
  else { hint.textContent='ğŸ‘¤ Entrando con usuario'; }
}

async function resolveEmail(identifier){
  // Returns email for any identifier type
  if(identifier.includes('@')&&identifier.includes('.')) return identifier;
  // Search Firestore users
  let snap;
  if(/^[+0-9]/.test(identifier)){
    // Phone: normalize
    const normalized=identifier.replace(/[^0-9+]/g,'');
    snap=await db.collection('users').where('telefonoCompleto','==',normalized).limit(1).get();
    if(snap.empty){
      // Try without country code variants
      snap=await db.collection('users').where('telefono','==',normalized.replace(/^\+[0-9]{1,3}/,'')).limit(1).get();
    }
  } else {
    // Username: strip leading @
    const uname=identifier.replace(/^@/,'').toLowerCase();
    snap=await db.collection('users').where('username','==',uname).limit(1).get();
  }
  if(!snap||snap.empty) return null;
  return snap.docs[0].data().email||null;
}

async function handleLogin(){
  const identifier=document.getElementById('loginIdentifier').value.trim();
  const pass=document.getElementById('loginPassword').value;
  const btn=document.getElementById('loginBtn');
  const err=document.getElementById('loginError');
  err.style.display='none'; btn.disabled=true; btn.textContent='Entrando...';
  try{
    const email=await resolveEmail(identifier);
    if(!email){ err.textContent='Usuario no encontrado.'; err.style.display='block'; return; }
    await auth.signInWithEmailAndPassword(email,pass);
  }catch(e){
    const m={
      'auth/user-not-found':'Usuario no encontrado.',
      'auth/wrong-password':'ContraseÃ±a incorrecta.',
      'auth/invalid-credential':'Credenciales incorrectas.',
      'auth/too-many-requests':'Demasiados intentos. Espera un momento.'
    };
    err.textContent=m[e.code]||'Error: '+e.message; err.style.display='block';
  } finally{ btn.disabled=false; btn.textContent='Entrar al Club'; }
}

// â”€â”€â”€ REGISTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function formatUsername(input){
  input.value=input.value.toLowerCase().replace(/[^a-z0-9_]/g,'');
  const hint=document.getElementById('usernameHint');
  if(input.value.length>0&&input.value.length<3){
    hint.textContent='âš ï¸ MÃ­nimo 3 caracteres'; hint.style.color='var(--red)';
  } else if(input.value.length>=3){
    hint.textContent='âœ… @'+input.value; hint.style.color='var(--green)';
  } else { hint.textContent='Solo letras, nÃºmeros y guiÃ³n bajo'; hint.style.color='var(--muted)'; }
}

function checkStrength(input){
  const v=input.value;
  const bar=document.getElementById('strengthBar');
  const lbl=document.getElementById('strengthLabel');
  let score=0;
  if(v.length>=6)score++;
  if(v.length>=10)score++;
  if(/[A-Z]/.test(v))score++;
  if(/[0-9]/.test(v))score++;
  if(/[^A-Za-z0-9]/.test(v))score++;
  const levels=[
    {w:'0%',bg:'var(--border)',t:''},
    {w:'25%',bg:'var(--red)',t:'Muy dÃ©bil'},
    {w:'50%',bg:'#FF9800',t:'DÃ©bil'},
    {w:'75%',bg:'#2196F3',t:'Buena'},
    {w:'100%',bg:'var(--green)',t:'Muy segura'},
  ];
  const lv=levels[Math.min(score,4)];
  bar.style.width=lv.w; bar.style.background=lv.bg;
  lbl.textContent=lv.t; lbl.style.color=lv.bg;
}

function togglePass(id,btn){
  const inp=document.getElementById(id);
  if(inp.type==='password'){ inp.type='text'; btn.textContent='ğŸ™ˆ'; }
  else { inp.type='password'; btn.textContent='ğŸ‘'; }
}

async function handleRegister(){
  const nombre=document.getElementById('regNombre').value.trim();
  const username=document.getElementById('regUsername').value.trim().toLowerCase();
  const email=document.getElementById('regEmail').value.trim();
  const tel=document.getElementById('regTelefono').value.trim();
  const codigo=document.getElementById('regPaisCodigo').value;
  const pass=document.getElementById('regPassword').value;
  const err=document.getElementById('registerError');
  const btn=document.getElementById('regBtn');
  err.style.display='none';

  if(!nombre){ err.textContent='El nombre es obligatorio.'; err.style.display='block'; return; }
  if(!username||username.length<3){ err.textContent='El usuario debe tener mÃ­nimo 3 caracteres.'; err.style.display='block'; return; }
  if(!email||!email.includes('@')){ err.textContent='Email invÃ¡lido.'; err.style.display='block'; return; }
  if(pass.length<6){ err.textContent='La contraseÃ±a debe tener mÃ­nimo 6 caracteres.'; err.style.display='block'; return; }

  btn.disabled=true; btn.textContent='Creando cuenta...';
  try{
    // Check username availability
    const usnap=await db.collection('users').where('username','==',username).limit(1).get();
    if(!usnap.empty){ err.textContent='Ese nombre de usuario ya estÃ¡ tomado.'; err.style.display='block'; return; }

    // Create Firebase Auth user
    const cred=await auth.createUserWithEmailAndPassword(email,pass);
    await cred.user.updateProfile({displayName:nombre});

    // Save profile to Firestore
    const telNorm=normalizeTelVE(tel,codigo);
    const telefonoCompleto=telNorm?(codigo+telNorm):'';
    const profile={
      email, nombre, username, role:'jugador', jugador_id:null,
      telefono:tel||'', codigoPais:tel?codigo:'', telefonoCompleto,
      verified:false, phoneVerified:false, legacy:false,
      creado:firebase.firestore.FieldValue.serverTimestamp()
    };
    await db.collection('users').doc(cred.user.uid).set(profile);
    STATE.profile=profile;

    // Go to verification choice
    document.getElementById('verifyEmailAddr').textContent=email;
    if(telefonoCompleto) document.getElementById('verifyPhoneNum').textContent=telefonoCompleto;
    else document.getElementById('optSMS').style.opacity='0.4';
    showVerifyChoice();
  }catch(e){
    const m={
      'auth/email-already-in-use':'Ese email ya tiene una cuenta.',
      'auth/invalid-email':'Email invÃ¡lido.',
      'auth/weak-password':'ContraseÃ±a muy dÃ©bil.'
    };
    err.textContent=m[e.code]||'Error: '+e.message; err.style.display='block';
  } finally{ btn.disabled=false; btn.textContent='Continuar â†’'; }
}

// â”€â”€â”€ VERIFICATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let verifyMethod=null;
let confirmationResult=null;
let appVerifier=null;

function chooseVerify(method){
  verifyMethod=method;
  document.getElementById('optEmail').classList.toggle('selected',method==='email');
  document.getElementById('optSMS').classList.toggle('selected',method==='sms');
}

async function sendVerification(){
  const err=document.getElementById('verifyChoiceError');
  const btn=document.getElementById('btnSendVerify');
  err.style.display='none';
  if(!verifyMethod){ err.textContent='Selecciona un mÃ©todo.'; err.style.display='block'; return; }
  btn.disabled=true; btn.textContent='Enviando...';

  try{
    if(verifyMethod==='email'){
      await auth.currentUser.sendEmailVerification({
        url:window.location.origin+window.location.pathname
      });
      document.getElementById('emailSentAddr').textContent=
        'Enviamos un link a '+auth.currentUser.email+'. Ãbrelo y luego vuelve aquÃ­.';
      showLoginView('emailSentView');
    } else {
      // SMS via Firebase Phone Auth
      const profile=STATE.profile||(await db.collection('users').doc(auth.currentUser.uid).get()).data();
      const phone=profile?.telefonoCompleto;
      if(!phone){ err.textContent='No tienes telÃ©fono registrado. Elige email.'; err.style.display='block'; return; }

      if(!appVerifier){
        appVerifier=new firebase.auth.RecaptchaVerifier('recaptcha-container',{
          size:'invisible',
          callback:()=>{}
        });
      }
      confirmationResult=await auth.signInWithPhoneNumber(phone,appVerifier);
      document.getElementById('smsSentTo').textContent='CÃ³digo enviado a '+phone;
      // Clear OTP inputs
      [0,1,2,3,4,5].forEach(i=>{ const el=document.getElementById('otp'+i); if(el)el.value=''; });
      showLoginView('smsCodeView');
      document.getElementById('otp0').focus();
      // Show resend after 30s
      setTimeout(()=>{ const b=document.getElementById('btnResendSMS'); if(b)b.style.display='block'; },30000);
    }
  }catch(e){
    err.textContent='Error: '+e.message; err.style.display='block';
    if(appVerifier){ try{appVerifier.clear();}catch(ex){} appVerifier=null; }
  } finally{ btn.disabled=false; btn.textContent='Enviar cÃ³digo'; }
}

// OTP input helpers
function otpNext(input,i){
  input.value=input.value.replace(/[^0-9]/g,'');
  if(input.value&&i<5) document.getElementById('otp'+(i+1)).focus();
  // Auto-confirm when all 6 filled
  const code=[0,1,2,3,4,5].map(n=>document.getElementById('otp'+n).value).join('');
  if(code.length===6) confirmSMS();
}
function otpBack(e,i){
  if(e.key==='Backspace'&&!e.target.value&&i>0) document.getElementById('otp'+(i-1)).focus();
}

async function confirmSMS(){
  const code=[0,1,2,3,4,5].map(i=>document.getElementById('otp'+i).value).join('');
  const err=document.getElementById('smsError');
  const btn=document.getElementById('btnConfirmSMS');
  err.style.display='none';
  if(code.length<6){ err.textContent='Ingresa los 6 dÃ­gitos.'; err.style.display='block'; return; }
  btn.disabled=true; btn.textContent='Verificando...';
  try{
    // Get phone credential and link to current user
    const credential=firebase.auth.PhoneAuthProvider.credential(
      confirmationResult.verificationId, code
    );
    await auth.currentUser.linkWithCredential(credential);
    // Mark verified in Firestore
    await db.collection('users').doc(auth.currentUser.uid).update({
      phoneVerified:true, verified:true,
      verifiedAt:firebase.firestore.FieldValue.serverTimestamp()
    });
    STATE.profile.phoneVerified=true; STATE.profile.verified=true;
    showApp_(); initListeners();
  }catch(e){
    const m={'auth/invalid-verification-code':'CÃ³digo incorrecto.','auth/code-expired':'CÃ³digo expirado, reenvÃ­a.'};
    err.textContent=m[e.code]||'Error: '+e.message; err.style.display='block';
  } finally{ btn.disabled=false; btn.textContent='Confirmar cÃ³digo'; }
}

async function resendSMS(){
  if(appVerifier){ try{appVerifier.clear();}catch(e){} appVerifier=null; }
  confirmationResult=null;
  showVerifyChoice();
  verifyMethod='sms';
  chooseVerify('sms');
}

async function recheckEmail(){
  await auth.currentUser.reload();
  if(auth.currentUser.emailVerified){
    await db.collection('users').doc(auth.currentUser.uid).update({verified:true,verifiedAt:firebase.firestore.FieldValue.serverTimestamp()});
    STATE.profile.verified=true;
    showApp_(); initListeners();
  } else {
    const err=document.getElementById('verifyChoiceError');
    showLoginView('emailSentView');
    alert('El email aÃºn no ha sido verificado. Por favor abre el link en tu correo.');
  }
}

async function resendEmail(){
  try{ await auth.currentUser.sendEmailVerification({url:window.location.origin+window.location.pathname}); }
  catch(e){ alert('Error al reenviar: '+e.message); }
}

function skipVerify(){
  // Allow limited access â€” can be restricted later
  showApp_(); initListeners();
}

async function handleLogout(){ await auth.signOut(); }

async function handleReset(){
  const email=document.getElementById('resetEmail').value.trim();
  const err=document.getElementById('resetError'); err.style.display='none';
  try{
    await auth.sendPasswordResetEmail(email);
    document.getElementById('resetForm').style.display='none';
    document.getElementById('resetSuccess').style.display='block';
  }catch{ err.textContent='No se encontrÃ³ ese email.'; err.style.display='block'; }
}

function showReset(){
  showLoginView('resetView');
  document.getElementById('resetForm').style.display='block';
  document.getElementById('resetSuccess').style.display='none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIRESTORE LISTENERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initListeners(){
  stopListeners();
  // Load ALL torneos (sorted: active first, then by creation date)
  STATE.unsubs.push(db.collection('torneos').orderBy('creado','desc')
    .onSnapshot(s=>{
      STATE.torneos=s.docs.map(d=>({id:d.id,...d.data()}));
      // Legacy: keep STATE.torneo as the first active one
      STATE.torneo=STATE.torneos.find(t=>t.estado==='Activo'||t.estado==='activo')||STATE.torneos[0]||null;
      if(!STATE.activeTorneoId&&STATE.torneo) STATE.activeTorneoId=STATE.torneo.id;
      if(STATE._connSetOnline)STATE._connSetOnline();
      renderCurrentTab();
    }));
  STATE.unsubs.push(db.collection('jugadores').orderBy('nombre')
    .onSnapshot(s=>{ STATE.jugadores=s.docs.map(d=>({id:d.id,...d.data()})); renderCurrentTab(); }));
  STATE.unsubs.push(db.collection('jornadas').orderBy('fecha')
    .onSnapshot(s=>{ STATE.jornadas=s.docs.map(d=>({id:d.id,...d.data()})); renderCurrentTab(); }));
  STATE.unsubs.push(db.collection('resultados')
    .onSnapshot(s=>{ STATE.resultados=s.docs.map(d=>({id:d.id,...d.data()})); if(STATE._connSetOnline)STATE._connSetOnline(); renderCurrentTab(); }));
  STATE.unsubs.push(db.collection('clubes').orderBy('nombre')
    .onSnapshot(s=>{ STATE.clubes=s.docs.map(d=>({id:d.id,...d.data()})); renderCurrentTab(); }));
}
function stopListeners(){ STATE.unsubs.forEach(u=>u()); STATE.unsubs=[]; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MONITOR DE CONEXIÃ“N EN TIEMPO REAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initConnectionMonitor(){
  // Firestore network state via .info/connected (uses Realtime DB trick via Firestore itself)
  // We use a heartbeat approach: check if snapshots arrive within expected time
  let lastUpdate=Date.now();
  let connTimer=null;
  const pill=document.getElementById('connPill');
  const dot=document.getElementById('connDot');
  const label=document.getElementById('connLabel');

  function setOnline(){
    lastUpdate=Date.now();
    if(pill){
      pill.style.background='#E8F5E9';pill.style.color='#2E7D32';pill.style.borderColor='#A5D6A7';
      dot.style.background='#4CAF50';dot.style.animation='';
      label.textContent='EN VIVO';
    }
  }
  function setOffline(){
    if(pill){
      pill.style.background='#FFF8E1';pill.style.color='#F57F17';pill.style.borderColor='#FFE082';
      dot.style.background='#FFC107';dot.style.animation='pulse-dot 1s infinite';
      label.textContent='RECONECTANDO';
    }
  }
  function setSyncing(){
    if(pill){
      pill.style.background='#E3F2FD';pill.style.color='#1565C0';pill.style.borderColor='#90CAF9';
      dot.style.background='#2196F3';
      label.textContent='SINCRONIZANDO';
    }
    setTimeout(setOnline,1500);
  }

  // Patch initListeners to call setSyncing on each snapshot
  const _origInit=initListeners;

  // Monitor: if no update in 15s, show reconnecting
  function heartbeat(){
    const elapsed=Date.now()-lastUpdate;
    if(elapsed>15000) setOffline();
    else setOnline();
  }
  connTimer=setInterval(heartbeat,5000);

  // Listen to window online/offline events
  window.addEventListener('online',()=>{
    setSyncing();
    // Re-init listeners on reconnect
    initListeners();
  });
  window.addEventListener('offline',setOffline);

  // Firestore automatically reconnects â€” track with a lightweight doc listener
  db.collection('torneos').limit(1).onSnapshot(
    ()=>{ lastUpdate=Date.now(); },
    ()=>{ setOffline(); }
  );

  // Expose setOnline so snapshot callbacks can call it
  STATE._connSetOnline=setOnline;
  STATE._connSetSyncing=setSyncing;
}

// CSS for pulsing dot
(function(){
  const s=document.createElement('style');
  s.textContent='@keyframes pulse-dot{0%,100%{opacity:1;transform:scale(1);}50%{opacity:0.5;transform:scale(0.8);}}';
  document.head.appendChild(s);
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVEGACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goTab(tab){
  STATE.currentTab=tab; STATE.cargarJornadaId=null;
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.querySelector('[data-tab="'+tab+'"]')?.classList.add('active');
  ['dashboard','mistorneos','jornadas','jugadores','clubes','cargar'].forEach(t=>{
    const el=document.getElementById('tab-'+t); if(el) el.style.display='none';
  });
  const tEl=document.getElementById('tab-'+tab); if(tEl) tEl.style.display='block';
  renderCurrentTab();
}
function goCargar(jornadaId){
  STATE.cargarJornadaId=jornadaId; STATE.currentTab='cargar';
  STATE._jornadaFotosExistentes=[];
  STATE._jornadaFotoFiles=[null,null,null];  // store File objects here
  cargarParticipantes=[]; cargarPosiciones=[]; cargarStep=1;
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  ['dashboard','mistorneos','partidas','jugadores','clubes'].forEach(t=>{
    const el=document.getElementById('tab-'+t); if(el) el.style.display='none';
  });
  const ct=document.getElementById('tab-cargar');
  if(ct) ct.style.display='block';
  renderCargar();
}
function renderCurrentTab(){
  if(STATE.currentTab==='dashboard') renderDashboard();
  else if(STATE.currentTab==='mistorneos') renderMisTorneos();
  else if(STATE.currentTab==='jornadas') renderJornadas();
  else if(STATE.currentTab==='jugadores') renderJugadores();
  else if(STATE.currentTab==='clubes') renderClubes();
  else if(STATE.currentTab==='cargar') renderCargar();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Reglas por defecto del torneo
function getReglas(torneoId){
  const t=STATE.torneos.find(t=>t.id===torneoId)||STATE.torneo;
  return Object.assign({
    puntos:{1:4,2:3,3:2,resto:1},
    bonusAsistencia:0,
    penalNoAsistencia:0,
    penalDQ:0,
    descartes:0,
    empates:'comparten'
  }, t?.reglas||{});
}

// Puntos por posiciÃ³n segÃºn reglas del torneo
function getPtsPosicion(pos, reglas){
  if(!reglas) reglas=getReglas(STATE.activeTorneoId);
  const p=reglas.puntos||{};
  return p[pos]!==undefined ? p[pos] : (p.resto!==undefined ? p.resto : 1);
}

// Legacy getPts (backward compat with cargar resultados)
function getPts(pos,asist,torneoId){
  if(!asist) return 0;
  const reglas=getReglas(torneoId||STATE.activeTorneoId);
  return getPtsPosicion(pos, reglas);
}

// â”€â”€â”€ calcRankingTorneo: with empates y descartes â”€â”€â”€â”€â”€
function calcRankingTorneo(torneoId){
  const reglas=getReglas(torneoId);
  const jornadasT=STATE.jornadas.filter(j=>
    (!torneoId||(j.torneo_id===torneoId||(!j.torneo_id&&torneoId===STATE.torneo?.id)))
    && j.cuentaRanking!==false
  );
  const jugados=jornadasT.filter(j=>j.estado!=='Planificada');
  const oficiales=jornadasT.filter(j=>j.estado==='Oficial');

  // 1. Build pts-per-partida map: recalculate from position applying empate rules
  // First build a map: jornada_id â†’ { jugador_id â†’ calculated_pts }
  const jornadaPtsMap={};
  for(const jn of jugados){
    // Per-partida rules: use reglasOverride if present
    const jnReglas=jn.reglasOverride?Object.assign({},reglas,{
      puntos:jn.reglasOverride.puntos||reglas.puntos,
      bonusAsistencia:jn.reglasOverride.bonusAsistencia!=null?jn.reglasOverride.bonusAsistencia:reglas.bonusAsistencia,
      penalNoAsistencia:jn.reglasOverride.penalNoAsistencia!=null?jn.reglasOverride.penalNoAsistencia:reglas.penalNoAsistencia,
      penalDQ:jn.reglasOverride.penalDQ!=null?jn.reglasOverride.penalDQ:reglas.penalDQ
    }):reglas;
    const jnResults=STATE.resultados.filter(r=>r.jornada_id===jn.id&&r.asistencia);
    // Group by position to detect empates
    const byPos={};
    jnResults.forEach(r=>{
      if(!byPos[r.pos]) byPos[r.pos]=[];
      byPos[r.pos].push(r);
    });
    jornadaPtsMap[jn.id]={};
    Object.entries(byPos).forEach(([posStr,group])=>{
      const pos=Number(posStr);
      let basePts;
      if(jnReglas.empates==='comparten'&&group.length>1){
        // Average points of positions pos, pos+1, ... pos+group.length-1
        let sum=0;
        for(let k=0;k<group.length;k++) sum+=getPtsPosicion(pos+k,jnReglas);
        basePts=sum/group.length;
      } else {
        basePts=getPtsPosicion(pos,jnReglas);
      }
      group.forEach(r=>{
        let pts=basePts;
        pts+=(jnReglas.bonusAsistencia||0);
        if(r.dq) pts+=(jnReglas.penalDQ||0);
        jornadaPtsMap[jn.id][r.jugador_id]=Math.round(pts*100)/100;
      });
    });
    // Non-attendees
    STATE.resultados.filter(r=>r.jornada_id===jn.id&&!r.asistencia).forEach(r=>{
      jornadaPtsMap[jn.id][r.jugador_id]=(jnReglas.penalNoAsistencia||0);
    });
  }

  // 2. Aggregate per player
  const rawData=STATE.jugadores.map(jugador=>{
    const jornadaPts=jugados.map(jn=>{
      const r=STATE.resultados.find(r=>r.jornada_id===jn.id&&r.jugador_id===jugador.id);
      if(!r) return null;
      const calculatedPts=jornadaPtsMap[jn.id]?.[jugador.id]??0;
      return{jornada_id:jn.id,pts:calculatedPts,asistencia:r.asistencia,dq:r.dq||false,pos:r.pos};
    }).filter(Boolean);

    // Apply descartes: remove N lowest scoring partidas
    let ptsList=[...jornadaPts];
    if(reglas.descartes>0&&ptsList.length>reglas.descartes){
      const sorted=[...ptsList].sort((a,b)=>a.pts-b.pts);
      const descartados=new Set(sorted.slice(0,reglas.descartes).map(p=>p.jornada_id));
      ptsList=ptsList.filter(p=>!descartados.has(p.jornada_id));
    }

    const ptsT=Math.round(ptsList.reduce((a,r)=>a+r.pts,0)*100)/100;
    const ptsOf=Math.round(ptsList.filter(r=>oficiales.some(j=>j.id===r.jornada_id)).reduce((a,r)=>a+r.pts,0)*100)/100;
    const asist=jornadaPts.filter(r=>r.asistencia).length;

    return{...jugador,ptsT,ptsOf,asist,jornadaPts};
  });

  // 3. Sort by ptsT desc
  rawData.sort((a,b)=>b.ptsT-a.ptsT);

  // 4. Assign ranking positions
  rawData.forEach((j,i)=>j.pos=i+1);

  return rawData;
}

// Legacy calcRanking uses active torneo
function calcRanking(){ return calcRankingTorneo(STATE.activeTorneoId||STATE.torneo?.id); }
function avatarBg(pos){
  if(pos===1)return'#C49A00'; if(pos===2)return'#78909C'; if(pos===3)return'#8D6E63';
  return'var(--green)';
}
function medal(pos){
  if(pos===1)return'ğŸ¥‡'; if(pos===2)return'ğŸ¥ˆ'; if(pos===3)return'ğŸ¥‰';
  return`<span style="color:var(--muted);font-weight:700;font-size:14px;width:22px;display:inline-block;text-align:center;">${pos}</span>`;
}
function badgeHTML(estado){
  const m={'Oficial':'badge-oficial','Jugado':'badge-validar','Por Validar':'badge-validar','Pendiente Attest':'badge-attest','Planificada':'badge-planificada','En Juego':'badge-enjuego','Activo':'badge-activo','Borrador':'badge-planificada'};
  return`<span class="badge ${m[estado]||'badge-planificada'}">${estado}</span>`;
}
function avatarHTML(foto,pos,size='md'){
  const bg=avatarBg(pos);
  const sz=size==='sm'?'32px;font-size:11px':size==='lg'?'42px;font-size:15px':'36px;font-size:13px';
  const shadow=pos===1?'box-shadow:0 0 0 3px rgba(196,154,0,0.25);':'';
  return`<div class="avatar" style="width:${sz};background:${bg};${shadow}">${foto||'?'}</div>`;
}
function fmtPts(n){ return Number.isInteger(n)?String(n):n.toFixed(1); }
function fmtFecha(v){
  if(!v) return 'â€”';
  let d;
  if(typeof v==='object' && v.seconds) d=new Date(v.seconds*1000);
  else if(typeof v==='object' && v.toDate) d=v.toDate();
  else if(typeof v==='string'||typeof v==='number') d=new Date(String(v).length<=10?v+'T12:00:00':v);
  else d=new Date(v);
  return (!d||isNaN(d.getTime())) ? 'â€”' : d.toLocaleDateString('es-ES',{day:'numeric',month:'short',year:'numeric'});
}
function fmtFechaJornada(jn){
  return fmtFecha(jn.fecha||jn.creado||null);
}

// Returns the LIVE estado for a partida (auto En Juego when date arrives)
function getEstadoJornada(jn){
  const stored=jn.estado||'Planificada';
  // Terminal states: never auto-change
  if(stored==='Pendiente Attest'||stored==='Jugado'||stored==='Oficial'||stored==='Por Validar') return stored;
  // Auto-transition: if fecha is today or past â†’ En Juego
  // Uses LOCAL date (not UTC) so Venezuela/Miami time is respected
  if(jn.fecha){
    const fechaStr=typeof jn.fecha==='object'&&jn.fecha.seconds
      ? new Date(jn.fecha.seconds*1000).toLocaleDateString('en-CA')  // YYYY-MM-DD in local tz
      : String(jn.fecha).substring(0,10);
    const now=new Date();
    const today=now.toLocaleDateString('en-CA');  // YYYY-MM-DD in local tz
    if(fechaStr<=today) return 'En Juego';
  }
  return 'Planificada';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD â€” Multi-torneo
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function torneoCardHTML(torneo, compact=false){
  const tid=torneo.id;
  const reglas=getReglas(tid);
  const jornadasT=STATE.jornadas.filter(j=>j.torneo_id===tid||(!j.torneo_id&&tid===STATE.torneo?.id));
  const jugadas=jornadasT.filter(j=>j.estado!=='Planificada').length;
  const total=torneo.jornadas_total||jornadasT.length||'?';
  const proxima=[...jornadasT].sort((a,b)=>new Date(a.fecha)-new Date(b.fecha))
    .find(j=>j.estado==='Planificada'&&j.fecha>=new Date().toISOString().slice(0,10));

  // My position
  const rk=calcRankingTorneo(tid);
  const myJugadorId=STATE.profile?.jugador_id;
  const myPos=rk.find(r=>r.id===myJugadorId);
  const isAdmin=STATE.profile?.role==='admin'||(torneo.admins||[]).includes(STATE.user?.uid)||torneo.adminId===STATE.user?.uid;

  const estadoColor={'Activo':'var(--green)','activo':'var(--green)','Finalizado':'var(--muted)','finalizado':'var(--muted)','Borrador':'var(--gold)','borrador':'var(--gold)'}[torneo.estado]||'var(--blue)';

  return`
  <div class="card" style="margin-bottom:12px;overflow:hidden;">
    <div style="background:linear-gradient(135deg,var(--green),var(--teal));padding:16px 20px;cursor:pointer;"
      onclick="toggleTorneoDash('${tid}')">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div>
          <div style="color:rgba(255,255,255,0.7);font-size:10px;letter-spacing:2px;text-transform:uppercase;margin-bottom:4px;">
            ${torneo.estado?.toUpperCase()||'ACTIVO'}
          </div>
          <div style="color:#fff;font-size:17px;font-weight:800;font-family:Georgia,serif;">${torneo.nombre}</div>
        </div>
        ${myPos?`<div style="text-align:right;">
          <div style="color:rgba(255,255,255,0.7);font-size:10px;">Mi posiciÃ³n</div>
          <div style="color:#fff;font-size:22px;font-weight:800;">#${myPos.pos}</div>
          <div style="color:rgba(255,255,255,0.7);font-size:11px;">${myPos.ptsT} pts</div>
        </div>`:''}
      </div>
      <div style="display:flex;gap:20px;margin-top:12px;">
        <div><div style="color:rgba(255,255,255,0.6);font-size:9px;text-transform:uppercase;letter-spacing:1px;">Partidas</div>
          <div style="color:#fff;font-size:14px;font-weight:700;">${jugadas}/${total}</div></div>
        <div><div style="color:rgba(255,255,255,0.6);font-size:9px;text-transform:uppercase;letter-spacing:1px;">Jugadores</div>
          <div style="color:#fff;font-size:14px;font-weight:700;">${rk.length}</div></div>
        <div><div style="color:rgba(255,255,255,0.6);font-size:9px;text-transform:uppercase;letter-spacing:1px;">PrÃ³xima</div>
          <div style="color:#fff;font-size:13px;font-weight:600;">${proxima?fmtFecha(proxima.fecha):'â€”'}</div></div>
      </div>
    </div>

    ${STATE.expandedTorneo===tid?`
    <div style="padding:0;">
      <!-- Mini ranking top 3 -->
      <div style="padding:14px 20px 8px;">
        <div class="text-11 text-muted font-bold" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">ğŸ† Podio</div>
        ${rk.slice(0,3).map(j=>`
          <div class="result-row" style="margin-bottom:8px;">
            ${medal(j.pos)}
            ${j.fotoURL?`<img src="${j.fotoURL}" style="width:32px;height:32px;border-radius:50%;object-fit:cover;flex-shrink:0;"/>`:avatarHTML(j.foto,j.pos,'sm')}
            <div class="flex-1 text-13 font-bold">${j.nombre}</div>
            <div style="font-size:16px;font-weight:800;color:${j.pos===1?'var(--gold)':'var(--text)'};">${fmtPts(j.ptsT)}<span class="text-10 text-muted"> pts</span></div>
          </div>`).join('')}
      </div>
      <!-- PrÃ³ximas partidas -->
      ${jornadasT.filter(j=>j.estado==='Planificada').slice(0,2).length?`
      <div style="border-top:1px solid var(--border);padding:12px 20px 8px;">
        <div class="text-11 text-muted font-bold" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;">ğŸ“… PrÃ³ximas</div>
        ${jornadasT.filter(j=>j.estado==='Planificada').slice(0,2).map(jn=>`
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
            ${clubAvatarHTML(jn.sede)}
            <div class="flex-1">
              <div class="text-13 font-bold">${jn.sede||'Sin sede'}</div>
              <div class="text-11 text-muted">${fmtFechaJornada(jn)}${jn.teeTime?' Â· â° '+jn.teeTime:''}</div>
            </div>
          </div>`).join('')}
      </div>`:''}
      <!-- Actions -->
      <div style="border-top:1px solid var(--border);padding:12px 20px;display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn-outline" style="font-size:12px;padding:7px 14px;" onclick="verTorneoCompleto('${tid}')">Ver ranking completo â†’</button>
        ${isAdmin?`<button class="btn-green" style="font-size:12px;padding:7px 14px;" onclick="openModalJornada(null,'${tid}')">+ Partida</button>`:''}
      </div>
    </div>`:``}
  </div>`;
}

function toggleTorneoDash(torneoId){
  STATE.expandedTorneo=STATE.expandedTorneo===torneoId?null:torneoId;
  renderDashboard();
}

function verTorneoCompleto(torneoId){
  STATE.activeTorneoId=torneoId;
  goTab('mistorneos');
  STATE.expandedTorneo=torneoId;
}

function renderDashboard(){
  const el=document.getElementById('tab-dashboard');
  const isAdmin=STATE.profile?.role==='admin';
  const torneos=STATE.torneos;
  const MAX_DASH=3; // max cards on dashboard

  // Sort: active first, then by creation
  const sorted=[...torneos].sort((a,b)=>{
    const order={activo:0,Activo:0,borrador:1,Borrador:1,finalizado:2,Finalizado:2};
    return (order[a.estado]||1)-(order[b.estado]||1);
  });
  const visible=sorted.slice(0,MAX_DASH);
  const hasMore=sorted.length>MAX_DASH;

  if(torneos.length===0){
    el.innerHTML=`
      <div class="hero">
        <div class="hero-label">Bienvenido a Golfeados</div>
        <div class="hero-title">No hay torneos activos</div>
        <div style="color:rgba(255,255,255,0.8);font-size:13px;margin-top:8px;">Crea tu primer torneo para comenzar</div>
      </div>
      ${isAdmin?`<div class="card"><div class="card-body" style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn-green" onclick="openModalJornada()">+ Partida</button>
        <button class="btn-blue" onclick="goTab('jugadores')">+ Jugador</button>
        ${STATE.jugadores.length===0?`<button class="btn-teal" onclick="seedDatos()">ğŸŒ± Cargar Datos Iniciales</button>`:''}
      </div><div id="seedMsg" style="display:none;padding:10px 20px;font-size:13px;color:var(--green);"></div></div>`:''}
    `;
    return;
  }

  el.innerHTML=`
    ${visible.map(t=>torneoCardHTML(t)).join('')}
    ${hasMore?`
      <div style="text-align:center;margin:4px 0 16px;">
        <button class="btn-outline" onclick="goTab('mistorneos')" style="width:100%;padding:12px;font-size:13px;">
          Ver todos mis torneos (${torneos.length}) â†’
        </button>
      </div>`:''}
    <div class="card" style="margin-bottom:0;">
      <div class="card-body" style="display:flex;gap:10px;flex-wrap:wrap;padding:14px 16px;">
        <button class="btn-green" style="font-size:13px;" onclick="openModalTorneo()">+ Crear Torneo</button>
      </div>
    </div>
    ${isAdmin?`
    <div class="card">
      <div class="card-header"><span class="card-title">âš™ï¸ Admin</span></div>
      <div class="card-body" style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn-green" onclick="openModalTorneo()">+ Torneo</button>
        <button class="btn-outline" onclick="goTab('jugadores')">+ Jugador</button>
        ${STATE.jugadores.length===0?`<button class="btn-teal" onclick="seedDatos()">ğŸŒ± Cargar Datos Iniciales</button>`:''}
      </div>
      <div id="seedMsg" style="display:none;padding:10px 20px;font-size:13px;color:var(--green);"></div>
    </div>`:''}
  `;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MIS TORNEOS â€” Lista completa con detalle expandible
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMisTorneos(){
  const el=document.getElementById('tab-mistorneos');
  const isAdmin=STATE.profile?.role==='admin';
  const torneos=[...STATE.torneos].sort((a,b)=>{
    const order={activo:0,Activo:0,borrador:1,Borrador:1,finalizado:2,Finalizado:2};
    return (order[a.estado]||1)-(order[b.estado]||1);
  });

  el.innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <div>
        <div class="text-15 font-bold" style="font-family:Georgia,serif;">Mis Torneos</div>
        <div class="text-12 text-muted">${torneos.length} torneo${torneos.length!==1?'s':''}</div>
      </div>
      <button class="btn-green" style="font-size:13px;padding:8px 16px;" onclick="openModalTorneo()">+ Nuevo</button>
    </div>
    ${torneos.length===0?`<div class="card"><div class="card-body" style="text-align:center;color:var(--muted);padding:40px;">
      <div style="font-size:48px;margin-bottom:12px;">â›³</div>
      <div style="margin-bottom:16px;">No tienes torneos aÃºn.</div>
      <button class="btn-green" onclick="openModalTorneo()">+ Crear primer torneo</button>
    </div></div>`:''}
    ${torneos.map(t=>{
      const tid=t.id;
      const isExpanded=STATE.expandedTorneo===tid;
      const rk=calcRankingTorneo(tid);
      const jornadasT=STATE.jornadas.filter(j=>j.torneo_id===tid||(!j.torneo_id&&tid===STATE.torneo?.id));
      const jugadas=jornadasT.filter(j=>j.estado!=='Planificada').length;
      const total=t.jornadas_total||jornadasT.length||'?';
      const myJugadorId=STATE.profile?.jugador_id;
      const myPos=rk.find(r=>r.id===myJugadorId);
      const isAdminT=isAdmin||(t.admins||[]).includes(STATE.user?.uid)||t.adminId===STATE.user?.uid;

      return`
      <div class="card" style="margin-bottom:12px;">
        <!-- Card header -->
        <div style="padding:16px 20px;cursor:pointer;display:flex;align-items:center;gap:14px;"
          onclick="toggleTorneoMis('${tid}')">
          <div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,var(--green),var(--teal));
            display:flex;align-items:center;justify-content:center;color:#fff;font-size:18px;flex-shrink:0;">â›³</div>
          <div class="flex-1">
            <div class="text-15 font-bold">${t.nombre}</div>
            <div class="text-12 text-muted">${jugadas}/${total} partidas Â· ${rk.length} jugadores</div>
            ${myPos?`<div class="text-11" style="color:var(--green);margin-top:2px;">Tu posiciÃ³n: #${myPos.pos} Â· ${myPos.ptsT} pts</div>`:''}
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
            ${badgeHTML(t.estado||'Activo')}
            <span style="color:var(--muted);font-size:13px;">${isExpanded?'â–²':'â–¼'}</span>
          </div>
        </div>

        ${isExpanded?`
        <!-- Ranking completo -->
        <div style="border-top:1px solid var(--border);">
          <div style="padding:14px 20px 4px;">
            <div class="text-11 text-muted font-bold" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">ğŸ“Š Ranking</div>
            <div class="rank-head"><span>#</span><span>Jugador</span><span>Asist.</span><span>Total</span></div>
            ${rk.map(j=>`
              <div class="rank-row ${j.pos<=3?'top':''}">
                <div>${medal(j.pos)}</div>
                <div class="flex items-center gap-8">
                  ${j.fotoURL?`<img src="${j.fotoURL}" style="width:28px;height:28px;border-radius:50%;object-fit:cover;flex-shrink:0;"/>`:avatarHTML(j.foto,j.pos,'sm')}
                  <div><div class="text-13 font-bold">${j.nombre}</div><div class="text-11 text-muted">${j.alias||''}</div></div>
                </div>
                <div class="text-13 text-muted">${j.asist}âœ“</div>
                <div style="font-size:15px;font-weight:800;color:${j.pos===1?'var(--gold)':'var(--text)'};">${j.ptsT}</div>
              </div>`).join('')}
          </div>

          <!-- Partidas del torneo â€” clickeables -->
          <div style="border-top:1px solid var(--border);padding:14px 20px 8px;">
            <div class="text-11 text-muted font-bold" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">ğŸ“… Partidas</div>
            ${jornadasT.length===0?`<div class="text-13 text-muted">Sin partidas aÃºn.</div>`:''}
            ${[...jornadasT].sort((a,b)=>{const fa=a.fecha&&typeof a.fecha==='object'&&a.fecha.seconds?new Date(a.fecha.seconds*1000):new Date(a.fecha||0);const fb=b.fecha&&typeof b.fecha==='object'&&b.fecha.seconds?new Date(b.fecha.seconds*1000):new Date(b.fecha||0);return fa-fb;}).map(jn=>jornadaRowMT(jn)).join('')}
          </div>

          <!-- Desglose por partida -->
          ${(()=>{
            const jJugadas=jornadasT.filter(j=>j.estado!=='Planificada');
            if(!jJugadas.length) return '';
            const minW=80+jJugadas.length*60;
            let html='<div style="border-top:1px solid var(--border);padding:14px 20px 8px;overflow-x:auto;">';
            html+='<div class="text-11 text-muted font-bold" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">Desglose por Partida</div>';
            html+='<table style="width:100%;border-collapse:collapse;font-size:12px;min-width:'+minW+'px;">';
            html+='<tr><td style="padding:4px 8px;color:var(--muted);font-weight:700;white-space:nowrap;">Jugador</td>';
            jJugadas.forEach(jn=>{html+='<td style="padding:4px 8px;text-align:center;color:var(--muted);font-weight:700;white-space:nowrap;">'+jn.sede+(jn.reglasOverride?' â­':'')+'<br/><span style="font-size:10px;opacity:0.75;">'+fmtFechaJornada(jn)+'</span><br/>'+badgeHTML(jn.estado)+'</td>';});
            html+='<td style="padding:4px 8px;text-align:center;color:var(--green);font-weight:700;">TOT</td></tr>';
            rk.forEach(j=>{
              html+='<tr style="border-top:1px solid var(--border);">';
              html+='<td style="padding:5px 8px;font-weight:600;white-space:nowrap;">'+j.nombre+'</td>';
              jJugadas.forEach(jn=>{
                const r=STATE.resultados.find(r=>r.jornada_id===jn.id&&r.jugador_id===j.id);
                const val=r?(r.asistencia?fmtPts(r.pts):'â€”'):'?';
                const col=r&&r.pts>=4?'var(--gold)':'var(--text)';
                html+='<td style="padding:5px 8px;text-align:center;color:'+col+';">'+val+'</td>';
              });
              html+='<td style="padding:5px 8px;text-align:center;font-weight:800;color:'+(j.pos===1?'var(--gold)':'var(--text)')+';">'+fmtPts(j.ptsT)+'</td>';
              html+='</tr>';
            });
            html+='</table></div>';
            return html;
          })()}

          <!-- Reglas del torneo -->
          <div style="border-top:1px solid var(--border);padding:14px 20px 8px;">
            <div class="text-11 text-muted font-bold" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">Reglas</div>
            ${reglasResumenHTML(t)}
            ${t.docURL?`<div style="margin-top:10px;">
              <a href="${t.docURL}" target="_blank" style="display:inline-flex;align-items:center;gap:8px;padding:8px 14px;background:var(--cardL);border-radius:8px;border:1px solid var(--border);color:var(--blue);font-size:13px;font-weight:600;text-decoration:none;">
                ${t.docType==='pdf'?'ğŸ“„ Ver reglamento / documento':'ğŸ–¼ï¸ Ver imagen del torneo'}
              </a>
            </div>`:''}
          </div>

          <!-- Acciones -->
          <div style="border-top:1px solid var(--border);padding:12px 20px;display:flex;gap:8px;flex-wrap:wrap;">
            ${isAdminT?`<button class="btn-green" style="font-size:12px;padding:7px 14px;" onclick="openModalJornada(null,'${tid}')">+ Partida</button>`:''}
            ${isAdminT?`<button class="btn-outline" style="font-size:12px;padding:7px 14px;" onclick="openModalEditTorneo('${tid}')">âœï¸ Editar torneo</button>`:''}
          </div>
        </div>`:``}
      </div>`;
    }).join('')}
  `;
}

function toggleTorneoMis(torneoId){
  STATE.expandedTorneo=STATE.expandedTorneo===torneoId?null:torneoId;
  STATE.activeTorneoId=torneoId;
  renderMisTorneos();
}

function toggleJornadaMT(jid){
  STATE.expandedJornadaMT=STATE.expandedJornadaMT===jid?null:jid;
  renderMisTorneos();
}

// Returns HTML string for a clickable partida row inside Mis Torneos
function jornadaRowMT(jn){
  const isOpen=STATE.expandedJornadaMT===jn.id;
  const est=getEstadoJornada(jn);
  const res=STATE.resultados.filter(r=>r.jornada_id===jn.id).sort((a,b)=>a.pos-b.pos);
  const hasResults=res.length>0;
  const hasFotos=Array.isArray(jn.fotos)&&jn.fotos.length>0;
  const isAdmin=STATE.profile?.role==='admin';

  // â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let html='<div style="border-radius:10px;overflow:hidden;margin-bottom:8px;border:1px solid '+(isOpen?'var(--green)':'var(--border)')+';">';
  html+='<div onclick="toggleJornadaMT(\''+jn.id+'\')" style="display:flex;align-items:center;gap:10px;padding:10px 12px;cursor:pointer;background:'+(isOpen?'#F1F8E9':'var(--white)')+';">';
  html+=clubAvatarHTML(jn.sede);
  html+='<div style="flex:1;min-width:0;">';
  html+='<div style="font-size:13px;font-weight:700;">'+(jn.sede||'Sin sede');
  if(jn.cuentaRanking===false) html+=' ğŸš«';
  if(jn.reglasOverride) html+=' <span style="background:#FEF3C7;color:#92400E;font-size:10px;font-weight:700;padding:1px 4px;border-radius:4px;">â­</span>';
  html+='</div>';
  html+='<div style="font-size:11px;color:var(--muted);margin-top:1px;">'+fmtFechaJornada(jn)+(jn.teeTime?' Â· â° '+jn.teeTime:'')+'</div>';
  html+='</div>';
  // Right side: badge + foto count + arrow
  html+='<div style="display:flex;align-items:center;gap:6px;flex-shrink:0;">';
  if(hasFotos) html+='<span style="background:#E3F2FD;color:#1565C0;font-size:10px;font-weight:700;padding:2px 6px;border-radius:10px;">ğŸ“·'+jn.fotos.length+'</span>';
  html+=badgeHTML(jn.estado);
  html+='<span style="color:var(--muted);font-size:12px;min-width:10px;">'+(isOpen?'â–²':'â–¼')+'</span>';
  html+='</div>';
  html+='</div>'; // end clickable header

  if(isOpen){
    // â”€â”€ RESULTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if(hasResults){
      html+='<div style="border-top:1px solid var(--border);background:var(--bg);">';
      res.forEach(function(r){
        const jug=STATE.jugadores.find(j=>j.id===r.jugador_id);
        const isTop=r.pos===1;
        const noAsist=!r.asistencia;
        const isDQ=r.dq;
        html+='<div style="display:flex;align-items:center;gap:10px;padding:9px 14px;border-bottom:1px solid var(--border);'+(isTop?'background:linear-gradient(90deg,#FFFDE7,transparent);':'')+(noAsist?'opacity:0.55;':'')+'">';
        html+='<div style="min-width:32px;text-align:center;">';
        if(r.pos<=3&&!noAsist&&!isDQ){
          html+='<span style="font-size:18px;">'+medal(r.pos)+'</span>';
        } else {
          html+='<span style="background:var(--border);border-radius:5px;padding:2px 6px;font-size:11px;font-weight:700;color:var(--muted);">'+(noAsist?'â€”':isDQ?'DQ':r.pos+'Â°')+'</span>';
        }
        html+='</div>';
        html+=avatarHTML(jug&&jug.foto?jug.foto:'?',r.pos,'sm');
        html+='<div style="flex:1;min-width:0;">';
        html+='<div style="font-size:13px;font-weight:600;">'+(jug?jug.nombre:'Desconocido')+'</div>';
        if(noAsist) html+='<div style="font-size:11px;color:var(--red);">No asistiÃ³</div>';
        if(isDQ) html+='<div style="font-size:11px;color:var(--red);">Descalificado</div>';
        html+='</div>';
        if(!noAsist) html+='<div style="font-size:16px;font-weight:800;color:'+(isTop?'#B8860B':'var(--text)')+';">'+fmtPts(r.pts)+'<span style="font-size:11px;font-weight:400;color:var(--muted);"> pts</span></div>';
        html+='</div>';
      });
      html+='</div>';
    } else {
      html+='<div style="padding:14px;text-align:center;color:var(--muted);font-size:12px;border-top:1px solid var(--border);">Sin resultados cargados aÃºn</div>';
    }

    // â”€â”€ FOTOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if(hasFotos){
      html+='<div style="border-top:1px solid var(--border);padding:12px 14px;background:#fafafa;">';
      html+='<div style="font-size:10px;font-weight:700;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;">ğŸ“¸ Fotos</div>';
      // Carousel container
      html+='<div style="position:relative;overflow:hidden;border-radius:10px;background:#111;cursor:pointer;" onclick="openCarousel(\''+jn.id+'\',0)">';
      html+='<div id="cmt_'+jn.id+'" style="display:flex;transition:transform 0.35s ease;">';
      jn.fotos.forEach(function(url){
        html+='<img src="'+url+'" style="width:100%;flex-shrink:0;aspect-ratio:4/3;object-fit:cover;" loading="lazy"/>';
      });
      html+='</div>';
      if(jn.fotos.length>1){
        html+='<button onclick="event.stopPropagation();slideCMT(\''+jn.id+'\',-1)" style="position:absolute;left:8px;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.5);border:none;color:#fff;font-size:26px;border-radius:50%;width:36px;height:36px;cursor:pointer;display:flex;align-items:center;justify-content:center;">&#8249;</button>';
        html+='<button onclick="event.stopPropagation();slideCMT(\''+jn.id+'\',1)" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.5);border:none;color:#fff;font-size:26px;border-radius:50%;width:36px;height:36px;cursor:pointer;display:flex;align-items:center;justify-content:center;">&#8250;</button>';
        html+='<div style="position:absolute;bottom:6px;left:50%;transform:translateX(-50%);display:flex;gap:5px;">';
        jn.fotos.forEach(function(_,di){
          html+='<div id="cmt_dot_'+jn.id+'_'+di+'" style="width:7px;height:7px;border-radius:50%;background:'+(di===0?'#fff':'rgba(255,255,255,0.4)')+';"></div>';
        });
        html+='</div>';
      }
      html+='</div></div>';
    }
  }

  html+='</div>';
  return html;
}


const _cmtIdx={};
function slideCMT(jid,dir){
  const t=document.getElementById('cmt_'+jid); if(!t) return;
  const n=t.querySelectorAll('img').length;
  _cmtIdx[jid]=((_cmtIdx[jid]||0)+dir+n)%n;
  t.style.transform='translateX(-'+(_cmtIdx[jid]*100)+'%)';
  for(let i=0;i<n;i++){const d=document.getElementById('cmt_dot_'+jid+'_'+i);if(d)d.style.background=i===_cmtIdx[jid]?'#fff':'rgba(255,255,255,0.4)';}
}

function reglasResumenHTML(torneo){
  const r=torneo.reglas||{};
  const pts=r.puntos||{1:4,2:3,3:2,resto:1};
  const items=[
    `Puntos: 1Â°=${pts[1]||4} Â· 2Â°=${pts[2]||3} Â· 3Â°=${pts[3]||2} Â· Resto=${pts.resto||1}`,
    r.bonusAsistencia?`Bonus asistencia: +${r.bonusAsistencia} pts`:'',
    r.penalNoAsistencia?`Penal no asistencia: ${r.penalNoAsistencia} pts`:'',
    r.penalDQ?`Penal DQ: ${r.penalDQ} pts`:'',
    r.descartes?`Descartes: ${r.descartes} peor(es) partida(s) no cuentan`:'',
    `Empates: ${r.empates==='comparten'?'Comparten puntos promedio':'PosiciÃ³n anterior'}`,
  ].filter(Boolean);
  return`<div style="display:flex;flex-direction:column;gap:4px;">
    ${items.map(i=>`<div class="text-12 text-muted">â€¢ ${i}</div>`).join('')}
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL TORNEO â€” Crear / Editar
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editingTorneoId = null;

function openModalTorneo(torneoId=null){
  editingTorneoId=torneoId;
  document.getElementById('modalTorneoError').style.display='none';
  const t=torneoId?STATE.torneos.find(t=>t.id===torneoId):null;
  document.getElementById('modalTorneoTitle').textContent=torneoId?'Editar Torneo':'Nuevo Torneo';

  // Info bÃ¡sica
  document.getElementById('tNombre').value=t?.nombre||'';
  // dates removed â€” managed through partidas
  document.getElementById('tJornadasTotal').value=t?.jornadas_total||'';
  document.getElementById('tEstado').value=t?.estado||'Activo';
  document.getElementById('tDescripcion').value=t?.descripcion||'';
  document.getElementById('tVisibilidad').value=t?.visibilidad||'privado';
  document.getElementById('tQuienCarga').value=t?.quienCargaResultados||'admins';

  // Reglas
  const r=t?.reglas||{};
  const pts=r.puntos||{};
  document.getElementById('rPts1').value=pts[1]!==undefined?pts[1]:4;
  document.getElementById('rPts2').value=pts[2]!==undefined?pts[2]:3;
  document.getElementById('rPts3').value=pts[3]!==undefined?pts[3]:2;
  document.getElementById('rPtsResto').value=pts.resto!==undefined?pts.resto:1;
  document.getElementById('rBonus').value=r.bonusAsistencia||0;
  document.getElementById('rPenalNoAsist').value=r.penalNoAsistencia||0;
  document.getElementById('rPenalDQ').value=r.penalDQ||0;
  document.getElementById('rDescartes').value=r.descartes||0;
  document.getElementById('rEmpates').value=r.empates||'comparten';

  updateEmpateEjemplo();

  // Load existing doc
  STATE._torneoDocURL=t?.docURL||null;
  STATE._torneoDocCleared=false;
  document.getElementById('tDocPreview').style.display='none';
  document.getElementById('tDocLabel').style.display='block';
  document.getElementById('tDocInput').value='';
  if(t?.docURL){
    document.getElementById('tDocExisting').style.display='flex';
    document.getElementById('tDocLink').href=t.docURL;
    document.getElementById('tDocLink').textContent=t.docType==='pdf'?'ğŸ“„ Ver reglamento':'ğŸ–¼ï¸ Ver imagen del torneo';
  } else {
    document.getElementById('tDocExisting').style.display='none';
  }

  // Load co-admins
  STATE._coAdmins=[...(t?.admins||[])].filter(uid=>uid!==STATE.user?.uid);
  renderAdminsList();

  // Hide co-admins section for new torneos (show after creation)
  document.getElementById('seccionAdmins').style.display=torneoId?'block':'none';
  document.getElementById('modalTorneo').style.display='flex';
}

// Alias for edit button
function openModalEditTorneo(torneoId){ openModalTorneo(torneoId); }

function renderAdminsList(){
  const el=document.getElementById('adminsList');
  if(!el)return;
  const admins=STATE._coAdmins||[];
  if(admins.length===0){
    el.innerHTML='<div class="text-12 text-muted">Sin co-administradores aÃºn.</div>';
    return;
  }
  el.innerHTML=admins.map(uid=>{
    const u=STATE._adminUsers?.[uid]||{};
    return`<div style="display:flex;align-items:center;gap:10px;padding:8px 10px;background:var(--bg);border-radius:8px;">
      <div style="width:28px;height:28px;border-radius:50%;background:var(--green);display:flex;align-items:center;justify-content:center;color:#fff;font-size:11px;font-weight:700;">${(u.nombre||uid).slice(0,2).toUpperCase()}</div>
      <div class="flex-1"><div class="text-12 font-bold">${u.nombre||uid}</div><div class="text-11 text-muted">${u.email||''}</div></div>
      <button onclick="removeCoAdmin('${uid}')" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px;">âœ•</button>
    </div>`;
  }).join('');
}

async function addCoAdmin(){
  const input=document.getElementById('addAdminInput');
  const errEl=document.getElementById('addAdminError');
  const val=input.value.trim();
  errEl.style.display='none';
  if(!val)return;

  try{
    // Search by email or username
    let snap;
    if(val.includes('@')&&val.includes('.')){
      snap=await db.collection('users').where('email','==',val).limit(1).get();
    } else {
      snap=await db.collection('users').where('username','==',val.replace('@','')).limit(1).get();
    }
    if(snap.empty){ errEl.textContent='Usuario no encontrado.'; errEl.style.display='block'; return; }
    const userData=snap.docs[0].data();
    const uid=snap.docs[0].id;
    if(STATE._coAdmins.includes(uid)||uid===STATE.user?.uid){
      errEl.textContent='Este usuario ya es admin.'; errEl.style.display='block'; return;
    }
    STATE._coAdmins.push(uid);
    if(!STATE._adminUsers) STATE._adminUsers={};
    STATE._adminUsers[uid]=userData;
    input.value='';
    renderAdminsList();
  }catch(e){ errEl.textContent='Error: '+e.message; errEl.style.display='block'; }
}

function removeCoAdmin(uid){
  STATE._coAdmins=(STATE._coAdmins||[]).filter(u=>u!==uid);
  renderAdminsList();
}

function closeModalTorneo(event){
  if(event&&event.currentTarget!==event.target)return;
  document.getElementById('modalTorneo').style.display='none';
  editingTorneoId=null;
}

function updateEmpateEjemplo(){
  const el=document.getElementById('empateEjemplo');
  if(!el)return;
  const tipo=(document.getElementById('rEmpates')?.value)||'comparten';
  const pts1=Number(document.getElementById('rPts1')?.value)||4;
  const pts2=Number(document.getElementById('rPts2')?.value)||3;
  const pts3=Number(document.getElementById('rPts3')?.value)||2;
  if(tipo==='comparten'){
    const avg2=((pts1+pts2)/2).toFixed(1);
    const avg3=((pts1+pts2+pts3)/3).toFixed(1);
    el.innerHTML=
      `<strong>2 empatados en 1Â°:</strong> ${avg2} pts c/u â†’ siguiente toma 3Â°<br>`+
      `<strong>3 empatados en 1Â°:</strong> ${avg3} pts c/u â†’ siguiente toma 4Â°`;
  } else {
    el.innerHTML=
      `<strong>2 empatados en 1Â°:</strong> ambos reciben ${pts1} pts â†’ siguiente toma 3Â°<br>`+
      `<strong>3 empatados en 1Â°:</strong> todos reciben ${pts1} pts â†’ siguiente toma 4Â°`;
  }
}

async function saveModalTorneo(){
  const nombre=document.getElementById('tNombre').value.trim();
  const err=document.getElementById('modalTorneoError');
  const btn=document.getElementById('btnGuardarTorneo');
  err.style.display='none';

  if(!nombre){ err.textContent='El nombre es obligatorio.'; err.style.display='block'; return; }

  btn.disabled=true; btn.textContent='Guardando...';
  try{
    // Upload doc if selected
    let docURL=STATE._torneoDocURL||null;
    let docType='';
    const docFile=document.getElementById('tDocInput').files[0];
    if(docFile){
      const path='torneos/'+(editingTorneoId||Date.now())+'_doc'+(docFile.type==='application/pdf'?'.pdf':'.jpg');
      if(docFile.type==='application/pdf'){
        docURL=await uploadPhoto(docFile,path,'tDocProgress');
        docType='pdf';
      } else {
        const comp=await resizeAndCompress(docFile,1200,0.85);
        docURL=await uploadPhoto(comp,path,'tDocProgress');
        docType='img';
      }
    }
    if(STATE._torneoDocCleared){ docURL=null; docType=''; }
    const data={
      nombre,
      ...(docURL?{docURL,docType}:{}),
      jornadas_total:Number(document.getElementById('tJornadasTotal').value)||0,
      estado:document.getElementById('tEstado').value,
      descripcion:document.getElementById('tDescripcion').value.trim(),
      visibilidad:document.getElementById('tVisibilidad').value,
      quienCargaResultados:document.getElementById('tQuienCarga').value,
      reglas:{
        puntos:{
          1:Number(document.getElementById('rPts1').value)||4,
          2:Number(document.getElementById('rPts2').value)||3,
          3:Number(document.getElementById('rPts3').value)||2,
          resto:Number(document.getElementById('rPtsResto').value)||1,
        },
        bonusAsistencia:Number(document.getElementById('rBonus').value)||0,
        penalNoAsistencia:Number(document.getElementById('rPenalNoAsist').value)||0,
        penalDQ:Number(document.getElementById('rPenalDQ').value)||0,
        descartes:Number(document.getElementById('rDescartes').value)||0,
        empates:document.getElementById('rEmpates').value||'comparten',
      }
    };

    if(editingTorneoId){
      data.updated_at=firebase.firestore.FieldValue.serverTimestamp();
      // Keep original adminId, update admins list
      const origTorneo=STATE.torneos.find(t=>t.id===editingTorneoId);
      data.admins=[origTorneo?.adminId||STATE.user.uid,...(STATE._coAdmins||[])];
      await db.collection('torneos').doc(editingTorneoId).update(data);
    } else {
      data.adminId=STATE.user.uid;
      data.admins=[STATE.user.uid];
      data.creado=firebase.firestore.FieldValue.serverTimestamp();
      const ref=await db.collection('torneos').add(data);
      STATE.activeTorneoId=ref.id;
    }
    closeModalTorneo();
    goTab('mistorneos');
  }catch(e){
    err.textContent='Error: '+e.message; err.style.display='block';
  }finally{
    btn.disabled=false; btn.textContent='Guardar Torneo';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RANKING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRanking(){
  const el=document.getElementById('tab-ranking');
  const torneoId=STATE.activeTorneoId||STATE.torneos[0]?.id||null;
  if(!torneoId||STATE.torneos.length===0){
    el.innerHTML='<div class="card"><div class="card-body" style="text-align:center;color:var(--muted);padding:40px;">Sin torneos.<br/><button class="btn-green" style="margin-top:12px;" onclick="openModalTorneo()">+ Crear Torneo</button></div></div>';
    return;
  }
  const torneo=STATE.torneos.find(t=>t.id===torneoId)||STATE.torneos[0];
  const rk=calcRankingTorneo(torneoId);
  const jornadasT=STATE.jornadas.filter(j=>j.torneo_id===torneoId||(!j.torneo_id&&torneoId===STATE.torneo?.id));
  const oficiales=jornadasT.filter(j=>j.estado==='Oficial').length;
  const jugadasAll=jornadasT.filter(j=>j.estado!=='Planificada');
  const selectorOpts=STATE.torneos.map(t=>`<option value="${t.id}" ${t.id===torneoId?'selected':''}>${t.nombre}</option>`).join('');

  el.innerHTML=`
    <div style="margin-bottom:14px;">
      <label class="form-label">Torneo</label>
      <select class="form-select" style="width:100%;font-size:14px;" onchange="STATE.activeTorneoId=this.value;renderRanking()">
        ${selectorOpts}
      </select>
    </div>
    <div class="card">
      <div class="card-header">
        <span class="card-title">ğŸ† ${torneo.nombre}</span>
        <span class="text-11 text-muted">${oficiales}/${jugadasAll.length} partidas oficiales</span>
      </div>
      <div class="rank-head"><span>#</span><span>Jugador</span><span>Asist.</span><span>Total</span></div>
      ${rk.map(j=>`
        <div class="rank-row ${j.pos<=3?'top':''}">
          <div>${medal(j.pos)}</div>
          <div class="flex items-center gap-8">${j.fotoURL?`<img src="${j.fotoURL}" style="width:32px;height:32px;border-radius:50%;object-fit:cover;flex-shrink:0;border:2px solid ${j.pos===1?'var(--gold)':'var(--border)'}"/>`:avatarHTML(j.foto,j.pos,'sm')}<div><div class="text-13 font-bold">${j.nombre}</div><div class="text-11 text-muted">${j.alias||''}</div></div></div>
          <div class="text-13 text-muted">${j.asist}âœ“</div>
          <div style="font-size:15px;font-weight:800;color:${j.pos===1?'var(--gold)':'var(--text)'};">${fmtPts(j.ptsT)}</div>
        </div>`).join('')}
    </div>
    ${jugadasAll.length>0?`
    <div class="card">
      <div class="card-header"><span class="card-title">ğŸ“Š Desglose por Partida</span></div>
      <div style="overflow-x:auto;padding:12px;">
        <table class="breakdown-table" style="min-width:${100+jugadasAll.length*80}px;">
          <tr>
            <td style="padding:6px 8px;color:var(--muted);font-weight:700;white-space:nowrap;">Jugador</td>
            ${jugadasAll.map(jn=>`<td style="padding:6px 8px;text-align:center;color:var(--muted);font-weight:700;white-space:nowrap;min-width:70px;">${jn.sede}<br/>${badgeHTML(jn.estado)}</td>`).join('')}
            <td style="padding:6px 8px;text-align:center;color:var(--green);font-weight:700;">TOTAL</td>
          </tr>
          ${rk.map(j=>`
            <tr>
              <td style="padding:8px;font-weight:600;white-space:nowrap;">${j.nombre}</td>
              ${jugadasAll.map(jn=>{const r=STATE.resultados.find(r=>r.jornada_id===jn.id&&r.jugador_id===j.id);const val=r?(r.asistencia?fmtPts(r.pts):'â€”'):'?';const col=r&&r.pts>=4?'var(--gold)':'var(--text)';return`<td style="padding:8px;text-align:center;color:${r?col:'var(--muted)'};">${val}</td>`;}).join('')}
              <td style="padding:8px;text-align:center;font-weight:800;color:${j.pos===1?'var(--gold)':'var(--text)'};">${fmtPts(j.ptsT)}</td>
            </tr>`).join('')}
        </table>
      </div>
    </div>`:''}
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JORNADAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Helper: club avatar for partida list
function clubAvatarHTML(sede){
  const cl=STATE.clubes.find(c=>c.nombre===sede);
  const bg=cl?.color||'#2E7D5E';
  const ini=cl?.iniciales||sede?.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,3)||'â›³';
  if(cl?.fotoURL) return`<img src="${cl.fotoURL}" style="width:42px;height:42px;border-radius:10px;object-fit:cover;flex-shrink:0;border:1px solid var(--border);"/>`;
  return`<div style="width:42px;height:42px;border-radius:10px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:12px;color:#fff;background:${bg};">${ini}</div>`;
}

function renderJornadas(){
  const el=document.getElementById('tab-jornadas');
  const isAdmin=STATE.profile?.role==='admin';
  // Show only partidas from torneos the user is in
  const misTorneoIds=new Set(STATE.torneos.map(t=>t.id));
  const misJornadas=STATE.jornadas.filter(j=>!j.torneo_id||misTorneoIds.has(j.torneo_id));
  const jornadasOrdenadas=[...misJornadas].sort((a,b)=>{
    const da=a.fecha?(typeof a.fecha==='object'&&a.fecha.seconds?new Date(a.fecha.seconds*1000):new Date(a.fecha)):null;
    const db_=b.fecha?(typeof b.fecha==='object'&&b.fecha.seconds?new Date(b.fecha.seconds*1000):new Date(b.fecha)):null;
    if(!da) return 1; if(!db_) return -1;
    return da-db_;
  });

  el.innerHTML=`
    <div style="margin-bottom:14px;">
      <div class="text-15 font-bold" style="font-family:Georgia,serif;">Mis Partidas</div>
      <div class="text-12 text-muted">Partidas de los torneos en que participas</div>
    </div>
    ${jornadasOrdenadas.length===0?`<div class="card"><div class="card-body" style="text-align:center;color:var(--muted);padding:40px;">No hay partidas creadas aÃºn.</div></div>`:''}
    ${jornadasOrdenadas.map(jn=>{
      const res=STATE.resultados.filter(r=>r.jornada_id===jn.id).sort((a,b)=>a.pos-b.pos);
      const isOpen=STATE.expandedJornada===jn.id;
      const cargador=STATE.jugadores.find(j=>j.id===jn.cargado_por);
      const attestador=STATE.jugadores.find(j=>j.id===jn.attest_por);
      const myJugadorId=STATE.profile?.jugador_id;
      const est=getEstadoJornada(jn);  // live computed estado
      const canAttest=(est==='Pendiente Attest'||est==='Por Validar')&&jn.cargado_por!==myJugadorId&&(isAdmin||STATE.resultados.some(r=>r.jornada_id===jn.id&&r.jugador_id===myJugadorId));

      return`
        <div class="partida-card" style="${est==='Jugado'||est==='Por Validar'?'border:2px solid #C8E6C9;':est==='En Juego'?'border:2px solid #FFE082;':''}">
          <div class="partida-header" onclick="toggleJornada('${jn.id}')" style="${est==='Jugado'||est==='Por Validar'?'background:linear-gradient(135deg,#F1F8E9,#E8F5E9);':est==='En Juego'?'background:linear-gradient(135deg,#FFFDE7,#FFF8E1);':''}"  >
            <div class="flex items-center gap-10" style="flex:1;min-width:0;">
              ${clubAvatarHTML(jn.sede)}
              <div style="flex:1;min-width:0;">
                <div class="text-14 font-bold" style="line-height:1.3;">
                  ${jn.sede||'Sin sede'}${jn.cuentaRanking===false?' ğŸš«':''}${jn.reglasOverride?` <span style="background:#FEF3C7;color:#92400E;font-size:10px;font-weight:700;padding:1px 5px;border-radius:4px;white-space:nowrap;">â­ Especial</span>`:''}
                </div>
                <div style="font-size:12px;color:var(--text2);font-weight:600;margin-top:2px;">${fmtFechaJornada(jn)}${jn.teeTime?' Â· â° '+jn.teeTime:''}</div>
                ${jn.notas?`<div class="text-11 text-muted">${jn.notas}</div>`:''}
                ${(()=>{const t=STATE.torneos.find(t=>t.id===jn.torneo_id);return t?`<div class="text-11" style="color:var(--green);font-weight:600;margin-top:1px;">ğŸ† ${t.nombre}</div>`:'';})()} 
              </div>
              ${jn.fotos&&jn.fotos.length>0?`<div style="display:flex;flex-direction:row;gap:0;flex-shrink:0;margin-left:4px;cursor:pointer;" onclick="event.stopPropagation();toggleJornada('${jn.id}')">${jn.fotos.slice(0,3).map((url,fi)=>'<img src="'+url+'" style="width:34px;height:34px;object-fit:cover;border-radius:6px;border:2px solid var(--white);'+(fi>0?'margin-left:-8px;':'')+'box-shadow:0 1px 3px rgba(0,0,0,0.15);"/>').join('')}</div>`:''}
            </div>
            <div class="flex items-center gap-6" style="flex-shrink:0;margin-left:8px;">
              ${badgeHTML(est)}
              ${isAdmin?`<button class="btn-outline" style="padding:4px 10px;font-size:12px;" onclick="event.stopPropagation();openModalJornada('${jn.id}')">âœï¸</button>`:''}
              <span style="color:var(--muted);font-size:13px;">${isOpen?'â–²':'â–¼'}</span>
            </div></div>
          ${isOpen?`
            <div class="partida-body">
              <div class="partida-actions">
                ${est==='En Juego'?`<button class="btn-primary" onclick="goCargar('${jn.id}')">ğŸ“‹ Cargar Resultados</button>`:''}
                ${est==='Planificada'?`<div class="text-11 text-muted" style="padding:4px 0;">â³ AÃºn no es el dÃ­a de juego</div>`:''}
                ${(est==='Pendiente Attest'||est==='Por Validar')&&canAttest?`<button class="btn-attest" onclick="handleAttest('${jn.id}')">âœï¸ Marcar como Jugada</button>`:''}
                ${(est==='Pendiente Attest'||est==='Por Validar')&&!canAttest&&res.length>0?`<div class="text-11 text-muted" style="padding:4px 0;">â³ Esperando confirmaciÃ³n</div>`:''}
                ${(est==='Pendiente Attest'||est==='Por Validar')?`<button class="btn-outline" onclick="goCargar('${jn.id}')">âœï¸ Editar resultados</button>`:''}
                ${isAdmin?`<button class="btn-danger" onclick="deleteJornada('${jn.id}')">ğŸ—‘ï¸ Eliminar</button>`:''}
              </div>
              ${res.length>0?`
                ${res.map(r=>{
                  const jug=STATE.jugadores.find(j=>j.id===r.jugador_id);
                  const isTop=r.pos===1;
                  const isDQ=r.dq;
                  const noAsistio=!r.asistencia;
                  return`
                  <div class="result-row" style="${isTop?'background:linear-gradient(135deg,#FFFDE7,#FFF9C4);border-color:#F9A825;':''}${noAsistio?'opacity:0.6;':''}">
                    <div style="min-width:28px;text-align:center;">
                      ${r.pos<=3&&!noAsistio&&!isDQ?`<span style="font-size:20px;">${medal(r.pos)}</span>`:`<span style="background:var(--bg);border-radius:6px;padding:2px 6px;font-size:12px;font-weight:700;color:var(--muted);">${noAsistio?'â€“':isDQ?'DQ':r.pos+'Â°'}</span>`}
                    </div>
                    ${avatarHTML(jug?.foto||'?',r.pos,'sm')}
                    <div class="flex-1">
                      <div class="text-13 font-bold">${jug?.nombre||'Desconocido'}</div>
                      ${noAsistio?`<div class="text-11" style="color:var(--red);">No asistiÃ³</div>`:''}
                      ${isDQ?`<div class="text-11" style="color:var(--red);">Descalificado</div>`:''}
                    </div>
                    ${!noAsistio?`<div style="font-size:17px;font-weight:800;color:${isTop?'#B8860B':'var(--text)'};">${fmtPts(r.pts)}<span style="font-size:11px;font-weight:400;color:var(--muted);"> pts</span></div>`:''}
                  </div>`;}).join('')}
                <div style="margin-top:10px;padding:8px 12px;background:var(--cardL);border-radius:8px;font-size:11px;color:var(--muted);border:1px solid var(--border);">
                  ${cargador?`ğŸ“‹ Cargado por <strong style="color:var(--text);">${cargador.nombre}</strong>`:''}
                  ${attestador?` Â· âœï¸ Attest: <strong style="color:#7B1FA2;">${attestador.nombre}</strong>`:''}
                </div>
` 
              :`<div style="padding:20px 0;text-align:center;color:var(--muted);font-size:13px;">
                ${jn.estado==='Planificada'?'â³ Pendiente Â· Presiona "Cargar Resultados" al finalizar':'Sin resultados cargados'}
              </div>`}
              ${jn.fotos&&jn.fotos.length>0?`
              <div style="margin-top:12px;">
                <div class="text-11 text-muted font-bold" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;">ğŸ“¸ Fotos del dÃ­a</div>
                <div style="position:relative;overflow:hidden;border-radius:12px;background:#111;cursor:pointer;" onclick="openCarousel('${jn.id}',0)">
                  <div id="carouselTrack_${jn.id}" style="display:flex;transition:transform 0.35s ease;">
                    ${jn.fotos.map(url=>'<img src="'+url+'" style="width:100%;flex-shrink:0;aspect-ratio:4/3;object-fit:cover;"/>').join('')}
                  </div>
                  ${jn.fotos.length>1?`
                  <button onclick="event.stopPropagation();slideCarousel('${jn.id}',-1)"
                    style="position:absolute;left:8px;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.5);border:none;color:#fff;font-size:26px;border-radius:50%;width:38px;height:38px;cursor:pointer;line-height:1;display:flex;align-items:center;justify-content:center;">&#8249;</button>
                  <button onclick="event.stopPropagation();slideCarousel('${jn.id}',1)"
                    style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.5);border:none;color:#fff;font-size:26px;border-radius:50%;width:38px;height:38px;cursor:pointer;line-height:1;display:flex;align-items:center;justify-content:center;">&#8250;</button>
                  <div style="position:absolute;bottom:6px;left:50%;transform:translateX(-50%);display:flex;gap:5px;">
                    ${jn.fotos.map((_,di)=>`<div id="dot_${jn.id}_${di}" style="width:7px;height:7px;border-radius:50%;background:${di===0?'#fff':'rgba(255,255,255,0.4)'}"></div>`).join('')}
                  </div>`:''}
                </div>
              </div>`:''}
            </div>`:``}
        </div>`;
    }).join('')}
  `;
}

function toggleJornada(id){ STATE.expandedJornada=STATE.expandedJornada===id?null:id; renderJornadas(); }

async function handleAttest(jornadaId){
  await db.collection('jornadas').doc(jornadaId).update({
    estado:'Jugado', attest_por:STATE.profile?.jugador_id||STATE.user.uid,
    attest_at:firebase.firestore.FieldValue.serverTimestamp()
  });
}
async function handleAprobar(jornadaId){
  await db.collection('jornadas').doc(jornadaId).update({
    estado:'Oficial', aprobado_por:STATE.user.uid,
    aprobado_at:firebase.firestore.FieldValue.serverTimestamp()
  });
}
async function deleteJornada(id){
  if(!confirm('Â¿Eliminar esta partida y sus resultados?'))return;
  const batch=db.batch();
  batch.delete(db.collection('jornadas').doc(id));
  STATE.resultados.filter(r=>r.jornada_id===id).forEach(r=>batch.delete(db.collection('resultados').doc(r.id)));
  await batch.commit();
}

function previewTorneoDoc(input){
  const file=input.files[0];
  if(!file)return;
  const isPDF=file.type==='application/pdf';
  const box=document.getElementById('tDocBox');
  document.getElementById('tDocLabel').textContent=isPDF?'ğŸ“„ '+file.name:'ğŸ–¼ï¸ '+file.name;
  if(!isPDF){
    const reader=new FileReader();
    reader.onload=e=>{
      document.getElementById('tDocPreview').src=e.target.result;
      document.getElementById('tDocPreview').style.display='block';
    };
    reader.readAsDataURL(file);
  }
}

function clearTorneoDoc(){
  STATE._torneoDocURL=null;
  STATE._torneoDocCleared=true;
  document.getElementById('tDocExisting').style.display='none';
  document.getElementById('tDocInput').value='';
  document.getElementById('tDocPreview').style.display='none';
  document.getElementById('tDocLabel').textContent='ğŸ“ Toca para subir PDF, imagen o reglamento';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL JORNADA â€” Crear / Editar
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModalJornada(jornadaId=null, torneoId=null){
  STATE.editingJornadaId=jornadaId;
  if(torneoId) STATE._modalTorneoId=torneoId;
  else STATE._modalTorneoId=STATE.activeTorneoId||STATE.torneo?.id||null;
  const modal=document.getElementById('modalJornada');
  const title=document.getElementById('modalJornadaTitle');
  const err=document.getElementById('modalJornadaError');
  err.style.display='none';

  // Populate club select
  const sel=document.getElementById('jornadaClub');
  sel.innerHTML=`<option value="">â€” Selecciona un club â€”</option>`+
    STATE.clubes.map(c=>`<option value="${c.nombre}">${c.nombre}</option>`).join('');

  if(jornadaId){
    title.textContent='Editar Partida';
    const jn=STATE.jornadas.find(j=>j.id===jornadaId);
    if(jn){
      document.getElementById('jornadaClub').value=jn.sede||'';
      document.getElementById('jornadaFecha').value=jn.fecha||'';
      // estado managed automatically
      document.getElementById('jornadaNotas').value=jn.notas||'';
      const tParts=(jn.teeTime||'').split(':');
      if(document.getElementById('teeHH')) document.getElementById('teeHH').value=tParts[0]||'07';
      if(document.getElementById('teeMM')) document.getElementById('teeMM').value=tParts[1]||'00';
    }
  } else {
    title.textContent='Nueva Partida';
    document.getElementById('jornadaClub').value='';
    document.getElementById('jornadaFecha').value='';
    // estado is automatic
    document.getElementById('jornadaNotas').value='';
    if(document.getElementById('teeHH')) document.getElementById('teeHH').value='07';
    if(document.getElementById('teeMM')) document.getElementById('teeMM').value='00';
  }
  modal.style.display='flex';
}


function resetJornadaFotoSlot(i){
  const slot=document.getElementById('jornadaFotoSlot'+i);
  if(!slot)return;
  slot.innerHTML=`
    <div class="photo-upload-box" style="height:80px;padding:8px;" onclick="document.getElementById('jornadaFotoInput${i}').click()">
      <div style="font-size:22px;">ğŸ“·</div>
      <div style="font-size:10px;color:var(--muted);">Foto ${i+1}</div>
      <input type="file" id="jornadaFotoInput${i}" accept="image/*" onchange="previewJornadaFoto(this,${i})"/>
    </div>`.replace(/\${i}/g,i).replace(/\${i\+1}/g,i+1);
}

function setJornadaFotoSlot(i,url){
  const slot=document.getElementById('jornadaFotoSlot'+i);
  if(!slot)return;
  slot.innerHTML=`
    <img src="${url}" style="width:100%;height:80px;object-fit:cover;border-radius:8px;border:1px solid var(--border);"/>
    <button class="del-photo" onclick="delJornadaFoto(${i})">âœ•</button>`;
}

function previewJornadaFoto(input,i){
  const file=input.files[0];
  if(!file)return;
  // Store the File object so saveResultados can access it even after DOM changes
  if(!STATE._jornadaFotoFiles) STATE._jornadaFotoFiles=[null,null,null];
  STATE._jornadaFotoFiles[i]=file;
  const reader=new FileReader();
  reader.onload=e=>{
    const slot=document.getElementById('jornadaFotoSlot'+i);
    if(!slot)return;
    // Show preview image + delete btn, keep hidden input alive for re-selection
    slot.innerHTML='<div style="position:relative;width:100%;height:80px;">'
      +'<img src="'+e.target.result+'" style="width:100%;height:80px;object-fit:cover;border-radius:8px;border:1px solid var(--border);"/>'
      +'<button class="del-photo" onclick="delJornadaFoto('+i+')" style="position:absolute;top:2px;right:2px;">âœ•</button>'
      +'<input type="file" id="jornadaFotoInput'+i+'" accept="image/*" style="position:absolute;inset:0;opacity:0;cursor:pointer;" onchange="previewJornadaFoto(this,'+i+')">'
      +'</div>';
  };
  reader.readAsDataURL(file);
}

function delJornadaFoto(i){
  if(STATE._jornadaFotosExistentes) STATE._jornadaFotosExistentes[i]=null;
  if(STATE._jornadaFotoFiles) STATE._jornadaFotoFiles[i]=null;
  resetJornadaFotoSlot(i);
}

function closeModalJornada(event){
  if(event&&event.currentTarget!==event.target)return;
  document.getElementById('modalJornada').style.display='none';
  STATE.editingJornadaId=null;
}

async function saveJornada(){
  const club=document.getElementById('jornadaClub').value.trim();
  const fecha=document.getElementById('jornadaFecha').value;
  // Estado is automatic â€” read from existing partida when editing, or 'Planificada' for new
  const _existingJornada=STATE.editingJornadaId?STATE.jornadas.find(j=>j.id===STATE.editingJornadaId):null;
  const estado=_existingJornada?.estado||'Planificada';
  const notas=document.getElementById('jornadaNotas').value.trim();
  const teeHH=document.getElementById('teeHH')?.value||'';
  const teeMM=document.getElementById('teeMM')?.value||'00';
  const teeTime=teeHH?(teeHH+':'+teeMM):'';
  const cuentaRanking=document.getElementById('jornadaCuentaRanking')?.checked!==false;
  const tieneReglasEsp=document.getElementById('jornadaReglasEspeciales')?.checked||false;
  const reglasOverride=tieneReglasEsp?{
    puntos:{
      1:Number(document.getElementById('jrPts1')?.value)||4,
      2:Number(document.getElementById('jrPts2')?.value)||3,
      3:Number(document.getElementById('jrPts3')?.value)||2,
      resto:Number(document.getElementById('jrPtsResto')?.value)||1,
    },
    bonusAsistencia:Number(document.getElementById('jrBonus')?.value)||0,
    penalNoAsistencia:Number(document.getElementById('jrPenalNoAsist')?.value)||0,
    penalDQ:Number(document.getElementById('jrPenalDQ')?.value)||0,
  }:null;
  const err=document.getElementById('modalJornadaError');
  const btn=document.getElementById('btnGuardarJornada');
  err.style.display='none';

  if(!club){err.textContent='Selecciona un club.';err.style.display='block';return;}
  if(!fecha){err.textContent='La fecha es obligatoria.';err.style.display='block';return;}

  btn.disabled=true; btn.textContent='Guardando...';
  try{
    // Upload new photos (slots with new files)
    let fotos=[...(STATE._jornadaFotosExistentes||[])];
    for(let i=0;i<3;i++){
      const fi=document.getElementById('jornadaFotoInput'+i);
      if(fi&&fi.files&&fi.files[0]){
        const jid=STATE.editingJornadaId||'new_'+Date.now();
        const compressed=await resizeAndCompress(fi.files[0],1200,0.82);
        const url=await uploadPhoto(compressed,`jornadas/${jid}_foto${i}.jpg`,'jornadaFotoProgress');
        fotos[i]=url;
      }
    }
    fotos=fotos.filter(Boolean);

    if(STATE.editingJornadaId){
      await db.collection('jornadas').doc(STATE.editingJornadaId).update({
        sede:club, fecha, estado, notas, teeTime, fotos, cuentaRanking,
        ...(reglasOverride?{reglasOverride}:{reglasOverride:null}),
        updated_at:firebase.firestore.FieldValue.serverTimestamp()
      });
    } else {
      const numero=(STATE.jornadas.length>0?Math.max(...STATE.jornadas.map(j=>j.numero||0)):0)+1;
      const torneoIdParaJornada=STATE._modalTorneoId||STATE.activeTorneoId||STATE.torneo?.id||'';
      await db.collection('jornadas').add({
        numero, nombre:`J${numero}`, sede:club, fecha, estado, notas, teeTime, fotos,
        cuentaRanking, ...(reglasOverride?{reglasOverride}:{}),
        torneo_id:torneoIdParaJornada,
        creado:firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    document.getElementById('modalJornada').style.display='none';
    STATE.editingJornadaId=null;
  } catch(e){
    err.textContent='Error al guardar: '+e.message; err.style.display='block';
  } finally{ btn.disabled=false; btn.textContent='Guardar Partida'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLUBES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editingClubId=null;

function renderClubes(){
  const el=document.getElementById('tab-clubes');
  const isAdmin=STATE.profile?.role==='admin';
  el.innerHTML=`
    ${isAdmin?`<div style="display:flex;justify-content:flex-end;margin-bottom:16px;">
      <button class="btn-green" onclick="openModalClub()">+ Agregar Club</button>
    </div>`:''}
    ${STATE.clubes.length===0?`<div class="card"><div class="card-body" style="text-align:center;color:var(--muted);padding:40px;">No hay clubes registrados.</div></div>`:''}
    <div style="display:flex;flex-direction:column;gap:10px;">
      ${STATE.clubes.map(club=>{
        const bg=club.color||'#2E7D5E';
        const ini=club.iniciales||club.nombre.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,3);
        const avatarEl=club.fotoURL
          ?`<img src="${club.fotoURL}" style="width:44px;height:44px;border-radius:10px;object-fit:cover;flex-shrink:0;border:1px solid var(--border);"/>`
          :`<div style="width:44px;height:44px;border-radius:10px;background:${bg};display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:13px;flex-shrink:0;">${ini}</div>`;
        return`
        <div class="card" style="margin-bottom:0;">
          <div style="padding:14px 18px;display:flex;align-items:center;gap:14px;">
            ${avatarEl}
            <div class="flex-1">
              <div class="text-14 font-bold">${club.nombre}</div>
              <div class="text-12 text-muted">${club.ciudad||'â€”'}</div>
            </div>
            ${isAdmin?`
              <button class="btn-outline" style="padding:5px 12px;font-size:12px;" onclick="openModalClub('${club.id}')">âœï¸ Editar</button>
              <button class="btn-danger" onclick="deleteClub('${club.id}','${club.nombre}')">Eliminar</button>
            `:''}
          </div>
        </div>`}).join('')}
    </div>
  `;
}

function openModalClub(clubId=null){
  editingClubId=clubId;
  document.getElementById('modalClubError').style.display='none';
  if(clubId){
    document.getElementById('modalClubTitle').textContent='Editar Club';
    const club=STATE.clubes.find(c=>c.id===clubId);
    if(club){
      document.getElementById('clubNombre').value=club.nombre||'';
      document.getElementById('clubCiudad').value=club.ciudad||'';
      document.getElementById('clubIniciales').value=club.iniciales||'';
      document.getElementById('clubColor').value=club.color||'#2E7D5E';
    }
  } else {
    document.getElementById('modalClubTitle').textContent='Nuevo Club';
    document.getElementById('clubNombre').value='';
    document.getElementById('clubCiudad').value='';
    document.getElementById('clubIniciales').value='';
    document.getElementById('clubColor').value='#2E7D5E';
  }
  document.getElementById('modalClub').style.display='flex';
}

function closeModalClub(){ document.getElementById('modalClub').style.display='none'; editingClubId=null; }

async function saveClub(){
  const nombre=document.getElementById('clubNombre').value.trim();
  const ciudad=document.getElementById('clubCiudad').value.trim();
  const iniciales=document.getElementById('clubIniciales').value.trim().toUpperCase().slice(0,3);
  const color=document.getElementById('clubColor').value;
  const err=document.getElementById('modalClubError');
  const btn=document.getElementById('btnGuardarClub');
  if(!nombre){err.textContent='El nombre es obligatorio.';err.style.display='block';return;}
  btn.disabled=true; btn.textContent='Guardando...';
  try{
    const ini=iniciales||nombre.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,3);
    const data={nombre,ciudad,iniciales:ini,color};
    // Upload photo if selected
    const fileInput=document.getElementById('clubFotoInput');
    if(fileInput.files&&fileInput.files[0]){
      const compressed=await resizeAndCompress(fileInput.files[0],800);
      const path='clubes/'+(editingClubId||Date.now())+'.jpg';
      data.fotoURL=await uploadPhoto(compressed,path,'clubFotoProgress');
    }
    if(editingClubId){
      data.updated_at=firebase.firestore.FieldValue.serverTimestamp();
      await db.collection('clubes').doc(editingClubId).update(data);
    } else {
      data.creado=firebase.firestore.FieldValue.serverTimestamp();
      await db.collection('clubes').add(data);
    }
    closeModalClub();
  }catch(e){err.textContent='Error: '+e.message;err.style.display='block';}
  finally{btn.disabled=false;btn.textContent='Guardar Club';}
}

async function deleteClub(id,nombre){
  if(!confirm(`Â¿Eliminar el club "${nombre}"?`))return;
  await db.collection('clubes').doc(id).delete();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARGAR RESULTADOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cargarEntries=[];

// â”€â”€ CARGAR STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let cargarStep=1; // 1=participantes, 2=posiciones
let cargarParticipantes=[]; // {jugador_id, jugador, asistio, dq}
let cargarPosiciones=[];    // [{pos, jugador_id, empate}] ordered list

function renderCargar(){
  const el=document.getElementById('tab-cargar');
  const jornadaId=STATE.cargarJornadaId;
  const partida=STATE.jornadas.find(j=>j.id===jornadaId);
  if(!partida){el.innerHTML='<p style="color:var(--muted);padding:20px;">Partida no encontrada.</p>';return;}

  // Init participantes if first load
  if(cargarParticipantes.length===0||cargarParticipantes[0]?._jid!==jornadaId){
    const existentes=STATE.resultados.filter(r=>r.jornada_id===jornadaId);
    cargarParticipantes=STATE.jugadores.map(j=>{
      const ex=existentes.find(r=>r.jugador_id===j.id);
      return{_jid:jornadaId,jugador_id:j.id,jugador:j,asistio:ex?ex.asistencia!==false:true,dq:ex?.dq||false};
    });
    // Init posiciones from existing results if any
    if(existentes.length>0){
      const sorted=[...existentes].filter(r=>r.asistencia!==false).sort((a,b)=>a.pos-b.pos);
      cargarPosiciones=sorted.map(r=>({pos:r.pos,jugador_id:r.jugador_id,empate:false}));
    } else {
      cargarPosiciones=[];
    }
    cargarStep=1;
  }

  const header=`
    <div class="flex items-center gap-8 mb-16">
      <button class="btn-back" onclick="backFromCargar()">â†</button>
      <div>
        <div class="text-15 font-bold font-georgia">${partida.sede} â€” ${fmtFecha(partida.fecha)}</div>
        <div class="text-12 text-muted">${badgeHTML(partida.estado)}</div>
      </div>
    </div>
    <div class="info-attest">âœï¸ TÃº cargas â†’ otro jugador confirma (Attest) â†’ Admin aprueba como Oficial.</div>`;

  if(cargarStep===1){
    // â”€â”€ STEP 1: Participantes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    el.innerHTML=header+`
    <div class="card mb-16">
      <div class="card-header">
        <span class="card-title">1ï¸âƒ£ Participantes</span>
        <span class="text-11 text-muted">Desmarca quien no asistiÃ³</span>
      </div>
      ${cargarParticipantes.map(p=>`
        <div class="cargar-row" style="gap:10px;">
          ${p.jugador.fotoURL?`<img src="${p.jugador.fotoURL}" style="width:36px;height:36px;border-radius:50%;object-fit:cover;flex-shrink:0;"/>`:avatarHTML(p.jugador.foto,99,'sm')}
          <div style="flex:1;">
            <div class="text-13 font-bold">${p.jugador.nombre}</div>
            <div class="text-11 text-muted">${p.jugador.alias||''}</div>
          </div>
          <label style="display:flex;align-items:center;gap:5px;font-size:12px;cursor:pointer;">
            <input type="checkbox" ${p.asistio?'checked':''} style="width:16px;height:16px;accent-color:var(--green);"
              onchange="toggleParticipante('${p.jugador_id}','asistio',this.checked)"/>
            <span>JugÃ³</span>
          </label>
          <label style="display:flex;align-items:center;gap:5px;font-size:12px;cursor:pointer;${p.asistio?'':'opacity:0.4;pointer-events:none;'}">
            <input type="checkbox" ${p.dq?'checked':''} style="width:16px;height:16px;accent-color:var(--red);"
              ${p.asistio?'':'disabled'}
              onchange="toggleParticipante('${p.jugador_id}','dq',this.checked)"/>
            <span style="color:var(--red);">DQ</span>
          </label>
        </div>`).join('')}
    </div>
    <button class="btn-save" onclick="goCargarStep2()">Continuar â†’ Asignar Posiciones</button>`;
  } else {
    // â”€â”€ STEP 2: Posiciones â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const asistentes=cargarParticipantes.filter(p=>p.asistio&&!p.dq);
    if(cargarPosiciones.length===0){
      // Start with ONE empty row
      cargarPosiciones=[{pos:1,jugador_id:'',empate:false}];
    }

    // Build set of already-used jugador_ids (one per row)
    const usados=new Set(cargarPosiciones.map(r=>r.jugador_id).filter(Boolean));
    const sinAsignar=asistentes.filter(p=>!usados.has(p.jugador_id));
    const totalAsistentes=asistentes.length;
    const totalAsignados=cargarPosiciones.filter(r=>r.jugador_id).length;
    const todoAsignado=totalAsignados>=totalAsistentes;

    el.innerHTML=header+`
    <div class="info-attest" style="background:#E3F2FD;border-color:#90CAF9;color:#1565C0;">
      ğŸ“‹ Asigna las posiciones de los <strong>${totalAsistentes}</strong> jugadores que participaron.
      ${todoAsignado?'<strong>âœ… Todos asignados</strong>':`Faltan <strong>${totalAsistentes-totalAsignados}</strong>`}
    </div>
    <div class="card mb-16">
      <div class="card-header">
        <span class="card-title">2ï¸âƒ£ Posiciones</span>
        <button class="btn-outline" style="font-size:11px;padding:4px 10px;" onclick="cargarStep=1;renderCargar()">â† Volver</button>
      </div>
      <div style="padding:14px 16px;display:flex;flex-direction:column;gap:10px;">
        ${(()=>{
          return cargarPosiciones.map((row,idx)=>{
            const otherUsed=new Set(cargarPosiciones.filter((_,i)=>i!==idx).map(r=>r.jugador_id).filter(Boolean));
            const opts=asistentes
              .filter(p=>!otherUsed.has(p.jugador_id)||p.jugador_id===row.jugador_id)
              .map(p=>'<option value="'+p.jugador_id+'" '+(row.jugador_id===p.jugador_id?'selected':'')+'>'+p.jugador.nombre+'</option>').join('');
            const nextSamePos=!!(cargarPosiciones[idx+1]&&cargarPosiciones[idx+1].pos===row.pos);
            const posBg=row.pos===1?'var(--gold)':row.pos===2?'#78909C':row.pos===3?'#8D6E63':'var(--green)';
            return '<div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--cardL);border-radius:10px;border:1px solid var(--border);">'+
              '<div style="width:36px;height:36px;border-radius:8px;background:'+posBg+';flex-shrink:0;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:13px;">'+row.pos+'\u00b0</div>'+
              '<select class="form-select" style="flex:1;" onchange="setPosJugador('+idx+',this.value)">'+
                '<option value="">â€” Seleccionar â€”</option>'+opts+
              '</select>'+
              '<label style="display:flex;align-items:center;gap:4px;font-size:11px;white-space:nowrap;cursor:pointer;">'+
                '<input type="checkbox" '+(nextSamePos?'checked':'')+' style="accent-color:var(--blue);" onchange="toggleEmpate('+idx+',this.checked)"/> Empate'+
              '</label>'+
              '<button onclick="removePosRow('+idx+')" style="background:none;border:none;color:var(--muted);font-size:16px;cursor:pointer;">\u2715</button>'+
            '</div>';
          }).join('');
        })()}

      </div>
    </div>

    <!-- FOTOS -->
    <div class="card mb-16" style="padding:16px;">
      <div class="card-header" style="margin-bottom:12px;"><span class="card-title">ğŸ“· Fotos del dÃ­a (mÃ¡x 3)</span></div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;" id="jornadaFotoGrid">
        <div class="photo-upload-box" style="height:80px;padding:8px;" id="jornadaFotoSlot0" onclick="document.getElementById('jornadaFotoInput0').click()">
          <div style="font-size:22px;">ğŸ“·</div><div style="font-size:10px;color:var(--muted);">Foto 1</div>
          <input type="file" id="jornadaFotoInput0" accept="image/*" style="display:none;" onchange="previewJornadaFoto(this,0)"/>
        </div>
        <div class="photo-upload-box" style="height:80px;padding:8px;" id="jornadaFotoSlot1" onclick="document.getElementById('jornadaFotoInput1').click()">
          <div style="font-size:22px;">ğŸ“·</div><div style="font-size:10px;color:var(--muted);">Foto 2</div>
          <input type="file" id="jornadaFotoInput1" accept="image/*" style="display:none;" onchange="previewJornadaFoto(this,1)"/>
        </div>
        <div class="photo-upload-box" style="height:80px;padding:8px;" id="jornadaFotoSlot2" onclick="document.getElementById('jornadaFotoInput2').click()">
          <div style="font-size:22px;">ğŸ“·</div><div style="font-size:10px;color:var(--muted);">Foto 3</div>
          <input type="file" id="jornadaFotoInput2" accept="image/*" style="display:none;" onchange="previewJornadaFoto(this,2)"/>
        </div>
      </div>
      <div class="upload-progress" style="margin-top:8px;"><div class="upload-progress-bar" id="jornadaFotoProgress"></div></div>
    </div>

    <div id="cargarError" class="error-box" style="display:none;"></div>
    <button class="btn-save" id="btnSave" onclick="saveResultados()">ğŸ’¾ Guardar y Enviar a Attest</button>`;
  }
}

function toggleParticipante(jugadorId,field,value){
  const p=cargarParticipantes.find(p=>p.jugador_id===jugadorId);
  if(!p)return;
  p[field]=value;
  if(field==='asistio'&&!value) p.dq=false;
  renderCargar();
}

function goCargarStep2(){
  cargarStep=2;
  cargarPosiciones=[];
  STATE._jornadaFotoFiles=[null,null,null];  // reset file refs on step2
  renderCargar();
  // Initialize foto slots immediately after render (DOM is ready)
  const jn=STATE.jornadas.find(j=>j.id===STATE.cargarJornadaId);
  const fotos=jn?.fotos||[];
  STATE._jornadaFotosExistentes=[...fotos];
  [0,1,2].forEach(i=>{ if(fotos[i]) setJornadaFotoSlot(i,fotos[i]); else resetJornadaFotoSlot(i); });
}

function setPosJugador(idx,jugadorId){
  if(!cargarPosiciones[idx]) return;
  cargarPosiciones[idx].jugador_id=jugadorId;
  // Auto-add next row if players still unassigned and no empty row waiting
  if(jugadorId){
    const asistentes=cargarParticipantes.filter(p=>p.asistio&&!p.dq);
    const usados=new Set(cargarPosiciones.map(r=>r.jugador_id).filter(Boolean));
    const hayPendientes=asistentes.some(p=>!usados.has(p.jugador_id));
    const lastIsEmpty=!cargarPosiciones[cargarPosiciones.length-1]?.jugador_id;
    if(hayPendientes && !lastIsEmpty){ addPosRow(); return; }
  }
  renderCargar();
}

function toggleEmpate(idx,checked){
  if(checked){
    const samePos=cargarPosiciones[idx].pos;
    // Insert empty row with SAME position right after
    cargarPosiciones.splice(idx+1,0,{pos:samePos,jugador_id:'',empate:true});
    // Subsequent rows: shift pos by 1 each (one extra player consumed this position)
    for(let i=idx+2;i<cargarPosiciones.length;i++) cargarPosiciones[i].pos++;
  } else {
    // Remove next row with same pos ONLY if it was added as empate
    if(cargarPosiciones[idx+1]&&cargarPosiciones[idx+1].pos===cargarPosiciones[idx].pos&&cargarPosiciones[idx+1].empate){
      const hadPlayer=!!cargarPosiciones[idx+1].jugador_id;
      cargarPosiciones.splice(idx+1,1);
      if(hadPlayer){
        // Restore subsequent positions
        for(let i=idx+1;i<cargarPosiciones.length;i++) cargarPosiciones[i].pos--;
      }
    }
  }
  renderCargar();
}

function addPosRow(){
  const last=cargarPosiciones[cargarPosiciones.length-1];
  // Next position = last pos + number of players at last pos (to account for empates)
  const sameAsLast=cargarPosiciones.filter(r=>r.pos===last?.pos).length;
  const nextPos=last?(last.pos+sameAsLast):1;
  cargarPosiciones.push({pos:nextPos,jugador_id:'',empate:false});
  renderCargar();
}

function removePosRow(idx){
  cargarPosiciones.splice(idx,1);
  // Recalculate positions
  let curPos=1;
  for(let i=0;i<cargarPosiciones.length;i++){
    if(i>0&&cargarPosiciones[i].pos===cargarPosiciones[i-1].pos){
      // keep same pos (empate)
    } else {
      cargarPosiciones[i].pos=curPos;
    }
    curPos=cargarPosiciones[i].pos+1;
  }
  renderCargar();
}

// Legacy updateEntry kept for backward compat
function updateEntry(jugadorId,field,value){ toggleParticipante(jugadorId,field,value); }

async function saveResultados(){
  const jornadaId=STATE.cargarJornadaId;
  const btn=document.getElementById('btnSave');
  const err=document.getElementById('cargarError');
  err.style.display='none';
  // Validate all asistentes have a position assigned
  const asistentesActivos=cargarParticipantes.filter(p=>p.asistio&&!p.dq);
  const asignadosIds=new Set(cargarPosiciones.filter(r=>r.jugador_id).map(r=>r.jugador_id));
  const sinPos=asistentesActivos.filter(p=>!asignadosIds.has(p.jugador_id));
  if(sinPos.length>0){
    err.textContent='Faltan posiciones para: '+sinPos.map(p=>p.jugador.nombre).join(', ');
    err.style.display='block'; return;
  }
  btn.disabled=true; btn.textContent='Guardando...';
  try{
    // Upload fotos â€” use stored File refs (DOM input loses files after innerHTML replace)
    let fotos=[...(STATE._jornadaFotosExistentes||[])];
    const fotoFiles=STATE._jornadaFotoFiles||[null,null,null];
    for(let i=0;i<3;i++){
      const file=fotoFiles[i];
      if(file){
        try{
          const compressed=await resizeAndCompress(file,1200,0.82);
          const url=await uploadPhoto(compressed,'jornadas/'+jornadaId+'_foto'+i+'.jpg','jornadaFotoProgress');
          fotos[i]=url;
          console.log('Foto '+i+' uploaded OK:', url.substring(0,60));
        }catch(uploadErr){
          console.error('Foto '+i+' upload failed:', uploadErr);
        }
      }
    }
    fotos=fotos.filter(Boolean);
    console.log('Total fotos to save:', fotos.length, fotos);

    const batch=db.batch();
    // Build results from new cargar model
    const partida=STATE.jornadas.find(j=>j.id===jornadaId);
    const torneoId=partida?.torneo_id||STATE.activeTorneoId||STATE.torneo?.id;
    const _baseReglas=getReglas(torneoId);
    const reglas=partida?.reglasOverride?Object.assign({},_baseReglas,{
      puntos:partida.reglasOverride.puntos||_baseReglas.puntos,
      bonusAsistencia:partida.reglasOverride.bonusAsistencia!=null?partida.reglasOverride.bonusAsistencia:_baseReglas.bonusAsistencia,
      penalNoAsistencia:partida.reglasOverride.penalNoAsistencia!=null?partida.reglasOverride.penalNoAsistencia:_baseReglas.penalNoAsistencia,
      penalDQ:partida.reglasOverride.penalDQ!=null?partida.reglasOverride.penalDQ:_baseReglas.penalDQ
    }):_baseReglas;

    // Merge participantes + posiciones
    cargarParticipantes.forEach(p=>{
      const posRow=cargarPosiciones.find(r=>r.jugador_id===p.jugador_id);
      const pos=posRow?.pos||99;
      // Calculate pts with empate logic
      const groupSize=cargarPosiciones.filter(r=>r.pos===pos).length;
      let basePts=0;
      if(p.asistio&&!p.dq){
        if(reglas.empates==='comparten'&&groupSize>1){
          let sum=0;
          for(let k=0;k<groupSize;k++) sum+=getPtsPosicion(pos+k,reglas);
          basePts=Math.round((sum/groupSize)*100)/100;
        } else {
          basePts=getPtsPosicion(pos,reglas);
        }
        basePts+=(reglas.bonusAsistencia||0);
        if(p.dq) basePts+=(reglas.penalDQ||0);
      } else if(!p.asistio){
        basePts=reglas.penalNoAsistencia||0;
      }
      batch.set(db.collection('resultados').doc(`${jornadaId}_${p.jugador_id}`),{
        jornada_id:jornadaId,jugador_id:p.jugador_id,
        pos:p.asistio?pos:99,pts:basePts,
        asistencia:p.asistio,dq:p.dq||false,
        cargado_por:STATE.profile?.jugador_id||STATE.user?.email,
        updated_at:firebase.firestore.FieldValue.serverTimestamp()
      });
    });
    batch.update(db.collection('jornadas').doc(jornadaId),{
      estado:'Pendiente Attest',cargado_por:STATE.profile?.jugador_id||null,
      cargado_at:firebase.firestore.FieldValue.serverTimestamp(),
      ...(fotos.length?{fotos}:{})
    });
    await batch.commit();
    cargarEntries=[];
    cargarParticipantes=[]; cargarPosiciones=[]; cargarStep=1;
    // Update local fotos in STATE immediately
    if(fotos.length){
      const jnIdx=STATE.jornadas.findIndex(j=>j.id===jornadaId);
      if(jnIdx>-1) STATE.jornadas[jnIdx]={...STATE.jornadas[jnIdx],fotos};
    }
    STATE.expandedJornada=jornadaId;
    goTab('jornadas');
  }catch(e){
    err.textContent='Error: '+e.message; err.style.display='block';
    btn.disabled=false; btn.textContent='ğŸ’¾ Guardar y Enviar a Attest';
  }
}
function backFromCargar(){
  cargarEntries=[]; cargarParticipantes=[]; cargarPosiciones=[]; cargarStep=1;
  const ct=document.getElementById('tab-cargar'); if(ct) ct.style.display='none';
  goTab('jornadas');
}

// â”€â”€ Carousel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const carouselIdx={};
function slideCarousel(jid,dir){
  const track=document.getElementById('carouselTrack_'+jid);
  if(!track) return;
  const n=track.querySelectorAll('img').length;
  carouselIdx[jid]=((carouselIdx[jid]||0)+dir+n)%n;
  track.style.transform='translateX(-'+(carouselIdx[jid]*100)+'%)';
  for(let i=0;i<n;i++){
    const dot=document.getElementById('dot_'+jid+'_'+i);
    if(dot) dot.style.background=i===carouselIdx[jid]?'#fff':'rgba(255,255,255,0.45)';
  }
}
function openCarousel(jid,startIdx){
  const jn=STATE.jornadas.find(j=>j.id===jid);
  if(!jn||!jn.fotos||!jn.fotos.length) return;
  let cur=startIdx||carouselIdx[jid]||0;
  const n=jn.fotos.length;
  const ov=document.createElement('div');
  ov.id='lightbox';
  ov.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.96);z-index:9999;display:flex;align-items:center;justify-content:center;';
  ov.onclick=function(e){if(e.target===ov)ov.remove();};
  function renderLB(){
    // Build lightbox content without nested quote issues
    const img=document.createElement('img');
    img.src=jn.fotos[cur];
    img.style.cssText='max-width:95vw;max-height:88vh;object-fit:contain;border-radius:8px;user-select:none;';
    ov.innerHTML='';
    ov.appendChild(img);
    // Counter
    const ctr=document.createElement('div');
    ctr.style.cssText='position:absolute;bottom:18px;left:50%;transform:translateX(-50%);color:rgba(255,255,255,0.7);font-size:13px;';
    ctr.textContent=(cur+1)+' / '+n;
    ov.appendChild(ctr);
    // Close button
    const closeBtn=document.createElement('button');
    closeBtn.textContent='âœ•';
    closeBtn.style.cssText='position:absolute;top:14px;right:14px;background:rgba(255,255,255,0.15);border:none;color:#fff;font-size:22px;border-radius:50%;width:42px;height:42px;cursor:pointer;display:flex;align-items:center;justify-content:center;';
    closeBtn.onclick=function(){ov.remove();};
    ov.appendChild(closeBtn);
    // Nav buttons
    if(n>1){
      const prev=document.createElement('button');
      prev.innerHTML='&#8249;';
      prev.style.cssText='position:absolute;left:12px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.15);border:none;color:#fff;font-size:36px;border-radius:50%;width:52px;height:52px;cursor:pointer;display:flex;align-items:center;justify-content:center;';
      prev.onclick=function(e){e.stopPropagation();cur=(cur-1+n)%n;renderLB();};
      ov.appendChild(prev);
      const next=document.createElement('button');
      next.innerHTML='&#8250;';
      next.style.cssText='position:absolute;right:12px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.15);border:none;color:#fff;font-size:36px;border-radius:50%;width:52px;height:52px;cursor:pointer;display:flex;align-items:center;justify-content:center;';
      next.onclick=function(e){e.stopPropagation();cur=(cur+1)%n;renderLB();};
      ov.appendChild(next);
    }
  }
  renderLB();
  document.body.appendChild(ov);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JUGADORES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let showAddJugador=false;
let editingJugadorId=null;

function renderJugadores(){
  const el=document.getElementById('tab-jugadores');
  const isAdmin=STATE.profile?.role==='admin';
  const myJugadorId=STATE.profile?.jugador_id;

  el.innerHTML=`
    ${isAdmin?`
      <button class="btn-green mb-16" onclick="toggleAddJugador()">${showAddJugador?'âœ• Cancelar':'+ Agregar Jugador'}</button>
      ${showAddJugador?`
        <div class="card mb-16">
          <div class="card-header"><span class="card-title">Nuevo Jugador</span></div>
          <div class="card-body" style="display:flex;flex-direction:column;gap:12px;">
            <div><label class="form-label">Nombre Completo *</label><input class="form-input" id="newNombre" placeholder="Ej: Daniel Badell"/></div>
            <div style="display:flex;gap:12px;">
              <div style="flex:1;"><label class="form-label">Alias</label><input class="form-input" id="newAlias" placeholder="Ej: Badell"/></div>
              <div style="width:90px;"><label class="form-label">Iniciales</label><input class="form-input" id="newFoto" placeholder="DB" maxlength="2"/></div>
            </div>
            <div>
              <label class="form-label">TelÃ©fono / WhatsApp</label>
              <div style="display:flex;gap:8px;align-items:center;">
                <select class="form-select" id="newPaisCodigo" style="width:110px;">
                  <option value="+58">ğŸ‡»ğŸ‡ª +58</option>
                  <option value="+1">ğŸ‡ºğŸ‡¸ +1</option>
                  <option value="+34">ğŸ‡ªğŸ‡¸ +34</option>
                  <option value="+52">ğŸ‡²ğŸ‡½ +52</option>
                  <option value="+57">ğŸ‡¨ğŸ‡´ +57</option>
                  <option value="+51">ğŸ‡µğŸ‡ª +51</option>
                  <option value="+54">ğŸ‡¦ğŸ‡· +54</option>
                  <option value="+56">ğŸ‡¨ğŸ‡± +56</option>
                  <option value="+55">ğŸ‡§ğŸ‡· +55</option>
                  <option value="+507">ğŸ‡µğŸ‡¦ +507</option>
                </select>
                <input class="form-input" id="newTelefono" type="tel" placeholder="4141234567" style="flex:1;" oninput="validarTelefonoNew(this)"/>
              </div>
              <div id="newTelefonoHint" style="font-size:11px;color:var(--muted);margin-top:4px;">Opcional Â· Solo nÃºmeros, sin espacios ni guiones</div>
            </div>
            <div id="addJugadorError" class="error-box" style="display:none;"></div>
            <button class="btn-green" onclick="addJugador()">Agregar al Club</button>
          </div>
        </div>`:''}
    `:''}
    <div style="display:flex;flex-direction:column;gap:10px;">
      ${STATE.jugadores.map(j=>{
        const canEdit=isAdmin||(myJugadorId===j.id);
        const rk=calcRanking().find(r=>r.id===j.id);
        return`
        <div class="card" style="margin-bottom:0;">
          <div style="padding:14px 18px;display:flex;align-items:center;gap:14px;">
            ${j.fotoURL
              ?`<img src="${j.fotoURL}" class="foto-perfil-circle" style="width:42px;height:42px;"/>`
              :avatarHTML(j.foto,rk?.pos||99,'lg')}
            <div class="flex-1">
              <div class="text-14 font-bold">${j.nombre}</div>
              <div class="text-12 text-muted">${j.alias||'â€”'}${j.handicap!==undefined?' Â· HCP '+j.handicap:''}</div>
              ${j.telefonoCompleto?`<div class="text-11 text-muted" style="margin-top:2px;">ğŸ“± ${j.telefonoCompleto}</div>`:''}
              ${isAdmin&&j.invite_code?`
                <div style="margin-top:4px;display:flex;align-items:center;gap:6px;">
                  ${!j.user_uid
                    ?`<span style="background:#E8F5E9;color:#2E7D32;font-size:11px;font-weight:700;padding:3px 8px;border-radius:6px;letter-spacing:1px;font-family:monospace;">ğŸ”‘ ${j.invite_code}</span>
                      <span style="font-size:10px;color:var(--muted);">Sin vincular</span>`
                    :`<span style="background:#E3F2FD;color:#1565C0;font-size:10px;padding:2px 7px;border-radius:6px;">âœ… Cuenta vinculada</span>`}
                </div>`:''}
            </div>
            <div style="text-align:right;min-width:40px;">
              <div style="font-size:18px;font-weight:800;color:${rk?.pos===1?'var(--gold)':'var(--text)'};">${rk?.ptsT||0}</div>
              <div class="text-10 text-muted">pts</div>
            </div>
            ${canEdit?`<button class="btn-outline" style="padding:5px 12px;font-size:12px;" onclick="openModalJugador('${j.id}')">âœï¸</button>`:''}
            ${isAdmin?`<button class="btn-danger" onclick="deleteJugador('${j.id}','${j.nombre}')">Eliminar</button>`:''}
          </div>
        </div>`;}).join('')}
    </div>
  `;
}

function toggleAddJugador(){ showAddJugador=!showAddJugador; renderJugadores(); }

function openModalJugador(jugadorId){
  editingJugadorId=jugadorId;
  document.getElementById('modalJugadorError').style.display='none';
  const j=STATE.jugadores.find(j=>j.id===jugadorId);
  if(j){
    document.getElementById('editNombre').value=j.nombre||'';
    document.getElementById('editAlias').value=j.alias||'';
    document.getElementById('editFoto').value=j.foto||'';
    document.getElementById('editHandicap').value=j.handicap??'';
    if(j.fotoURL){
      document.getElementById('jugadorFotoPreview').src=j.fotoURL;
      document.getElementById('jugadorFotoPreview').style.display='block';
      document.getElementById('jugadorFotoFallback').style.display='none';
    } else {
      document.getElementById('jugadorFotoPreview').style.display='none';
      document.getElementById('jugadorFotoFallback').style.display='flex';
    }
    document.getElementById('jugadorFotoInput').value='';
    const tel=j.telefono||'';
    const codigoPais=j.codigoPais||'+58';
    document.getElementById('editPaisCodigo').value=codigoPais;
    document.getElementById('editTelefono').value=tel;
    document.getElementById('telefonoHint').textContent='Sin el 0 inicial con +58. Ej: 4141234567 (no 04141234567)';
    document.getElementById('telefonoHint').style.color='var(--muted)';
  }
  document.getElementById('modalJugador').style.display='flex';
}

function closeModalJugador(){ document.getElementById('modalJugador').style.display='none'; editingJugadorId=null; }

function validarFormatoTel(num, codigo){
  if(!/^\d{7,15}$/.test(num)) return false;
  if(codigo==='+58'){
    // Accept with leading 0: 0412... (10 digits)
    // OR without leading 0: 412...  (10 digits, international style)
    return /^(04|02)\d{8}$/.test(num) || /^(4|2)\d{9}$/.test(num);
  }
  return num.length>=7&&num.length<=15;
}

function normalizeTelVE(num, codigo){
  // Remove leading 0 for international storage: 04122746658 â†’ 4122746658
  if(codigo==='+58' && /^0(4|2)/.test(num)) return num.slice(1);
  return num;
}

function validarTelefonoNew(input){
  const hint=document.getElementById('newTelefonoHint');
  const codigo=document.getElementById('newPaisCodigo').value;
  const val=input.value.replace(/\D/g,'');
  input.value=val;
  if(!val){hint.textContent='Opcional Â· Solo nÃºmeros, sin espacios ni guiones';hint.style.color='var(--muted)';return;}
  if(validarFormatoTel(val,codigo)){
    hint.textContent='âœ… Formato vÃ¡lido Â· '+codigo+val;
    hint.style.color='var(--green)';
    input.style.borderColor='var(--green)';
  } else {
    const tip=codigo==='+58'?'Sin 0 inicial: 4xxxxxxxxx o 2xxxxxxxxx (10 dÃ­gitos)':'Entre 7 y 15 dÃ­gitos numÃ©ricos';
    hint.textContent='âš ï¸ '+tip;
    hint.style.color='var(--red)';
    input.style.borderColor='var(--red)';
  }
}

function validarTelefono(input){
  const hint=document.getElementById('telefonoHint');
  const codigo=document.getElementById('editPaisCodigo').value;
  const val=input.value.replace(/\D/g,'');
  input.value=val; // strip non-digits live
  if(!val){hint.textContent='Solo nÃºmeros, sin espacios ni guiones. Ej: 4141234567';hint.style.color='var(--muted)';return;}
  if(validarFormatoTel(val,codigo)){
    hint.textContent='âœ… Formato vÃ¡lido Â· '+codigo+val;
    hint.style.color='var(--green)';
    input.style.borderColor='var(--green)';
  } else {
    const tip=codigo==='+58'?'Sin 0 inicial: 4xxxxxxxxx o 2xxxxxxxxx (10 dÃ­gitos)':'Entre 7 y 15 dÃ­gitos numÃ©ricos';
    hint.textContent='âš ï¸ '+tip;
    hint.style.color='var(--red)';
    input.style.borderColor='var(--red)';
  }
}

async function saveJugador(){
  const nombre=document.getElementById('editNombre').value.trim();
  const alias=document.getElementById('editAlias').value.trim();
  const foto=document.getElementById('editFoto').value.trim().toUpperCase().slice(0,2);
  const handicap=document.getElementById('editHandicap').value;
  let telefono=document.getElementById('editTelefono').value.trim().replace(/\D/g,'');
  const codigoPais=document.getElementById('editPaisCodigo').value;
  telefono=normalizeTelVE(telefono,codigoPais);
  const err=document.getElementById('modalJugadorError');
  // Validate phone
  if(telefono&&!validarFormatoTel(telefono,codigoPais)){
    err.textContent='Formato de telÃ©fono invÃ¡lido. Solo nÃºmeros, entre 7 y 15 dÃ­gitos.';
    err.style.display='block';return;
  }
  const btn=document.getElementById('btnGuardarJugador');
  if(!nombre){err.textContent='El nombre es obligatorio.';err.style.display='block';return;}
  btn.disabled=true; btn.textContent='Guardando...';
  try{
    const upd={nombre,alias:alias||nombre.split(' ')[0],foto:foto||nombre.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2),updated_at:firebase.firestore.FieldValue.serverTimestamp()};
    if(handicap!=='')upd.handicap=Number(handicap);
    if(telefono){upd.telefono=telefono;upd.codigoPais=codigoPais;upd.telefonoCompleto=codigoPais+telefono;}
    const fotoFile=document.getElementById('jugadorFotoInput').files[0];
    if(fotoFile){
      const compressed=await resizeAndCompress(fotoFile,400,0.85);
      upd.fotoURL=await uploadPhoto(compressed,'jugadores/'+editingJugadorId+'.jpg');
    }
    await db.collection('jugadores').doc(editingJugadorId).update(upd);
    closeModalJugador();
  }catch(e){err.textContent='Error: '+e.message;err.style.display='block';}
  finally{btn.disabled=false;btn.textContent='Guardar';}
}

async function addJugador(){
  const nombre=document.getElementById('newNombre').value.trim();
  const alias=document.getElementById('newAlias').value.trim();
  const foto=document.getElementById('newFoto').value.trim().toUpperCase().slice(0,2);
  let telefono=document.getElementById('newTelefono').value.trim().replace(/\D/g,'');
  const codigoPais=document.getElementById('newPaisCodigo').value;
  telefono=normalizeTelVE(telefono,codigoPais);
  const err=document.getElementById('addJugadorError');
  if(!nombre){err.textContent='El nombre es obligatorio.';err.style.display='block';return;}
  if(telefono&&!validarFormatoTel(telefono,codigoPais)){
    err.textContent='Formato de telÃ©fono invÃ¡lido.';err.style.display='block';return;
  }
  const initials=foto||nombre.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
  const id=nombre.toLowerCase().replace(/\s+/g,'_')+'_'+Date.now();
  let invite_code=generateInviteCode();
  const codeSnap=await db.collection('jugadores').where('invite_code','==',invite_code).get();
  if(!codeSnap.empty) invite_code=generateInviteCode();
  const data={nombre,alias:alias||nombre.split(' ')[0],foto:initials,
              invite_code, user_uid:null,
              creado:firebase.firestore.FieldValue.serverTimestamp()};
  if(telefono){data.telefono=telefono;data.codigoPais=codigoPais;data.telefonoCompleto=codigoPais+telefono;}
  await db.collection('jugadores').doc(id).set(data);
  showAddJugador=false;
}

async function deleteJugador(id,nombre){
  if(!confirm(`Â¿Eliminar a ${nombre}?`))return;
  await db.collection('jugadores').doc(id).delete();
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE â€” Subir fotos
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function uploadPhoto(file, path, progressBarId=null){
  return new Promise((resolve,reject)=>{
    const ref=storage.ref(path);
    const task=ref.put(file);
    task.on('state_changed',
      snap=>{
        if(progressBarId){
          const pct=Math.round((snap.bytesTransferred/snap.totalBytes)*100);
          const bar=document.getElementById(progressBarId);
          if(bar){bar.parentElement.style.display='block';bar.style.width=pct+'%';}
        }
      },
      err=>reject(err),
      async ()=>{
        const url=await task.snapshot.ref.getDownloadURL();
        if(progressBarId){
          const bar=document.getElementById(progressBarId);
          if(bar){bar.parentElement.style.display='none';bar.style.width='0%';}
        }
        resolve(url);
      }
    );
  });
}

function resizeAndCompress(file, maxW=800, quality=0.82){
  return new Promise(resolve=>{
    const img=new Image();
    const url=URL.createObjectURL(file);
    img.onload=()=>{
      const ratio=Math.min(1,maxW/img.width);
      const canvas=document.createElement('canvas');
      canvas.width=img.width*ratio; canvas.height=img.height*ratio;
      canvas.getContext('2d').drawImage(img,0,0,canvas.width,canvas.height);
      canvas.toBlob(b=>{ URL.revokeObjectURL(url); resolve(new File([b],file.name,{type:'image/jpeg'})); },'image/jpeg',quality);
    };
    img.src=url;
  });
}

function previewPhoto(input, imgId, fallbackId=null){
  const file=input.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    const img=document.getElementById(imgId);
    if(img){img.src=e.target.result;img.style.display='block';}
    if(fallbackId){const fb=document.getElementById(fallbackId);if(fb)fb.style.display='none';}
  };
  reader.readAsDataURL(file);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTUALIZACIONES AUTOMÃTICAS â€” iOS compatible
// iOS ignora reload(true), usamos navegaciÃ³n con cache-bust
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initUpdateChecker(){
  // Si llegamos con ?bust= en la URL, limpiar y guardar versiÃ³n
  const url=new URL(window.location.href);
  if(url.searchParams.get('bust')){
    localStorage.setItem('golfeados_version', APP_VERSION);
    localStorage.setItem('golfeados_dismissed_ver', APP_VERSION);
    document.getElementById('updateBanner').style.display='none';
    url.searchParams.delete('bust');
    window.history.replaceState(null,'',url.toString());
  }
  // Also hide banner immediately if current version was dismissed
  const alreadyDismissed=localStorage.getItem('golfeados_dismissed_ver');
  if(alreadyDismissed===APP_VERSION){
    document.getElementById('updateBanner').style.display='none';
  }

  // Si la versiÃ³n guardada no coincide â†’ navegar con cache-bust (recarga real en iOS)
  const stored=localStorage.getItem('golfeados_version');
  if(stored && stored !== APP_VERSION){
    localStorage.setItem('golfeados_version', APP_VERSION);
    doHardReload();
    return;
  }
  localStorage.setItem('golfeados_version', APP_VERSION);

  // Chequeo periÃ³dico: descarga el HTML y compara versiÃ³n
  async function checkForUpdate(){
    try{
      const res=await fetch(window.location.pathname+'?nc='+Date.now(),{
        cache:'no-store',
        headers:{'Cache-Control':'no-cache','Pragma':'no-cache'}
      });
      const text=await res.text();
      const match=text.match(/APP_VERSION\s*=\s*['"]([^'"]+)['"]/);
      if(match && match[1] && match[1] !== APP_VERSION){
        showUpdateBanner(match[1]);
      }
    }catch(e){ /* sin conexiÃ³n, silencioso */ }
  }

  // Chequear 4s despuÃ©s de entrar, luego cada 3 minutos
  setTimeout(checkForUpdate, 4000);
  setInterval(checkForUpdate, 3*60*1000);

  // Chequear al volver de segundo plano (iOS PWA)
  document.addEventListener('visibilitychange',()=>{
    if(document.visibilityState==='visible') setTimeout(checkForUpdate,1500);
  });

  // Chequear al recuperar conexiÃ³n
  window.addEventListener('online', ()=>setTimeout(checkForUpdate,2000));
}

function showUpdateBanner(newVer){
  const banner=document.getElementById('updateBanner');
  const sub=banner.querySelector('div div:last-child');
  if(sub) sub.textContent='VersiÃ³n '+newVer+' disponible â€” toca para instalar';
  banner.style.display='flex';
}

function doHardReload(){
  // iOS-compatible: navegar a la misma URL con parÃ¡metro nuevo (bypassa cachÃ©)
  const url=new URL(window.location.href);
  url.searchParams.set('bust', Date.now());
  window.location.replace(url.toString());
}

function forceUpdate(){
  // Limpiar cachÃ© del navegador si estÃ¡ disponible
  localStorage.setItem('golfeados_dismissed_ver', APP_VERSION);
  if('caches' in window){
    caches.keys().then(names=>{
      names.forEach(n=>caches.delete(n));
      // DespuÃ©s de limpiar, navegar
      setTimeout(doHardReload, 300);
    });
  } else {
    doHardReload();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function seedDatos(){
  const msg=document.getElementById('seedMsg');
  msg.style.display='block'; msg.textContent='â³ Cargando datos iniciales...';
  try{
    const batch=db.batch();
    batch.set(db.collection('torneos').doc('apertura2026'),{nombre:'Torneo Apertura 2026',estado:'Activo',jornadas_total:8,temporada:'2026',creado:firebase.firestore.FieldValue.serverTimestamp()});
    [
      {id:'badell',nombre:'Daniel Badell',alias:'Badell',foto:'DB'},
      {id:'jimeno',nombre:'Javi Jimeno',alias:'Jimeno',foto:'JJ'},
      {id:'padron',nombre:'Loor PadrÃ³n',alias:'Loor',foto:'LP'},
      {id:'kolman',nombre:'Juan Kolman',alias:'Kolman',foto:'JK'},
      {id:'aguiar',nombre:'JesÃºs Aguiar',alias:'J. Aguiar',foto:'JA'},
      {id:'soto',nombre:'Mauricio Soto',alias:'Soto',foto:'MS'},
      {id:'aguiar_r',nombre:'JesÃºs Aguiar Romero',alias:'Aguiar R.',foto:'JR'},
    ].forEach(j=>{const{id,...d}=j;batch.set(db.collection('jugadores').doc(id),{...d,creado:firebase.firestore.FieldValue.serverTimestamp()});});
    await batch.commit();
    const clubesSeed=[
      {nombre:'Izcaragua Country Club',ciudad:'Caracas'},
      {nombre:'Junko Golf Club',ciudad:'Caracas'},
      {nombre:'Lagunita Country Club',ciudad:'Caracas'},
      {nombre:'Valle Arriba Golf Club',ciudad:'Caracas'},
      {nombre:'Guataparo Country Club',ciudad:'Valencia'},
    ];
    for(const c of clubesSeed){
      await db.collection('clubes').add({...c,creado:firebase.firestore.FieldValue.serverTimestamp()});
    }
    msg.textContent='âœ… Â¡Datos cargados! Jugadores, partidas y clubes creados.';
  }catch(e){ msg.style.color='var(--red)'; msg.textContent='âŒ Error: '+e.message; }
}
</script>
</body>
</html>
