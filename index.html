

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<meta name="theme-color" content="#2E7D5E"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<meta name="description" content="Golfeados Golf Club - Tournament Manager"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="default"/>
<meta name="apple-mobile-web-app-title" content="Golfeados"/>
<link rel="manifest" href="manifest.json"/>
<link rel="apple-touch-icon" href="Logo_Golfeados.png"/>
<title>Golfeados Â· Golf Club</title>

<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-storage-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#F0F4F2;
  --bg2:#E8EEEB;
  --card:#FFFFFF;
  --cardL:#F5F9F7;
  --border:#D0DDD8;
  --border2:#B8CEC7;
  --green:#2E7D5E;
  --greenL:#3DA07A;
  --greenPale:#E8F5F0;
  --blue:#1A6B8A;
  --blueL:#2589AD;
  --bluePale:#E3F2F8;
  --teal:#0D7377;
  --text:#1A2E27;
  --text2:#3D5A50;
  --muted:#7A9A8E;
  --white:#FFFFFF;
  --red:#D32F2F;
  --redPale:#FFEBEE;
  --gold:#C49A00;
  --goldPale:#FFF8E1;
  --shadow:0 1px 6px rgba(46,125,94,0.08);
  --shadow-md:0 4px 16px rgba(46,125,94,0.12);
}
html,body{background:var(--bg);color:var(--text);font-family:'Trebuchet MS',sans-serif;min-height:100dvh;}
button{cursor:pointer;font-family:inherit;}
input,select,textarea{font-family:inherit;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

/* â”€â”€ LOADING â”€â”€ */
#loading{position:fixed;inset:0;background:var(--white);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:14px;z-index:999;}
.spin{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--green);border-radius:50%;animation:spin 0.8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* â”€â”€ LOGIN â”€â”€ */
#loginScreen{min-height:100dvh;display:flex;align-items:center;justify-content:center;padding:24px;
  background:linear-gradient(160deg,#E8F5F0 0%,#E3F2F8 50%,#F0F4F2 100%);}
.login-card{width:100%;max-width:380px;background:var(--white);border-radius:20px;border:1px solid var(--border);padding:40px 32px;box-shadow:var(--shadow-md);}
.login-logo{text-align:center;margin-bottom:28px;}
.login-logo img{width:90px;height:90px;object-fit:contain;}
.login-title{font-size:22px;font-weight:800;color:var(--green);font-family:Georgia,serif;letter-spacing:1px;margin-top:10px;}
.login-sub{font-size:11px;color:var(--muted);letter-spacing:3px;text-transform:uppercase;margin-top:3px;}
.field{margin-bottom:16px;}
.field label{font-size:11px;color:var(--text2);font-weight:700;letter-spacing:1px;text-transform:uppercase;display:block;margin-bottom:6px;}
.field input{width:100%;padding:11px 14px;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;color:var(--text);font-size:15px;outline:none;transition:border-color 0.2s;}
.field input:focus{border-color:var(--green);background:var(--white);}
.btn-login{width:100%;padding:13px;border-radius:10px;border:none;background:var(--green);color:#fff;font-weight:700;font-size:16px;font-family:Georgia,serif;letter-spacing:1px;box-shadow:0 4px 14px rgba(46,125,94,0.3);transition:opacity 0.2s;margin-top:4px;}
.btn-google{width:100%;padding:12px;border-radius:10px;border:2px solid #e0e0e0;background:#fff;color:#3c4043;font-weight:600;font-size:15px;font-family:Georgia,serif;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;margin-top:10px;box-shadow:0 1px 4px rgba(0,0,0,0.1);}
.btn-google:hover{background:#f8f8f8;border-color:#dadce0;}
.btn-google:active{background:#f0f0f0;}
.login-or{display:flex;align-items:center;gap:10px;margin:14px 0;color:var(--muted);font-size:12px;}
.login-or::before,.login-or::after{content:'';flex:1;height:1px;background:var(--border);}
.btn-login:disabled{opacity:0.6;cursor:not-allowed;}
.btn-link{background:none;border:none;color:var(--muted);font-size:13px;text-align:center;display:block;width:100%;margin-top:14px;}
.error-box{background:var(--redPale);border:1px solid #FFCDD2;border-radius:8px;padding:10px 14px;color:var(--red);font-size:13px;margin-bottom:12px;}
.login-footer{position:fixed;bottom:20px;left:0;right:0;text-align:center;color:var(--muted);font-size:11px;letter-spacing:2px;}

/* â”€â”€ HEADER â”€â”€ */
#header{background:var(--white);border-bottom:1px solid var(--border);padding:0 20px;display:flex;align-items:center;justify-content:space-between;height:56px;position:sticky;top:0;z-index:100;box-shadow:var(--shadow);}
.header-logo{display:flex;align-items:center;gap:10px;}
.header-logo img{width:38px;height:38px;object-fit:contain;}
.header-title{font-size:15px;font-weight:800;color:var(--green);font-family:Georgia,serif;letter-spacing:1px;}
.header-sub{font-size:9px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;}
.header-right{display:flex;align-items:center;gap:10px;}
.badge-admin{font-size:10px;color:var(--white);font-weight:700;letter-spacing:1px;background:var(--green);padding:3px 8px;border-radius:10px;}
.header-user{font-size:11px;color:var(--green);max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:600;padding:4px 8px;border-radius:8px;transition:background 0.2s;}.header-user:hover{background:rgba(46,125,50,0.08);}
.btn-logout{background:none;border:1px solid var(--border);border-radius:6px;color:var(--muted);padding:5px 10px;font-size:11px;}

/* â”€â”€ NAV â”€â”€ */
#nav{background:var(--white);border-bottom:1px solid var(--border);display:flex;padding:0 12px;overflow-x:auto;position:sticky;top:56px;z-index:99;}
#nav::-webkit-scrollbar{height:0;}
.nav-btn{padding:11px 14px;background:transparent;border:none;border-bottom:2px solid transparent;color:var(--muted);font-weight:400;font-size:13px;display:flex;align-items:center;gap:5px;white-space:nowrap;transition:all 0.15s;}
.nav-btn.active{border-bottom-color:var(--green);color:var(--green);font-weight:700;}

/* â”€â”€ CONTENT â”€â”€ */
#content{padding:20px;max-width:900px;margin:0 auto;padding-bottom:40px;}

/* â”€â”€ CARDS â”€â”€ */
.card{background:var(--white);border-radius:14px;border:1px solid var(--border);overflow:hidden;margin-bottom:16px;box-shadow:var(--shadow);}
.card-header{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:var(--cardL);}
.card-title{font-size:12px;font-weight:700;color:var(--green);letter-spacing:1px;text-transform:uppercase;}
.card-body{padding:20px;}

/* â”€â”€ HERO â”€â”€ */
.hero{background:linear-gradient(135deg,var(--green) 0%,var(--teal) 60%,var(--blue) 100%);border-radius:16px;padding:24px 28px;border:none;position:relative;overflow:hidden;margin-bottom:16px;box-shadow:var(--shadow-md);}
.hero::after{content:'';position:absolute;top:-40px;right:-40px;width:220px;height:220px;border-radius:50%;background:rgba(255,255,255,0.06);}
.hero-label{font-size:11px;color:rgba(255,255,255,0.75);font-weight:600;letter-spacing:2px;text-transform:uppercase;margin-bottom:6px;}
.hero-title{font-size:22px;font-weight:700;color:#fff;font-family:Georgia,serif;}
.hero-stats{display:flex;gap:24px;margin-top:16px;flex-wrap:wrap;}
.hero-stat label{font-size:10px;color:rgba(255,255,255,0.65);letter-spacing:1px;text-transform:uppercase;display:block;}
.hero-stat span{font-size:15px;font-weight:600;color:#fff;margin-top:2px;display:block;}

/* â”€â”€ AVATAR â”€â”€ */
.avatar{border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-family:Georgia,serif;flex-shrink:0;color:#fff;}

/* â”€â”€ BADGES â”€â”€ */
.badge{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;}
.badge::before{content:'';width:6px;height:6px;border-radius:50%;background:currentColor;flex-shrink:0;}
.badge-oficial{background:#E8F5E9;color:#2E7D32;}
.badge-validar{background:#FFF8E1;color:#F57F17;}
.badge-attest{background:#EDE7F6;color:#5E35B1;}
.badge-planificada{background:#E3F2FD;color:#1565C0;}
.badge-enjuego{background:#FBE9E7;color:#BF360C;}
.badge-activo{background:#E8F5E9;color:#2E7D32;}

/* â”€â”€ RANKING â”€â”€ */
.rank-row{display:grid;grid-template-columns:40px 1fr 50px 55px 50px;gap:8px;padding:12px 16px;border-bottom:1px solid var(--border);align-items:center;}
.rank-row.top{background:var(--greenPale);}
.rank-head{display:grid;grid-template-columns:40px 1fr 50px 55px 50px;gap:8px;padding:8px 16px;border-bottom:1px solid var(--border);background:var(--cardL);}
.rank-head span{font-size:10px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:1px;}

/* â”€â”€ JORNADA CARD â”€â”€ */
.partida-card{background:var(--white);border-radius:12px;border:1px solid var(--border);overflow:hidden;margin-bottom:10px;box-shadow:var(--shadow);}
.partida-header{padding:14px 18px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;user-select:none;transition:background 0.15s;}
.partida-header:hover{background:var(--cardL);}
.partida-body{padding:0 18px 18px;border-top:1px solid var(--border);}
.partida-actions{display:flex;gap:8px;padding:12px 0;flex-wrap:wrap;}

/* â”€â”€ RESULT ROW â”€â”€ */
.result-row{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:10px;background:var(--cardL);margin-bottom:6px;border:1px solid var(--border);}

/* â”€â”€ FORM â”€â”€ */
.form-label{font-size:11px;color:var(--text2);font-weight:700;letter-spacing:1px;text-transform:uppercase;display:block;margin-bottom:6px;}
.form-input{width:100%;padding:10px 14px;background:var(--bg);border:1.5px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;outline:none;transition:border-color 0.2s;}
.form-input:focus{border-color:var(--green);background:var(--white);}
.form-select{padding:8px 12px;background:var(--bg);border:1.5px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;outline:none;transition:border-color 0.2s;}
.form-select:focus{border-color:var(--green);}
.form-check{accent-color:var(--green);width:16px;height:16px;}

/* â”€â”€ BUTTONS â”€â”€ */
.btn-green{padding:9px 18px;border-radius:8px;border:none;background:var(--green);color:#fff;font-weight:700;font-size:13px;box-shadow:0 2px 8px rgba(46,125,94,0.25);cursor:pointer;}
.btn-blue{padding:9px 18px;border-radius:8px;border:none;background:var(--blue);color:#fff;font-weight:700;font-size:13px;}
.btn-teal{padding:9px 18px;border-radius:8px;border:none;background:var(--teal);color:#fff;font-weight:700;font-size:13px;}
.btn-attest{padding:8px 18px;border-radius:8px;border:1px solid #9C27B0;background:#F3E5F5;color:#7B1FA2;font-weight:700;font-size:13px;}
.btn-approve{padding:8px 18px;border-radius:8px;border:none;background:#E8F5E9;color:#2E7D32;font-weight:700;font-size:13px;border:1px solid #A5D6A7;}
.btn-outline{padding:8px 18px;border-radius:8px;border:1px solid var(--border2);background:var(--white);color:var(--text2);font-weight:600;font-size:13px;}
.btn-danger{padding:6px 10px;border-radius:8px;border:1px solid #FFCDD2;background:var(--redPale);color:var(--red);font-size:12px;font-weight:600;}
.btn-save{width:100%;padding:14px;border-radius:12px;border:none;background:var(--green);color:#fff;font-weight:800;font-size:16px;font-family:Georgia,serif;letter-spacing:1px;box-shadow:0 4px 14px rgba(46,125,94,0.3);margin-top:8px;}
.btn-back{background:none;border:none;color:var(--muted);font-size:22px;padding:0 8px 0 0;}
/* keep btn-primary as alias */
.btn-primary{padding:9px 18px;border-radius:8px;border:none;background:var(--green);color:#fff;font-weight:700;font-size:13px;box-shadow:0 2px 8px rgba(46,125,94,0.2);}

/* â”€â”€ CARGAR â”€â”€ */
.cargar-row{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
.pts-box{width:50px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:18px;border:1.5px solid var(--border);}

/* â”€â”€ INFO / SUCCESS â”€â”€ */
.info-attest{background:var(--bluePale);border:1px solid #B3D9E8;border-radius:10px;padding:12px 16px;font-size:12px;color:var(--blue);margin-bottom:16px;}
.success-box{background:var(--greenPale);border:1px solid #A5D6A7;border-radius:14px;padding:32px;text-align:center;}

/* â”€â”€ TABLE â”€â”€ */
.breakdown-table{width:100%;border-collapse:collapse;font-size:12px;}
.breakdown-table td{padding:8px;border-top:1px solid var(--border);}

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:200;display:flex;align-items:flex-end;justify-content:center;padding:0;}@media(min-width:520px){.modal-overlay{align-items:center;padding:20px;}}
.modal-box{background:var(--white);border-radius:20px 20px 0 0;width:100%;max-width:500px;box-shadow:0 -4px 30px rgba(0,0,0,0.2);overflow:hidden;max-height:92vh;overflow-y:auto;}@media(min-width:520px){.modal-box{border-radius:16px;max-height:88vh;}}
.modal-header{padding:18px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:var(--cardL);}
.modal-title{font-size:15px;font-weight:700;color:var(--green);}
.modal-body{padding:24px;}
.modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end;}

/* â”€â”€ UTILS â”€â”€ */
.flex{display:flex;}.flex-1{flex:1;}.gap-8{gap:8px;}.gap-12{gap:12px;}.gap-16{gap:16px;}
.items-center{align-items:center;}.justify-between{justify-content:space-between;}
.text-green{color:var(--green);}.text-muted{color:var(--muted);}.text-dark{color:var(--text);}
.font-bold{font-weight:700;}.font-georgia{font-family:Georgia,serif;}
.text-11{font-size:11px;}.text-12{font-size:12px;}.text-13{font-size:13px;}.text-14{font-size:14px;}.text-15{font-size:15px;}
.mb-8{margin-bottom:8px;}.mb-12{margin-bottom:12px;}.mb-16{margin-bottom:16px;}
.mt-8{margin-top:8px;}.mt-12{margin-top:12px;}.mt-16{margin-top:16px;}
.overflow-x{overflow-x:auto;}
.section-gap{margin-bottom:20px;}
/* â”€â”€ FOTOS â”€â”€ */
.photo-upload-box{border:2px dashed var(--border2);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all 0.2s;background:var(--cardL);}
.photo-upload-box:hover{border-color:var(--green);background:var(--greenPale);}
.photo-upload-box input[type=file]{display:none;}
.photo-preview{width:100%;height:140px;object-fit:cover;border-radius:10px;border:1px solid var(--border);}
.photo-preview-sm{width:60px;height:60px;object-fit:cover;border-radius:8px;border:1px solid var(--border);}
.photo-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px;}
.photo-grid-item{position:relative;aspect-ratio:1;}
.photo-grid-item img{width:100%;height:100%;object-fit:cover;border-radius:8px;border:1px solid var(--border);}
.photo-grid-item .del-photo{position:absolute;top:3px;right:3px;background:rgba(0,0,0,0.6);color:#fff;border:none;border-radius:50%;width:20px;height:20px;font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.upload-progress{height:4px;background:var(--border);border-radius:2px;margin-top:8px;overflow:hidden;display:none;}
.upload-progress-bar{height:100%;background:var(--green);width:0%;transition:width 0.3s;border-radius:2px;}
.foto-perfil-circle{width:64px;height:64px;border-radius:50%;object-fit:cover;border:2px solid var(--border);flex-shrink:0;}


/* â”€â”€ AUTH EXTRA â”€â”€ */
.login-divider{display:flex;align-items:center;gap:10px;margin:14px 0;}
.login-divider::before,.login-divider::after{content:'';flex:1;height:1px;background:var(--border);}
.login-divider span{font-size:11px;color:var(--muted);white-space:nowrap;}
.verify-option{border:1.5px solid var(--border);border-radius:12px;padding:16px;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:14px;}
.verify-option:hover,.verify-option.selected{border-color:var(--green);background:var(--greenPale);}
.verify-option-icon{font-size:28px;flex-shrink:0;}
.otp-inputs{display:flex;gap:10px;justify-content:center;margin:20px 0;}
.otp-input{width:46px;height:56px;border:2px solid var(--border);border-radius:10px;text-align:center;font-size:24px;font-weight:700;color:var(--text);background:var(--bg);outline:none;transition:border-color 0.2s;}
.otp-input:focus{border-color:var(--green);}
.strength-bar{height:4px;border-radius:2px;transition:all 0.3s;margin-top:6px;}
.input-icon-wrap{position:relative;}
.input-icon-wrap input{padding-right:40px;}
.input-icon-wrap .toggle-pass{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px;}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading">
  <div class="spin"></div>
  <div style="font-size:12px;color:var(--muted);letter-spacing:2px;">CARGANDO...</div>
</div>

<!-- LOGIN SCREEN â€” multiple views -->
<div id="loginScreen" style="display:none;">
  <div class="login-card" style="max-width:400px;">

    <!-- LOGO (shared) -->
    <div class="login-logo">
      <img src="Logo_Golfeados.png" alt="Golfeados"/>
      <div class="login-title">GOLFEADOS</div>
      <div class="login-sub">Golf Club Â· Tournament Manager</div>
    </div>

    <!-- â‘  LOGIN -->
    <div id="loginView">
      <div id="loginError" class="error-box" style="display:none;"></div>
      <div class="field">
        <label>Email, usuario o telÃ©fono</label>
        <input type="text" id="loginIdentifier" placeholder="email / @usuario / +58414..." autocomplete="username"
          oninput="updateLoginHint(this)"/>
        <div id="loginHint" style="font-size:11px;color:var(--muted);margin-top:4px;"></div>
      </div>
      <div class="field">
        <label>ContraseÃ±a</label>
        <div class="input-icon-wrap">
          <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"/>
          <button class="toggle-pass" type="button" onclick="togglePass('loginPassword',this)">ğŸ‘</button>
        </div>
      </div>
      <button class="btn-login" id="loginBtn" onclick="handleLogin()">Entrar al Club</button>
      <div class="login-or">o</div>
      <button class="btn-google" onclick="handleGoogleSignIn()">
        <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.08 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.35-8.16 2.35-6.26 0-11.57-3.59-13.46-8.83l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
        Continuar con Google
      </button>
      <div class="login-divider"><span>Â¿No tienes cuenta?</span></div>
      <button class="btn-login" style="background:transparent;border:2px solid var(--green);color:var(--green);box-shadow:none;" onclick="showRegister()">Crear cuenta</button>
      <button class="btn-link" onclick="showReset()">Â¿Olvidaste tu contraseÃ±a?</button>
    </div>

    <!-- â‘¡ REGISTRO -->
    <div id="registerView" style="display:none;">
      <div style="font-size:15px;font-weight:700;color:var(--green);margin-bottom:16px;">Crear cuenta</div>
      <div id="registerError" class="error-box" style="display:none;"></div>
      <div class="field">
        <label>Nombre completo *</label>
        <input type="text" id="regNombre" placeholder="Ej: Daniel Badell"/>
      </div>
      <div class="field">
        <label>Nombre de usuario *</label>
        <div class="input-icon-wrap">
          <input type="text" id="regUsername" placeholder="@badell" oninput="formatUsername(this)"/>
        </div>
        <div id="usernameHint" style="font-size:11px;color:var(--muted);margin-top:4px;">Solo letras, nÃºmeros y guiÃ³n bajo</div>
      </div>
      <div class="field">
        <label>Email *</label>
        <input type="email" id="regEmail" placeholder="tu@email.com" autocomplete="email"/>
      </div>
      <div class="field">
        <label>TelÃ©fono (opcional pero recomendado)</label>
        <div style="display:flex;gap:8px;">
          <select class="form-select" id="regPaisCodigo" style="width:110px;">
            <option value="+58">ğŸ‡»ğŸ‡ª +58</option>
            <option value="+1">ğŸ‡ºğŸ‡¸ +1</option>
            <option value="+34">ğŸ‡ªğŸ‡¸ +34</option>
            <option value="+52">ğŸ‡²ğŸ‡½ +52</option>
            <option value="+57">ğŸ‡¨ğŸ‡´ +57</option>
            <option value="+51">ğŸ‡µğŸ‡ª +51</option>
            <option value="+54">ğŸ‡¦ğŸ‡· +54</option>
            <option value="+56">ğŸ‡¨ğŸ‡± +56</option>
            <option value="+55">ğŸ‡§ğŸ‡· +55</option>
          </select>
          <input class="form-input" id="regTelefono" type="tel" placeholder="4141234567" style="flex:1;"
            oninput="this.value=this.value.replace(/[^0-9]/g,'')"/>
        </div>
      </div>
      <div class="field">
        <label>ContraseÃ±a *</label>
        <div class="input-icon-wrap">
          <input type="password" id="regPassword" placeholder="MÃ­n. 6 caracteres" oninput="checkStrength(this)"/>
          <button class="toggle-pass" type="button" onclick="togglePass('regPassword',this)">ğŸ‘</button>
        </div>
        <div class="strength-bar" id="strengthBar" style="background:var(--border);width:0%;"></div>
        <div id="strengthLabel" style="font-size:11px;color:var(--muted);margin-top:4px;"></div>
      </div>
      <button class="btn-login" id="regBtn" onclick="handleRegister()">Continuar â†’</button>
      <div class="login-or">o regÃ­strate con</div>
      <button class="btn-google" onclick="handleGoogleSignIn()">
        <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.08 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.35-8.16 2.35-6.26 0-11.57-3.59-13.46-8.83l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
        Continuar con Google
      </button>
      <button class="btn-link" onclick="showLogin()">â† Ya tengo cuenta</button>
    </div>

    <!-- COMPLETAR PERFIL (Google nuevos usuarios) -->
    <div id="completarPerfilView" style="display:none;">
      <div style="text-align:center;margin-bottom:20px;">
        <div style="font-size:40px;margin-bottom:8px;">â›³</div>
        <div style="font-size:16px;font-weight:700;color:var(--green);">Â¡Bienvenido al club!</div>
        <div style="font-size:12px;color:var(--muted);margin-top:6px;">Un paso mÃ¡s para completar tu perfil</div>
      </div>
      <div id="completarPerfilError" class="error-box" style="display:none;margin-bottom:12px;"></div>
      <div class="field">
        <label>Nombre completo</label>
        <input type="text" id="completarNombre" placeholder="Ej: JesÃºs Aguiar"/>
      </div>
      <div class="field">
        <label>Nombre de usuario *</label>
        <div class="input-icon-wrap">
          <input type="text" id="completarUsername" placeholder="@tuusuario"
            oninput="formatUsername(this)"/>
        </div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px;">Solo letras, nÃºmeros y guiÃ³n bajo</div>
      </div>
      <div class="field">
        <label>TelÃ©fono / WhatsApp (opcional)</label>
        <div style="display:flex;gap:8px;">
          <select class="form-select" id="completarPais" style="width:110px;">
            <option value="+58">ğŸ‡»ğŸ‡ª +58</option>
            <option value="+1">ğŸ‡ºğŸ‡¸ +1</option>
            <option value="+34">ğŸ‡ªğŸ‡¸ +34</option>
            <option value="+57">ğŸ‡¨ğŸ‡´ +57</option>
          </select>
          <input class="form-input" id="completarTel" type="tel" placeholder="4141234567" style="flex:1;"
            oninput="this.value=this.value.replace(/[^0-9]/g,'')"/>
        </div>
      </div>
      <button class="btn-login" id="completarBtn" onclick="handleCompletarPerfil()">Entrar al Club ğŸŒï¸</button>
    </div>

    <!-- â‘¢ ELEGIR VERIFICACIÃ“N -->
    <div id="verifyChoiceView" style="display:none;">
      <div style="font-size:15px;font-weight:700;color:var(--green);margin-bottom:6px;">Verificar tu cuenta</div>
      <div style="font-size:13px;color:var(--muted);margin-bottom:20px;">Verifica al menos uno para activar tu cuenta.</div>
      <div id="verifyChoiceError" class="error-box" style="display:none;"></div>
      <div class="verify-option mb-12" id="optEmail" onclick="chooseVerify('email')">
        <div class="verify-option-icon">ğŸ“§</div>
        <div>
          <div style="font-weight:700;font-size:14px;">Verificar por Email</div>
          <div id="verifyEmailAddr" style="font-size:12px;color:var(--muted);">Gratis e instantÃ¡neo</div>
        </div>
      </div>
      <div class="verify-option" id="optSMS" onclick="chooseVerify('sms')">
        <div class="verify-option-icon">ğŸ“±</div>
        <div>
          <div style="font-weight:700;font-size:14px;">Verificar por SMS</div>
          <div id="verifyPhoneNum" style="font-size:12px;color:var(--muted);">RecibirÃ¡s un cÃ³digo de 6 dÃ­gitos</div>
        </div>
      </div>
      <div id="recaptcha-container" style="margin-top:12px;"></div>
      <button class="btn-login" style="margin-top:16px;" id="btnSendVerify" onclick="sendVerification()">Enviar cÃ³digo</button>
      <button class="btn-link" onclick="skipVerify()">Verificar mÃ¡s tarde</button>
    </div>

    <!-- â‘£ CÃ“DIGO SMS -->
    <div id="smsCodeView" style="display:none;">
      <div style="text-align:center;margin-bottom:20px;">
        <div style="font-size:36px;margin-bottom:10px;">ğŸ“±</div>
        <div style="font-size:15px;font-weight:700;color:var(--green);">CÃ³digo enviado</div>
        <div id="smsSentTo" style="font-size:13px;color:var(--muted);margin-top:4px;"></div>
      </div>
      <div id="smsError" class="error-box" style="display:none;"></div>
      <div class="otp-inputs">
        <input class="otp-input" id="otp0" maxlength="1" oninput="otpNext(this,0)" onkeydown="otpBack(event,0)"/>
        <input class="otp-input" id="otp1" maxlength="1" oninput="otpNext(this,1)" onkeydown="otpBack(event,1)"/>
        <input class="otp-input" id="otp2" maxlength="1" oninput="otpNext(this,2)" onkeydown="otpBack(event,2)"/>
        <input class="otp-input" id="otp3" maxlength="1" oninput="otpNext(this,3)" onkeydown="otpBack(event,3)"/>
        <input class="otp-input" id="otp4" maxlength="1" oninput="otpNext(this,4)" onkeydown="otpBack(event,4)"/>
        <input class="otp-input" id="otp5" maxlength="1" oninput="otpNext(this,5)" onkeydown="otpBack(event,5)"/>
      </div>
      <button class="btn-login" id="btnConfirmSMS" onclick="confirmSMS()">Confirmar cÃ³digo</button>
      <button class="btn-link" onclick="showVerifyChoice()">â† Cambiar mÃ©todo</button>
      <button class="btn-link" id="btnResendSMS" onclick="resendSMS()" style="display:none;">Reenviar cÃ³digo</button>
    </div>

    <!-- â‘¤ EMAIL ENVIADO -->
    <div id="emailSentView" style="display:none;">
      <div style="text-align:center;padding:10px 0 20px;">
        <div style="font-size:48px;margin-bottom:12px;">ğŸ“§</div>
        <div style="font-size:16px;font-weight:700;color:var(--green);">Â¡Revisa tu email!</div>
        <div id="emailSentAddr" style="font-size:13px;color:var(--muted);margin-top:6px;line-height:1.5;"></div>
      </div>
      <button class="btn-login" onclick="recheckEmail()">Ya verifiquÃ© mi email âœ“</button>
      <button class="btn-link" onclick="resendEmail()">Reenviar email</button>
      <button class="btn-link" onclick="skipVerify()">Verificar mÃ¡s tarde</button>
    </div>

    <!-- â‘¥ VERIFICACIÃ“N PENDIENTE (usuario ya registrado pero no verificÃ³) -->
    <!-- VINCULAR CUENTA CON CÃ“DIGO DE INVITACIÃ“N -->
    <div id="vincularView" style="display:none;">
      <div style="text-align:center;padding:10px 0 20px;">
        <div style="font-size:48px;margin-bottom:12px;">â›³</div>
        <div style="font-size:16px;font-weight:700;color:var(--green);margin-bottom:8px;">Â¡Bienvenido al club!</div>
        <div style="font-size:13px;color:var(--muted);line-height:1.5;">Si el administrador ya cargÃ³ tu perfil de jugador,<br/>ingresa tu cÃ³digo de invitaciÃ³n para vincularte.</div>
      </div>
      <div id="vincularError" class="error-box" style="display:none;margin-bottom:12px;"></div>
      <div class="field">
        <label>CÃ³digo de invitaciÃ³n</label>
        <input type="text" id="vincularCodigo" placeholder="GOLF-XXXX" 
          style="text-transform:uppercase;letter-spacing:2px;font-size:18px;text-align:center;font-weight:700;"
          oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9-]/g,'')"/>
      </div>
      <button class="btn-login" id="vincularBtn" onclick="handleVincular()">Vincular mi perfil ğŸŒï¸</button>
      <button class="btn-link" style="margin-top:10px;" onclick="skipVincular()">Saltar por ahora â†’</button>
    </div>

    <div id="pendingVerifyView" style="display:none;">
      <div style="text-align:center;padding:10px 0 20px;">
        <div style="font-size:48px;margin-bottom:12px;">âš ï¸</div>
        <div style="font-size:15px;font-weight:700;color:var(--gold);">Cuenta pendiente de verificaciÃ³n</div>
        <div style="font-size:13px;color:var(--muted);margin-top:8px;line-height:1.5;">Debes verificar tu email o telÃ©fono para acceder.</div>
      </div>
      <button class="btn-login" onclick="showVerifyChoice()">Verificar ahora</button>
      <button class="btn-link" onclick="handleLogout()">Cerrar sesiÃ³n</button>
    </div>

    <!-- â‘¦ RESET PASSWORD -->
    <div id="resetView" style="display:none;">
      <div style="font-size:13px;color:var(--muted);margin-bottom:14px;">Ingresa tu email para recibir un enlace de recuperaciÃ³n.</div>
      <div id="resetError" class="error-box" style="display:none;"></div>
      <div id="resetSuccess" style="display:none;text-align:center;padding:20px 0;">
        <div style="font-size:40px;margin-bottom:10px;">ğŸ“§</div>
        <div style="color:var(--text);font-size:14px;">Email de recuperaciÃ³n enviado.</div>
      </div>
      <div id="resetForm">
        <div class="field"><label>Email</label><input type="email" id="resetEmail" placeholder="tu@email.com"/></div>
        <button class="btn-login" onclick="handleReset()">Enviar Email</button>
      </div>
      <button class="btn-link" onclick="showLogin()">â† Volver al login</button>
    </div>

  </div>
  <div class="login-footer">PLAY Â· RELAX Â· ENJOY Â· SINCE 2024</div>
</div>

<!-- BANNER ACTUALIZACIÃ“N -->
<div id="updateBanner" style="display:none;position:fixed;bottom:0;left:0;right:0;z-index:500;
  background:linear-gradient(135deg,var(--green),var(--teal));
  padding:14px 20px;display:flex;align-items:center;justify-content:space-between;
  box-shadow:0 -4px 20px rgba(0,0,0,0.2);gap:12px;">
  <div>
    <div style="color:#fff;font-weight:700;font-size:14px;">ğŸ”„ Nueva versiÃ³n disponible</div>
    <div style="color:rgba(255,255,255,0.8);font-size:12px;margin-top:2px;" id="updateBannerSub">Nueva versiÃ³n disponible</div>
  </div>
  <button onclick="forceUpdate()" style="background:#fff;color:var(--green);border:none;border-radius:8px;
    padding:10px 18px;font-weight:800;font-size:13px;white-space:nowrap;cursor:pointer;">
    Actualizar
  </button>
</div>

<!-- APP -->
<div id="app" style="display:none;">
  <div id="header">
    <div class="header-logo">
      <img src="Logo_Golfeados.png" alt="Golfeados"/>
      <div>
        <div class="header-title">GOLFEADOS</div>
        <div class="header-sub">Golf Club</div>
      </div>
    </div>
    <div class="header-right">
      <span id="adminBadge" class="badge-admin" style="display:none;">ADMIN</span>
      <div id="connPill" title="Estado de conexiÃ³n" style="display:flex;align-items:center;gap:4px;padding:3px 8px;border-radius:20px;font-size:10px;font-weight:700;letter-spacing:0.5px;background:#E8F5E9;color:#2E7D32;border:1px solid #A5D6A7;transition:all 0.4s;">
        <span id="connDot" style="width:6px;height:6px;border-radius:50%;background:#4CAF50;display:inline-block;"></span>
        <span id="connLabel">EN VIVO</span>
      </div>
      <span id="headerUser" class="header-user" onclick="openPerfilModal()" style="cursor:pointer;"></span>
      <button class="btn-logout" onclick="handleLogout()">Salir</button>
    </div>
  </div>

  <div id="nav">
    <button class="nav-btn active" data-tab="dashboard" onclick="goTab('dashboard')">ğŸ  Inicio</button>
    <button class="nav-btn" data-tab="mistorneos" onclick="goTab('mistorneos')">ğŸ† Mis Torneos</button>
    <button class="nav-btn" data-tab="jornadas" onclick="goTab('jornadas')">ğŸŒï¸ Partidas</button>
    <button class="nav-btn" data-tab="jugadores" onclick="goTab('jugadores')">ğŸ‘¤ Jugadores</button>
    <button class="nav-btn" data-tab="clubes" onclick="goTab('clubes')">â›³ Clubes</button>
  </div>

  <div id="content">
    <div id="tab-dashboard"></div>
    <div id="tab-mistorneos" style="display:none;"></div>
    <div id="tab-jornadas" style="display:none;"></div>
    <div id="tab-jugadores" style="display:none;"></div>
    <div id="tab-clubes" style="display:none;"></div>
    <div id="tab-cargar" style="display:none;"></div>
  </div>
</div>

<!-- MODAL JORNADA -->
<div id="modalJornada" class="modal-overlay" style="display:none;" onclick="closeModalJornada()">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="modalJornadaTitle">Nueva Partida</div>
      <button onclick="closeModalJornada()" style="background:none;border:none;font-size:20px;color:var(--muted);cursor:pointer;">âœ•</button>
    </div>
    <div class="modal-body">
      <div id="modalJornadaError" class="error-box" style="display:none;"></div>
      <div style="display:flex;flex-direction:column;gap:14px;">
        <div>
          <label class="form-label">Club / Sede *</label>
          <select class="form-select" id="jornadaClub" style="width:100%;"></select>
        </div>
        <div>
          <label class="form-label">Fecha *</label>
          <input type="date" class="form-input" id="jornadaFecha"/>
        </div>
        <div style="display:flex;gap:12px;">
          <div style="flex:1;">
            <label class="form-label">Tee Time</label>
            <div style="display:flex;gap:6px;align-items:center;">
              <select class="form-select" id="teeHH" style="width:75px;">
                <option value="05">05</option>
                <option value="06">06</option>
                <option value="07">07</option>
                <option value="08">08</option>
                <option value="09">09</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
                <option value="15">15</option>
                <option value="16">16</option>
                <option value="17">17</option>
                <option value="18">18</option>
                <option value="19">19</option>
                <option value="20">20</option>
                <option value="21">21</option>
              </select>
              <span style="font-weight:700;color:var(--text);">:</span>
              <select class="form-select" id="teeMM" style="width:75px;">
                <option value="00">00</option>
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="30">30</option>
                <option value="40">40</option>
                <option value="50">50</option>
              </select>
            </div>
          </div>
          <div style="flex:2;">
            <label class="form-label">Notas (opcional)</label>
            <input type="text" class="form-input" id="jornadaNotas" placeholder="Ej: Scramble, 18 hoyos..."/>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--cardL);border-radius:10px;border:1px solid var(--border);">
            <input type="checkbox" id="jornadaCuentaRanking" checked style="width:18px;height:18px;cursor:pointer;accent-color:var(--green);"/>
            <div>
              <label for="jornadaCuentaRanking" style="font-weight:700;font-size:13px;cursor:pointer;">Cuenta para el ranking</label>
              <div style="font-size:11px;color:var(--muted);">Desactiva para partidas de prÃ¡ctica o exhibiciÃ³n (ğŸš«)</div>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--cardL);border-radius:10px;border:1px solid var(--border);">
            <input type="checkbox" id="jornadaReglasEspeciales" style="width:18px;height:18px;cursor:pointer;accent-color:var(--blue);"
              onchange="document.getElementById('reglasEspecialesPanel').style.display=this.checked?'block':'none'"/>
            <div>
              <label for="jornadaReglasEspeciales" style="font-weight:700;font-size:13px;cursor:pointer;">âš™ï¸ Reglas especiales para esta partida</label>
              <div style="font-size:11px;color:var(--muted);">Anulan las reglas del torneo solo para esta partida</div>
            </div>
          </div>
          <div id="reglasEspecialesPanel" style="display:none;background:var(--cardL);border-radius:10px;padding:14px;border:1px solid var(--border);">
            <div class="text-11 text-muted font-bold" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">Puntos por posiciÃ³n</div>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px;">
              <div style="text-align:center;"><div style="font-size:16px;">ğŸ¥‡</div><input type="number" class="form-input" id="jrPts1" placeholder="4" min="0" style="text-align:center;padding:6px 4px;"/></div>
              <div style="text-align:center;"><div style="font-size:16px;">ğŸ¥ˆ</div><input type="number" class="form-input" id="jrPts2" placeholder="3" min="0" style="text-align:center;padding:6px 4px;"/></div>
              <div style="text-align:center;"><div style="font-size:16px;">ğŸ¥‰</div><input type="number" class="form-input" id="jrPts3" placeholder="2" min="0" style="text-align:center;padding:6px 4px;"/></div>
              <div style="text-align:center;"><div style="font-size:11px;color:var(--muted);margin-bottom:4px;">Resto</div><input type="number" class="form-input" id="jrPtsResto" placeholder="1" min="0" style="text-align:center;padding:6px 4px;"/></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <div><label class="form-label">âœ… Bonus asistencia</label>
                <div style="display:flex;align-items:center;gap:6px;"><input type="number" class="form-input" id="jrBonus" value="0" min="0" style="width:65px;text-align:center;"/><span class="text-11 text-muted">pts</span></div></div>
              <div><label class="form-label">âŒ Penal no asistencia</label>
                <div style="display:flex;align-items:center;gap:6px;"><input type="number" class="form-input" id="jrPenalNoAsist" value="0" style="width:65px;text-align:center;"/><span class="text-11 text-muted">pts</span></div></div>
              <div><label class="form-label">ğŸš« Penal DQ</label>
                <div style="display:flex;align-items:center;gap:6px;"><input type="number" class="form-input" id="jrPenalDQ" value="0" style="width:65px;text-align:center;"/><span class="text-11 text-muted">pts</span></div></div>
            </div>
          </div>
        </div>
      </div>
<!-- fotos se cargan en pantalla de resultados -->
    </div>
    <div class="modal-footer">
      <button class="btn-outline" onclick="closeModalJornada()">Cancelar</button>
      <button class="btn-green" id="btnGuardarJornada" onclick="saveJornada()">Guardar Partida</button>
    </div>
  </div>
</div>


<!-- MODAL CLUB -->
<div id="modalClub" class="modal-overlay" style="display:none;" onclick="closeModalClub()">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="modalClubTitle">Nuevo Club</div>
      <button onclick="closeModalClub()" style="background:none;border:none;font-size:20px;color:var(--muted);cursor:pointer;">âœ•</button>
    </div>
    <div class="modal-body">
      <div id="modalClubError" class="error-box" style="display:none;"></div>
      <div style="display:flex;flex-direction:column;gap:14px;">
        <div><label class="form-label">Nombre del Club *</label><input class="form-input" id="clubNombre" placeholder="Ej: Izcaragua Country Club"/></div>
        <div><label class="form-label">Ciudad</label><input class="form-input" id="clubCiudad" placeholder="Ej: Caracas"/></div>
        <div style="display:flex;gap:12px;">
          <div style="width:80px;"><label class="form-label">Iniciales</label><input class="form-input" id="clubIniciales" placeholder="IC" maxlength="3"/></div>
          <div style="flex:1;"><label class="form-label">Color avatar</label>
            <select class="form-select" id="clubColor" style="width:100%;">
              <option value="#2E7D5E">Verde</option>
              <option value="#1A6B8A">Azul</option>
              <option value="#0D7377">Teal</option>
              <option value="#7B1FA2">Morado</option>
              <option value="#C49A00">Dorado</option>
              <option value="#D32F2F">Rojo</option>
            </select>
          </div>
        </div>
        <div>
          <label class="form-label">Foto del Club (opcional)</label>
          <div class="photo-upload-box" onclick="document.getElementById('clubFotoInput').click()">
            <img id="clubFotoPreview" style="display:none;width:100%;height:120px;object-fit:cover;border-radius:8px;margin-bottom:8px;"/>
            <div id="clubFotoPlaceholder">ğŸ“· Toca para subir foto</div>
            <input type="file" id="clubFotoInput" accept="image/*" onchange="previewPhoto(this,'clubFotoPreview','clubFotoPlaceholder')"/>
          </div>
          <div class="upload-progress"><div class="upload-progress-bar" id="clubFotoProgress"></div></div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-outline" onclick="closeModalClub()">Cancelar</button>
      <button class="btn-green" id="btnGuardarClub" onclick="saveClub()">Guardar Club</button>
    </div>
  </div>
</div>

<!-- MODAL JUGADOR EDIT -->
<div id="modalJugador" class="modal-overlay" style="display:none;" onclick="closeModalJugador()">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title">Editar Jugador</div>
      <button onclick="closeModalJugador()" style="background:none;border:none;font-size:20px;color:var(--muted);cursor:pointer;">âœ•</button>
    </div>
    <div class="modal-body">
      <div id="modalJugadorError" class="error-box" style="display:none;"></div>
      <div style="display:flex;flex-direction:column;gap:14px;">
        <div style="display:flex;align-items:center;gap:16px;">
          <div style="position:relative;flex-shrink:0;">
            <img id="jugadorFotoPreview" src="" style="display:none;" class="foto-perfil-circle"/>
            <div id="jugadorFotoFallback" style="width:64px;height:64px;border-radius:50%;background:var(--green);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:20px;">ğŸ‘¤</div>
            <button type="button" onclick="document.getElementById('jugadorFotoInput').click()" 
              style="position:absolute;bottom:0;right:0;background:var(--green);border:none;border-radius:50%;width:22px;height:22px;color:#fff;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;">âœï¸</button>
            <input type="file" id="jugadorFotoInput" accept="image/*" style="display:none;" onchange="previewPhoto(this,'jugadorFotoPreview','jugadorFotoFallback')"/>
          </div>
          <div style="flex:1;"><label class="form-label">Nombre Completo *</label><input class="form-input" id="editNombre" placeholder="Nombre completo"/></div>
        </div>
        <div style="display:flex;gap:12px;">
          <div style="flex:1;"><label class="form-label">Alias</label><input class="form-input" id="editAlias" placeholder="Alias o apodo"/></div>
          <div style="width:80px;"><label class="form-label">Iniciales</label><input class="form-input" id="editFoto" placeholder="DB" maxlength="2"/></div>
        </div>
        <div><label class="form-label">Handicap</label><input class="form-input" id="editHandicap" type="number" min="0" max="54" placeholder="0" style="width:100px;"/></div>
        <div>
          <label class="form-label">TelÃ©fono / WhatsApp</label>
          <div style="display:flex;gap:8px;align-items:center;">
            <select class="form-select" id="editPaisCodigo" style="width:110px;">
              <option value="+58">ğŸ‡»ğŸ‡ª +58</option>
              <option value="+1">ğŸ‡ºğŸ‡¸ +1</option>
              <option value="+34">ğŸ‡ªğŸ‡¸ +34</option>
              <option value="+52">ğŸ‡²ğŸ‡½ +52</option>
              <option value="+57">ğŸ‡¨ğŸ‡´ +57</option>
              <option value="+51">ğŸ‡µğŸ‡ª +51</option>
              <option value="+54">ğŸ‡¦ğŸ‡· +54</option>
              <option value="+56">ğŸ‡¨ğŸ‡± +56</option>
              <option value="+55">ğŸ‡§ğŸ‡· +55</option>
              <option value="+507">ğŸ‡µğŸ‡¦ +507</option>
            </select>
            <input class="form-input" id="editTelefono" type="tel" placeholder="4141234567" style="flex:1;" oninput="validarTelefono(this)"/>
          </div>
          <div id="telefonoHint" style="font-size:11px;color:var(--muted);margin-top:4px;">Solo nÃºmeros, sin espacios ni guiones. Ej: 4141234567</div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-outline" onclick="closeModalJugador()">Cancelar</button>
      <button class="btn-green" id="btnGuardarJugador" onclick="saveJugador()">Guardar</button>
    </div>
  </div>
</div>


<!-- MODAL TORNEO â€” Crear / Editar -->
<div id="modalTorneo" class="modal-overlay" style="display:none;" onclick="closeModalTorneo(event)">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="modalTorneoTitle">Nuevo Torneo</div>
      <button onclick="closeModalTorneo()" style="background:none;border:none;font-size:20px;color:var(--muted);cursor:pointer;">âœ•</button>
    </div>
    <div class="modal-body" style="display:flex;flex-direction:column;gap:16px;">
      <div id="modalTorneoError" class="error-box" style="display:none;"></div>

      <!-- INFO BÃSICA -->
      <div style="background:var(--cardL);border-radius:10px;padding:14px;border:1px solid var(--border);">
        <div class="text-12 font-bold text-muted" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:12px;">ğŸ“‹ InformaciÃ³n</div>
        <div style="display:flex;flex-direction:column;gap:12px;">
          <div><label class="form-label">Nombre del Torneo *</label>
            <input class="form-input" id="tNombre" placeholder="Ej: Torneo Apertura 2026"/></div>
<!-- fechas: se gestionan por partidas -->
          <div style="display:flex;gap:12px;">
            <div style="flex:1;"><label class="form-label">NÂ° Partidas</label>
              <input type="number" class="form-input" id="tJornadasTotal" min="1" max="52" placeholder="8"/></div>
            <div style="flex:1;"><label class="form-label">Estado</label>
              <select class="form-select" id="tEstado" style="width:100%;">
                <option value="Borrador">Borrador</option>
                <option value="Activo" selected>Activo</option>
                <option value="Finalizado">Finalizado</option>
              </select></div>
          </div>
          <div>
            <label class="form-label">DescripciÃ³n (opcional)</label>
            <textarea class="form-input" id="tDescripcion" placeholder="DescripciÃ³n del torneo..." rows="3" style="resize:vertical;"></textarea>
          </div>
                      <div>
            <label class="form-label">Documento / imagen (opcional)</label>
            <div onclick="document.getElementById('tDocInput').click()" id="tDocBox"
              style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--cardL);border-radius:10px;border:2px dashed var(--border);cursor:pointer;min-height:52px;">
              <span style="font-size:22px;flex-shrink:0;">ğŸ“</span>
              <div style="flex:1;min-width:0;">
                <div id="tDocLabel" style="font-size:12px;color:var(--muted);line-height:1.3;">Subir PDF o imagen</div>
              </div>
              <img id="tDocPreview" style="display:none;width:44px;height:44px;object-fit:cover;border-radius:6px;flex-shrink:0;"/>
              <input type="file" id="tDocInput" accept="image/*,application/pdf" style="display:none;" onchange="previewTorneoDoc(this)"/>
            </div>
            <div id="tDocExisting" style="display:none;margin-top:8px;display:flex;align-items:center;gap:8px;">
              <a id="tDocLink" href="#" target="_blank" style="font-size:12px;color:var(--blue);">ğŸ“ Ver documento actual</a>
              <button onclick="clearTorneoDoc()" style="background:none;border:none;color:var(--muted);font-size:12px;cursor:pointer;">âœ• Quitar</button>
            </div>
            <div class="upload-progress"><div class="upload-progress-bar" id="tDocProgress"></div></div>
          </div>
          <div style="display:flex;gap:12px;">
            <div style="flex:1;"><label class="form-label">Visibilidad</label>
              <select class="form-select" id="tVisibilidad" style="width:100%;">
                <option value="privado">ğŸ”’ Privado</option>
                <option value="publico">ğŸŒ PÃºblico</option>
              </select></div>
            <div style="flex:1;"><label class="form-label">Â¿QuiÃ©n carga?</label>
              <select class="form-select" id="tQuienCarga" style="width:100%;">
                <option value="admins">Solo admins</option>
                <option value="cualquiera">Cualquier jugador</option>
              </select></div>
          </div>
        </div>
      </div>

      <!-- REGLAS DE PUNTUACIÃ“N -->
      <div style="background:var(--cardL);border-radius:10px;padding:14px;border:1px solid var(--border);">
        <div class="text-12 font-bold text-muted" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:12px;">âš™ï¸ Reglas de PuntuaciÃ³n</div>

        <!-- Puntos por posiciÃ³n -->
        <div style="margin-bottom:14px;">
          <label class="form-label">Puntos por posiciÃ³n</label>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:6px;">
            <div style="text-align:center;">
              <div style="font-size:18px;margin-bottom:4px;">ğŸ¥‡</div>
              <input type="number" class="form-input" id="rPts1" oninput="updateEmpateEjemplo()" value="4" min="0" style="text-align:center;padding:8px 4px;"/>
            </div>
            <div style="text-align:center;">
              <div style="font-size:18px;margin-bottom:4px;">ğŸ¥ˆ</div>
              <input type="number" class="form-input" id="rPts2" oninput="updateEmpateEjemplo()" value="3" min="0" style="text-align:center;padding:8px 4px;"/>
            </div>
            <div style="text-align:center;">
              <div style="font-size:18px;margin-bottom:4px;">ğŸ¥‰</div>
              <input type="number" class="form-input" id="rPts3" oninput="updateEmpateEjemplo()" value="2" min="0" style="text-align:center;padding:8px 4px;"/>
            </div>
            <div style="text-align:center;">
              <div style="font-size:18px;margin-bottom:4px;">ğŸŒï¸</div>
              <div style="font-size:10px;color:var(--muted);margin-bottom:4px;">Resto</div>
              <input type="number" class="form-input" id="rPtsResto" value="1" min="0" style="text-align:center;padding:8px 4px;"/>
            </div>
          </div>
        </div>

        <!-- Bonus / Penales -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
          <div>
            <label class="form-label">âœ… Bonus asistencia</label>
            <div style="display:flex;align-items:center;gap:6px;">
              <input type="number" class="form-input" id="rBonus" value="0" min="0" style="text-align:center;width:70px;"/>
              <span class="text-12 text-muted">pts extra</span>
            </div>
          </div>
          <div>
            <label class="form-label">âŒ Penal no asistencia</label>
            <div style="display:flex;align-items:center;gap:6px;">
              <input type="number" class="form-input" id="rPenalNoAsist" value="0" style="text-align:center;width:70px;"/>
              <span class="text-12 text-muted">pts</span>
            </div>
          </div>
          <div>
            <label class="form-label">ğŸš« Penal DQ</label>
            <div style="display:flex;align-items:center;gap:6px;">
              <input type="number" class="form-input" id="rPenalDQ" value="0" style="text-align:center;width:70px;"/>
              <span class="text-12 text-muted">pts</span>
            </div>
          </div>
          <div>
            <label class="form-label">ğŸ—‘ï¸ Descartes</label>
            <div style="display:flex;align-items:center;gap:6px;">
              <input type="number" class="form-input" id="rDescartes" value="0" min="0" style="text-align:center;width:70px;"/>
              <span class="text-12 text-muted">partidas</span>
            </div>
          </div>
        </div>

        <!-- Empates -->
        <div>
          <label class="form-label">ğŸ¤ Empates</label>
          <select class="form-select" id="rEmpates" style="width:100%;margin-top:6px;" onchange="updateEmpateEjemplo()" oninput="updateEmpateEjemplo()">
            <option value="comparten">Comparten puntos â€” promedio de posiciones empatadas</option>
            <option value="posicion_anterior">PosiciÃ³n anterior â€” ambos toman la misma posiciÃ³n</option>
          </select>
          <div id="empateEjemplo" style="margin-top:6px;font-size:11px;color:var(--muted);padding:8px 10px;background:var(--bg);border-radius:6px;"></div>
        </div>
      </div>


      <!-- DELEGAR ADMINS -->
      <div style="background:var(--cardL);border-radius:10px;padding:14px;border:1px solid var(--border);" id="seccionAdmins">
        <div class="text-12 font-bold text-muted" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:12px;">ğŸ‘¥ Co-Administradores</div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:10px;">Pueden cargar partidas, editar y gestionar el torneo.</div>
        <div id="adminsList" style="display:flex;flex-direction:column;gap:8px;margin-bottom:10px;"></div>
        <div style="display:flex;gap:8px;">
          <input class="form-input" id="addAdminInput" placeholder="Email o @usuario del jugador" style="flex:1;"/>
          <button class="btn-outline" style="white-space:nowrap;padding:8px 14px;" onclick="addCoAdmin()">+ Agregar</button>
        </div>
        <div id="addAdminError" style="font-size:11px;color:var(--red);margin-top:6px;display:none;"></div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-outline" onclick="closeModalTorneo()">Cancelar</button>
      <button class="btn-green" id="btnGuardarTorneo" onclick="saveModalTorneo()">Guardar Torneo</button>
    </div>
  </div>
</div>

<!-- MODAL AGREGAR JUGADOR -->
<div id="agregarJugadorModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9999;align-items:flex-end;justify-content:center;" onclick="closeAgregarJugadorModal()">
  <div style="background:var(--white);border-radius:20px 20px 0 0;width:100%;max-width:500px;padding:24px 20px 32px;max-height:85vh;overflow-y:auto;" onclick="event.stopPropagation()">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <div style="font-size:16px;font-weight:800;" id="modalAgregarTitle">Agregar jugador</div>
      <button onclick="closeAgregarJugadorModal()" style="background:none;border:none;font-size:22px;cursor:pointer;color:var(--muted);">âœ•</button>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:16px;">
      <button id="tabBuscar" onclick="switchAgregarTab('buscar')"
        style="flex:1;padding:8px;border-radius:8px;border:2px solid var(--green);background:var(--green);color:#fff;font-weight:700;font-size:13px;cursor:pointer;">ğŸ” Buscar</button>
      <button id="tabCrear" onclick="switchAgregarTab('crear')"
        style="flex:1;padding:8px;border-radius:8px;border:2px solid var(--border);background:transparent;color:var(--text);font-weight:700;font-size:13px;cursor:pointer;">+ Crear nuevo</button>
    </div>
    <div id="panelBuscar">
      <input type="text" id="buscarJugadorInput" placeholder="Nombre, alias, telÃ©fono o email..."
        style="width:100%;padding:12px;border:2px solid var(--border);border-radius:10px;background:var(--bg);color:var(--text);font-size:14px;"
        oninput="buscarJugadorGlobal(this.value)"/>
      <div id="buscarResultados" style="margin-top:12px;"></div>
    </div>
    <div id="panelCrear" style="display:none;">
      <div style="display:flex;flex-direction:column;gap:12px;">
        <div><label class="form-label">Nombre Completo *</label><input class="form-input" id="newNombre" placeholder="Ej: Daniel Badell"/></div>
        <div style="display:flex;gap:12px;">
          <div style="flex:1;"><label class="form-label">Alias</label><input class="form-input" id="newAlias" placeholder="Ej: Badell"/></div>
          <div style="width:90px;"><label class="form-label">Iniciales</label><input class="form-input" id="newFoto" placeholder="DB" maxlength="2"/></div>
        </div>
        <div>
          <label class="form-label">TelÃ©fono / WhatsApp</label>
          <div style="display:flex;gap:8px;align-items:center;">
            <select class="form-select" id="newPaisCodigo" style="width:110px;">
              <option value="+58">ğŸ‡»ğŸ‡ª +58</option><option value="+1">ğŸ‡ºğŸ‡¸ +1</option>
              <option value="+34">ğŸ‡ªğŸ‡¸ +34</option><option value="+52">ğŸ‡²ğŸ‡½ +52</option>
              <option value="+57">ğŸ‡¨ğŸ‡´ +57</option>
            </select>
            <input class="form-input" id="newTelefono" type="tel" placeholder="4141234567" style="flex:1;" oninput="validarTelefonoNew(this)"/>
          </div>
        </div>
        <div id="addJugadorError" class="error-box" style="display:none;"></div>
        <button type="button" id="btnCrearJugador" class="btn-green" style="width:100%;padding:12px;font-size:14px;cursor:pointer;">Crear y agregar al torneo ğŸŒï¸</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL PERFIL DE USUARIO -->
<div id="modalPerfil" class="modal-overlay" style="display:none;" onclick="closePerfilModal()">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title">ğŸ‘¤ Mi Perfil</div>
      <button onclick="closePerfilModal()" style="background:none;border:none;font-size:20px;color:var(--muted);cursor:pointer;">âœ•</button>
    </div>
    <div class="modal-body" style="padding:20px 24px;">
      <div id="perfilError" class="error-box" style="display:none;"></div>
      <div id="perfilSuccess" style="display:none;padding:10px 14px;background:#E8F5E9;color:#2E7D32;border-radius:10px;font-size:13px;margin-bottom:14px;font-weight:600;"></div>

      <!-- Foto de perfil -->
      <div style="text-align:center;margin-bottom:20px;">
        <div id="perfilFotoContainer" style="position:relative;display:inline-block;">
          <div id="perfilFotoPreview" style="width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,var(--green),var(--teal));display:flex;align-items:center;justify-content:center;color:#fff;font-size:28px;font-weight:800;margin:0 auto;overflow:hidden;border:3px solid var(--border);"></div>
          <label for="perfilFotoInput" style="position:absolute;bottom:0;right:calc(50% - 52px);width:28px;height:28px;border-radius:50%;background:var(--green);color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;border:2px solid var(--white);box-shadow:0 2px 6px rgba(0,0,0,0.2);">ğŸ“·</label>
          <input type="file" id="perfilFotoInput" accept="image/*" style="display:none;" onchange="handlePerfilFotoChange(event)"/>
        </div>
        <div id="perfilFotoProgress" style="display:none;margin-top:8px;">
          <div style="width:120px;height:4px;background:var(--border);border-radius:2px;margin:0 auto;overflow:hidden;">
            <div id="perfilFotoBar" style="width:0;height:100%;background:var(--green);transition:width 0.3s;"></div>
          </div>
        </div>
      </div>

      <!-- Datos -->
      <div style="display:flex;flex-direction:column;gap:14px;">
        <div>
          <label class="form-label">Nombre completo</label>
          <input type="text" class="form-input" id="perfilNombre" placeholder="Tu nombre"/>
        </div>
        <div>
          <label class="form-label">Alias / Apodo</label>
          <input type="text" class="form-input" id="perfilAlias" placeholder="CÃ³mo te llaman en el campo"/>
        </div>
        <div>
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="perfilEmail" disabled style="background:var(--bg);color:var(--muted);"/>
        </div>
        <div>
          <label class="form-label">Handicap</label>
          <input type="number" class="form-input" id="perfilHandicap" placeholder="0" step="0.1" min="0" max="54"/>
        </div>
      </div>

      <!-- Cambiar contraseÃ±a (solo para email/password users) -->
      <div id="perfilPasswordSection" style="margin-top:20px;border-top:1px solid var(--border);padding-top:16px;">
        <div class="text-13 font-bold" style="margin-bottom:12px;">ğŸ”’ Cambiar contraseÃ±a</div>
        <div style="display:flex;flex-direction:column;gap:10px;">
          <input type="password" class="form-input" id="perfilPassActual" placeholder="ContraseÃ±a actual"/>
          <input type="password" class="form-input" id="perfilPassNueva" placeholder="Nueva contraseÃ±a (mÃ­n. 6 caracteres)"/>
          <input type="password" class="form-input" id="perfilPassConfirm" placeholder="Confirmar nueva contraseÃ±a"/>
        </div>
      </div>

      <!-- Info de vinculaciÃ³n -->
      <div id="perfilVinculacion" style="margin-top:16px;padding:12px;background:var(--bg);border-radius:10px;border:1px solid var(--border);">
        <div class="text-11 text-muted font-bold" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">Jugador vinculado</div>
        <div id="perfilJugadorInfo" class="text-13"></div>
      </div>

      <!-- Vincular cÃ³digo de invitaciÃ³n -->
      <div id="perfilVincularSection" style="margin-top:16px;border-top:1px solid var(--border);padding-top:16px;">
        <div class="text-13 font-bold" style="margin-bottom:8px;">ğŸ”‘ Vincular cÃ³digo de invitaciÃ³n</div>
        <div class="text-11 text-muted" style="margin-bottom:10px;line-height:1.5;">Si un admin te dio un cÃ³digo para vincular un perfil existente con resultados, ingrÃ©salo aquÃ­.</div>
        <div style="display:flex;gap:8px;">
          <input type="text" class="form-input" id="perfilVincularCodigo" placeholder="GOLF-XXXX"
            style="text-transform:uppercase;letter-spacing:2px;font-weight:700;text-align:center;flex:1;"
            oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9-]/g,'')"/>
          <button class="btn-outline" onclick="handlePerfilVincular()" style="white-space:nowrap;padding:8px 14px;font-size:12px;">Vincular</button>
        </div>
        <div id="perfilVincularMsg" style="display:none;margin-top:8px;font-size:12px;padding:8px;border-radius:8px;"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-outline" onclick="closePerfilModal()">Cancelar</button>
      <button class="btn-green" onclick="savePerfilModal()">Guardar cambios</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VERSIÃ“N â€” cambia este nÃºmero cada vez que subas cambios
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const APP_VERSION = '4.3.0';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig = {
  apiKey:            "AIzaSyCu98_7auFGd3nJJmYDRCM7KaM5OdtCBx4",
  authDomain:        "golfeados-660b3.firebaseapp.com",
  projectId:         "golfeados-660b3",
  storageBucket:     "golfeados-660b3.firebasestorage.app",
  messagingSenderId: "417996522021",
  appId:             "1:417996522021:web:67871e33758befec81f5cc"
};
firebase.initializeApp(firebaseConfig);
const auth    = firebase.auth();
const db      = firebase.firestore();
const storage = firebase.storage();

// Handle Google redirect result (fires after page reloads from Google auth)
// Google auth uses popup (more reliable on mobile)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ESTADO GLOBAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let STATE = {
  user:null, profile:null,
  torneo:null,          // legacy single-torneo (kept for compatibility)
  torneos:[],           // filtered torneos (user's torneos)
  allTorneos:[],        // all platform torneos (for participant discovery)
  jugadores:[], jugadores_by_torneo:{}, jugadores_global:[], partidas:[], resultados:[], clubes:[],
  jornadas:[],
  linked_jugador_ids:new Set(),  // ALL jugador IDs linked to this user (for multi-torneo vincular)
  currentTab:'dashboard', cargarJornadaId:null,
  expandedJornada:null, expandedTorneo:null,
  expandedJornadaMT:null,  // partida expanded inside Mis Torneos
  chartInstance:null, editingJornadaId:null,
  activeTorneoId:null,  // torneo being viewed in detail
  unsubs:[]
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH â€” Multi-method login + Registration + Verification
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Show/hide login views
// â”€â”€ Google Sign-In â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleGoogleSignIn(){
  const errEl=document.getElementById('loginError')||document.getElementById('registerError');
  if(errEl) errEl.style.display='none';
  try{
    const provider=new firebase.auth.GoogleAuthProvider();
    provider.addScope('email');
    provider.addScope('profile');
    // signInWithPopup is more reliable on mobile than redirect
    // It works because it's called directly from a user tap (no await before it)
    await auth.signInWithPopup(provider);
    // onAuthStateChanged handles the rest automatically
  }catch(e){
    if(e.code==='auth/popup-closed-by-user'||e.code==='auth/cancelled-popup-request') return;
    if(e.code==='auth/popup-blocked'){
      // Popup was blocked by browser â€” fall back to redirect
      const provider2=new firebase.auth.GoogleAuthProvider();
      await auth.signInWithRedirect(provider2);
      return;
    }
    if(errEl){ errEl.textContent='Error con Google: '+e.message; errEl.style.display='block'; }
  }
}

// â”€â”€ Invite Code (Vincular cuenta) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showVincular(){ showLoginView('vincularView'); }
function showVincularModal(){
  const existing=document.getElementById('vincularModal');
  if(existing){ existing.style.display='flex'; return; }
  const m=document.createElement('div');
  m.id='vincularModal';
  m.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;';
  m.innerHTML=`<div style="background:var(--white);border-radius:20px;padding:28px 24px;max-width:360px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
    <div style="text-align:center;margin-bottom:20px;">
      <div style="font-size:40px;margin-bottom:8px;">â›³</div>
      <div style="font-size:16px;font-weight:700;color:var(--green);">Vincular perfil de jugador</div>
      <div style="font-size:12px;color:var(--muted);margin-top:6px;line-height:1.5;">Ingresa el cÃ³digo que te enviÃ³ el administrador para ver tus estadÃ­sticas y puntos.</div>
    </div>
    <div id="vincularModalError" class="error-box" style="display:none;margin-bottom:12px;"></div>
    <input type="text" id="vincularModalCodigo" placeholder="GOLF-XXXX"
      style="width:100%;padding:14px;text-align:center;font-size:20px;font-weight:700;letter-spacing:3px;text-transform:uppercase;border:2px solid var(--border);border-radius:10px;background:var(--bg);color:var(--text);margin-bottom:12px;"
      oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9-]/g,'')"/>
    <button class="btn-login" id="vincularModalBtn" onclick="handleVincularModal()">Vincular ğŸŒï¸</button>
    <button class="btn-link" style="margin-top:8px;" onclick="document.getElementById('vincularModal').style.display='none'">Saltar por ahora</button>
  </div>`;
  document.body.appendChild(m);
}
async function handleVincularModal(){
  const code=document.getElementById('vincularModalCodigo').value.trim().toUpperCase();
  const err=document.getElementById('vincularModalError');
  const btn=document.getElementById('vincularModalBtn');
  err.style.display='none';
  if(!code||code.length<6){err.textContent='Ingresa el cÃ³digo.';err.style.display='block';return;}
  btn.disabled=true;btn.textContent='Verificando...';
  try{
    await vincularCodigo(code);
    document.getElementById('vincularModal').style.display='none';
    const vb=document.getElementById('vincularBadge');
    if(vb) vb.style.display='none';
    _filterMyTorneos();
    renderCurrentTab();
  }catch(e){
    const msg=e.message==='INVALID_CODE'?'CÃ³digo invÃ¡lido. Verifica con tu admin.'
      :e.message==='CODE_USED'?'Este cÃ³digo ya fue usado.'
      :'Error: '+e.message;
    err.textContent=msg;err.style.display='block';
  }finally{btn.disabled=false;btn.textContent='Vincular ğŸŒï¸';}
}
async function handleCompletarPerfil(){
  const nombre=document.getElementById('completarNombre').value.trim();
  const username=document.getElementById('completarUsername').value.trim().toLowerCase();
  const tel=document.getElementById('completarTel').value.trim();
  const pais=document.getElementById('completarPais').value;
  const err=document.getElementById('completarPerfilError');
  const btn=document.getElementById('completarBtn');
  err.style.display='none';
  if(!nombre){err.textContent='El nombre es obligatorio.';err.style.display='block';return;}
  if(!username||username.length<3){err.textContent='El usuario debe tener mÃ­nimo 3 caracteres.';err.style.display='block';return;}
  btn.disabled=true; btn.textContent='Guardando...';
  try{
    // Check username availability
    const usnap=await db.collection('users').where('username','==',username).limit(1).get();
    if(!usnap.empty){err.textContent='Ese usuario ya estÃ¡ tomado.';err.style.display='block';btn.disabled=false;btn.textContent='Entrar al Club ğŸŒï¸';return;}
    const upd={nombre, username, verified:true};
    if(tel){
      const telCompleto=normalizeTelVE(tel,pais);
      upd.telefono=tel; upd.codigoPais=pais; upd.telefonoCompleto=pais+tel; upd.phoneVerified=false;
    }
    await db.collection('users').doc(STATE.user.uid).update(upd);
    await STATE.user.updateProfile({displayName:nombre});
    STATE.profile={...STATE.profile,...upd};
    // Auto-create jugador profile (every user = jugador)
    await ensureAutoJugador(STATE.user.uid, STATE.profile);
    showApp_();
    initListeners();
  }catch(e){err.textContent='Error: '+e.message;err.style.display='block';btn.disabled=false;btn.textContent='Entrar al Club ğŸŒï¸';}
}

function skipVincular(){
  // User skips â€” goes to main app without jugador linked
  // Mark as skipped so we don't ask again every login
  if(STATE.user) db.collection('users').doc(STATE.user.uid).update({vincular_skipped:true}).catch(()=>{});
  if(STATE.profile) STATE.profile.vincular_skipped=true;
  showApp_();
  initListeners();
}
async function handleVincular(){
  const code=document.getElementById('vincularCodigo').value.trim().toUpperCase();
  const err=document.getElementById('vincularError');
  const btn=document.getElementById('vincularBtn');
  err.style.display='none';
  if(!code||code.length<6){ err.textContent='Ingresa el cÃ³digo de invitaciÃ³n.'; err.style.display='block'; return; }
  btn.disabled=true; btn.textContent='Verificando...';
  try{
    await vincularCodigo(code);
    STATE.profile.vincular_skipped=false;
    await db.collection('users').doc(STATE.user.uid).update({vincular_skipped:false}).catch(()=>{});
    document.getElementById('loginScreen').style.display='none';
    showApp_();
    initListeners();
  }catch(e){
    const msg=e.message==='INVALID_CODE'?'CÃ³digo invÃ¡lido. Verifica con tu administrador.'
      :e.message==='CODE_USED'?'Este cÃ³digo ya fue usado.'
      :'Error: '+e.message;
    err.textContent=msg; err.style.display='block';
  }finally{ btn.disabled=false; btn.textContent='Vincular mi perfil ğŸŒï¸'; }
}

// â”€â”€ Update participantes with user_uid after vincular â”€â”€
// Uses collectionGroup query to find ALL participantes across ALL torneos
async function _updateParticipantesUserUid(jugadorId, uid){
  console.log('[_updateParticipantesUserUid] jugadorId='+jugadorId+' uid='+uid);
  let updated=0;

  // 1) Update local cache immediately (for instant UI)
  for(const [tid, jugs] of Object.entries(STATE.jugadores_by_torneo||{})){
    const p=jugs.find(j=>j.id===jugadorId||j.jugador_id===jugadorId);
    if(p){
      p.user_uid=uid;
      updated++;
    }
  }

  // 2) Update Firestore â€” search all torneos for this jugador
  // Try collectionGroup first (most efficient)
  try{
    const cgSnap=await db.collectionGroup('participantes')
      .where('jugador_id','==',jugadorId).get();
    for(const doc of cgSnap.docs){
      if(doc.data().user_uid!==uid){
        await doc.ref.update({user_uid:uid});
        updated++;
      }
    }
    console.log('[_updateParticipantesUserUid] collectionGroup updated '+updated+' docs');
  }catch(e){
    console.warn('[_updateParticipantesUserUid] collectionGroup failed, using per-torneo fallback:',e.message);
    // Fallback: iterate all known torneos
    const allTids=(STATE.allTorneos||[]).map(t=>t.id);
    for(const tid of allTids){
      try{
        const pDoc=await db.collection('torneos').doc(tid)
          .collection('participantes').doc(jugadorId).get();
        if(pDoc.exists && pDoc.data().user_uid!==uid){
          await pDoc.ref.update({user_uid:uid});
          updated++;
        }
      }catch(e2){ /* skip */ }
    }
    console.log('[_updateParticipantesUserUid] fallback updated '+updated+' docs');
  }
}

// â”€â”€ Unified vincular function â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Handles first vincular AND subsequent ones correctly
async function vincularCodigo(code){
  console.log('[vincularCodigo] code='+code);
  // Validate
  const snap=await db.collection('jugadores').where('invite_code','==',code).limit(1).get();
  if(snap.empty) throw new Error('INVALID_CODE');
  const jugDoc=snap.docs[0];
  if(jugDoc.data().user_uid) throw new Error('CODE_USED');

  const uid=STATE.user.uid;
  const manualId=jugDoc.id;
  const existingJugadorId=STATE.profile?.jugador_id;
  const isFirstVincular=!existingJugadorId || existingJugadorId===uid;
  console.log('[vincularCodigo] uid='+uid+' manualId='+manualId+' existing='+existingJugadorId+' isFirst='+isFirstVincular);

  // Mark the manual jugador as linked to this user
  await db.collection('jugadores').doc(manualId).update({user_uid:uid});
  // Track this jugador as linked
  STATE.linked_jugador_ids.add(manualId);

  if(isFirstVincular){
    // â”€â”€ FIRST VINCULAR: adopt manual jugador as primary identity â”€â”€
    await db.collection('users').doc(uid).update({jugador_id:manualId});
    STATE.profile.jugador_id=manualId;
    // Delete auto-created jugador/{uid} if different
    if(manualId!==uid){
      await db.collection('jugadores').doc(uid).delete().catch(()=>{});
    }
  } else {
    // â”€â”€ SUBSEQUENT VINCULAR: keep existing jugador_id, just link user_uid â”€â”€
    // Don't change jugador_id â€” user already has a primary identity
    console.log('[vincularCodigo] Subsequent vincular: keeping jugador_id='+existingJugadorId+', linking manual='+manualId);
  }

  // Set user_uid on all participantes of this manual jugador across all torneos
  await _updateParticipantesUserUid(manualId, uid);

  // Debug: verify which torneos see this user
  const myTIDs=[];
  for(const [tid, jugs] of Object.entries(STATE.jugadores_by_torneo||{})){
    if(jugs.some(j=>j.user_uid===uid)) myTIDs.push(tid);
  }
  console.log('[vincularCodigo] Torneos with my user_uid:', myTIDs);
  console.log('[vincularCodigo] STATE.profile.jugador_id='+STATE.profile?.jugador_id);

  // Re-filter torneos now that user_uid is set on new participantes
  _filterMyTorneos();
  console.log('[vincularCodigo] After filter, STATE.torneos count='+STATE.torneos.length, STATE.torneos.map(t=>t.id+':'+t.nombre));

  return { manualId, nombre: jugDoc.data().nombre||manualId, isFirstVincular };
}

// â”€â”€ Generate invite code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateInviteCode(){
  const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // no confusing chars (0,O,1,I)
  let code='GOLF-';
  for(let i=0;i<4;i++) code+=chars[Math.floor(Math.random()*chars.length)];
  return code;
}

// â”€â”€ Auto-create jugador profile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Every registered user gets a jugador/{uid} doc automatically
async function ensureAutoJugador(uid, profileData){
  if(!uid) return;
  try{
    const jugRef=db.collection('jugadores').doc(uid);
    const existing=await jugRef.get();
    if(existing.exists) return; // already has auto-jugador
    const nombre=profileData?.nombre||'';
    const jugData={
      nombre,
      alias:profileData?.alias||nombre.split(' ')[0]||'',
      foto:nombre.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2)||'?',
      nombre_lower:(nombre||'').toLowerCase(),
      email:profileData?.email||'',
      user_uid:uid,
      telefonoCompleto:profileData?.telefonoCompleto||'',
      telefono:profileData?.telefono||'',
      codigoPais:profileData?.codigoPais||'',
      handicap:profileData?.handicap||0,
      fotoURL:profileData?.fotoURL||null,
      invite_code:null, // auto-created jugadores don't need invite codes
      creado:firebase.firestore.FieldValue.serverTimestamp()
    };
    await jugRef.set(jugData);
    // Also update user profile to link jugador_id = uid
    await db.collection('users').doc(uid).update({jugador_id:uid}).catch(()=>{});
    if(STATE.profile) STATE.profile.jugador_id=uid;
    // Add to local cache
    STATE.jugadores_global.push({id:uid,...jugData});
    console.log('[ensureAutoJugador] Created jugador profile for uid:',uid);
  }catch(e){
    console.error('ensureAutoJugador error:',e);
  }
}

function showLoginView(id){
  ['loginView','registerView','verifyChoiceView','smsCodeView',
   'emailSentView','pendingVerifyView','resetView','vincularView','completarPerfilView'].forEach(v=>{
    const el=document.getElementById(v);
    if(el) el.style.display=v===id?'block':'none';
  });
}
function showLogin(){ showLoginView('loginView'); }
function showRegister(){ showLoginView('registerView'); }
function showVerifyChoice(){ showLoginView('verifyChoiceView'); }

// â”€â”€â”€ onAuthStateChanged â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
auth.onAuthStateChanged(async user=>{
  if(user){
    STATE.user=user;
    try{
      // Load or create user profile
      const snap=await db.collection('users').doc(user.uid).get();
      if(snap.exists){
        STATE.profile=snap.data();
      } else {
        const p={email:user.email,nombre:user.displayName||user.email,
                 role:'jugador',jugador_id:user.uid,verified:false,username:''};
        await db.collection('users').doc(user.uid).set(p);
        STATE.profile=p;
        // Auto-create jugador for brand new user
        await ensureAutoJugador(user.uid, p);
      }
      // Google users are auto-verified
      const isGoogle=user.providerData&&user.providerData[0]&&user.providerData[0].providerId==='google.com';
      if(isGoogle && !STATE.profile.verified){
        await db.collection('users').doc(user.uid).update({verified:true}).catch(()=>{});
        STATE.profile.verified=true;
      }
      // Ensure existing users have a jugador profile (migration)
      if(STATE.profile.jugador_id!==user.uid){
        // User exists but might not have auto-jugador yet
        ensureAutoJugador(user.uid, STATE.profile); // fire-and-forget for migration
      }
      // Check email verification (skip for Google, phone-verified, or legacy accounts)
      await user.reload();
      const emailVerif=user.emailVerified;
      const phoneVerif=STATE.profile?.phoneVerified||false;
      const isLegacy=STATE.profile?.legacy||false;
      if(!emailVerif && !phoneVerif && !isLegacy && !isGoogle){
        showLogin_();
        document.getElementById('loginScreen').style.display='flex';
        document.getElementById('verifyEmailAddr').textContent=user.email||'';
        const tc=STATE.profile?.telefonoCompleto;
        if(tc) document.getElementById('verifyPhoneNum').textContent=tc;
        showLoginView('pendingVerifyView');
        return;
      }
      // New Google user with no username â†’ must complete profile first
      if(isGoogle && !STATE.profile.username){
        document.getElementById('loginScreen').style.display='flex';
        document.getElementById('app').style.display='none';
        document.getElementById('completarNombre').value=user.displayName||'';
        showLoginView('completarPerfilView');
        return;
      }
      // All good â€” enter app
      showApp_();
      initListeners();
    }catch(e){
      console.error('Auth state error:',e);
      // Show error but don't crash â€” user is authenticated, try to continue
      if((e.code==='permission-denied'||(e.message||'').includes('permission'))&&!STATE.profile){
        // Can't read profile â€” create minimal fallback
        STATE.profile={email:user.email,nombre:user.displayName||user.email,role:'jugador',jugador_id:null};
      }
      showApp_();
      initListeners();
    }
    // Note: vincular (invite code linking) is done from INSIDE the app
  } else {
    STATE.user=null; STATE.profile=null;
    stopListeners(); showLogin_();
  }
});

function showLogin_(){
  document.getElementById('loading').style.display='none';
  document.getElementById('loginScreen').style.display='flex';
  document.getElementById('app').style.display='none';
  showLoginView('loginView');
}

function showApp_(){
  document.getElementById('loading').style.display='none';
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('app').style.display='block';
  document.getElementById('headerUser').textContent=STATE.profile?.nombre||STATE.user?.email||'';
  document.getElementById('adminBadge').style.display=STATE.profile?.role==='admin'?'inline':'none';
  // Show vincular badge if no jugador linked
  const vBadge=document.getElementById('vincularBadge');
  if(vBadge) vBadge.style.display=(!STATE.profile?.jugador_id&&STATE.profile?.role!=='admin')?'inline-flex':'none';
  initConnectionMonitor();
  initUpdateChecker();
}

// Keep showApp as alias
function showApp(){ showApp_(); }

// â”€â”€â”€ LOGIN: email / username / phone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateLoginHint(input){
  const v=input.value.trim();
  const hint=document.getElementById('loginHint');
  if(!v){ hint.textContent=''; return; }
  if(v.includes('@')&&v.includes('.')){ hint.textContent='ğŸ“§ Entrando con email'; }
  else if(/^[+0-9]/.test(v)){ hint.textContent='ğŸ“± Entrando con telÃ©fono'; }
  else { hint.textContent='ğŸ‘¤ Entrando con usuario'; }
}

async function resolveEmail(identifier){
  // Returns email for any identifier type
  if(identifier.includes('@')&&identifier.includes('.')) return identifier;
  // Search Firestore users (may fail if rules require auth)
  try{
    let snap;
    if(/^[+0-9]/.test(identifier)){
      // Phone: normalize
      const normalized=identifier.replace(/[^0-9+]/g,'');
      snap=await db.collection('users').where('telefonoCompleto','==',normalized).limit(1).get();
      if(snap.empty){
        // Try without country code variants
        snap=await db.collection('users').where('telefono','==',normalized.replace(/^\+[0-9]{1,3}/,'')).limit(1).get();
      }
    } else {
      // Username: strip leading @
      const uname=identifier.replace(/^@/,'').toLowerCase();
      snap=await db.collection('users').where('username','==',uname).limit(1).get();
    }
    if(!snap||snap.empty) return null;
    return snap.docs[0].data().email||null;
  }catch(e){
    console.warn('resolveEmail permission error:',e.message||e);
    // Firestore rules may block pre-auth reads â€” throw specific error
    if(e.code==='permission-denied'||(e.message||'').includes('permission')){
      throw new Error('Para entrar con usuario o telÃ©fono, usa tu email directamente. Las reglas de seguridad no permiten bÃºsquedas sin autenticaciÃ³n.');
    }
    throw e;
  }
}

async function handleLogin(){
  const identifier=document.getElementById('loginIdentifier').value.trim();
  const pass=document.getElementById('loginPassword').value;
  const btn=document.getElementById('loginBtn');
  const err=document.getElementById('loginError');
  err.style.display='none'; btn.disabled=true; btn.textContent='Entrando...';
  try{
    const email=await resolveEmail(identifier);
    if(!email){ err.textContent='Usuario no encontrado.'; err.style.display='block'; return; }
    await auth.signInWithEmailAndPassword(email,pass);
  }catch(e){
    const m={
      'auth/user-not-found':'Usuario no encontrado.',
      'auth/wrong-password':'ContraseÃ±a incorrecta.',
      'auth/invalid-credential':'Credenciales incorrectas.',
      'auth/too-many-requests':'Demasiados intentos. Espera un momento.'
    };
    err.textContent=m[e.code]||'Error: '+e.message; err.style.display='block';
  } finally{ btn.disabled=false; btn.textContent='Entrar al Club'; }
}

// â”€â”€â”€ REGISTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function formatUsername(input){
  input.value=input.value.toLowerCase().replace(/[^a-z0-9_]/g,'');
  const hint=document.getElementById('usernameHint');
  if(input.value.length>0&&input.value.length<3){
    hint.textContent='âš ï¸ MÃ­nimo 3 caracteres'; hint.style.color='var(--red)';
  } else if(input.value.length>=3){
    hint.textContent='âœ… @'+input.value; hint.style.color='var(--green)';
  } else { hint.textContent='Solo letras, nÃºmeros y guiÃ³n bajo'; hint.style.color='var(--muted)'; }
}

function checkStrength(input){
  const v=input.value;
  const bar=document.getElementById('strengthBar');
  const lbl=document.getElementById('strengthLabel');
  let score=0;
  if(v.length>=6)score++;
  if(v.length>=10)score++;
  if(/[A-Z]/.test(v))score++;
  if(/[0-9]/.test(v))score++;
  if(/[^A-Za-z0-9]/.test(v))score++;
  const levels=[
    {w:'0%',bg:'var(--border)',t:''},
    {w:'25%',bg:'var(--red)',t:'Muy dÃ©bil'},
    {w:'50%',bg:'#FF9800',t:'DÃ©bil'},
    {w:'75%',bg:'#2196F3',t:'Buena'},
    {w:'100%',bg:'var(--green)',t:'Muy segura'},
  ];
  const lv=levels[Math.min(score,4)];
  bar.style.width=lv.w; bar.style.background=lv.bg;
  lbl.textContent=lv.t; lbl.style.color=lv.bg;
}

function togglePass(id,btn){
  const inp=document.getElementById(id);
  if(inp.type==='password'){ inp.type='text'; btn.textContent='ğŸ™ˆ'; }
  else { inp.type='password'; btn.textContent='ğŸ‘'; }
}

async function handleRegister(){
  const nombre=document.getElementById('regNombre').value.trim();
  const username=document.getElementById('regUsername').value.trim().toLowerCase();
  const email=document.getElementById('regEmail').value.trim();
  const tel=document.getElementById('regTelefono').value.trim();
  const codigo=document.getElementById('regPaisCodigo').value;
  const pass=document.getElementById('regPassword').value;
  const err=document.getElementById('registerError');
  const btn=document.getElementById('regBtn');
  err.style.display='none';

  if(!nombre){ err.textContent='El nombre es obligatorio.'; err.style.display='block'; return; }
  if(!username||username.length<3){ err.textContent='El usuario debe tener mÃ­nimo 3 caracteres.'; err.style.display='block'; return; }
  if(!email||!email.includes('@')){ err.textContent='Email invÃ¡lido.'; err.style.display='block'; return; }
  if(pass.length<6){ err.textContent='La contraseÃ±a debe tener mÃ­nimo 6 caracteres.'; err.style.display='block'; return; }

  btn.disabled=true; btn.textContent='Creando cuenta...';
  try{
    // Check username availability
    const usnap=await db.collection('users').where('username','==',username).limit(1).get();
    if(!usnap.empty){ err.textContent='Ese nombre de usuario ya estÃ¡ tomado.'; err.style.display='block'; return; }

    // Create Firebase Auth user
    const cred=await auth.createUserWithEmailAndPassword(email,pass);
    await cred.user.updateProfile({displayName:nombre});

    // Save profile to Firestore
    const telNorm=normalizeTelVE(tel,codigo);
    const telefonoCompleto=telNorm?(codigo+telNorm):'';
    const profile={
      email, nombre, username, role:'jugador', jugador_id:cred.user.uid,
      telefono:tel||'', codigoPais:tel?codigo:'', telefonoCompleto,
      verified:false, phoneVerified:false, legacy:false,
      creado:firebase.firestore.FieldValue.serverTimestamp()
    };
    await db.collection('users').doc(cred.user.uid).set(profile);
    STATE.profile=profile;

    // Auto-create jugador profile (every user = jugador)
    await ensureAutoJugador(cred.user.uid, profile);

    // Go to verification choice
    document.getElementById('verifyEmailAddr').textContent=email;
    if(telefonoCompleto) document.getElementById('verifyPhoneNum').textContent=telefonoCompleto;
    else document.getElementById('optSMS').style.opacity='0.4';
    showVerifyChoice();
  }catch(e){
    const m={
      'auth/email-already-in-use':'Ese email ya tiene una cuenta.',
      'auth/invalid-email':'Email invÃ¡lido.',
      'auth/weak-password':'ContraseÃ±a muy dÃ©bil.'
    };
    err.textContent=m[e.code]||'Error: '+e.message; err.style.display='block';
  } finally{ btn.disabled=false; btn.textContent='Continuar â†’'; }
}

// â”€â”€â”€ VERIFICATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let verifyMethod=null;
let confirmationResult=null;
let appVerifier=null;

function chooseVerify(method){
  verifyMethod=method;
  document.getElementById('optEmail').classList.toggle('selected',method==='email');
  document.getElementById('optSMS').classList.toggle('selected',method==='sms');
}

async function sendVerification(){
  const err=document.getElementById('verifyChoiceError');
  const btn=document.getElementById('btnSendVerify');
  err.style.display='none';
  if(!verifyMethod){ err.textContent='Selecciona un mÃ©todo.'; err.style.display='block'; return; }
  btn.disabled=true; btn.textContent='Enviando...';

  try{
    if(verifyMethod==='email'){
      await auth.currentUser.sendEmailVerification({
        url:window.location.origin+window.location.pathname
      });
      document.getElementById('emailSentAddr').textContent=
        'Enviamos un link a '+auth.currentUser.email+'. Ãbrelo y luego vuelve aquÃ­.';
      showLoginView('emailSentView');
    } else {
      // SMS via Firebase Phone Auth
      const profile=STATE.profile||(await db.collection('users').doc(auth.currentUser.uid).get()).data();
      const phone=profile?.telefonoCompleto;
      if(!phone){ err.textContent='No tienes telÃ©fono registrado. Elige email.'; err.style.display='block'; return; }

      if(!appVerifier){
        appVerifier=new firebase.auth.RecaptchaVerifier('recaptcha-container',{
          size:'invisible',
          callback:()=>{}
        });
      }
      confirmationResult=await auth.signInWithPhoneNumber(phone,appVerifier);
      document.getElementById('smsSentTo').textContent='CÃ³digo enviado a '+phone;
      // Clear OTP inputs
      [0,1,2,3,4,5].forEach(i=>{ const el=document.getElementById('otp'+i); if(el)el.value=''; });
      showLoginView('smsCodeView');
      document.getElementById('otp0').focus();
      // Show resend after 30s
      setTimeout(()=>{ const b=document.getElementById('btnResendSMS'); if(b)b.style.display='block'; },30000);
    }
  }catch(e){
    err.textContent='Error: '+e.message; err.style.display='block';
    if(appVerifier){ try{appVerifier.clear();}catch(ex){} appVerifier=null; }
  } finally{ btn.disabled=false; btn.textContent='Enviar cÃ³digo'; }
}

// OTP input helpers
function otpNext(input,i){
  input.value=input.value.replace(/[^0-9]/g,'');
  if(input.value&&i<5) document.getElementById('otp'+(i+1)).focus();
  // Auto-confirm when all 6 filled
  const code=[0,1,2,3,4,5].map(n=>document.getElementById('otp'+n).value).join('');
  if(code.length===6) confirmSMS();
}
function otpBack(e,i){
  if(e.key==='Backspace'&&!e.target.value&&i>0) document.getElementById('otp'+(i-1)).focus();
}

async function confirmSMS(){
  const code=[0,1,2,3,4,5].map(i=>document.getElementById('otp'+i).value).join('');
  const err=document.getElementById('smsError');
  const btn=document.getElementById('btnConfirmSMS');
  err.style.display='none';
  if(code.length<6){ err.textContent='Ingresa los 6 dÃ­gitos.'; err.style.display='block'; return; }
  btn.disabled=true; btn.textContent='Verificando...';
  try{
    // Get phone credential and link to current user
    const credential=firebase.auth.PhoneAuthProvider.credential(
      confirmationResult.verificationId, code
    );
    await auth.currentUser.linkWithCredential(credential);
    // Mark verified in Firestore
    await db.collection('users').doc(auth.currentUser.uid).update({
      phoneVerified:true, verified:true,
      verifiedAt:firebase.firestore.FieldValue.serverTimestamp()
    });
    STATE.profile.phoneVerified=true; STATE.profile.verified=true;
    showApp_(); initListeners();
  }catch(e){
    const m={'auth/invalid-verification-code':'CÃ³digo incorrecto.','auth/code-expired':'CÃ³digo expirado, reenvÃ­a.'};
    err.textContent=m[e.code]||'Error: '+e.message; err.style.display='block';
  } finally{ btn.disabled=false; btn.textContent='Confirmar cÃ³digo'; }
}

async function resendSMS(){
  if(appVerifier){ try{appVerifier.clear();}catch(e){} appVerifier=null; }
  confirmationResult=null;
  showVerifyChoice();
  verifyMethod='sms';
  chooseVerify('sms');
}

async function recheckEmail(){
  await auth.currentUser.reload();
  if(auth.currentUser.emailVerified){
    await db.collection('users').doc(auth.currentUser.uid).update({verified:true,verifiedAt:firebase.firestore.FieldValue.serverTimestamp()});
    STATE.profile.verified=true;
    showApp_(); initListeners();
  } else {
    const err=document.getElementById('verifyChoiceError');
    showLoginView('emailSentView');
    alert('El email aÃºn no ha sido verificado. Por favor abre el link en tu correo.');
  }
}

async function resendEmail(){
  try{ await auth.currentUser.sendEmailVerification({url:window.location.origin+window.location.pathname}); }
  catch(e){ alert('Error al reenviar: '+e.message); }
}

function skipVerify(){
  // Allow limited access â€” can be restricted later
  showApp_(); initListeners();
}

async function handleLogout(){ await auth.signOut(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERFIL DE USUARIO â€” Modal de gestiÃ³n
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _perfilFotoURL=null; // temp storage for new photo URL

function openPerfilModal(){
  const p=STATE.profile||{};
  const u=STATE.user;
  const err=document.getElementById('perfilError');
  const suc=document.getElementById('perfilSuccess');
  err.style.display='none'; suc.style.display='none';

  // Fill fields
  document.getElementById('perfilNombre').value=p.nombre||u?.displayName||'';
  document.getElementById('perfilAlias').value=p.alias||'';
  document.getElementById('perfilEmail').value=u?.email||p.email||'';
  document.getElementById('perfilHandicap').value=p.handicap||'';

  // Photo preview
  _perfilFotoURL=null;
  const preview=document.getElementById('perfilFotoPreview');
  if(p.fotoURL||u?.photoURL){
    preview.innerHTML=`<img src="${p.fotoURL||u.photoURL}" style="width:100%;height:100%;object-fit:cover;"/>`;
  } else {
    const initials=(p.nombre||u?.email||'?').split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
    preview.innerHTML=`<span>${initials}</span>`;
  }

  // Show/hide password section (only for email/password users)
  const isEmailUser=u?.providerData?.some(pd=>pd.providerId==='password');
  document.getElementById('perfilPasswordSection').style.display=isEmailUser?'block':'none';
  document.getElementById('perfilPassActual').value='';
  document.getElementById('perfilPassNueva').value='';
  document.getElementById('perfilPassConfirm').value='';

  // Jugador vinculado info
  const jugId=p.jugador_id;
  const vinc=document.getElementById('perfilJugadorInfo');
  if(jugId){
    const j=getJugador(jugId);
    vinc.innerHTML=`<span style="color:var(--green);font-weight:600;">âœ… ${j?.nombre||jugId}</span>`;
  } else {
    vinc.innerHTML=`<span style="color:var(--muted);">No vinculado â€” usa un cÃ³digo de invitaciÃ³n para vincular tu perfil de jugador</span>`;
  }

  document.getElementById('modalPerfil').style.display='flex';
}

function closePerfilModal(){
  document.getElementById('modalPerfil').style.display='none';
}

async function handlePerfilFotoChange(event){
  const file=event.target.files[0];
  if(!file) return;
  const err=document.getElementById('perfilError');
  err.style.display='none';

  if(file.size>5*1024*1024){
    err.textContent='La imagen no puede superar 5MB.';
    err.style.display='block';
    return;
  }

  try{
    // Show preview immediately
    const reader=new FileReader();
    reader.onload=e=>{
      document.getElementById('perfilFotoPreview').innerHTML=
        `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;"/>`;
    };
    reader.readAsDataURL(file);

    // Resize and upload
    const compressed=await resizeAndCompress(file, 400, 0.8);
    const path=`perfiles/${STATE.user.uid}/foto_${Date.now()}.jpg`;
    const prog=document.getElementById('perfilFotoProgress');
    const bar=document.getElementById('perfilFotoBar');
    prog.style.display='block';

    const ref=storage.ref(path);
    const task=ref.put(compressed);
    task.on('state_changed',
      snap=>{
        const pct=Math.round((snap.bytesTransferred/snap.totalBytes)*100);
        bar.style.width=pct+'%';
      },
      error=>{
        prog.style.display='none';
        err.textContent='Error al subir foto: '+error.message;
        err.style.display='block';
      },
      async()=>{
        _perfilFotoURL=await task.snapshot.ref.getDownloadURL();
        prog.style.display='none';
        bar.style.width='0%';
        document.getElementById('perfilSuccess').textContent='âœ… Foto cargada. Guarda los cambios para aplicar.';
        document.getElementById('perfilSuccess').style.display='block';
      }
    );
  }catch(e){
    err.textContent='Error procesando imagen: '+e.message;
    err.style.display='block';
  }
}

async function savePerfilModal(){
  const err=document.getElementById('perfilError');
  const suc=document.getElementById('perfilSuccess');
  err.style.display='none'; suc.style.display='none';

  const nombre=document.getElementById('perfilNombre').value.trim();
  const alias=document.getElementById('perfilAlias').value.trim();
  const handicap=parseFloat(document.getElementById('perfilHandicap').value)||0;

  if(!nombre){ err.textContent='El nombre es obligatorio.'; err.style.display='block'; return; }

  try{
    // Update user profile in Firestore
    const upd={nombre, alias, handicap};
    if(_perfilFotoURL) upd.fotoURL=_perfilFotoURL;
    await db.collection('users').doc(STATE.user.uid).update(upd);

    // Update Firebase Auth displayName and photoURL
    const authUpd={displayName:nombre};
    if(_perfilFotoURL) authUpd.photoURL=_perfilFotoURL;
    await STATE.user.updateProfile(authUpd);

    // Update local state
    Object.assign(STATE.profile, upd);
    document.getElementById('headerUser').textContent=nombre;

    // Also update linked jugador if exists
    const jugId=STATE.profile?.jugador_id;
    if(jugId){
      const jugUpd={nombre, alias:alias||nombre.split(' ')[0], handicap};
      if(_perfilFotoURL) jugUpd.fotoURL=_perfilFotoURL;
      await db.collection('jugadores').doc(jugId).update(jugUpd).catch(()=>{});

      // Update participantes in all torneos
      for(const [tid, jugs] of Object.entries(STATE.jugadores_by_torneo)){
        const p=jugs.find(j=>j.id===jugId||j.jugador_id===jugId);
        if(p){
          await db.collection('torneos').doc(tid).collection('participantes').doc(p.id)
            .update(jugUpd).catch(()=>{});
        }
      }
    }

    // Handle password change
    const passActual=document.getElementById('perfilPassActual').value;
    const passNueva=document.getElementById('perfilPassNueva').value;
    const passConfirm=document.getElementById('perfilPassConfirm').value;
    if(passNueva){
      if(passNueva.length<6){ err.textContent='La nueva contraseÃ±a debe tener al menos 6 caracteres.'; err.style.display='block'; return; }
      if(passNueva!==passConfirm){ err.textContent='Las contraseÃ±as no coinciden.'; err.style.display='block'; return; }
      if(!passActual){ err.textContent='Ingresa tu contraseÃ±a actual para cambiarla.'; err.style.display='block'; return; }
      // Re-authenticate
      const cred=firebase.auth.EmailAuthProvider.credential(STATE.user.email, passActual);
      await STATE.user.reauthenticateWithCredential(cred);
      await STATE.user.updatePassword(passNueva);
      document.getElementById('perfilPassActual').value='';
      document.getElementById('perfilPassNueva').value='';
      document.getElementById('perfilPassConfirm').value='';
    }

    suc.textContent='âœ… Perfil actualizado correctamente.';
    suc.style.display='block';
    _perfilFotoURL=null;
    renderCurrentTab();

    // Auto-close after a moment
    setTimeout(()=>{ if(document.getElementById('modalPerfil').style.display==='flex') closePerfilModal(); }, 1500);
  }catch(e){
    const msg=e.code==='auth/wrong-password'?'ContraseÃ±a actual incorrecta.':
              e.code==='auth/requires-recent-login'?'Debes re-iniciar sesiÃ³n para cambiar la contraseÃ±a.':
              'Error: '+e.message;
    err.textContent=msg;
    err.style.display='block';
  }
}

async function handlePerfilVincular(){
  const code=document.getElementById('perfilVincularCodigo').value.trim().toUpperCase();
  const msgEl=document.getElementById('perfilVincularMsg');
  msgEl.style.display='none';
  if(!code||code.length<6){
    msgEl.textContent='Ingresa el cÃ³digo completo.';
    msgEl.style.cssText='display:block;margin-top:8px;font-size:12px;padding:8px;border-radius:8px;background:#FFEBEE;color:#C62828;';
    return;
  }
  try{
    const result=await vincularCodigo(code);
    // Update UI
    const vinc=document.getElementById('perfilJugadorInfo');
    if(vinc) vinc.innerHTML=`<span style="color:var(--green);font-weight:600;">âœ… ${result.nombre}</span>`;
    document.getElementById('perfilVincularCodigo').value='';
    msgEl.textContent=result.isFirstVincular
      ?'âœ… Â¡VinculaciÃ³n exitosa! Tu perfil ahora estÃ¡ conectado con tus resultados.'
      :'âœ… Â¡Torneo vinculado! Se agregÃ³ a tu lista de torneos.';
    msgEl.style.cssText='display:block;margin-top:8px;font-size:12px;padding:8px;border-radius:8px;background:#E8F5E9;color:#2E7D32;font-weight:600;';
    _filterMyTorneos();
    renderCurrentTab();
  }catch(e){
    const msg=e.message==='INVALID_CODE'?'CÃ³digo invÃ¡lido. Verifica con tu admin.'
      :e.message==='CODE_USED'?'Este cÃ³digo ya fue utilizado por otro jugador.'
      :'Error: '+e.message;
    msgEl.textContent=msg;
    msgEl.style.cssText='display:block;margin-top:8px;font-size:12px;padding:8px;border-radius:8px;background:#FFEBEE;color:#C62828;';
  }
}

async function handleReset(){
  const email=document.getElementById('resetEmail').value.trim();
  const err=document.getElementById('resetError'); err.style.display='none';
  try{
    await auth.sendPasswordResetEmail(email);
    document.getElementById('resetForm').style.display='none';
    document.getElementById('resetSuccess').style.display='block';
  }catch{ err.textContent='No se encontrÃ³ ese email.'; err.style.display='block'; }
}

function showReset(){
  showLoginView('resetView');
  document.getElementById('resetForm').style.display='block';
  document.getElementById('resetSuccess').style.display='none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIRESTORE LISTENERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initListeners(){
  stopListeners();
  const uid=STATE.user?.uid;
  const isPlataformaAdmin=STATE.profile?.role==='admin';

  // Initialize linked_jugador_ids: find ALL jugadores linked to this user
  if(uid){
    STATE.linked_jugador_ids=new Set();
    if(STATE.profile?.jugador_id) STATE.linked_jugador_ids.add(STATE.profile.jugador_id);
    STATE.linked_jugador_ids.add(uid); // auto-jugador
    // Query Firestore for all jugadores with this user_uid
    db.collection('jugadores').where('user_uid','==',uid).get().then(snap=>{
      snap.docs.forEach(d=>STATE.linked_jugador_ids.add(d.id));
      console.log('[initListeners] linked_jugador_ids:', Array.from(STATE.linked_jugador_ids));
      _filterMyTorneos();
      renderCurrentTab();
    }).catch(e=>console.warn('linked jugadores query error:',e));
  }

  if(isPlataformaAdmin){
    // Admin de plataforma: read all (broad queries)
    _initBroadListeners(uid,true);
  } else {
    // Usuario normal: scoped queries que cumplen con las reglas de Firestore
    _initScopedListeners(uid);
  }
}

// â”€â”€â”€ Broad listeners (only for platform admin) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _initBroadListeners(uid,isAdmin){
  STATE.unsubs.push(db.collection('torneos').orderBy('creado','desc')
    .onSnapshot(s=>{
      STATE.torneos=s.docs.map(d=>({id:d.id,...d.data()}));
      STATE.allTorneos=STATE.torneos; // admin sees all
      STATE.torneo=STATE.torneos.find(t=>t.estado==='Activo'||t.estado==='activo')||STATE.torneos[0]||null;
      if(!STATE.activeTorneoId&&STATE.torneo) STATE.activeTorneoId=STATE.torneo.id;
      if(STATE._connSetOnline)STATE._connSetOnline();
      subscribeParticipantes();
      renderCurrentTab();
    },err=>{
      console.error('torneos broad error:',err);
      // Fallback to scoped queries even for admin
      _initScopedListeners(uid);
    }));
  STATE.unsubs.push(db.collection('jornadas').orderBy('fecha')
    .onSnapshot(s=>{ STATE.jornadas=s.docs.map(d=>({id:d.id,...d.data()})); renderCurrentTab(); },
    err=>console.warn('jornadas error:',err)));
  STATE.unsubs.push(db.collection('resultados')
    .onSnapshot(s=>{ STATE.resultados=s.docs.map(d=>({id:d.id,...d.data()})); if(STATE._connSetOnline)STATE._connSetOnline(); renderCurrentTab(); },
    err=>console.warn('resultados error:',err)));
  STATE.unsubs.push(db.collection('clubes').orderBy('nombre')
    .onSnapshot(s=>{ STATE.clubes=s.docs.map(d=>({id:d.id,...d.data()})); renderCurrentTab(); },
    err=>console.warn('clubes error:',err)));
  ensureJugadoresGlobal();
}

// â”€â”€â”€ Scoped listeners (for regular users) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Load ALL torneos (rules allow read for authenticated users), filter client-side
let _torneosMergeMap={};
let _torneosReadyCount=0;
const _TORNEO_QUERY_COUNT=4;

function _initScopedListeners(uid){
  // Load ALL torneos broadly â€” Firestore rules allow read for any authenticated user
  STATE.unsubs.push(db.collection('torneos').orderBy('creado','desc')
    .onSnapshot(s=>{
      STATE.allTorneos=s.docs.map(d=>({id:d.id,...d.data()}));
      _filterMyTorneos();
      subscribeParticipantes();
      renderCurrentTab();
    },err=>{
      console.warn('torneos broad (user) error:',err.message||err);
      // Fallback: 4 parallel scoped queries
      _initScopedQueriesFallback(uid);
    }));

  // JORNADAS
  STATE.unsubs.push(db.collection('jornadas').orderBy('fecha')
    .onSnapshot(s=>{
      STATE.jornadas=s.docs.map(d=>({id:d.id,...d.data()}));
      _filterMyTorneos();
      renderCurrentTab();
    },err=>{
      console.warn('jornadas error:',err.message||err);
      _loadJornadasPerTorneo();
    }));

  // RESULTADOS
  STATE.unsubs.push(db.collection('resultados')
    .onSnapshot(s=>{
      STATE.resultados=s.docs.map(d=>({id:d.id,...d.data()}));
      if(STATE._connSetOnline)STATE._connSetOnline();
      _filterMyTorneos();
      renderCurrentTab();
    },err=>{
      console.warn('resultados error:',err.message||err);
      _loadResultadosPerTorneo();
    }));

  // CLUBES
  STATE.unsubs.push(db.collection('clubes').orderBy('nombre')
    .onSnapshot(s=>{ STATE.clubes=s.docs.map(d=>({id:d.id,...d.data()})); renderCurrentTab(); },
    err=>console.warn('clubes error:',err.message||err)));

  ensureJugadoresGlobal();
}

// Filter allTorneos â†’ STATE.torneos: only torneos user is involved in
function _filterMyTorneos(){
  if(!STATE.allTorneos||STATE.allTorneos.length===0) return;
  // Platform admin sees ALL torneos â€” no filtering needed
  if(STATE.profile?.role==='admin'){
    STATE.torneos=STATE.allTorneos;
    STATE.torneo=STATE.torneos.find(t=>t.estado==='Activo'||t.estado==='activo')||STATE.torneos[0]||null;
    if(!STATE.activeTorneoId&&STATE.torneo) STATE.activeTorneoId=STATE.torneo.id;
    return;
  }
  const uid=STATE.user?.uid;
  const jugadorId=STATE.profile?.jugador_id;

  // Build complete set of jugador IDs linked to this user
  const allMyIds=new Set(STATE.linked_jugador_ids);
  if(jugadorId) allMyIds.add(jugadorId);
  if(uid) allMyIds.add(uid); // auto-jugador has id = uid

  // Torneos where user has results (check ALL linked jugador IDs)
  const torneoIdsFromResults=new Set();
  if(allMyIds.size>0 && STATE.jornadas.length>0 && STATE.resultados.length>0){
    const myJornadaIds=new Set(
      STATE.resultados.filter(r=>allMyIds.has(r.jugador_id)).map(r=>r.jornada_id)
    );
    STATE.jornadas.forEach(j=>{
      if(myJornadaIds.has(j.id) && j.torneo_id) torneoIdsFromResults.add(j.torneo_id);
    });
  }

  // Torneos where user is in participantes subcollection
  const torneoIdsFromParticipantes=new Set();
  for(const [tid, jugs] of Object.entries(STATE.jugadores_by_torneo||{})){
    if(jugs.some(j=>
      j.user_uid===uid
      || allMyIds.has(j.jugador_id)
      || allMyIds.has(j.id)
    )){
      torneoIdsFromParticipantes.add(tid);
    }
  }

  STATE.torneos=STATE.allTorneos.filter(t=>{
    if(t.creado_por===uid) return true;
    if(t.adminId===uid) return true;
    if((t.admins||[]).includes(uid)) return true;
    if((t.cargadores||[]).includes(uid)) return true;
    if(torneoIdsFromParticipantes.has(t.id)) return true;
    if(torneoIdsFromResults.has(t.id)) return true;
    return false;
  });

  STATE.torneo=STATE.torneos.find(t=>t.estado==='Activo'||t.estado==='activo')||STATE.torneos[0]||null;
  if(!STATE.activeTorneoId&&STATE.torneo) STATE.activeTorneoId=STATE.torneo.id;
}

// Fallback: 4 parallel scoped queries if broad torneos read fails
function _initScopedQueriesFallback(uid){
  _torneosMergeMap={};
  _torneosReadyCount=0;
  [
    db.collection('torneos').where('creado_por','==',uid),
    db.collection('torneos').where('adminId','==',uid),
    db.collection('torneos').where('admins','array-contains',uid),
    db.collection('torneos').where('cargadores','array-contains',uid)
  ].forEach(q=>{
    STATE.unsubs.push(q.onSnapshot(s=>{
      s.docs.forEach(d=>{ _torneosMergeMap[d.id]={id:d.id,...d.data()}; });
      _torneosReadyCount++;
      _syncTorneos();
    },err=>{ _torneosReadyCount++; _syncTorneos(); }));
  });
}

// Merge and sync torneos from scoped queries
function _syncTorneos(){
  const arr=Object.values(_torneosMergeMap);
  arr.sort((a,b)=>((b.creado?.seconds||0)-(a.creado?.seconds||0)));
  STATE.torneos=arr;
  STATE.torneo=STATE.torneos.find(t=>t.estado==='Activo'||t.estado==='activo')||STATE.torneos[0]||null;
  if(!STATE.activeTorneoId&&STATE.torneo) STATE.activeTorneoId=STATE.torneo.id;
  if(STATE._connSetOnline)STATE._connSetOnline();
  subscribeParticipantes();
  renderCurrentTab();
}

// Fallback: load jornadas per-torneo (when broad query fails)
function _loadJornadasPerTorneo(){
  const ids=STATE.torneos.map(t=>t.id);
  if(!ids.length) return;
  // Firestore 'in' supports up to 30 values â€” batch if needed
  const batches=[];
  for(let i=0;i<ids.length;i+=30) batches.push(ids.slice(i,i+30));
  STATE.jornadas=[];
  batches.forEach(batch=>{
    db.collection('jornadas').where('torneo_id','in',batch).get().then(s=>{
      const newJornadas=s.docs.map(d=>({id:d.id,...d.data()}));
      // Merge without duplicates
      const existing=new Set(STATE.jornadas.map(j=>j.id));
      newJornadas.forEach(j=>{ if(!existing.has(j.id)) STATE.jornadas.push(j); });
      STATE.jornadas.sort((a,b)=>{
        const fa=a.fecha?.seconds||0, fb=b.fecha?.seconds||0;
        return fa-fb;
      });
      renderCurrentTab();
    }).catch(e=>console.warn('jornadas per-torneo fallback:',e.message||e));
  });
}

// Fallback: load resultados for known jornadas (when broad query fails)
function _loadResultadosPerTorneo(){
  const jids=STATE.jornadas.map(j=>j.id);
  if(!jids.length){
    // Jornadas might not be loaded yet â€” retry after short delay
    setTimeout(_loadResultadosPerTorneo,2000);
    return;
  }
  const batches=[];
  for(let i=0;i<jids.length;i+=30) batches.push(jids.slice(i,i+30));
  STATE.resultados=[];
  batches.forEach(batch=>{
    db.collection('resultados').where('jornada_id','in',batch).get().then(s=>{
      const newRes=s.docs.map(d=>({id:d.id,...d.data()}));
      const existing=new Set(STATE.resultados.map(r=>r.id));
      newRes.forEach(r=>{ if(!existing.has(r.id)) STATE.resultados.push(r); });
      if(STATE._connSetOnline)STATE._connSetOnline();
      renderCurrentTab();
    }).catch(e=>console.warn('resultados per-torneo fallback:',e.message||e));
  });
}

// Subscribe to participantes subcollection for ALL torneos (to discover participation)
let _participantesUnsubs={};  // { torneoId: unsubFn }
let _participantesTorneoId=null;  // kept for compat
function subscribeParticipantes(){
  // Use allTorneos if populated, else fall back to filtered torneos
  const source=(STATE.allTorneos&&STATE.allTorneos.length>0)?STATE.allTorneos:STATE.torneos||[];
  if(source.length===0) return;
  const uid=STATE.user?.uid;
  source.forEach(t=>{
    const tid=t.id;
    if(_participantesUnsubs[tid]) return; // already subscribed
    _participantesUnsubs[tid]=db.collection('torneos').doc(tid)
      .collection('participantes').orderBy('nombre')
      .onSnapshot(s=>{
        const jugs=s.docs.map(d=>({id:d.id,...d.data()}));
        STATE.jugadores_by_torneo[tid]=jugs;
        if(tid===STATE.activeTorneoId){
          STATE.jugadores=jugs;
        }
        // Discover linked jugador IDs from participantes
        if(uid){
          jugs.forEach(j=>{
            if(j.user_uid===uid){
              STATE.linked_jugador_ids.add(j.id);
              if(j.jugador_id) STATE.linked_jugador_ids.add(j.jugador_id);
            }
          });
        }
        // Re-filter torneos: might discover user is participant in this torneo
        _filterMyTorneos();
        renderCurrentTab();
      }, err=>console.error('participantes['+tid+'] error:',err));
  });
  if(STATE.activeTorneoId && STATE.jugadores_by_torneo[STATE.activeTorneoId]){
    STATE.jugadores=STATE.jugadores_by_torneo[STATE.activeTorneoId];
  }
}

// Call when active torneo changes (tab switch, etc)
function switchActiveTorneo(tid){
  if(STATE.activeTorneoId===tid) return;
  STATE.activeTorneoId=tid;
  STATE.torneo=STATE.torneos.find(t=>t.id===tid)||null;
  STATE.jugadores=[];
  _participantesTorneoId=null;
  subscribeParticipantes();
  renderCurrentTab();
}

function stopListeners(){
  STATE.unsubs.forEach(u=>u()); STATE.unsubs=[];
  Object.values(_participantesUnsubs).forEach(u=>{ try{u();}catch(e){} });
  _participantesUnsubs={};
  _participantesTorneoId=null;
  _jugadoresGlobalUnsub=null;
  STATE.jugadores_by_torneo={};
  STATE.jugadores_global=[];
  STATE.allTorneos=[];
  STATE.linked_jugador_ids=new Set();
  STATE._expandedJugTorneo=null;
  _torneosMergeMap={};
  _torneosReadyCount=0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MONITOR DE CONEXIÃ“N EN TIEMPO REAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initConnectionMonitor(){
  // Firestore network state via .info/connected (uses Realtime DB trick via Firestore itself)
  // We use a heartbeat approach: check if snapshots arrive within expected time
  let lastUpdate=Date.now();
  let connTimer=null;
  const pill=document.getElementById('connPill');
  const dot=document.getElementById('connDot');
  const label=document.getElementById('connLabel');

  function setOnline(){
    lastUpdate=Date.now();
    if(pill){
      pill.style.background='#E8F5E9';pill.style.color='#2E7D32';pill.style.borderColor='#A5D6A7';
      dot.style.background='#4CAF50';dot.style.animation='';
      label.textContent='EN VIVO';
    }
  }
  function setOffline(){
    if(pill){
      pill.style.background='#FFF8E1';pill.style.color='#F57F17';pill.style.borderColor='#FFE082';
      dot.style.background='#FFC107';dot.style.animation='pulse-dot 1s infinite';
      label.textContent='RECONECTANDO';
    }
  }
  function setSyncing(){
    if(pill){
      pill.style.background='#E3F2FD';pill.style.color='#1565C0';pill.style.borderColor='#90CAF9';
      dot.style.background='#2196F3';
      label.textContent='SINCRONIZANDO';
    }
    setTimeout(setOnline,1500);
  }

  // Patch initListeners to call setSyncing on each snapshot
  const _origInit=initListeners;

  // Monitor: if no update in 15s, show reconnecting
  function heartbeat(){
    const elapsed=Date.now()-lastUpdate;
    if(elapsed>15000) setOffline();
    else setOnline();
  }
  connTimer=setInterval(heartbeat,5000);

  // Listen to window online/offline events
  window.addEventListener('online',()=>{
    setSyncing();
    // Re-init listeners on reconnect
    initListeners();
  });
  window.addEventListener('offline',setOffline);

  // Firestore automatically reconnects â€” track with a lightweight doc listener
  // Use user's own profile doc (always has permission) instead of broad torneos query
  if(STATE.user?.uid){
    db.collection('users').doc(STATE.user.uid).onSnapshot(
      ()=>{ lastUpdate=Date.now(); },
      ()=>{ setOffline(); }
    );
  }

  // Expose setOnline so snapshot callbacks can call it
  STATE._connSetOnline=setOnline;
  STATE._connSetSyncing=setSyncing;
}

// CSS for pulsing dot
(function(){
  const s=document.createElement('style');
  s.textContent='@keyframes pulse-dot{0%,100%{opacity:1;transform:scale(1);}50%{opacity:0.5;transform:scale(0.8);}}';
  document.head.appendChild(s);
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVEGACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goTab(tab){
  STATE.currentTab=tab; STATE.cargarJornadaId=null;
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.querySelector('[data-tab="'+tab+'"]')?.classList.add('active');
  ['dashboard','mistorneos','jornadas','jugadores','clubes','cargar'].forEach(t=>{
    const el=document.getElementById('tab-'+t); if(el) el.style.display='none';
  });
  const tEl=document.getElementById('tab-'+tab); if(tEl) tEl.style.display='block';
  renderCurrentTab();
}
function goCargar(jornadaId){
  STATE.cargarJornadaId=jornadaId; STATE.currentTab='cargar';
  STATE._jornadaFotosExistentes=[];
  STATE._jornadaFotoFiles=[null,null,null];  // store File objects here
  cargarParticipantes=[]; cargarPosiciones=[]; cargarStep=1;
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  ['dashboard','mistorneos','jornadas','jugadores','clubes','cargar'].forEach(t=>{
    const el=document.getElementById('tab-'+t); if(el) el.style.display='none';
  });
  const ct=document.getElementById('tab-cargar');
  if(ct) ct.style.display='block';
  renderCargar();
}
let _renderRAF=null;
function renderCurrentTab(){
  if(_renderRAF) cancelAnimationFrame(_renderRAF);
  _renderRAF=requestAnimationFrame(()=>{
    _renderRAF=null;
    if(STATE.currentTab==='dashboard') renderDashboard();
    else if(STATE.currentTab==='mistorneos') renderMisTorneos();
    else if(STATE.currentTab==='jornadas') renderJornadas();
    else if(STATE.currentTab==='jugadores') renderJugadores();
    else if(STATE.currentTab==='clubes') renderClubes();
    else if(STATE.currentTab==='cargar') renderCargar();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Reglas por defecto del torneo
// â”€â”€ Permission helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function isTorneoAdmin(torneo){
  if(!torneo||!STATE.user) return false;
  if(STATE.profile?.role==='admin') return true; // plataforma admin
  const uid=STATE.user.uid;
  return torneo.creado_por===uid || torneo.adminId===uid ||
         (torneo.admins||[]).includes(uid);
}
function isCargador(torneo){
  if(!torneo||!STATE.user) return false;
  if(isTorneoAdmin(torneo)) return true;
  return (torneo.cargadores||[]).includes(STATE.user.uid);
}
function isCargadorTorneo(torneo){ return isCargador(torneo); }
function canCargarTorneo(torneo){ return isCargador(torneo); }
// â”€â”€â”€ JUGADOR LOOKUP â€” busca en todos los torneos cargados â”€â”€â”€â”€â”€
function getJugador(jugadorId){
  if(!jugadorId) return null;
  // Search active torneo first (fastest)
  const fromActive=(STATE.jugadores||[]).find(j=>j.id===jugadorId);
  if(fromActive) return fromActive;
  // Search all torneos by_torneo map
  for(const lista of Object.values(STATE.jugadores_by_torneo||{})){
    const found=lista.find(j=>j.id===jugadorId);
    if(found) return found;
  }
  // Fallback to global cache (covers old torneos with players only in jugadores/ collection)
  const fromGlobal=(STATE.jugadores_global||[]).find(j=>j.id===jugadorId);
  if(fromGlobal) return fromGlobal;
  return null;
}

// Ensure global jugadores are loaded (for name lookups and search)
let _jugadoresGlobalUnsub=null;
function ensureJugadoresGlobal(){
  if(_jugadoresGlobalUnsub) return; // already listening
  _jugadoresGlobalUnsub=db.collection('jugadores').orderBy('nombre')
    .onSnapshot(s=>{
      STATE.jugadores_global=s.docs.map(d=>({id:d.id,...d.data()}));
    }, e=>console.error('jugadores global listener:',e));
  // Add to unsubs for cleanup
  STATE.unsubs.push(()=>{ if(_jugadoresGlobalUnsub){ _jugadoresGlobalUnsub(); _jugadoresGlobalUnsub=null; }});
}
function getJugadoresTorneo(torneoId){
  if(torneoId===STATE.activeTorneoId) return STATE.jugadores||[];
  return STATE.jugadores_by_torneo[torneoId]||[];
}

// Returns unified list: participantes + players from resultados (same source as calcRankingTorneo)
function getJugadoresCompletesTorneo(torneoId){
  const participantes=getJugadoresTorneo(torneoId);
  const pMap=new Map(participantes.map(j=>[j.id,j]));
  // Collect jugador_ids from resultados for this torneo's jornadas
  const jornadasT=STATE.jornadas.filter(j=>
    j.torneo_id===torneoId||(!j.torneo_id&&torneoId===STATE.torneo?.id)
  );
  jornadasT.forEach(jn=>{
    STATE.resultados.filter(r=>r.jornada_id===jn.id).forEach(r=>{
      if(!pMap.has(r.jugador_id)){
        const jug=getJugador(r.jugador_id)||{id:r.jugador_id,nombre:'Jugador',foto:'?'};
        pMap.set(r.jugador_id,{...jug,id:r.jugador_id,_fromResults:true});
      }
    });
  });
  // Sort: participantes first (alphabetical), then result-only players
  return Array.from(pMap.values()).sort((a,b)=>{
    if(a._fromResults&&!b._fromResults) return 1;
    if(!a._fromResults&&b._fromResults) return -1;
    return (a.nombre||'').localeCompare(b.nombre||'');
  });
}
// â”€â”€ Phone utility functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function normalizeTelVE(tel, codigoPais){
  if(!tel) return '';
  // Strip non-digits
  let t=tel.replace(/\D/g,'');
  if(!t) return '';
  // For Venezuela (+58): if starts with 0, remove leading 0
  if(codigoPais==='+58' && t.startsWith('0')) t=t.substring(1);
  return t;
}

function validarFormatoTel(tel, codigoPais){
  if(!tel) return true; // empty is valid (optional field)
  const digits=tel.replace(/\D/g,'');
  if(codigoPais==='+58') return digits.length>=7 && digits.length<=10;
  return digits.length>=7 && digits.length<=15;
}

function validarTelefonoNew(input){
  // Live validation hint for phone input in agregar jugador form
  const v=input.value.replace(/\D/g,'');
  input.value=v;
}

// Normaliza texto quitando acentos y caracteres especiales
function normalizeStr(str){
  return (str||'').toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g,'')  // remove diacritics
    .replace(/[^a-z0-9 ]/g,' ')
    .replace(/\s+/g,' ').trim();
}

function setActiveTorneo(torneoId){
  if(STATE.activeTorneoId===torneoId) return;
  STATE.activeTorneoId=torneoId;
  STATE.torneo=STATE.torneos.find(t=>t.id===torneoId)||null;
  // Swap STATE.jugadores to the new active torneo (already loaded or empty)
  STATE.jugadores=STATE.jugadores_by_torneo[torneoId]||[];
  // Subscribe if not yet loaded
  if(!_participantesUnsubs[torneoId]){
    subscribeParticipantes();
  } else {
    renderCurrentTab();
  }
}

function getActiveTorneo(){
  return STATE.torneos.find(t=>t.id===STATE.activeTorneoId)||STATE.torneo||null;
}

// Find a torneo by ID â€” searches allTorneos (broad) then filtered torneos
function findTorneo(torneoId){
  if(!torneoId) return null;
  return (STATE.allTorneos||[]).find(t=>t.id===torneoId)
      || STATE.torneos.find(t=>t.id===torneoId)
      || null;
}

function getReglas(torneoId){
  const t=findTorneo(torneoId)||STATE.torneo;
  return Object.assign({
    puntos:{1:4,2:3,3:2,resto:1},
    bonusAsistencia:0,
    penalNoAsistencia:0,
    penalDQ:0,
    descartes:0,
    empates:'comparten'
  }, t?.reglas||{});
}

// Puntos por posiciÃ³n segÃºn reglas del torneo
function getPtsPosicion(pos, reglas){
  if(!reglas) reglas=getReglas(STATE.activeTorneoId);
  const p=reglas.puntos||{};
  return p[pos]!==undefined ? p[pos] : (p.resto!==undefined ? p.resto : 1);
}

// Legacy getPts (backward compat with cargar resultados)
function getPts(pos,asist,torneoId){
  if(!asist) return 0;
  const reglas=getReglas(torneoId||STATE.activeTorneoId);
  return getPtsPosicion(pos, reglas);
}

// â”€â”€â”€ calcRankingTorneo: with empates y descartes â”€â”€â”€â”€â”€
function calcRankingTorneo(torneoId){
  const reglas=getReglas(torneoId);
  const jornadasT=STATE.jornadas.filter(j=>
    (!torneoId||(j.torneo_id===torneoId||(!j.torneo_id&&torneoId===STATE.torneo?.id)))
    && j.cuentaRanking!==false
  );
  const jugados=jornadasT.filter(j=>j.estado!=='Planificada');
  const oficiales=jornadasT.filter(j=>j.estado==='Oficial');

  // 1. Build pts-per-partida map: recalculate from position applying empate rules
  // First build a map: jornada_id â†’ { jugador_id â†’ calculated_pts }
  const jornadaPtsMap={};
  for(const jn of jugados){
    // Per-partida rules: use reglasOverride if present
    const jnReglas=jn.reglasOverride?Object.assign({},reglas,{
      puntos:jn.reglasOverride.puntos||reglas.puntos,
      bonusAsistencia:jn.reglasOverride.bonusAsistencia!=null?jn.reglasOverride.bonusAsistencia:reglas.bonusAsistencia,
      penalNoAsistencia:jn.reglasOverride.penalNoAsistencia!=null?jn.reglasOverride.penalNoAsistencia:reglas.penalNoAsistencia,
      penalDQ:jn.reglasOverride.penalDQ!=null?jn.reglasOverride.penalDQ:reglas.penalDQ
    }):reglas;
    const jnResults=STATE.resultados.filter(r=>r.jornada_id===jn.id&&r.asistencia);
    // Group by position to detect empates
    const byPos={};
    jnResults.forEach(r=>{
      if(!byPos[r.pos]) byPos[r.pos]=[];
      byPos[r.pos].push(r);
    });
    jornadaPtsMap[jn.id]={};
    Object.entries(byPos).forEach(([posStr,group])=>{
      const pos=Number(posStr);
      let basePts;
      if(jnReglas.empates==='comparten'&&group.length>1){
        // Average points of positions pos, pos+1, ... pos+group.length-1
        let sum=0;
        for(let k=0;k<group.length;k++) sum+=getPtsPosicion(pos+k,jnReglas);
        basePts=sum/group.length;
      } else {
        basePts=getPtsPosicion(pos,jnReglas);
      }
      group.forEach(r=>{
        let pts=basePts;
        pts+=(jnReglas.bonusAsistencia||0);
        if(r.dq) pts+=(jnReglas.penalDQ||0);
        jornadaPtsMap[jn.id][r.jugador_id]=Math.round(pts*100)/100;
      });
    });
    // Non-attendees
    STATE.resultados.filter(r=>r.jornada_id===jn.id&&!r.asistencia).forEach(r=>{
      jornadaPtsMap[jn.id][r.jugador_id]=(jnReglas.penalNoAsistencia||0);
    });
  }

  // 2. Aggregate per player â€” build from resultados (works without participantes subcollection)
  // Collect unique jugador_ids who have results in this torneo's jornadas
  const jugadorIds=new Set();
  jugados.forEach(jn=>{
    STATE.resultados.filter(r=>r.jornada_id===jn.id).forEach(r=>jugadorIds.add(r.jugador_id));
  });
  // Also include participantes even if no results yet
  const participantes=getJugadoresTorneo(torneoId);
  participantes.forEach(j=>jugadorIds.add(j.id));

  const rawData=Array.from(jugadorIds).map(jugadorId=>{
    // Look up jugador from all sources
    const jugador=getJugador(jugadorId)||participantes.find(j=>j.id===jugadorId)||{id:jugadorId,nombre:'Jugador',foto:'?'};
    const jornadaPts=jugados.map(jn=>{
      const r=STATE.resultados.find(r=>r.jornada_id===jn.id&&r.jugador_id===jugadorId);
      if(!r) return null;
      const calculatedPts=jornadaPtsMap[jn.id]?.[jugadorId]??0;
      return{jornada_id:jn.id,pts:calculatedPts,asistencia:r.asistencia,dq:r.dq||false,pos:r.pos};
    }).filter(Boolean);

    // Apply descartes: remove N lowest scoring partidas
    let ptsList=[...jornadaPts];
    if(reglas.descartes>0&&ptsList.length>reglas.descartes){
      const sorted=[...ptsList].sort((a,b)=>a.pts-b.pts);
      const descartados=new Set(sorted.slice(0,reglas.descartes).map(p=>p.jornada_id));
      ptsList=ptsList.filter(p=>!descartados.has(p.jornada_id));
    }

    const ptsT=Math.round(ptsList.reduce((a,r)=>a+r.pts,0)*100)/100;
    const ptsOf=Math.round(ptsList.filter(r=>oficiales.some(j=>j.id===r.jornada_id)).reduce((a,r)=>a+r.pts,0)*100)/100;
    const asist=jornadaPts.filter(r=>r.asistencia).length;
    return{...jugador,id:jugadorId,ptsT,ptsOf,asist,jornadaPts};
  });

  // 3. Sort by ptsT desc
  rawData.sort((a,b)=>b.ptsT-a.ptsT);

  // 4. Assign ranking positions
  rawData.forEach((j,i)=>j.pos=i+1);

  return rawData;
}

// Legacy calcRanking uses active torneo
function calcRanking(){ return calcRankingTorneo(STATE.activeTorneoId||STATE.torneo?.id); }
function avatarBg(pos){
  if(pos===1)return'#C49A00'; if(pos===2)return'#78909C'; if(pos===3)return'#8D6E63';
  return'var(--green)';
}
function medal(pos){
  if(pos===1)return'ğŸ¥‡'; if(pos===2)return'ğŸ¥ˆ'; if(pos===3)return'ğŸ¥‰';
  return`<span style="color:var(--muted);font-weight:700;font-size:14px;width:22px;display:inline-block;text-align:center;">${pos}</span>`;
}
function badgeHTML(estado){
  const m={'Oficial':'badge-oficial','Jugado':'badge-validar','Por Validar':'badge-validar','Pendiente Attest':'badge-attest','Planificada':'badge-planificada','En Juego':'badge-enjuego','Activo':'badge-activo','Borrador':'badge-planificada'};
  return`<span class="badge ${m[estado]||'badge-planificada'}">${estado}</span>`;
}
function avatarHTML(foto,pos,size='md'){
  const bg=avatarBg(pos);
  const sz=size==='sm'?'32px;font-size:11px':size==='lg'?'42px;font-size:15px':'36px;font-size:13px';
  const shadow=pos===1?'box-shadow:0 0 0 3px rgba(196,154,0,0.25);':'';
  return`<div class="avatar" style="width:${sz};background:${bg};${shadow}">${foto||'?'}</div>`;
}
function fmtPts(n){ return Number.isInteger(n)?String(n):n.toFixed(1); }
function fmtFecha(v){
  if(!v) return 'â€”';
  let d;
  if(typeof v==='object' && v.seconds) d=new Date(v.seconds*1000);
  else if(typeof v==='object' && v.toDate) d=v.toDate();
  else if(typeof v==='string'||typeof v==='number') d=new Date(String(v).length<=10?v+'T12:00:00':v);
  else d=new Date(v);
  return (!d||isNaN(d.getTime())) ? 'â€”' : d.toLocaleDateString('es-ES',{day:'numeric',month:'short',year:'numeric'});
}
function fmtFechaJornada(jn){
  return fmtFecha(jn.fecha||jn.creado||null);
}

// Returns the LIVE estado for a partida (auto En Juego when date arrives)
function getEstadoJornada(jn){
  const stored=jn.estado||'Planificada';
  // Terminal states: never auto-change
  if(stored==='Pendiente Attest'||stored==='Jugado'||stored==='Oficial'||stored==='Por Validar') return stored;
  // Auto-transition: if fecha is today or past â†’ En Juego
  // Uses LOCAL date (not UTC) so Venezuela/Miami time is respected
  if(jn.fecha){
    const fechaStr=typeof jn.fecha==='object'&&jn.fecha.seconds
      ? new Date(jn.fecha.seconds*1000).toLocaleDateString('en-CA')  // YYYY-MM-DD in local tz
      : String(jn.fecha).substring(0,10);
    const now=new Date();
    const today=now.toLocaleDateString('en-CA');  // YYYY-MM-DD in local tz
    if(fechaStr<=today) return 'En Juego';
  }
  return 'Planificada';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD â€” Multi-torneo
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function torneoCardHTML(torneo, compact=false){
  const tid=torneo.id;
  const reglas=getReglas(tid);
  const jornadasT=STATE.jornadas.filter(j=>j.torneo_id===tid||(!j.torneo_id&&tid===STATE.torneo?.id));
  const jugadas=jornadasT.filter(j=>j.estado!=='Planificada').length;
  const total=torneo.jornadas_total||jornadasT.length||'?';
  const proxima=[...jornadasT].sort((a,b)=>new Date(a.fecha)-new Date(b.fecha))
    .find(j=>j.estado==='Planificada'&&j.fecha>=new Date().toISOString().slice(0,10));

  // My position
  const rk=calcRankingTorneo(tid);
  const jugCount=getJugadoresTorneo(tid).filter(j=>j.activo!==false).length;
  const myJugadorId=STATE.profile?.jugador_id;
  const myPos=rk.find(r=>r.id===myJugadorId);
  const isAdmin=isTorneoAdmin(torneo);

  const estadoColor={'Activo':'var(--green)','activo':'var(--green)','Finalizado':'var(--muted)','finalizado':'var(--muted)','Borrador':'var(--gold)','borrador':'var(--gold)'}[torneo.estado]||'var(--blue)';

  return`
  <div class="card" style="margin-bottom:12px;overflow:hidden;">
    <div style="background:linear-gradient(135deg,var(--green),var(--teal));padding:16px 20px;cursor:pointer;"
      onclick="toggleTorneoDash('${tid}')">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div>
          <div style="color:rgba(255,255,255,0.7);font-size:10px;letter-spacing:2px;text-transform:uppercase;margin-bottom:4px;">
            ${torneo.estado?.toUpperCase()||'ACTIVO'}
          </div>
          <div style="color:#fff;font-size:17px;font-weight:800;font-family:Georgia,serif;">${torneo.nombre}</div>
        </div>
        ${myPos?`<div style="text-align:right;">
          <div style="color:rgba(255,255,255,0.7);font-size:10px;">Mi posiciÃ³n</div>
          <div style="color:#fff;font-size:22px;font-weight:800;">#${myPos.pos}</div>
          <div style="color:rgba(255,255,255,0.7);font-size:11px;">${myPos.ptsT} pts</div>
        </div>`:''}
      </div>
      <div style="display:flex;gap:20px;margin-top:12px;">
        <div><div style="color:rgba(255,255,255,0.6);font-size:9px;text-transform:uppercase;letter-spacing:1px;">Partidas</div>
          <div style="color:#fff;font-size:14px;font-weight:700;">${jugadas}/${total}</div></div>
        <div><div style="color:rgba(255,255,255,0.6);font-size:9px;text-transform:uppercase;letter-spacing:1px;">Jugadores</div>
          <div style="color:#fff;font-size:14px;font-weight:700;">${jugCount}</div></div>
        <div><div style="color:rgba(255,255,255,0.6);font-size:9px;text-transform:uppercase;letter-spacing:1px;">PrÃ³xima</div>
          <div style="color:#fff;font-size:13px;font-weight:600;">${proxima?fmtFecha(proxima.fecha):'â€”'}</div></div>
      </div>
    </div>

    ${STATE.expandedTorneo===tid?`
    <div style="padding:0;">
      <!-- Mini ranking top 3 -->
      <div style="padding:14px 20px 8px;">
        <div class="text-11 text-muted font-bold" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">ğŸ† Podio</div>
        ${rk.slice(0,3).map(j=>`
          <div class="result-row" style="margin-bottom:8px;">
            ${medal(j.pos)}
            ${j.fotoURL?`<img src="${j.fotoURL}" style="width:32px;height:32px;border-radius:50%;object-fit:cover;flex-shrink:0;"/>`:avatarHTML(j.foto,j.pos,'sm')}
            <div class="flex-1 text-13 font-bold">${j.nombre}</div>
            <div style="font-size:16px;font-weight:800;color:${j.pos===1?'var(--gold)':'var(--text)'};">${fmtPts(j.ptsT)}<span class="text-10 text-muted"> pts</span></div>
          </div>`).join('')}
      </div>
      <!-- PrÃ³ximas partidas -->
      ${jornadasT.filter(j=>j.estado==='Planificada').slice(0,2).length?`
      <div style="border-top:1px solid var(--border);padding:12px 20px 8px;">
        <div class="text-11 text-muted font-bold" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;">ğŸ“… PrÃ³ximas</div>
        ${jornadasT.filter(j=>j.estado==='Planificada').slice(0,2).map(jn=>`
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
            ${clubAvatarHTML(jn.sede)}
            <div class="flex-1">
              <div class="text-13 font-bold">${jn.sede||'Sin sede'}</div>
              <div class="text-11 text-muted">${fmtFechaJornada(jn)}${jn.teeTime?' Â· â° '+jn.teeTime:''}</div>
            </div>
          </div>`).join('')}
      </div>`:''}
      <!-- Actions -->
      <div style="border-top:1px solid var(--border);padding:12px 20px;display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn-outline" style="font-size:12px;padding:7px 14px;" onclick="verTorneoCompleto('${tid}')">Ver ranking completo â†’</button>
        ${isAdmin?`<button class="btn-green" style="font-size:12px;padding:7px 14px;" onclick="openModalJornada(null,'${tid}')">+ Partida</button>`:''}
      </div>
    </div>`:``}
  </div>`;
}

function toggleTorneoDash(torneoId){
  STATE.expandedTorneo=STATE.expandedTorneo===torneoId?null:torneoId;
  renderDashboard();
}

function verTorneoCompleto(torneoId){
  STATE.activeTorneoId=torneoId;
  goTab('mistorneos');
  STATE.expandedTorneo=torneoId;
}

function renderDashboard(){
  const el=document.getElementById('tab-dashboard');
  const isAdmin=STATE.profile?.role==='admin';
  const torneos=STATE.torneos;
  const MAX_DASH=3; // max cards on dashboard

  // Sort: active first, then by creation
  const sorted=[...torneos].sort((a,b)=>{
    const order={activo:0,Activo:0,borrador:1,Borrador:1,finalizado:2,Finalizado:2};
    return (order[a.estado]||1)-(order[b.estado]||1);
  });
  const visible=sorted.slice(0,MAX_DASH);
  const hasMore=sorted.length>MAX_DASH;

  if(torneos.length===0){
    el.innerHTML=`
      <div class="hero">
        <div class="hero-label">Bienvenido a Golfeados</div>
        <div class="hero-title">No hay torneos activos</div>
        <div style="color:rgba(255,255,255,0.8);font-size:13px;margin-top:8px;">Ve a Mis Torneos para crear o unirte a un torneo</div>
      </div>
      <div class="card" style="margin-top:12px;">
        <div class="card-body" style="text-align:center;padding:24px;">
          <button class="btn-outline" onclick="goTab('mistorneos')" style="font-size:14px;padding:12px 24px;">ğŸ† Ir a Mis Torneos</button>
        </div>
      </div>
      ${isAdmin?`<div class="card"><div class="card-body" style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn-green" onclick="openModalJornada()">+ Partida</button>
        <button class="btn-blue" onclick="goTab('jugadores')">+ Jugador</button>
        ${STATE.jugadores.length===0?`<button class="btn-teal" onclick="seedDatos()">ğŸŒ± Cargar Datos Iniciales</button>`:''}
      </div><div id="seedMsg" style="display:none;padding:10px 20px;font-size:13px;color:var(--green);"></div></div>`:''}
    `;
    return;
  }

  el.innerHTML=`
    ${visible.map(t=>torneoCardHTML(t)).join('')}
    ${hasMore?`
      <div style="text-align:center;margin:4px 0 16px;">
        <button class="btn-outline" onclick="goTab('mistorneos')" style="width:100%;padding:12px;font-size:13px;">
          Ver todos mis torneos (${torneos.length}) â†’
        </button>
      </div>`:''}
    ${isAdmin?`
    <div class="card">
      <div class="card-header"><span class="card-title">âš™ï¸ Admin</span></div>
      <div class="card-body" style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn-green" onclick="openModalTorneo()">+ Torneo</button>
        <button class="btn-outline" onclick="goTab('jugadores')">+ Jugador</button>
        ${STATE.jugadores.length===0?`<button class="btn-teal" onclick="seedDatos()">ğŸŒ± Cargar Datos Iniciales</button>`:''}
      </div>
      <div id="seedMsg" style="display:none;padding:10px 20px;font-size:13px;color:var(--green);"></div>
    </div>`:''}
  `;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MIS TORNEOS â€” Lista completa con detalle expandible
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMisTorneos(){
  const el=document.getElementById('tab-mistorneos');
  const isAdmin=STATE.profile?.role==='admin';
  const torneos=[...STATE.torneos].sort((a,b)=>{
    const order={activo:0,Activo:0,borrador:1,Borrador:1,finalizado:2,Finalizado:2};
    return (order[a.estado]||1)-(order[b.estado]||1);
  });

  el.innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <div>
        <div class="text-15 font-bold" style="font-family:Georgia,serif;">Mis Torneos</div>
        <div class="text-12 text-muted">${torneos.length} torneo${torneos.length!==1?'s':''}</div>
      </div>
      <button class="btn-green" style="font-size:13px;padding:8px 16px;" onclick="openModalTorneo()">+ Nuevo</button>
    </div>
    ${torneos.length===0?`<div class="card"><div class="card-body" style="text-align:center;color:var(--muted);padding:40px;">
      <div style="font-size:48px;margin-bottom:12px;">â›³</div>
      <div style="margin-bottom:16px;">No tienes torneos aÃºn.</div>
      <button class="btn-green" onclick="openModalTorneo()">+ Crear primer torneo</button>
    </div></div>`:''}
    ${torneos.map(t=>{
      const tid=t.id;
      const isExpanded=STATE.expandedTorneo===tid;
      const rk=calcRankingTorneo(tid);
      const jornadasT=STATE.jornadas.filter(j=>j.torneo_id===tid||(!j.torneo_id&&tid===STATE.torneo?.id));
      const jugadas=jornadasT.filter(j=>j.estado!=='Planificada').length;
      const total=t.jornadas_total||jornadasT.length||'?';
      const myJugadorId=STATE.profile?.jugador_id;
      const myPos=rk.find(r=>r.id===myJugadorId);
      const isAdminT=isTorneoAdmin(t);

      return`
      <div class="card" style="margin-bottom:12px;">
        <!-- Card header -->
        <div style="padding:16px 20px;cursor:pointer;display:flex;align-items:center;gap:14px;"
          onclick="toggleTorneoMis('${tid}')">
          <div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,var(--green),var(--teal));
            display:flex;align-items:center;justify-content:center;color:#fff;font-size:18px;flex-shrink:0;">â›³</div>
          <div class="flex-1">
            <div class="text-15 font-bold">${t.nombre}</div>
            <div class="text-12 text-muted">${jugadas}/${total} partidas Â· ${getJugadoresTorneo(tid).filter(j=>j.activo!==false).length} jugadores</div>
            ${myPos?`<div class="text-11" style="color:var(--green);margin-top:2px;">Tu posiciÃ³n: #${myPos.pos} Â· ${myPos.ptsT} pts</div>`:''}
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
            ${badgeHTML(t.estado||'Activo')}
            <span style="color:var(--muted);font-size:13px;">${isExpanded?'â–²':'â–¼'}</span>
          </div>
        </div>

        ${isExpanded?`
        <!-- Ranking completo -->
        <div style="border-top:1px solid var(--border);">
          <div style="padding:14px 20px 4px;">
            <div class="text-11 text-muted font-bold" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">ğŸ“Š Ranking</div>
            <div class="rank-head"><span>#</span><span>Jugador</span><span>Asist.</span><span>Total</span></div>
            ${rk.map(j=>`
              <div class="rank-row ${j.pos<=3?'top':''}">
                <div>${medal(j.pos)}</div>
                <div class="flex items-center gap-8">
                  ${j.fotoURL?`<img src="${j.fotoURL}" style="width:28px;height:28px;border-radius:50%;object-fit:cover;flex-shrink:0;"/>`:avatarHTML(j.foto,j.pos,'sm')}
                  <div><div class="text-13 font-bold">${j.nombre}</div><div class="text-11 text-muted">${j.alias||''}</div></div>
                </div>
                <div class="text-13 text-muted">${j.asist}âœ“</div>
                <div style="font-size:15px;font-weight:800;color:${j.pos===1?'var(--gold)':'var(--text)'};">${j.ptsT}</div>
              </div>`).join('')}
          </div>

          <!-- Partidas del torneo â€” clickeables -->
          <div style="border-top:1px solid var(--border);padding:14px 20px 8px;">
            <div class="text-11 text-muted font-bold" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">ğŸ“… Partidas</div>
            ${jornadasT.length===0?`<div class="text-13 text-muted">Sin partidas aÃºn.</div>`:''}
            ${[...jornadasT].sort((a,b)=>{const fa=a.fecha&&typeof a.fecha==='object'&&a.fecha.seconds?new Date(a.fecha.seconds*1000):new Date(a.fecha||0);const fb=b.fecha&&typeof b.fecha==='object'&&b.fecha.seconds?new Date(b.fecha.seconds*1000):new Date(b.fecha||0);return fa-fb;}).map(jn=>jornadaRowMT(jn)).join('')}
          </div>

          <!-- Desglose por partida -->
          ${(()=>{
            const jJugadas=jornadasT.filter(j=>j.estado!=='Planificada');
            if(!jJugadas.length) return '';
            const minW=80+jJugadas.length*60;
            let html='<div style="border-top:1px solid var(--border);padding:14px 20px 8px;overflow-x:auto;">';
            html+='<div class="text-11 text-muted font-bold" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">Desglose por Partida</div>';
            html+='<table style="width:100%;border-collapse:collapse;font-size:12px;min-width:'+minW+'px;">';
            html+='<tr><td style="padding:4px 8px;color:var(--muted);font-weight:700;white-space:nowrap;">Jugador</td>';
            jJugadas.forEach(jn=>{html+='<td style="padding:4px 8px;text-align:center;color:var(--muted);font-weight:700;white-space:nowrap;">'+jn.sede+(jn.reglasOverride?' â­':'')+'<br/><span style="font-size:10px;opacity:0.75;">'+fmtFechaJornada(jn)+'</span><br/>'+badgeHTML(getEstadoJornada(jn))+'</td>';});
            html+='<td style="padding:4px 8px;text-align:center;color:var(--green);font-weight:700;">TOT</td></tr>';
            rk.forEach(j=>{
              html+='<tr style="border-top:1px solid var(--border);">';
              html+='<td style="padding:5px 8px;font-weight:600;white-space:nowrap;">'+j.nombre+'</td>';
              jJugadas.forEach(jn=>{
                const r=STATE.resultados.find(r=>r.jornada_id===jn.id&&r.jugador_id===j.id);
                const val=r?(r.asistencia?fmtPts(r.pts):'â€”'):'?';
                const col=r&&r.pts>=4?'var(--gold)':'var(--text)';
                html+='<td style="padding:5px 8px;text-align:center;color:'+col+';">'+val+'</td>';
              });
              html+='<td style="padding:5px 8px;text-align:center;font-weight:800;color:'+(j.pos===1?'var(--gold)':'var(--text)')+';">'+fmtPts(j.ptsT)+'</td>';
              html+='</tr>';
            });
            html+='</table></div>';
            return html;
          })()}

          <!-- Reglas del torneo -->
          <div style="border-top:1px solid var(--border);padding:14px 20px 8px;">
            <div class="text-11 text-muted font-bold" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">Reglas</div>
            ${reglasResumenHTML(t)}
            ${t.docURL?`<div style="margin-top:10px;">
              <a href="${t.docURL}" target="_blank" style="display:inline-flex;align-items:center;gap:8px;padding:8px 14px;background:var(--cardL);border-radius:8px;border:1px solid var(--border);color:var(--blue);font-size:13px;font-weight:600;text-decoration:none;">
                ${t.docType==='pdf'?'ğŸ“„ Ver reglamento / documento':'ğŸ–¼ï¸ Ver imagen del torneo'}
              </a>
            </div>`:''}
          </div>

          <!-- Acciones -->
          <div style="border-top:1px solid var(--border);padding:12px 20px;display:flex;gap:8px;flex-wrap:wrap;">
            ${isAdminT?`<button class="btn-green" style="font-size:12px;padding:7px 14px;" onclick="openModalJornada(null,'${tid}')">+ Partida</button>`:''}
            ${isAdminT?`<button class="btn-outline" style="font-size:12px;padding:7px 14px;" onclick="openModalEditTorneo('${tid}')">âœï¸ Editar torneo</button>`:''}
          </div>
        </div>`:``}
      </div>`;
    }).join('')}
  `;
}

function toggleTorneoMis(torneoId){
  STATE.expandedTorneo=STATE.expandedTorneo===torneoId?null:torneoId;
  renderMisTorneos();
}

function toggleJornadaMT(jid){
  STATE.expandedJornadaMT=STATE.expandedJornadaMT===jid?null:jid;
  renderMisTorneos();
}

// Returns HTML string for a clickable partida row inside Mis Torneos
function jornadaRowMT(jn){
  const isOpen=STATE.expandedJornadaMT===jn.id;
  const est=getEstadoJornada(jn);
  const res=STATE.resultados.filter(r=>r.jornada_id===jn.id).sort((a,b)=>a.pos-b.pos);
  const hasResults=res.length>0;
  const hasFotos=Array.isArray(jn.fotos)&&jn.fotos.length>0;
  const isAdmin=STATE.profile?.role==='admin';

  // â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let html='<div style="border-radius:10px;overflow:hidden;margin-bottom:8px;border:1px solid '+(isOpen?'var(--green)':'var(--border)')+';">';
  html+='<div onclick="toggleJornadaMT(\''+jn.id+'\')" style="display:flex;align-items:center;gap:10px;padding:10px 12px;cursor:pointer;background:'+(isOpen?'#F1F8E9':'var(--white)')+';">';
  html+=clubAvatarHTML(jn.sede);
  html+='<div style="flex:1;min-width:0;">';
  html+='<div style="font-size:13px;font-weight:700;">'+(jn.sede||'Sin sede');
  if(jn.cuentaRanking===false) html+=' ğŸš«';
  if(jn.reglasOverride) html+=' <span style="background:#FEF3C7;color:#92400E;font-size:10px;font-weight:700;padding:1px 4px;border-radius:4px;">â­</span>';
  html+='</div>';
  html+='<div style="font-size:11px;color:var(--muted);margin-top:1px;">'+fmtFechaJornada(jn)+(jn.teeTime?' Â· â° '+jn.teeTime:'')+'</div>';
  html+='</div>';
  // Right side: badge + foto count + arrow
  html+='<div style="display:flex;align-items:center;gap:6px;flex-shrink:0;">';
  if(hasFotos) html+='<span style="background:#E3F2FD;color:#1565C0;font-size:10px;font-weight:700;padding:2px 6px;border-radius:10px;">ğŸ“·'+jn.fotos.length+'</span>';
  html+=badgeHTML(getEstadoJornada(jn));
  html+='<span style="color:var(--muted);font-size:12px;min-width:10px;">'+(isOpen?'â–²':'â–¼')+'</span>';
  html+='</div>';
  html+='</div>'; // end clickable header

  if(isOpen){
    // â”€â”€ RESULTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if(hasResults){
      html+='<div style="border-top:1px solid var(--border);background:var(--bg);">';
      res.forEach(function(r){
        const jug=getJugador(r.jugador_id);
        const isTop=r.pos===1;
        const noAsist=!r.asistencia;
        const isDQ=r.dq;
        html+='<div style="display:flex;align-items:center;gap:10px;padding:9px 14px;border-bottom:1px solid var(--border);'+(isTop?'background:linear-gradient(90deg,#FFFDE7,transparent);':'')+(noAsist?'opacity:0.55;':'')+'">';
        html+='<div style="min-width:32px;text-align:center;">';
        if(r.pos<=3&&!noAsist&&!isDQ){
          html+='<span style="font-size:18px;">'+medal(r.pos)+'</span>';
        } else {
          html+='<span style="background:var(--border);border-radius:5px;padding:2px 6px;font-size:11px;font-weight:700;color:var(--muted);">'+(noAsist?'â€”':isDQ?'DQ':r.pos+'Â°')+'</span>';
        }
        html+='</div>';
        html+=avatarHTML(jug&&jug.foto?jug.foto:'?',r.pos,'sm');
        html+='<div style="flex:1;min-width:0;">';
        html+='<div style="font-size:13px;font-weight:600;">'+(jug?jug.nombre:'Desconocido')+'</div>';
        if(noAsist) html+='<div style="font-size:11px;color:var(--red);">No asistiÃ³</div>';
        if(isDQ) html+='<div style="font-size:11px;color:var(--red);">Descalificado</div>';
        html+='</div>';
        if(!noAsist) html+='<div style="font-size:16px;font-weight:800;color:'+(isTop?'#B8860B':'var(--text)')+';">'+fmtPts(r.pts)+'<span style="font-size:11px;font-weight:400;color:var(--muted);"> pts</span></div>';
        html+='</div>';
      });
      html+='</div>';
    } else {
      html+='<div style="padding:14px;text-align:center;color:var(--muted);font-size:12px;border-top:1px solid var(--border);">Sin resultados cargados aÃºn</div>';
    }

    // â”€â”€ FOTOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if(hasFotos){
      html+='<div style="border-top:1px solid var(--border);padding:12px 14px;background:#fafafa;">';
      html+='<div style="font-size:10px;font-weight:700;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;">ğŸ“¸ Fotos</div>';
      // Carousel container
      html+='<div style="position:relative;overflow:hidden;border-radius:10px;background:#111;cursor:pointer;" onclick="openCarousel(\''+jn.id+'\',0)">';
      html+='<div id="cmt_'+jn.id+'" style="display:flex;transition:transform 0.35s ease;">';
      jn.fotos.forEach(function(url){
        html+='<img src="'+url+'" style="width:100%;flex-shrink:0;aspect-ratio:4/3;object-fit:cover;" loading="lazy"/>';
      });
      html+='</div>';
      if(jn.fotos.length>1){
        html+='<button onclick="event.stopPropagation();slideCMT(\''+jn.id+'\',-1)" style="position:absolute;left:8px;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.5);border:none;color:#fff;font-size:26px;border-radius:50%;width:36px;height:36px;cursor:pointer;display:flex;align-items:center;justify-content:center;">&#8249;</button>';
        html+='<button onclick="event.stopPropagation();slideCMT(\''+jn.id+'\',1)" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.5);border:none;color:#fff;font-size:26px;border-radius:50%;width:36px;height:36px;cursor:pointer;display:flex;align-items:center;justify-content:center;">&#8250;</button>';
        html+='<div style="position:absolute;bottom:6px;left:50%;transform:translateX(-50%);display:flex;gap:5px;">';
        jn.fotos.forEach(function(_,di){
          html+='<div id="cmt_dot_'+jn.id+'_'+di+'" style="width:7px;height:7px;border-radius:50%;background:'+(di===0?'#fff':'rgba(255,255,255,0.4)')+';"></div>';
        });
        html+='</div>';
      }
      html+='</div></div>';
    }
  }

  html+='</div>';
  return html;
}


const _cmtIdx={};
function slideCMT(jid,dir){
  const t=document.getElementById('cmt_'+jid); if(!t) return;
  const n=t.querySelectorAll('img').length;
  _cmtIdx[jid]=((_cmtIdx[jid]||0)+dir+n)%n;
  t.style.transform='translateX(-'+(_cmtIdx[jid]*100)+'%)';
  for(let i=0;i<n;i++){const d=document.getElementById('cmt_dot_'+jid+'_'+i);if(d)d.style.background=i===_cmtIdx[jid]?'#fff':'rgba(255,255,255,0.4)';}
}

function reglasResumenHTML(torneo){
  const r=torneo.reglas||{};
  const pts=r.puntos||{1:4,2:3,3:2,resto:1};
  const items=[
    `Puntos: 1Â°=${pts[1]||4} Â· 2Â°=${pts[2]||3} Â· 3Â°=${pts[3]||2} Â· Resto=${pts.resto||1}`,
    r.bonusAsistencia?`Bonus asistencia: +${r.bonusAsistencia} pts`:'',
    r.penalNoAsistencia?`Penal no asistencia: ${r.penalNoAsistencia} pts`:'',
    r.penalDQ?`Penal DQ: ${r.penalDQ} pts`:'',
    r.descartes?`Descartes: ${r.descartes} peor(es) partida(s) no cuentan`:'',
    `Empates: ${r.empates==='comparten'?'Comparten puntos promedio':'PosiciÃ³n anterior'}`,
  ].filter(Boolean);
  return`<div style="display:flex;flex-direction:column;gap:4px;">
    ${items.map(i=>`<div class="text-12 text-muted">â€¢ ${i}</div>`).join('')}
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL TORNEO â€” Crear / Editar
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editingTorneoId = null;

function openModalTorneo(torneoId=null){
  editingTorneoId=torneoId;
  document.getElementById('modalTorneoError').style.display='none';
  const t=torneoId?STATE.torneos.find(t=>t.id===torneoId):null;
  document.getElementById('modalTorneoTitle').textContent=torneoId?'Editar Torneo':'Nuevo Torneo';

  // Info bÃ¡sica
  document.getElementById('tNombre').value=t?.nombre||'';
  // dates removed â€” managed through partidas
  document.getElementById('tJornadasTotal').value=t?.jornadas_total||'';
  document.getElementById('tEstado').value=t?.estado||'Activo';
  document.getElementById('tDescripcion').value=t?.descripcion||'';
  document.getElementById('tVisibilidad').value=t?.visibilidad||'privado';
  document.getElementById('tQuienCarga').value=t?.quienCargaResultados||'admins';

  // Reglas
  const r=t?.reglas||{};
  const pts=r.puntos||{};
  document.getElementById('rPts1').value=pts[1]!==undefined?pts[1]:4;
  document.getElementById('rPts2').value=pts[2]!==undefined?pts[2]:3;
  document.getElementById('rPts3').value=pts[3]!==undefined?pts[3]:2;
  document.getElementById('rPtsResto').value=pts.resto!==undefined?pts.resto:1;
  document.getElementById('rBonus').value=r.bonusAsistencia||0;
  document.getElementById('rPenalNoAsist').value=r.penalNoAsistencia||0;
  document.getElementById('rPenalDQ').value=r.penalDQ||0;
  document.getElementById('rDescartes').value=r.descartes||0;
  document.getElementById('rEmpates').value=r.empates||'comparten';

  updateEmpateEjemplo();

  // Load existing doc
  STATE._torneoDocURL=t?.docURL||null;
  STATE._torneoDocCleared=false;
  document.getElementById('tDocPreview').style.display='none';
  document.getElementById('tDocLabel').style.display='block';
  document.getElementById('tDocInput').value='';
  if(t?.docURL){
    document.getElementById('tDocExisting').style.display='flex';
    document.getElementById('tDocLink').href=t.docURL;
    document.getElementById('tDocLink').textContent=t.docType==='pdf'?'ğŸ“„ Ver reglamento':'ğŸ–¼ï¸ Ver imagen del torneo';
  } else {
    document.getElementById('tDocExisting').style.display='none';
  }

  // Load co-admins
  STATE._coAdmins=[...(t?.admins||[])].filter(uid=>uid!==STATE.user?.uid);
  renderAdminsList();

  // Hide co-admins section for new torneos (show after creation)
  document.getElementById('seccionAdmins').style.display=torneoId?'block':'none';
  document.getElementById('modalTorneo').style.display='flex';
}

// Alias for edit button
function openModalEditTorneo(torneoId){ openModalTorneo(torneoId); }

function renderAdminsList(){
  const el=document.getElementById('adminsList');
  if(!el)return;
  const admins=STATE._coAdmins||[];
  if(admins.length===0){
    el.innerHTML='<div class="text-12 text-muted">Sin co-administradores aÃºn.</div>';
    return;
  }
  el.innerHTML=admins.map(uid=>{
    const u=STATE._adminUsers?.[uid]||{};
    return`<div style="display:flex;align-items:center;gap:10px;padding:8px 10px;background:var(--bg);border-radius:8px;">
      <div style="width:28px;height:28px;border-radius:50%;background:var(--green);display:flex;align-items:center;justify-content:center;color:#fff;font-size:11px;font-weight:700;">${(u.nombre||uid).slice(0,2).toUpperCase()}</div>
      <div class="flex-1"><div class="text-12 font-bold">${u.nombre||uid}</div><div class="text-11 text-muted">${u.email||''}</div></div>
      <button onclick="removeCoAdmin('${uid}')" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px;">âœ•</button>
    </div>`;
  }).join('');
}

async function addCoAdmin(){
  const input=document.getElementById('addAdminInput');
  const errEl=document.getElementById('addAdminError');
  const val=input.value.trim();
  errEl.style.display='none';
  if(!val)return;

  try{
    // Search by email or username
    let snap;
    if(val.includes('@')&&val.includes('.')){
      snap=await db.collection('users').where('email','==',val).limit(1).get();
    } else {
      snap=await db.collection('users').where('username','==',val.replace('@','')).limit(1).get();
    }
    if(snap.empty){ errEl.textContent='Usuario no encontrado.'; errEl.style.display='block'; return; }
    const userData=snap.docs[0].data();
    const uid=snap.docs[0].id;
    if(STATE._coAdmins.includes(uid)||uid===STATE.user?.uid){
      errEl.textContent='Este usuario ya es admin.'; errEl.style.display='block'; return;
    }
    STATE._coAdmins.push(uid);
    if(!STATE._adminUsers) STATE._adminUsers={};
    STATE._adminUsers[uid]=userData;
    input.value='';
    renderAdminsList();
  }catch(e){ errEl.textContent='Error: '+e.message; errEl.style.display='block'; }
}

function removeCoAdmin(uid){
  STATE._coAdmins=(STATE._coAdmins||[]).filter(u=>u!==uid);
  renderAdminsList();
}

function closeModalTorneo(event){
  if(event&&event.currentTarget!==event.target)return;
  document.getElementById('modalTorneo').style.display='none';
  editingTorneoId=null;
}

function updateEmpateEjemplo(){
  const el=document.getElementById('empateEjemplo');
  if(!el)return;
  const tipo=(document.getElementById('rEmpates')?.value)||'comparten';
  const pts1=Number(document.getElementById('rPts1')?.value)||4;
  const pts2=Number(document.getElementById('rPts2')?.value)||3;
  const pts3=Number(document.getElementById('rPts3')?.value)||2;
  if(tipo==='comparten'){
    const avg2=((pts1+pts2)/2).toFixed(1);
    const avg3=((pts1+pts2+pts3)/3).toFixed(1);
    el.innerHTML=
      `<strong>2 empatados en 1Â°:</strong> ${avg2} pts c/u â†’ siguiente toma 3Â°<br>`+
      `<strong>3 empatados en 1Â°:</strong> ${avg3} pts c/u â†’ siguiente toma 4Â°`;
  } else {
    el.innerHTML=
      `<strong>2 empatados en 1Â°:</strong> ambos reciben ${pts1} pts â†’ siguiente toma 3Â°<br>`+
      `<strong>3 empatados en 1Â°:</strong> todos reciben ${pts1} pts â†’ siguiente toma 4Â°`;
  }
}

async function saveModalTorneo(){
  const nombre=document.getElementById('tNombre').value.trim();
  const err=document.getElementById('modalTorneoError');
  const btn=document.getElementById('btnGuardarTorneo');
  err.style.display='none';

  if(!nombre){ err.textContent='El nombre es obligatorio.'; err.style.display='block'; return; }

  btn.disabled=true; btn.textContent='Guardando...';
  try{
    // Upload doc if selected
    let docURL=STATE._torneoDocURL||null;
    let docType='';
    const docFile=document.getElementById('tDocInput').files[0];
    if(docFile){
      const path='torneos/'+(editingTorneoId||Date.now())+'_doc'+(docFile.type==='application/pdf'?'.pdf':'.jpg');
      if(docFile.type==='application/pdf'){
        docURL=await uploadPhoto(docFile,path,'tDocProgress');
        docType='pdf';
      } else {
        const comp=await resizeAndCompress(docFile,1200,0.85);
        docURL=await uploadPhoto(comp,path,'tDocProgress');
        docType='img';
      }
    }
    if(STATE._torneoDocCleared){ docURL=null; docType=''; }
    const data={
      nombre,
      ...(docURL?{docURL,docType}:{}),
      jornadas_total:Number(document.getElementById('tJornadasTotal').value)||0,
      estado:document.getElementById('tEstado').value,
      descripcion:document.getElementById('tDescripcion').value.trim(),
      visibilidad:document.getElementById('tVisibilidad').value,
      quienCargaResultados:document.getElementById('tQuienCarga').value,
      reglas:{
        puntos:{
          1:Number(document.getElementById('rPts1').value)||4,
          2:Number(document.getElementById('rPts2').value)||3,
          3:Number(document.getElementById('rPts3').value)||2,
          resto:Number(document.getElementById('rPtsResto').value)||1,
        },
        bonusAsistencia:Number(document.getElementById('rBonus').value)||0,
        penalNoAsistencia:Number(document.getElementById('rPenalNoAsist').value)||0,
        penalDQ:Number(document.getElementById('rPenalDQ').value)||0,
        descartes:Number(document.getElementById('rDescartes').value)||0,
        empates:document.getElementById('rEmpates').value||'comparten',
      }
    };

    if(editingTorneoId){
      data.updated_at=firebase.firestore.FieldValue.serverTimestamp();
      // Keep original adminId, update admins list
      const origTorneo=STATE.torneos.find(t=>t.id===editingTorneoId);
      data.admins=[origTorneo?.adminId||STATE.user.uid,...(STATE._coAdmins||[])];
      await db.collection('torneos').doc(editingTorneoId).update(data);
    } else {
      data.adminId=STATE.user.uid;
      data.creado_por=STATE.user.uid;
      data.admins=[STATE.user.uid];
      data.cargadores=[];
      data.creado=firebase.firestore.FieldValue.serverTimestamp();
      const ref=await db.collection('torneos').add(data);
      switchActiveTorneo(ref.id);
    }
    closeModalTorneo();
    goTab('mistorneos');
  }catch(e){
    err.textContent='Error: '+e.message; err.style.display='block';
  }finally{
    btn.disabled=false; btn.textContent='Guardar Torneo';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RANKING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRanking(){
  const el=document.getElementById('tab-ranking');
  const torneoId=STATE.activeTorneoId||STATE.torneos[0]?.id||null;
  if(!torneoId||STATE.torneos.length===0){
    el.innerHTML='<div class="card"><div class="card-body" style="text-align:center;color:var(--muted);padding:40px;">Sin torneos disponibles.</div></div>';
    return;
  }
  const torneo=STATE.torneos.find(t=>t.id===torneoId)||STATE.torneos[0];
  const rk=calcRankingTorneo(torneoId);
  const jornadasT=STATE.jornadas.filter(j=>j.torneo_id===torneoId||(!j.torneo_id&&torneoId===STATE.torneo?.id));
  const oficiales=jornadasT.filter(j=>j.estado==='Oficial').length;
  const jugadasAll=jornadasT.filter(j=>j.estado!=='Planificada');
  const selectorOpts=STATE.torneos.map(t=>`<option value="${t.id}" ${t.id===torneoId?'selected':''}>${t.nombre}</option>`).join('');

  el.innerHTML=`
    <div style="margin-bottom:14px;">
      <label class="form-label">Torneo</label>
      <select class="form-select" style="width:100%;font-size:14px;" onchange="STATE.activeTorneoId=this.value;renderRanking()">
        ${selectorOpts}
      </select>
    </div>
    <div class="card">
      <div class="card-header">
        <span class="card-title">ğŸ† ${torneo.nombre}</span>
        <span class="text-11 text-muted">${oficiales}/${jugadasAll.length} partidas oficiales</span>
      </div>
      <div class="rank-head"><span>#</span><span>Jugador</span><span>Asist.</span><span>Total</span></div>
      ${rk.map(j=>`
        <div class="rank-row ${j.pos<=3?'top':''}">
          <div>${medal(j.pos)}</div>
          <div class="flex items-center gap-8">${j.fotoURL?`<img src="${j.fotoURL}" style="width:32px;height:32px;border-radius:50%;object-fit:cover;flex-shrink:0;border:2px solid ${j.pos===1?'var(--gold)':'var(--border)'}"/>`:avatarHTML(j.foto,j.pos,'sm')}<div><div class="text-13 font-bold">${j.nombre}</div><div class="text-11 text-muted">${j.alias||''}</div></div></div>
          <div class="text-13 text-muted">${j.asist}âœ“</div>
          <div style="font-size:15px;font-weight:800;color:${j.pos===1?'var(--gold)':'var(--text)'};">${fmtPts(j.ptsT)}</div>
        </div>`).join('')}
    </div>
    ${jugadasAll.length>0?`
    <div class="card">
      <div class="card-header"><span class="card-title">ğŸ“Š Desglose por Partida</span></div>
      <div style="overflow-x:auto;padding:12px;">
        <table class="breakdown-table" style="min-width:${100+jugadasAll.length*80}px;">
          <tr>
            <td style="padding:6px 8px;color:var(--muted);font-weight:700;white-space:nowrap;">Jugador</td>
            ${jugadasAll.map(jn=>`<td style="padding:6px 8px;text-align:center;color:var(--muted);font-weight:700;white-space:nowrap;min-width:70px;">${jn.sede}<br/>${badgeHTML(getEstadoJornada(jn))}</td>`).join('')}
            <td style="padding:6px 8px;text-align:center;color:var(--green);font-weight:700;">TOTAL</td>
          </tr>
          ${rk.map(j=>`
            <tr>
              <td style="padding:8px;font-weight:600;white-space:nowrap;">${j.nombre}</td>
              ${jugadasAll.map(jn=>{const r=STATE.resultados.find(r=>r.jornada_id===jn.id&&r.jugador_id===j.id);const val=r?(r.asistencia?fmtPts(r.pts):'â€”'):'?';const col=r&&r.pts>=4?'var(--gold)':'var(--text)';return`<td style="padding:8px;text-align:center;color:${r?col:'var(--muted)'};">${val}</td>`;}).join('')}
              <td style="padding:8px;text-align:center;font-weight:800;color:${j.pos===1?'var(--gold)':'var(--text)'};">${fmtPts(j.ptsT)}</td>
            </tr>`).join('')}
        </table>
      </div>
    </div>`:''}
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JORNADAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Helper: club avatar for partida list
function clubAvatarHTML(sede){
  const cl=STATE.clubes.find(c=>c.nombre===sede);
  const bg=cl?.color||'#2E7D5E';
  const ini=cl?.iniciales||sede?.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,3)||'â›³';
  if(cl?.fotoURL) return`<img src="${cl.fotoURL}" style="width:42px;height:42px;border-radius:10px;object-fit:cover;flex-shrink:0;border:1px solid var(--border);"/>`;
  return`<div style="width:42px;height:42px;border-radius:10px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:12px;color:#fff;background:${bg};">${ini}</div>`;
}

function renderJornadas(){
  const el=document.getElementById('tab-jornadas');
  const torneo_=getActiveTorneo();
  // Show only partidas from torneos the user admins or participates in
  const misTorneoIds=new Set(STATE.torneos.map(t=>t.id)); // ya filtrado por admins
  const myJugId=STATE.profile?.jugador_id;
  // Include jornada if: user is admin of its torneo OR user has a result in it
  const jornadasConResultado=myJugId?new Set(
    STATE.resultados.filter(r=>r.jugador_id===myJugId).map(r=>r.jornada_id)
  ):new Set();
  const misJornadas=STATE.jornadas.filter(j=>{
    if(j.torneo_id && misTorneoIds.has(j.torneo_id)) return true;  // admin del torneo
    if(jornadasConResultado.has(j.id)) return true;                // tiene resultado
    return false;
  });
  const jornadasOrdenadas=[...misJornadas].sort((a,b)=>{
    const da=a.fecha?(typeof a.fecha==='object'&&a.fecha.seconds?new Date(a.fecha.seconds*1000):new Date(a.fecha)):null;
    const db_=b.fecha?(typeof b.fecha==='object'&&b.fecha.seconds?new Date(b.fecha.seconds*1000):new Date(b.fecha)):null;
    if(!da) return 1; if(!db_) return -1;
    return da-db_;
  });

  el.innerHTML=`
    <div style="margin-bottom:14px;">
      <div class="text-15 font-bold" style="font-family:Georgia,serif;">Mis Partidas</div>
      <div class="text-12 text-muted">Partidas de los torneos en que participas</div>
    </div>
    ${jornadasOrdenadas.length===0?`<div class="card"><div class="card-body" style="text-align:center;color:var(--muted);padding:40px;">No hay partidas creadas aÃºn.</div></div>`:''}
    ${jornadasOrdenadas.map(jn=>{
      const res=STATE.resultados.filter(r=>r.jornada_id===jn.id).sort((a,b)=>a.pos-b.pos);
      const isOpen=STATE.expandedJornada===jn.id;
      const cargador=getJugador(jn.cargado_por);
      const attestador=getJugador(jn.attest_por);
      const myJugadorId=STATE.profile?.jugador_id;
      const est=getEstadoJornada(jn);  // live computed estado
      // Per-jornada torneo permissions
      const torneoDeJornada=findTorneo(jn.torneo_id);
      const isAdminJornada=isTorneoAdmin(torneoDeJornada);
      const canCargarThis=canCargarTorneo(torneoDeJornada);
      const quienCarga=torneoDeJornada?.quienCargaResultados||'admins';
      const canAttest=(est==='Pendiente Attest'||est==='Por Validar')&&jn.cargado_por!==myJugadorId&&(isAdminJornada||STATE.resultados.some(r=>r.jornada_id===jn.id&&r.jugador_id===myJugadorId));
      const canCargar=est==='En Juego'&&(canCargarThis||(quienCarga==='cualquiera'&&STATE.profile?.jugador_id&&STATE.resultados.some(r=>r.jornada_id===jn.id&&r.jugador_id===myJugadorId)));
      // Build "quiÃ©n puede cargar" label
      const quienPuedeMsj=quienCarga==='cualquiera'?'Cualquier participante puede cargar los resultados':
        'Solo el admin del torneo puede cargar resultados';

      return`
        <div class="partida-card" style="${est==='Jugado'||est==='Por Validar'?'border:2px solid #C8E6C9;':est==='En Juego'?'border:2px solid #FFE082;':''}">
          <div class="partida-header" onclick="toggleJornada('${jn.id}')" style="${est==='Jugado'||est==='Por Validar'?'background:linear-gradient(135deg,#F1F8E9,#E8F5E9);':est==='En Juego'?'background:linear-gradient(135deg,#FFFDE7,#FFF8E1);':''}"  >
            <div class="flex items-center gap-10" style="flex:1;min-width:0;">
              ${clubAvatarHTML(jn.sede)}
              <div style="flex:1;min-width:0;">
                <div class="text-14 font-bold" style="line-height:1.3;">
                  ${jn.sede||'Sin sede'}${jn.cuentaRanking===false?' ğŸš«':''}${jn.reglasOverride?` <span style="background:#FEF3C7;color:#92400E;font-size:10px;font-weight:700;padding:1px 5px;border-radius:4px;white-space:nowrap;">â­ Especial</span>`:''}
                </div>
                <div style="font-size:12px;color:var(--text2);font-weight:600;margin-top:2px;">${fmtFechaJornada(jn)}${jn.teeTime?' Â· â° '+jn.teeTime:''}</div>
                ${jn.notas?`<div class="text-11 text-muted">${jn.notas}</div>`:''}
                ${(()=>{const t=findTorneo(jn.torneo_id);return t?`<div class="text-11" style="color:var(--green);font-weight:600;margin-top:1px;">ğŸ† ${t.nombre}</div>`:'';})()} 
              </div>
              ${jn.fotos&&jn.fotos.length>0?`<div style="display:flex;flex-direction:row;gap:0;flex-shrink:0;margin-left:4px;cursor:pointer;" onclick="event.stopPropagation();toggleJornada('${jn.id}')">${jn.fotos.slice(0,3).map((url,fi)=>'<img src="'+url+'" style="width:34px;height:34px;object-fit:cover;border-radius:6px;border:2px solid var(--white);'+(fi>0?'margin-left:-8px;':'')+'box-shadow:0 1px 3px rgba(0,0,0,0.15);"/>').join('')}</div>`:''}
            </div>
            <div class="flex items-center gap-6" style="flex-shrink:0;margin-left:8px;">
              ${badgeHTML(est)}
              ${isAdminJornada&&est!=='Jugado'&&est!=='Oficial'?`<button class="btn-outline" style="padding:4px 10px;font-size:12px;" onclick="event.stopPropagation();openModalJornada('${jn.id}')">âœï¸</button>`:''}              <span style="color:var(--muted);font-size:13px;">${isOpen?'â–²':'â–¼'}</span>
            </div></div>
          ${isOpen?`
            <div class="partida-body">
              <div class="partida-actions">
                ${est==='En Juego'&&(isAdminJornada||quienCarga==='cualquiera')?`<button class="btn-primary" onclick="event.stopPropagation();goCargar('${jn.id}')">ğŸ“‹ Cargar Resultados</button>`:''}
                ${est==='En Juego'&&!isAdminJornada&&quienCarga!=='cualquiera'?`<div style="padding:6px 10px;background:#FFF8E1;border-radius:8px;border:1px solid #FFE082;font-size:12px;color:#5D4037;line-height:1.5;">â›³ <strong>Partida en juego</strong><br/>${quienPuedeMsj}</div>`:''}
                ${est==='Planificada'?`<div class="text-11 text-muted" style="padding:4px 0;">â³ AÃºn no es el dÃ­a de juego</div>`:''}
                ${(est==='Pendiente Attest'||est==='Por Validar')&&canAttest?`<button class="btn-attest" onclick="event.stopPropagation();handleAttest('${jn.id}')">âœï¸ Marcar como Jugada</button>`:''}
                ${(est==='Pendiente Attest'||est==='Por Validar')&&!canAttest&&res.length>0?`<div class="text-11 text-muted" style="padding:4px 0;">â³ Esperando confirmaciÃ³n</div>`:''}
                ${(est==='Pendiente Attest'||est==='Por Validar')&&(isAdminJornada||canCargarThis)?`<button class="btn-outline" onclick="event.stopPropagation();goCargar('${jn.id}')">âœï¸ Editar resultados</button>`:''}
                ${isAdminJornada&&est!=='Jugado'&&est!=='Oficial'?`<button class="btn-danger" onclick="deleteJornada('${jn.id}')">ğŸ—‘ï¸ Eliminar</button>`:''}
              </div>
              ${res.length>0?`
                ${res.map(r=>{
                  const jug=getJugador(r.jugador_id);
                  const isTop=r.pos===1;
                  const isDQ=r.dq;
                  const noAsistio=!r.asistencia;
                  return`
                  <div class="result-row" style="${isTop?'background:linear-gradient(135deg,#FFFDE7,#FFF9C4);border-color:#F9A825;':''}${noAsistio?'opacity:0.6;':''}">
                    <div style="min-width:28px;text-align:center;">
                      ${r.pos<=3&&!noAsistio&&!isDQ?`<span style="font-size:20px;">${medal(r.pos)}</span>`:`<span style="background:var(--bg);border-radius:6px;padding:2px 6px;font-size:12px;font-weight:700;color:var(--muted);">${noAsistio?'â€“':isDQ?'DQ':r.pos+'Â°'}</span>`}
                    </div>
                    ${avatarHTML(jug?.foto||'?',r.pos,'sm')}
                    <div class="flex-1">
                      <div class="text-13 font-bold">${jug?.nombre||'Desconocido'}</div>
                      ${noAsistio?`<div class="text-11" style="color:var(--red);">No asistiÃ³</div>`:''}
                      ${isDQ?`<div class="text-11" style="color:var(--red);">Descalificado</div>`:''}
                    </div>
                    ${!noAsistio?`<div style="font-size:17px;font-weight:800;color:${isTop?'#B8860B':'var(--text)'};">${fmtPts(r.pts)}<span style="font-size:11px;font-weight:400;color:var(--muted);"> pts</span></div>`:''}
                  </div>`;}).join('')}
                <div style="margin-top:10px;padding:8px 12px;background:var(--cardL);border-radius:8px;font-size:11px;color:var(--muted);border:1px solid var(--border);">
                  ${cargador?`ğŸ“‹ Cargado por <strong style="color:var(--text);">${cargador.nombre}</strong>`:''}
                  ${attestador?` Â· âœï¸ Attest: <strong style="color:#7B1FA2;">${attestador.nombre}</strong>`:''}
                </div>
` 
              :`<div style="padding:20px 0;text-align:center;color:var(--muted);font-size:13px;">
                ${jn.estado==='Planificada'?'â³ Pendiente Â· Presiona "Cargar Resultados" al finalizar':'Sin resultados cargados'}
              </div>`}
              ${jn.fotos&&jn.fotos.length>0?`
              <div style="margin-top:12px;">
                <div class="text-11 text-muted font-bold" style="letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;">ğŸ“¸ Fotos del dÃ­a</div>
                <div style="position:relative;overflow:hidden;border-radius:12px;background:#111;cursor:pointer;" onclick="openCarousel('${jn.id}',0)">
                  <div id="carouselTrack_${jn.id}" style="display:flex;transition:transform 0.35s ease;">
                    ${jn.fotos.map(url=>'<img src="'+url+'" style="width:100%;flex-shrink:0;aspect-ratio:4/3;object-fit:cover;"/>').join('')}
                  </div>
                  ${jn.fotos.length>1?`
                  <button onclick="event.stopPropagation();slideCarousel('${jn.id}',-1)"
                    style="position:absolute;left:8px;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.5);border:none;color:#fff;font-size:26px;border-radius:50%;width:38px;height:38px;cursor:pointer;line-height:1;display:flex;align-items:center;justify-content:center;">&#8249;</button>
                  <button onclick="event.stopPropagation();slideCarousel('${jn.id}',1)"
                    style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.5);border:none;color:#fff;font-size:26px;border-radius:50%;width:38px;height:38px;cursor:pointer;line-height:1;display:flex;align-items:center;justify-content:center;">&#8250;</button>
                  <div style="position:absolute;bottom:6px;left:50%;transform:translateX(-50%);display:flex;gap:5px;">
                    ${jn.fotos.map((_,di)=>`<div id="dot_${jn.id}_${di}" style="width:7px;height:7px;border-radius:50%;background:${di===0?'#fff':'rgba(255,255,255,0.4)'}"></div>`).join('')}
                  </div>`:''}
                </div>
              </div>`:''}
            </div>`:``}
        </div>`;
    }).join('')}
  `;
}

function toggleJornada(id){ STATE.expandedJornada=STATE.expandedJornada===id?null:id; renderJornadas(); }

async function handleAttest(jornadaId){
  await db.collection('jornadas').doc(jornadaId).update({
    estado:'Jugado', attest_por:STATE.profile?.jugador_id||STATE.user.uid,
    attest_at:firebase.firestore.FieldValue.serverTimestamp()
  });
}
async function handleAprobar(jornadaId){
  await db.collection('jornadas').doc(jornadaId).update({
    estado:'Oficial', aprobado_por:STATE.user.uid,
    aprobado_at:firebase.firestore.FieldValue.serverTimestamp()
  });
}
async function deleteJornada(id){
  if(!confirm('Â¿Eliminar esta partida y sus resultados?'))return;
  const batch=db.batch();
  batch.delete(db.collection('jornadas').doc(id));
  STATE.resultados.filter(r=>r.jornada_id===id).forEach(r=>batch.delete(db.collection('resultados').doc(r.id)));
  await batch.commit();
}

function previewTorneoDoc(input){
  const file=input.files[0];
  if(!file)return;
  const isPDF=file.type==='application/pdf';
  const box=document.getElementById('tDocBox');
  document.getElementById('tDocLabel').textContent=isPDF?'ğŸ“„ '+file.name:'ğŸ–¼ï¸ '+file.name;
  if(!isPDF){
    const reader=new FileReader();
    reader.onload=e=>{
      document.getElementById('tDocPreview').src=e.target.result;
      document.getElementById('tDocPreview').style.display='block';
    };
    reader.readAsDataURL(file);
  }
}

function clearTorneoDoc(){
  STATE._torneoDocURL=null;
  STATE._torneoDocCleared=true;
  document.getElementById('tDocExisting').style.display='none';
  document.getElementById('tDocInput').value='';
  document.getElementById('tDocPreview').style.display='none';
  document.getElementById('tDocLabel').textContent='ğŸ“ Toca para subir PDF, imagen o reglamento';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL JORNADA â€” Crear / Editar
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModalJornada(jornadaId=null, torneoId=null){
  STATE.editingJornadaId=jornadaId;
  if(torneoId) STATE._modalTorneoId=torneoId;
  else STATE._modalTorneoId=STATE.activeTorneoId||STATE.torneo?.id||null;
  const modal=document.getElementById('modalJornada');
  const title=document.getElementById('modalJornadaTitle');
  const err=document.getElementById('modalJornadaError');
  err.style.display='none';

  // Populate club select
  const sel=document.getElementById('jornadaClub');
  sel.innerHTML=`<option value="">â€” Selecciona un club â€”</option>`+
    STATE.clubes.map(c=>`<option value="${c.nombre}">${c.nombre}</option>`).join('');

  if(jornadaId){
    title.textContent='Editar Partida';
    const jn=STATE.jornadas.find(j=>j.id===jornadaId);
    if(jn){
      document.getElementById('jornadaClub').value=jn.sede||'';
      document.getElementById('jornadaFecha').value=jn.fecha||'';
      // estado managed automatically
      document.getElementById('jornadaNotas').value=jn.notas||'';
      const tParts=(jn.teeTime||'').split(':');
      if(document.getElementById('teeHH')) document.getElementById('teeHH').value=tParts[0]||'07';
      if(document.getElementById('teeMM')) document.getElementById('teeMM').value=tParts[1]||'00';
    }
  } else {
    title.textContent='Nueva Partida';
    document.getElementById('jornadaClub').value='';
    document.getElementById('jornadaFecha').value='';
    // estado is automatic
    document.getElementById('jornadaNotas').value='';
    if(document.getElementById('teeHH')) document.getElementById('teeHH').value='07';
    if(document.getElementById('teeMM')) document.getElementById('teeMM').value='00';
  }
  modal.style.display='flex';
}


function resetJornadaFotoSlot(i){
  const slot=document.getElementById('jornadaFotoSlot'+i);
  if(!slot)return;
  slot.innerHTML=`
    <div class="photo-upload-box" style="height:80px;padding:8px;" onclick="document.getElementById('jornadaFotoInput${i}').click()">
      <div style="font-size:22px;">ğŸ“·</div>
      <div style="font-size:10px;color:var(--muted);">Foto ${i+1}</div>
      <input type="file" id="jornadaFotoInput${i}" accept="image/*" onchange="previewJornadaFoto(this,${i})"/>
    </div>`.replace(/\${i}/g,i).replace(/\${i\+1}/g,i+1);
}

function setJornadaFotoSlot(i,url){
  const slot=document.getElementById('jornadaFotoSlot'+i);
  if(!slot)return;
  slot.innerHTML=`
    <img src="${url}" style="width:100%;height:80px;object-fit:cover;border-radius:8px;border:1px solid var(--border);"/>
    <button class="del-photo" onclick="delJornadaFoto(${i})">âœ•</button>`;
}

function previewJornadaFoto(input,i){
  const file=input.files[0];
  if(!file)return;
  // Store the File object so saveResultados can access it even after DOM changes
  if(!STATE._jornadaFotoFiles) STATE._jornadaFotoFiles=[null,null,null];
  STATE._jornadaFotoFiles[i]=file;
  const reader=new FileReader();
  reader.onload=e=>{
    const slot=document.getElementById('jornadaFotoSlot'+i);
    if(!slot)return;
    // Show preview image + delete btn, keep hidden input alive for re-selection
    slot.innerHTML='<div style="position:relative;width:100%;height:80px;">'
      +'<img src="'+e.target.result+'" style="width:100%;height:80px;object-fit:cover;border-radius:8px;border:1px solid var(--border);"/>'
      +'<button class="del-photo" onclick="delJornadaFoto('+i+')" style="position:absolute;top:2px;right:2px;">âœ•</button>'
      +'<input type="file" id="jornadaFotoInput'+i+'" accept="image/*" style="position:absolute;inset:0;opacity:0;cursor:pointer;" onchange="previewJornadaFoto(this,'+i+')">'
      +'</div>';
  };
  reader.readAsDataURL(file);
}

function delJornadaFoto(i){
  if(STATE._jornadaFotosExistentes) STATE._jornadaFotosExistentes[i]=null;
  if(STATE._jornadaFotoFiles) STATE._jornadaFotoFiles[i]=null;
  resetJornadaFotoSlot(i);
}

function closeModalJornada(event){
  if(event&&event.currentTarget!==event.target)return;
  document.getElementById('modalJornada').style.display='none';
  STATE.editingJornadaId=null;
}

async function saveJornada(){
  const club=document.getElementById('jornadaClub').value.trim();
  const fecha=document.getElementById('jornadaFecha').value;
  // Estado is automatic â€” read from existing partida when editing, or 'Planificada' for new
  const _existingJornada=STATE.editingJornadaId?STATE.jornadas.find(j=>j.id===STATE.editingJornadaId):null;
  const estado=_existingJornada?.estado||'Planificada';
  const notas=document.getElementById('jornadaNotas').value.trim();
  const teeHH=document.getElementById('teeHH')?.value||'';
  const teeMM=document.getElementById('teeMM')?.value||'00';
  const teeTime=teeHH?(teeHH+':'+teeMM):'';
  const cuentaRanking=document.getElementById('jornadaCuentaRanking')?.checked!==false;
  const tieneReglasEsp=document.getElementById('jornadaReglasEspeciales')?.checked||false;
  const reglasOverride=tieneReglasEsp?{
    puntos:{
      1:Number(document.getElementById('jrPts1')?.value)||4,
      2:Number(document.getElementById('jrPts2')?.value)||3,
      3:Number(document.getElementById('jrPts3')?.value)||2,
      resto:Number(document.getElementById('jrPtsResto')?.value)||1,
    },
    bonusAsistencia:Number(document.getElementById('jrBonus')?.value)||0,
    penalNoAsistencia:Number(document.getElementById('jrPenalNoAsist')?.value)||0,
    penalDQ:Number(document.getElementById('jrPenalDQ')?.value)||0,
  }:null;
  const err=document.getElementById('modalJornadaError');
  const btn=document.getElementById('btnGuardarJornada');
  err.style.display='none';

  if(!club){err.textContent='Selecciona un club.';err.style.display='block';return;}
  if(!fecha){err.textContent='La fecha es obligatoria.';err.style.display='block';return;}

  btn.disabled=true; btn.textContent='Guardando...';
  try{
    // Upload new photos (slots with new files)
    let fotos=[...(STATE._jornadaFotosExistentes||[])];
    for(let i=0;i<3;i++){
      const fi=document.getElementById('jornadaFotoInput'+i);
      if(fi&&fi.files&&fi.files[0]){
        const jid=STATE.editingJornadaId||'new_'+Date.now();
        const compressed=await resizeAndCompress(fi.files[0],1200,0.82);
        const url=await uploadPhoto(compressed,`jornadas/${jid}_foto${i}.jpg`,'jornadaFotoProgress');
        fotos[i]=url;
      }
    }
    fotos=fotos.filter(Boolean);

    if(STATE.editingJornadaId){
      await db.collection('jornadas').doc(STATE.editingJornadaId).update({
        sede:club, fecha, estado, notas, teeTime, fotos, cuentaRanking,
        ...(reglasOverride?{reglasOverride}:{reglasOverride:null}),
        updated_at:firebase.firestore.FieldValue.serverTimestamp()
      });
    } else {
      const numero=(STATE.jornadas.length>0?Math.max(...STATE.jornadas.map(j=>j.numero||0)):0)+1;
      const torneoIdParaJornada=STATE._modalTorneoId||STATE.activeTorneoId||STATE.torneo?.id||'';
      await db.collection('jornadas').add({
        numero, nombre:`J${numero}`, sede:club, fecha, estado, notas, teeTime, fotos,
        cuentaRanking, ...(reglasOverride?{reglasOverride}:{}),
        torneo_id:torneoIdParaJornada,
        creado:firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    document.getElementById('modalJornada').style.display='none';
    STATE.editingJornadaId=null;
  } catch(e){
    err.textContent='Error al guardar: '+e.message; err.style.display='block';
  } finally{ btn.disabled=false; btn.textContent='Guardar Partida'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLUBES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editingClubId=null;

function renderClubes(){
  const el=document.getElementById('tab-clubes');
  const isAdmin=STATE.profile?.role==='admin';
  el.innerHTML=`
    ${isAdmin?`<div style="display:flex;justify-content:flex-end;margin-bottom:16px;">
      <button class="btn-green" onclick="openModalClub()">+ Agregar Club</button>
    </div>`:''}
    ${STATE.clubes.length===0?`<div class="card"><div class="card-body" style="text-align:center;color:var(--muted);padding:40px;">No hay clubes registrados.</div></div>`:''}
    <div style="display:flex;flex-direction:column;gap:10px;">
      ${STATE.clubes.map(club=>{
        const bg=club.color||'#2E7D5E';
        const ini=club.iniciales||club.nombre.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,3);
        const avatarEl=club.fotoURL
          ?`<img src="${club.fotoURL}" style="width:44px;height:44px;border-radius:10px;object-fit:cover;flex-shrink:0;border:1px solid var(--border);"/>`
          :`<div style="width:44px;height:44px;border-radius:10px;background:${bg};display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:13px;flex-shrink:0;">${ini}</div>`;
        return`
        <div class="card" style="margin-bottom:0;">
          <div style="padding:14px 18px;display:flex;align-items:center;gap:14px;">
            ${avatarEl}
            <div class="flex-1">
              <div class="text-14 font-bold">${club.nombre}</div>
              <div class="text-12 text-muted">${club.ciudad||'â€”'}</div>
            </div>
            ${isAdmin?`
              <button class="btn-outline" style="padding:5px 12px;font-size:12px;" onclick="openModalClub('${club.id}')">âœï¸ Editar</button>
              <button class="btn-danger" onclick="deleteClub('${club.id}','${club.nombre}')">Eliminar</button>
            `:''}
          </div>
        </div>`}).join('')}
    </div>
  `;
}

function openModalClub(clubId=null){
  editingClubId=clubId;
  document.getElementById('modalClubError').style.display='none';
  if(clubId){
    document.getElementById('modalClubTitle').textContent='Editar Club';
    const club=STATE.clubes.find(c=>c.id===clubId);
    if(club){
      document.getElementById('clubNombre').value=club.nombre||'';
      document.getElementById('clubCiudad').value=club.ciudad||'';
      document.getElementById('clubIniciales').value=club.iniciales||'';
      document.getElementById('clubColor').value=club.color||'#2E7D5E';
    }
  } else {
    document.getElementById('modalClubTitle').textContent='Nuevo Club';
    document.getElementById('clubNombre').value='';
    document.getElementById('clubCiudad').value='';
    document.getElementById('clubIniciales').value='';
    document.getElementById('clubColor').value='#2E7D5E';
  }
  document.getElementById('modalClub').style.display='flex';
}

function closeModalClub(){ document.getElementById('modalClub').style.display='none'; editingClubId=null; }

async function saveClub(){
  const nombre=document.getElementById('clubNombre').value.trim();
  const ciudad=document.getElementById('clubCiudad').value.trim();
  const iniciales=document.getElementById('clubIniciales').value.trim().toUpperCase().slice(0,3);
  const color=document.getElementById('clubColor').value;
  const err=document.getElementById('modalClubError');
  const btn=document.getElementById('btnGuardarClub');
  if(!nombre){err.textContent='El nombre es obligatorio.';err.style.display='block';return;}
  btn.disabled=true; btn.textContent='Guardando...';
  try{
    const ini=iniciales||nombre.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,3);
    const data={nombre,ciudad,iniciales:ini,color};
    // Upload photo if selected
    const fileInput=document.getElementById('clubFotoInput');
    if(fileInput.files&&fileInput.files[0]){
      const compressed=await resizeAndCompress(fileInput.files[0],800);
      const path='clubes/'+(editingClubId||Date.now())+'.jpg';
      data.fotoURL=await uploadPhoto(compressed,path,'clubFotoProgress');
    }
    if(editingClubId){
      data.updated_at=firebase.firestore.FieldValue.serverTimestamp();
      await db.collection('clubes').doc(editingClubId).update(data);
    } else {
      data.creado=firebase.firestore.FieldValue.serverTimestamp();
      await db.collection('clubes').add(data);
    }
    closeModalClub();
  }catch(e){err.textContent='Error: '+e.message;err.style.display='block';}
  finally{btn.disabled=false;btn.textContent='Guardar Club';}
}

async function deleteClub(id,nombre){
  if(!confirm(`Â¿Eliminar el club "${nombre}"?`))return;
  await db.collection('clubes').doc(id).delete();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARGAR RESULTADOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cargarEntries=[];

// â”€â”€ CARGAR STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let cargarStep=1; // 1=participantes, 2=posiciones
let cargarParticipantes=[]; // {jugador_id, jugador, asistio, dq}
let cargarPosiciones=[];    // [{pos, jugador_id, empate}] ordered list

function renderCargar(){
  const el=document.getElementById('tab-cargar');
  const jornadaId=STATE.cargarJornadaId;
  const partida=STATE.jornadas.find(j=>j.id===jornadaId);
  if(!partida){el.innerHTML='<p style="color:var(--muted);padding:20px;">Partida no encontrada.</p>';return;}

  // Init participantes if first load
  if(cargarParticipantes.length===0||cargarParticipantes[0]?._jid!==jornadaId){
    const existentes=STATE.resultados.filter(r=>r.jornada_id===jornadaId);
    // Use participants of the jornada's own torneo
    const jornadaTorneo=partida?.torneo_id||STATE.activeTorneoId;
    const jugsParaCargar=getJugadoresTorneo(jornadaTorneo).filter(j=>j.activo!==false);
    cargarParticipantes=jugsParaCargar.map(j=>{
      const ex=existentes.find(r=>r.jugador_id===j.id);
      return{_jid:jornadaId,jugador_id:j.id,jugador:j,asistio:ex?ex.asistencia!==false:true,dq:ex?.dq||false};
    });
    // Init posiciones from existing results if any
    if(existentes.length>0){
      const sorted=[...existentes].filter(r=>r.asistencia!==false).sort((a,b)=>a.pos-b.pos);
      cargarPosiciones=sorted.map(r=>({pos:r.pos,jugador_id:r.jugador_id,empate:false}));
    } else {
      cargarPosiciones=[];
    }
    cargarStep=1;
  }

  const header=`
    <div class="flex items-center gap-8 mb-16">
      <button class="btn-back" onclick="backFromCargar()">â†</button>
      <div>
        <div class="text-15 font-bold font-georgia">${partida.sede} â€” ${fmtFecha(partida.fecha)}</div>
        <div class="text-12 text-muted">${badgeHTML(partida.estado)}</div>
      </div>
    </div>
    <div class="info-attest">âœï¸ TÃº cargas â†’ otro jugador confirma (Attest) â†’ Admin aprueba como Oficial.</div>`;

  if(cargarStep===1){
    // â”€â”€ STEP 1: Participantes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    el.innerHTML=header+`
    <div class="card mb-16">
      <div class="card-header">
        <span class="card-title">1ï¸âƒ£ Participantes</span>
        <span class="text-11 text-muted">Desmarca quien no asistiÃ³</span>
      </div>
      ${cargarParticipantes.map(p=>`
        <div class="cargar-row" style="gap:10px;">
          ${p.jugador.fotoURL?`<img src="${p.jugador.fotoURL}" style="width:36px;height:36px;border-radius:50%;object-fit:cover;flex-shrink:0;"/>`:avatarHTML(p.jugador.foto,99,'sm')}
          <div style="flex:1;">
            <div class="text-13 font-bold">${p.jugador.nombre}</div>
            <div class="text-11 text-muted">${p.jugador.alias||''}</div>
          </div>
          <label style="display:flex;align-items:center;gap:5px;font-size:12px;cursor:pointer;">
            <input type="checkbox" ${p.asistio?'checked':''} style="width:16px;height:16px;accent-color:var(--green);"
              onchange="toggleParticipante('${p.jugador_id}','asistio',this.checked)"/>
            <span>JugÃ³</span>
          </label>
          <label style="display:flex;align-items:center;gap:5px;font-size:12px;cursor:pointer;${p.asistio?'':'opacity:0.4;pointer-events:none;'}">
            <input type="checkbox" ${p.dq?'checked':''} style="width:16px;height:16px;accent-color:var(--red);"
              ${p.asistio?'':'disabled'}
              onchange="toggleParticipante('${p.jugador_id}','dq',this.checked)"/>
            <span style="color:var(--red);">DQ</span>
          </label>
        </div>`).join('')}
    </div>
    <button class="btn-save" onclick="goCargarStep2()">Continuar â†’ Asignar Posiciones</button>`;
  } else {
    // â”€â”€ STEP 2: Posiciones â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const asistentes=cargarParticipantes.filter(p=>p.asistio&&!p.dq);
    if(cargarPosiciones.length===0){
      // Start with ONE empty row
      cargarPosiciones=[{pos:1,jugador_id:'',empate:false}];
    }

    // Build set of already-used jugador_ids (one per row)
    const usados=new Set(cargarPosiciones.map(r=>r.jugador_id).filter(Boolean));
    const sinAsignar=asistentes.filter(p=>!usados.has(p.jugador_id));
    const totalAsistentes=asistentes.length;
    const totalAsignados=cargarPosiciones.filter(r=>r.jugador_id).length;
    const todoAsignado=totalAsignados>=totalAsistentes;

    el.innerHTML=header+`
    <div class="info-attest" style="background:#E3F2FD;border-color:#90CAF9;color:#1565C0;">
      ğŸ“‹ Asigna las posiciones de los <strong>${totalAsistentes}</strong> jugadores que participaron.
      ${todoAsignado?'<strong>âœ… Todos asignados</strong>':`Faltan <strong>${totalAsistentes-totalAsignados}</strong>`}
    </div>
    <div class="card mb-16">
      <div class="card-header">
        <span class="card-title">2ï¸âƒ£ Posiciones</span>
        <button class="btn-outline" style="font-size:11px;padding:4px 10px;" onclick="cargarStep=1;renderCargar()">â† Volver</button>
      </div>
      <div style="padding:14px 16px;display:flex;flex-direction:column;gap:10px;">
        ${(()=>{
          return cargarPosiciones.map((row,idx)=>{
            const otherUsed=new Set(cargarPosiciones.filter((_,i)=>i!==idx).map(r=>r.jugador_id).filter(Boolean));
            const opts=asistentes
              .filter(p=>!otherUsed.has(p.jugador_id)||p.jugador_id===row.jugador_id)
              .map(p=>'<option value="'+p.jugador_id+'" '+(row.jugador_id===p.jugador_id?'selected':'')+'>'+p.jugador.nombre+'</option>').join('');
            const nextSamePos=!!(cargarPosiciones[idx+1]&&cargarPosiciones[idx+1].pos===row.pos);
            const posBg=row.pos===1?'var(--gold)':row.pos===2?'#78909C':row.pos===3?'#8D6E63':'var(--green)';
            return '<div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--cardL);border-radius:10px;border:1px solid var(--border);">'+
              '<div style="width:36px;height:36px;border-radius:8px;background:'+posBg+';flex-shrink:0;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:13px;">'+row.pos+'\u00b0</div>'+
              '<select class="form-select" style="flex:1;" onchange="setPosJugador('+idx+',this.value)">'+
                '<option value="">â€” Seleccionar â€”</option>'+opts+
              '</select>'+
              '<label style="display:flex;align-items:center;gap:4px;font-size:11px;white-space:nowrap;cursor:pointer;">'+
                '<input type="checkbox" '+(nextSamePos?'checked':'')+' style="accent-color:var(--blue);" onchange="toggleEmpate('+idx+',this.checked)"/> Empate'+
              '</label>'+
              '<button onclick="removePosRow('+idx+')" style="background:none;border:none;color:var(--muted);font-size:16px;cursor:pointer;">\u2715</button>'+
            '</div>';
          }).join('');
        })()}

      </div>
    </div>

    <!-- FOTOS -->
    <div class="card mb-16" style="padding:16px;">
      <div class="card-header" style="margin-bottom:12px;"><span class="card-title">ğŸ“· Fotos del dÃ­a (mÃ¡x 3)</span></div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;" id="jornadaFotoGrid">
        <div class="photo-upload-box" style="height:80px;padding:8px;" id="jornadaFotoSlot0" onclick="document.getElementById('jornadaFotoInput0').click()">
          <div style="font-size:22px;">ğŸ“·</div><div style="font-size:10px;color:var(--muted);">Foto 1</div>
          <input type="file" id="jornadaFotoInput0" accept="image/*" style="display:none;" onchange="previewJornadaFoto(this,0)"/>
        </div>
        <div class="photo-upload-box" style="height:80px;padding:8px;" id="jornadaFotoSlot1" onclick="document.getElementById('jornadaFotoInput1').click()">
          <div style="font-size:22px;">ğŸ“·</div><div style="font-size:10px;color:var(--muted);">Foto 2</div>
          <input type="file" id="jornadaFotoInput1" accept="image/*" style="display:none;" onchange="previewJornadaFoto(this,1)"/>
        </div>
        <div class="photo-upload-box" style="height:80px;padding:8px;" id="jornadaFotoSlot2" onclick="document.getElementById('jornadaFotoInput2').click()">
          <div style="font-size:22px;">ğŸ“·</div><div style="font-size:10px;color:var(--muted);">Foto 3</div>
          <input type="file" id="jornadaFotoInput2" accept="image/*" style="display:none;" onchange="previewJornadaFoto(this,2)"/>
        </div>
      </div>
      <div class="upload-progress" style="margin-top:8px;"><div class="upload-progress-bar" id="jornadaFotoProgress"></div></div>
    </div>

    <div id="cargarError" class="error-box" style="display:none;"></div>
    <button class="btn-save" id="btnSave" onclick="saveResultados()">ğŸ’¾ Guardar y Enviar a Attest</button>`;
  }
}

function toggleParticipante(jugadorId,field,value){
  const p=cargarParticipantes.find(p=>p.jugador_id===jugadorId);
  if(!p)return;
  p[field]=value;
  if(field==='asistio'&&!value) p.dq=false;
  renderCargar();
}

function goCargarStep2(){
  cargarStep=2;
  cargarPosiciones=[];
  STATE._jornadaFotoFiles=[null,null,null];  // reset file refs on step2
  renderCargar();
  // Initialize foto slots immediately after render (DOM is ready)
  const jn=STATE.jornadas.find(j=>j.id===STATE.cargarJornadaId);
  const fotos=jn?.fotos||[];
  STATE._jornadaFotosExistentes=[...fotos];
  [0,1,2].forEach(i=>{ if(fotos[i]) setJornadaFotoSlot(i,fotos[i]); else resetJornadaFotoSlot(i); });
}

function setPosJugador(idx,jugadorId){
  if(!cargarPosiciones[idx]) return;
  cargarPosiciones[idx].jugador_id=jugadorId;
  // Auto-add next row if players still unassigned and no empty row waiting
  if(jugadorId){
    const asistentes=cargarParticipantes.filter(p=>p.asistio&&!p.dq);
    const usados=new Set(cargarPosiciones.map(r=>r.jugador_id).filter(Boolean));
    const hayPendientes=asistentes.some(p=>!usados.has(p.jugador_id));
    const lastIsEmpty=!cargarPosiciones[cargarPosiciones.length-1]?.jugador_id;
    if(hayPendientes && !lastIsEmpty){ addPosRow(); return; }
  }
  renderCargar();
}

function toggleEmpate(idx,checked){
  if(checked){
    const samePos=cargarPosiciones[idx].pos;
    // Insert empty row with SAME position right after
    cargarPosiciones.splice(idx+1,0,{pos:samePos,jugador_id:'',empate:true});
    // Subsequent rows: shift pos by 1 each (one extra player consumed this position)
    for(let i=idx+2;i<cargarPosiciones.length;i++) cargarPosiciones[i].pos++;
  } else {
    // Remove next row with same pos ONLY if it was added as empate
    if(cargarPosiciones[idx+1]&&cargarPosiciones[idx+1].pos===cargarPosiciones[idx].pos&&cargarPosiciones[idx+1].empate){
      const hadPlayer=!!cargarPosiciones[idx+1].jugador_id;
      cargarPosiciones.splice(idx+1,1);
      if(hadPlayer){
        // Restore subsequent positions
        for(let i=idx+1;i<cargarPosiciones.length;i++) cargarPosiciones[i].pos--;
      }
    }
  }
  renderCargar();
}

function addPosRow(){
  const last=cargarPosiciones[cargarPosiciones.length-1];
  // Next position = last pos + number of players at last pos (to account for empates)
  const sameAsLast=cargarPosiciones.filter(r=>r.pos===last?.pos).length;
  const nextPos=last?(last.pos+sameAsLast):1;
  cargarPosiciones.push({pos:nextPos,jugador_id:'',empate:false});
  renderCargar();
}

function removePosRow(idx){
  cargarPosiciones.splice(idx,1);
  // Recalculate positions
  let curPos=1;
  for(let i=0;i<cargarPosiciones.length;i++){
    if(i>0&&cargarPosiciones[i].pos===cargarPosiciones[i-1].pos){
      // keep same pos (empate)
    } else {
      cargarPosiciones[i].pos=curPos;
    }
    curPos=cargarPosiciones[i].pos+1;
  }
  renderCargar();
}

// Legacy updateEntry kept for backward compat
function updateEntry(jugadorId,field,value){ toggleParticipante(jugadorId,field,value); }

async function saveResultados(){
  const jornadaId=STATE.cargarJornadaId;
  const btn=document.getElementById('btnSave');
  const err=document.getElementById('cargarError');
  err.style.display='none';
  // Validate all asistentes have a position assigned
  const asistentesActivos=cargarParticipantes.filter(p=>p.asistio&&!p.dq);
  const asignadosIds=new Set(cargarPosiciones.filter(r=>r.jugador_id).map(r=>r.jugador_id));
  const sinPos=asistentesActivos.filter(p=>!asignadosIds.has(p.jugador_id));
  if(sinPos.length>0){
    err.textContent='Faltan posiciones para: '+sinPos.map(p=>p.jugador.nombre).join(', ');
    err.style.display='block'; return;
  }
  btn.disabled=true; btn.textContent='Guardando...';
  try{
    // Upload fotos â€” use stored File refs (DOM input loses files after innerHTML replace)
    let fotos=[...(STATE._jornadaFotosExistentes||[])];
    const fotoFiles=STATE._jornadaFotoFiles||[null,null,null];
    for(let i=0;i<3;i++){
      const file=fotoFiles[i];
      if(file){
        try{
          const compressed=await resizeAndCompress(file,1200,0.82);
          const url=await uploadPhoto(compressed,'jornadas/'+jornadaId+'_foto'+i+'.jpg','jornadaFotoProgress');
          fotos[i]=url;
          console.log('Foto '+i+' uploaded OK:', url.substring(0,60));
        }catch(uploadErr){
          console.error('Foto '+i+' upload failed:', uploadErr);
        }
      }
    }
    fotos=fotos.filter(Boolean);
    console.log('Total fotos to save:', fotos.length, fotos);

    const batch=db.batch();
    // Build results from new cargar model
    const partida=STATE.jornadas.find(j=>j.id===jornadaId);
    const torneoId=partida?.torneo_id||STATE.activeTorneoId||STATE.torneo?.id;
    const _baseReglas=getReglas(torneoId);
    const reglas=partida?.reglasOverride?Object.assign({},_baseReglas,{
      puntos:partida.reglasOverride.puntos||_baseReglas.puntos,
      bonusAsistencia:partida.reglasOverride.bonusAsistencia!=null?partida.reglasOverride.bonusAsistencia:_baseReglas.bonusAsistencia,
      penalNoAsistencia:partida.reglasOverride.penalNoAsistencia!=null?partida.reglasOverride.penalNoAsistencia:_baseReglas.penalNoAsistencia,
      penalDQ:partida.reglasOverride.penalDQ!=null?partida.reglasOverride.penalDQ:_baseReglas.penalDQ
    }):_baseReglas;

    // Merge participantes + posiciones
    cargarParticipantes.forEach(p=>{
      const posRow=cargarPosiciones.find(r=>r.jugador_id===p.jugador_id);
      const pos=posRow?.pos||99;
      // Calculate pts with empate logic
      const groupSize=cargarPosiciones.filter(r=>r.pos===pos).length;
      let basePts=0;
      if(p.asistio&&!p.dq){
        if(reglas.empates==='comparten'&&groupSize>1){
          let sum=0;
          for(let k=0;k<groupSize;k++) sum+=getPtsPosicion(pos+k,reglas);
          basePts=Math.round((sum/groupSize)*100)/100;
        } else {
          basePts=getPtsPosicion(pos,reglas);
        }
        basePts+=(reglas.bonusAsistencia||0);
        if(p.dq) basePts+=(reglas.penalDQ||0);
      } else if(!p.asistio){
        basePts=reglas.penalNoAsistencia||0;
      }
      batch.set(db.collection('resultados').doc(`${jornadaId}_${p.jugador_id}`),{
        jornada_id:jornadaId,jugador_id:p.jugador_id,
        pos:p.asistio?pos:99,pts:basePts,
        asistencia:p.asistio,dq:p.dq||false,
        cargado_por:STATE.profile?.jugador_id||STATE.user?.email,
        updated_at:firebase.firestore.FieldValue.serverTimestamp()
      });
    });
    batch.update(db.collection('jornadas').doc(jornadaId),{
      estado:'Pendiente Attest',cargado_por:STATE.profile?.jugador_id||null,
      cargado_at:firebase.firestore.FieldValue.serverTimestamp(),
      ...(fotos.length?{fotos}:{})
    });
    await batch.commit();
    cargarEntries=[];
    cargarParticipantes=[]; cargarPosiciones=[]; cargarStep=1;
    // Update local fotos in STATE immediately
    if(fotos.length){
      const jnIdx=STATE.jornadas.findIndex(j=>j.id===jornadaId);
      if(jnIdx>-1) STATE.jornadas[jnIdx]={...STATE.jornadas[jnIdx],fotos};
    }
    STATE.expandedJornada=jornadaId;
    goTab('jornadas');
  }catch(e){
    err.textContent='Error: '+e.message; err.style.display='block';
    btn.disabled=false; btn.textContent='ğŸ’¾ Guardar y Enviar a Attest';
  }
}
function backFromCargar(){
  cargarEntries=[]; cargarParticipantes=[]; cargarPosiciones=[]; cargarStep=1;
  const ct=document.getElementById('tab-cargar'); if(ct) ct.style.display='none';
  goTab('jornadas');
}

// â”€â”€ Carousel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const carouselIdx={};
function slideCarousel(jid,dir){
  const track=document.getElementById('carouselTrack_'+jid);
  if(!track) return;
  const n=track.querySelectorAll('img').length;
  carouselIdx[jid]=((carouselIdx[jid]||0)+dir+n)%n;
  track.style.transform='translateX(-'+(carouselIdx[jid]*100)+'%)';
  for(let i=0;i<n;i++){
    const dot=document.getElementById('dot_'+jid+'_'+i);
    if(dot) dot.style.background=i===carouselIdx[jid]?'#fff':'rgba(255,255,255,0.45)';
  }
}
function openCarousel(jid,startIdx){
  const jn=STATE.jornadas.find(j=>j.id===jid);
  if(!jn||!jn.fotos||!jn.fotos.length) return;
  let cur=startIdx||carouselIdx[jid]||0;
  const n=jn.fotos.length;
  const ov=document.createElement('div');
  ov.id='lightbox';
  ov.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.96);z-index:9999;display:flex;align-items:center;justify-content:center;';
  ov.onclick=function(e){if(e.target===ov)ov.remove();};
  function renderLB(){
    // Build lightbox content without nested quote issues
    const img=document.createElement('img');
    img.src=jn.fotos[cur];
    img.style.cssText='max-width:95vw;max-height:88vh;object-fit:contain;border-radius:8px;user-select:none;';
    ov.innerHTML='';
    ov.appendChild(img);
    // Counter
    const ctr=document.createElement('div');
    ctr.style.cssText='position:absolute;bottom:18px;left:50%;transform:translateX(-50%);color:rgba(255,255,255,0.7);font-size:13px;';
    ctr.textContent=(cur+1)+' / '+n;
    ov.appendChild(ctr);
    // Close button
    const closeBtn=document.createElement('button');
    closeBtn.textContent='âœ•';
    closeBtn.style.cssText='position:absolute;top:14px;right:14px;background:rgba(255,255,255,0.15);border:none;color:#fff;font-size:22px;border-radius:50%;width:42px;height:42px;cursor:pointer;display:flex;align-items:center;justify-content:center;';
    closeBtn.onclick=function(){ov.remove();};
    ov.appendChild(closeBtn);
    // Nav buttons
    if(n>1){
      const prev=document.createElement('button');
      prev.innerHTML='&#8249;';
      prev.style.cssText='position:absolute;left:12px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.15);border:none;color:#fff;font-size:36px;border-radius:50%;width:52px;height:52px;cursor:pointer;display:flex;align-items:center;justify-content:center;';
      prev.onclick=function(e){e.stopPropagation();cur=(cur-1+n)%n;renderLB();};
      ov.appendChild(prev);
      const next=document.createElement('button');
      next.innerHTML='&#8250;';
      next.style.cssText='position:absolute;right:12px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.15);border:none;color:#fff;font-size:36px;border-radius:50%;width:52px;height:52px;cursor:pointer;display:flex;align-items:center;justify-content:center;';
      next.onclick=function(e){e.stopPropagation();cur=(cur+1)%n;renderLB();};
      ov.appendChild(next);
    }
  }
  renderLB();
  document.body.appendChild(ov);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JUGADORES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let showAddJugador=false;
let editingJugadorId=null;

function renderJugadores(){
  const el=document.getElementById('tab-jugadores');
  const myJugadorId=STATE.profile?.jugador_id;
  const uid=STATE.user?.uid;

  const todosLosTorneos=STATE.torneos;

  if(todosLosTorneos.length===0){
    el.innerHTML=`<div style="text-align:center;padding:40px 20px;color:var(--muted);">
      <div style="font-size:40px;margin-bottom:12px;">ğŸ†</div>
      <div style="font-size:15px;font-weight:600;">No hay torneos disponibles</div>
    </div>`;
    return;
  }

  // Own expanded state â€” independent from Mis Torneos tab
  if(!STATE._expandedJugTorneo && todosLosTorneos.length>0){
    STATE._expandedJugTorneo=STATE.activeTorneoId||todosLosTorneos[0].id;
  }

  // Render one card per torneo
  el.innerHTML=`<div style="display:flex;flex-direction:column;gap:16px;">
    ${todosLosTorneos.map(t=>{
      const canManage=isTorneoAdmin(t);
      const isExpanded=t.id===STATE._expandedJugTorneo;
      // Same source as calcRankingTorneo â€” participantes subcollection
      const allJugadores=getJugadoresTorneo(t.id);
      const jugadoresActivos=allJugadores.filter(j=>j.activo!==false);
      const jugadoresEliminados=allJugadores.filter(j=>j.activo===false||j.eliminado===true);
      const jugadoresHTML=[...jugadoresActivos,...jugadoresEliminados].map(j=>{
        const isMe=j.id===myJugadorId||j.jugador_id===myJugadorId||j.user_uid===uid;
        const isElim=j.activo===false||j.eliminado===true;
        const initials=j.foto||j.alias?.slice(0,2)||j.nombre?.slice(0,2)||'?';
        return `<div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);${isElim?'opacity:0.5;':''}">
          ${j.fotoURL
            ?`<img src="${j.fotoURL}" style="width:36px;height:36px;border-radius:50%;object-fit:cover;flex-shrink:0;${isElim?'filter:grayscale(1);':''}"/>`
            :`<div style="width:36px;height:36px;border-radius:50%;background:${isElim?'var(--muted)':'var(--green)'};color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0;">${initials}</div>`}
          <div style="flex:1;min-width:0;">
            <div style="font-weight:700;font-size:13px;${isElim?'text-decoration:line-through;color:var(--muted);':''}">${j.nombre||''}${isMe?` <span style="font-size:10px;background:#E8F5E9;color:#2E7D32;padding:1px 5px;border-radius:6px;">TÃº</span>`:''}${isElim?` <span style="font-size:10px;background:#FFEBEE;color:#C62828;padding:1px 5px;border-radius:6px;">Eliminado</span>`:''}</div>
            <div style="font-size:11px;color:var(--muted);">
              ${j.alias&&j.alias!==j.nombre?`@${j.alias}`:''} ${j.telefonoCompleto?'Â· '+j.telefonoCompleto:''}
            </div>
            ${canManage?`<div style="margin-top:4px;display:flex;align-items:center;gap:6px;flex-wrap:wrap;">${
              j.invite_code&&!j.user_uid
              ?`<span style="background:#E8F5E9;color:#2E7D32;font-size:10px;font-weight:700;padding:2px 6px;border-radius:5px;font-family:monospace;">ğŸ”‘ ${j.invite_code}</span><button onclick="enviarInvitacionWA('${(j.nombre||'').replace(/'/g,"\\'")}','${j.invite_code}','${j.telefonoCompleto||''}',event)" style="background:#25D366;color:#fff;border:none;border-radius:5px;padding:2px 8px;font-size:10px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:3px;"><svg width="12" height="12" viewBox="0 0 24 24" fill="white"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 2C6.477 2 2 6.477 2 12c0 1.89.525 3.66 1.438 5.168L2 22l4.832-1.438A9.955 9.955 0 0012 22c5.523 0 10-4.477 10-10S17.523 2 12 2zm0 18c-1.657 0-3.216-.5-4.51-1.348l-.324-.194-2.866.852.852-2.866-.194-.324A7.963 7.963 0 014 12c0-4.411 3.589-8 8-8s8 3.589 8 8-3.589 8-8 8z"/></svg> Invitar</button>`
              :j.user_uid
              ?`<span style="background:#E3F2FD;color:#1565C0;font-size:10px;padding:2px 6px;border-radius:5px;">âœ… Con cuenta</span>`
              :''
            }</div>`:''}
          </div>
          ${canManage&&!isElim?`<button onclick="removeParticipante('${j.id}','${(j.nombre||'').replace(/'/g,"\\'")}','${t.id}',event)"
            style="background:none;border:1px solid var(--border);border-radius:6px;padding:3px 8px;color:var(--muted);font-size:12px;cursor:pointer;">âœ•</button>`:''}
          ${canManage&&isElim?`<button onclick="reactivarParticipante('${j.id}','${t.id}',event)"
            style="background:none;border:1px solid #A5D6A7;border-radius:6px;padding:3px 8px;color:var(--green);font-size:11px;cursor:pointer;font-weight:600;">â†© Restaurar</button>`:''}
        </div>`;
      }).join('');

      return `<div class="card" style="${isExpanded?'border:2px solid var(--green);':''}">
        <div style="padding:14px 16px;">
          <!-- Header del torneo -->
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;cursor:pointer;" onclick="toggleJugadoresTorneo('${t.id}')">
            <div>
              <div style="font-size:13px;font-weight:800;color:var(--green);">${t.nombre}</div>
              <div style="font-size:11px;color:var(--muted);">${jugadoresActivos.length} participante${jugadoresActivos.length!==1?'s':''}${jugadoresEliminados.length>0?` Â· ${jugadoresEliminados.length} eliminado${jugadoresEliminados.length!==1?'s':''}`:''}${isExpanded?'':' Â· Toca para ver'}</div>
            </div>
            <span style="font-size:12px;color:var(--muted);">${isExpanded?'â–²':'â–¼'}</span>
          </div>

          ${isExpanded?`
            <!-- Lista de jugadores -->
            <div style="margin-top:8px;">
              ${allJugadores.length===0
                ?`<div style="text-align:center;padding:20px;color:var(--muted);font-size:13px;">Sin jugadores aÃºn</div>`
                :jugadoresHTML}
            </div>
            <!-- BotÃ³n agregar -->
            ${canManage?`<div style="margin-top:12px;">
              <button class="btn-green" style="width:100%;padding:10px;font-size:13px;" onclick="openAgregarJugadorModal('${t.id}')">
                + Invitar / Agregar Jugador
              </button>
            </div>`:''}
          `:''}
        </div>
      </div>`;
    }).join('')}
  </div>`;
}


function toggleJugadoresTorneo(torneoId){
  STATE._expandedJugTorneo=STATE._expandedJugTorneo===torneoId?null:torneoId;
  renderJugadores();
}

function openAgregarJugadorModal(torneoId){
  // Set active torneo for add flow
  if(torneoId){
    STATE.activeTorneoId=torneoId;
    STATE._expandedJugTorneo=torneoId;
    STATE.torneo=STATE.torneos.find(t=>t.id===torneoId)||null;
    if(!_participantesUnsubs[torneoId]) subscribeParticipantes();
  }
  // Ensure global jugadores listener is active
  ensureJugadoresGlobal();
  // Show modal
  const m=document.getElementById('agregarJugadorModal');
  if(!m) return;
  m.style.display='flex';
  const t=getActiveTorneo();
  const title=document.getElementById('modalAgregarTitle');
  if(title&&t) title.textContent='Agregar a: '+t.nombre;
  // Reset form
  switchAgregarTab('buscar');
  const inp=document.getElementById('buscarJugadorInput');
  if(inp){ inp.value=''; }
  const res=document.getElementById('buscarResultados');
  if(res) res.innerHTML='<div style="color:var(--muted);font-size:13px;text-align:center;padding:12px;">Escribe al menos 2 caracteres</div>';
  setTimeout(()=>{ if(inp) inp.focus(); },100);
}
function closeAgregarJugadorModal(){
  const m=document.getElementById('agregarJugadorModal');
  if(m) m.style.display='none';
  // Clean form fields
  const fields=['newNombre','newAlias','newFoto','newTelefono','buscarJugadorInput'];
  fields.forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
  const err=document.getElementById('addJugadorError');
  if(err) err.style.display='none';
  const res=document.getElementById('buscarResultados');
  if(res) res.innerHTML='';
}
function switchAgregarTab(tab){
  const isBuscar=tab==='buscar';
  document.getElementById('panelBuscar').style.display=isBuscar?'block':'none';
  document.getElementById('panelCrear').style.display=isBuscar?'none':'block';
  document.getElementById('tabBuscar').style.background=isBuscar?'var(--green)':'transparent';
  document.getElementById('tabBuscar').style.color=isBuscar?'#fff':'var(--text)';
  document.getElementById('tabBuscar').style.borderColor=isBuscar?'var(--green)':'var(--border)';
  document.getElementById('tabCrear').style.background=isBuscar?'transparent':'var(--green)';
  document.getElementById('tabCrear').style.color=isBuscar?'var(--text)':'#fff';
  document.getElementById('tabCrear').style.borderColor=isBuscar?'var(--border)':'var(--green)';
}

let _buscarTimer=null;
function buscarJugadorGlobal(q){
  clearTimeout(_buscarTimer);
  const res=document.getElementById('buscarResultados');
  if(!q||q.length<2){ res.innerHTML='<div style="color:var(--muted);font-size:13px;text-align:center;padding:12px;">Escribe al menos 2 caracteres</div>'; return; }
  res.innerHTML='<div style="color:var(--muted);font-size:13px;text-align:center;padding:12px;">Buscando...</div>';
  _buscarTimer=setTimeout(()=>{
    const ql=normalizeStr(q);
    // Search in already-loaded global (normalized â€” ignores accents/diacritics)
    let found=STATE.jugadores_global.filter(j=>{
      return normalizeStr(j.nombre).includes(ql)
          || normalizeStr(j.alias).includes(ql)
          || (j.telefonoCompleto||'').includes(ql)
          || (j.telefono||'').includes(ql)
          || normalizeStr(j.email).includes(ql);
    });
    // Exclude already in torneo
    // Exclude players already in the ACTIVE torneo (not all torneos)
    const activeTid=STATE.activeTorneoId;
    const inTorneo=new Set((STATE.jugadores_by_torneo[activeTid]||STATE.jugadores||[]).map(j=>j.id||j.jugador_id));
    found=found.filter(j=>!inTorneo.has(j.id));
    if(found.length===0){
      res.innerHTML=`<div style="text-align:center;padding:16px;color:var(--muted);">
        <div style="font-size:13px;">No encontrado.</div>
        <button class="btn-link" style="margin-top:8px;" onclick="switchAgregarTab('crear')">+ Crear jugador nuevo</button>
      </div>`;
      return;
    }
    res.innerHTML=found.slice(0,8).map(j=>`
      <div onclick="agregarParticipante('${j.id}')" style="display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:10px;border:1px solid var(--border);margin-bottom:8px;cursor:pointer;background:var(--cardL);">
        <div class="avatar-initials" style="width:38px;height:38px;font-size:13px;">${j.foto||j.alias?.slice(0,2)||j.nombre?.slice(0,2)||'?'}</div>
        <div style="flex:1;">
          <div style="font-weight:700;font-size:14px;">${j.nombre}</div>
          <div style="font-size:12px;color:var(--muted);">${j.alias||''} ${j.telefonoCompleto?'Â· '+j.telefonoCompleto:''}</div>
        </div>
        <span style="color:var(--green);font-size:20px;">+</span>
      </div>`).join('');
  }, 300);
}

async function agregarParticipante(jugadorId){
  const torneo=getActiveTorneo();
  if(!torneo) return;
  const j=STATE.jugadores_global.find(x=>x.id===jugadorId);
  if(!j) return;
  try{
    await db.collection('torneos').doc(torneo.id)
      .collection('participantes').doc(jugadorId).set({
        jugador_id: jugadorId,
        nombre: j.nombre||'',
        alias: j.alias||'',
        foto: j.foto||'',
        fotoURL: j.fotoURL||null,
        telefonoCompleto: j.telefonoCompleto||null,
        invite_code: j.invite_code||null,
        user_uid: j.user_uid||null,
        handicap: j.handicap||0,
        activo: true,
        fecha_ingreso: firebase.firestore.FieldValue.serverTimestamp()
      });
    // Update count on torneo
    closeAgregarJugadorModal();
  }catch(e){ alert('Error: '+e.message); }
}

async function crearYAgregarJugador(){
  console.log('[crearYAgregarJugador] START');
  let err;
  try{
    const nombre=(document.getElementById('newNombre')?.value||'').trim();
    const alias=(document.getElementById('newAlias')?.value||'').trim();
    const foto=(document.getElementById('newFoto')?.value||'').trim().toUpperCase().slice(0,2);
    let telefono=(document.getElementById('newTelefono')?.value||'').trim().replace(/\D/g,'');
    const codigoPais=(document.getElementById('newPaisCodigo')?.value)||'+58';
    telefono=normalizeTelVE(telefono,codigoPais);
    err=document.getElementById('addJugadorError');
    if(err) err.style.display='none';
    if(!nombre){
      if(err){err.textContent='El nombre es obligatorio.';err.style.display='block';}
      else alert('El nombre es obligatorio.');
      return;
    }
    if(telefono&&!validarFormatoTel(telefono,codigoPais)){
      if(err){err.textContent='Formato de telÃ©fono invÃ¡lido.';err.style.display='block';}
      return;
    }
    const torneo=getActiveTorneo();
    console.log('[crearYAgregarJugador] torneo:', torneo?.id, torneo?.nombre);
    if(!torneo){
      if(err){err.textContent='No hay torneo activo.';err.style.display='block';}
      else alert('No hay torneo activo.');
      return;
    }
    const initials=foto||nombre.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
    const invite_code=generateInviteCode();
    const nombre_lower=nombre.toLowerCase();
    const jugData={
      nombre, alias:alias||nombre.split(' ')[0], foto:initials,
      nombre_lower, invite_code, user_uid:null,
      creado:firebase.firestore.FieldValue.serverTimestamp()
    };
    if(telefono){ jugData.telefono=telefono; jugData.codigoPais=codigoPais; jugData.telefonoCompleto=codigoPais+telefono; }
    const id=nombre_lower.replace(/\s+/g,'_')+'_'+Date.now();
    console.log('[crearYAgregarJugador] Creating jugador:', id);
    await db.collection('jugadores').doc(id).set(jugData);
    // Add to jugadores_global cache
    STATE.jugadores_global.push({id,...jugData});
    // Add to torneo participantes
    await db.collection('torneos').doc(torneo.id)
      .collection('participantes').doc(id).set({
        jugador_id:id, nombre, alias:alias||nombre.split(' ')[0],
        foto:initials, fotoURL:null, telefonoCompleto:jugData.telefonoCompleto||null,
        invite_code, user_uid:null, handicap:0, activo:true,
        fecha_ingreso:firebase.firestore.FieldValue.serverTimestamp()
      });
    console.log('[crearYAgregarJugador] SUCCESS');
    closeAgregarJugadorModal();
    // Show invite toast with WhatsApp button
    showInviteToast(nombre, invite_code, jugData.telefonoCompleto||'');
  }catch(e){
    console.error('[crearYAgregarJugador] ERROR:', e);
    if(err){err.textContent='Error: '+e.message;err.style.display='block';}
    else alert('Error al crear jugador: '+e.message);
  }
}

// â”€â”€ WhatsApp Invitation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getAppURL(){
  return window.location.origin + window.location.pathname;
}

function buildInviteMessage(nombre, code){
  return `ğŸŒï¸ *Â¡Te invitaron a Golfeados!*\n\n`
    +`Hola${nombre?' '+nombre.split(' ')[0]:''}, te agregaron a un torneo de golf.\n\n`
    +`Tu cÃ³digo de vinculaciÃ³n es: *${code}*\n\n`
    +`1ï¸âƒ£ RegÃ­strate aquÃ­: ${getAppURL()}\n`
    +`2ï¸âƒ£ Una vez dentro, ve a tu *Perfil* (toca tu nombre arriba) y usa el cÃ³digo para vincular tu cuenta.\n\n`
    +`Â¡Nos vemos en el campo! â›³`;
}

function enviarInvitacionWA(nombre, code, telefono, event){
  if(event) event.stopPropagation();
  const msg=encodeURIComponent(buildInviteMessage(nombre, code));
  // Clean phone: remove spaces, dashes, keep + and digits
  const phone=(telefono||'').replace(/[^0-9+]/g,'').replace(/^\+/,'');
  const url=phone ? `https://wa.me/${phone}?text=${msg}` : `https://wa.me/?text=${msg}`;
  window.open(url, '_blank');
}

function copyInviteCode(code, event){
  if(event) event.stopPropagation();
  navigator.clipboard.writeText(code).then(()=>{
    const btn=event?.target;
    if(btn){
      const orig=btn.textContent;
      btn.textContent='âœ… Copiado';
      setTimeout(()=>{ btn.textContent=orig; }, 1500);
    }
  }).catch(()=>{ prompt('Copia el cÃ³digo:', code); });
}

function showInviteToast(nombre, code, telefono){
  // Remove any existing toast
  const old=document.getElementById('inviteToast');
  if(old) old.remove();

  const toast=document.createElement('div');
  toast.id='inviteToast';
  toast.style.cssText='position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:10000;background:var(--white);border-radius:16px;padding:20px;box-shadow:0 8px 32px rgba(0,0,0,0.25);max-width:360px;width:calc(100% - 40px);border:2px solid var(--green);';
  toast.innerHTML=`
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
      <div style="font-size:14px;font-weight:800;color:var(--green);">âœ… Jugador creado</div>
      <button onclick="this.closest('#inviteToast').remove()" style="background:none;border:none;font-size:18px;cursor:pointer;color:var(--muted);">âœ•</button>
    </div>
    <div style="font-size:13px;color:var(--text);margin-bottom:10px;">
      <strong>${nombre}</strong> fue agregado al torneo.
    </div>
    <div style="background:var(--bg);border-radius:10px;padding:10px 14px;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;">
      <div>
        <div style="font-size:10px;color:var(--muted);text-transform:uppercase;font-weight:600;">CÃ³digo de vinculaciÃ³n</div>
        <div style="font-size:20px;font-weight:800;font-family:monospace;letter-spacing:3px;color:var(--green);">${code}</div>
      </div>
      <button onclick="copyInviteCode('${code}',event)" style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:6px 10px;font-size:11px;cursor:pointer;color:var(--text);font-weight:600;">ğŸ“‹ Copiar</button>
    </div>
    <button onclick="enviarInvitacionWA('${(nombre||'').replace(/'/g,"\\'")}','${code}','${telefono||''}');this.closest('#inviteToast').remove();"
      style="width:100%;padding:12px;border:none;border-radius:10px;background:#25D366;color:#fff;font-weight:700;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 2px 8px rgba(37,211,102,0.3);">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 2C6.477 2 2 6.477 2 12c0 1.89.525 3.66 1.438 5.168L2 22l4.832-1.438A9.955 9.955 0 0012 22c5.523 0 10-4.477 10-10S17.523 2 12 2zm0 18c-1.657 0-3.216-.5-4.51-1.348l-.324-.194-2.866.852.852-2.866-.194-.324A7.963 7.963 0 014 12c0-4.411 3.589-8 8-8s8 3.589 8 8-3.589 8-8 8z"/></svg>
      Enviar invitaciÃ³n por WhatsApp
    </button>
    <div style="text-align:center;margin-top:8px;">
      <button onclick="this.closest('#inviteToast').remove()" style="background:none;border:none;color:var(--muted);font-size:12px;cursor:pointer;">Cerrar</button>
    </div>`;
  document.body.appendChild(toast);

  // Auto-dismiss after 15 seconds
  setTimeout(()=>{ const t=document.getElementById('inviteToast'); if(t) t.remove(); }, 15000);
}

async function removeParticipante(jugadorId, nombre, torneoId, event){
  if(event) event.stopPropagation();
  const tid=torneoId||STATE.activeTorneoId;
  if(!tid) return;
  const t=STATE.torneos.find(x=>x.id===tid);
  // Check if jugador has results in this torneo
  const jornadasT=STATE.jornadas.filter(j=>j.torneo_id===tid);
  const hasResults=jornadasT.some(jn=>
    STATE.resultados.some(r=>r.jornada_id===jn.id && r.jugador_id===jugadorId)
  );
  const msg=hasResults
    ?`${nombre} tiene resultados en ${t?.nombre||'este torneo'}. Se marcarÃ¡ como eliminado pero sus resultados se mantienen. Â¿Continuar?`
    :`Â¿Quitar a ${nombre} de ${t?.nombre||'este torneo'}?`;
  if(!confirm(msg)) return;
  try{
    if(hasResults){
      // Soft delete â€” mark as eliminated, keep for historical integrity
      await db.collection('torneos').doc(tid)
        .collection('participantes').doc(jugadorId).update({
          activo:false,
          eliminado:true,
          eliminado_fecha:firebase.firestore.FieldValue.serverTimestamp()
        });
    } else {
      // No results â€” safe to hard delete
      await db.collection('torneos').doc(tid)
        .collection('participantes').doc(jugadorId).delete();
    }
  }catch(e){ alert('Error: '+e.message); }
}

async function reactivarParticipante(jugadorId, torneoId, event){
  if(event) event.stopPropagation();
  const tid=torneoId||STATE.activeTorneoId;
  if(!tid) return;
  try{
    await db.collection('torneos').doc(tid)
      .collection('participantes').doc(jugadorId).update({
        activo:true,
        eliminado:false,
        eliminado_fecha:null
      });
  }catch(e){ alert('Error: '+e.message); }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE â€” Subir fotos
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function uploadPhoto(file, path, progressBarId=null){
  return new Promise((resolve,reject)=>{
    const ref=storage.ref(path);
    const task=ref.put(file);
    task.on('state_changed',
      snap=>{
        if(progressBarId){
          const pct=Math.round((snap.bytesTransferred/snap.totalBytes)*100);
          const bar=document.getElementById(progressBarId);
          if(bar){bar.parentElement.style.display='block';bar.style.width=pct+'%';}
        }
      },
      err=>reject(err),
      async ()=>{
        const url=await task.snapshot.ref.getDownloadURL();
        if(progressBarId){
          const bar=document.getElementById(progressBarId);
          if(bar){bar.parentElement.style.display='none';bar.style.width='0%';}
        }
        resolve(url);
      }
    );
  });
}

function resizeAndCompress(file, maxW=800, quality=0.82){
  return new Promise(resolve=>{
    const img=new Image();
    const url=URL.createObjectURL(file);
    img.onload=()=>{
      const ratio=Math.min(1,maxW/img.width);
      const canvas=document.createElement('canvas');
      canvas.width=img.width*ratio; canvas.height=img.height*ratio;
      canvas.getContext('2d').drawImage(img,0,0,canvas.width,canvas.height);
      canvas.toBlob(b=>{ URL.revokeObjectURL(url); resolve(new File([b],file.name,{type:'image/jpeg'})); },'image/jpeg',quality);
    };
    img.src=url;
  });
}

function previewPhoto(input, imgId, fallbackId=null){
  const file=input.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    const img=document.getElementById(imgId);
    if(img){img.src=e.target.result;img.style.display='block';}
    if(fallbackId){const fb=document.getElementById(fallbackId);if(fb)fb.style.display='none';}
  };
  reader.readAsDataURL(file);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTUALIZACIONES AUTOMÃTICAS â€” iOS compatible
// iOS ignora reload(true), usamos navegaciÃ³n con cache-bust
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initUpdateChecker(){
  // Si llegamos con ?bust= en la URL, limpiar y guardar versiÃ³n
  const url=new URL(window.location.href);
  if(url.searchParams.get('bust')){
    localStorage.setItem('golfeados_version', APP_VERSION);
    localStorage.setItem('golfeados_dismissed_ver', APP_VERSION);
    document.getElementById('updateBanner').style.display='none';
    url.searchParams.delete('bust');
    window.history.replaceState(null,'',url.toString());
  }
  // Also hide banner immediately if current version was dismissed
  const alreadyDismissed=localStorage.getItem('golfeados_dismissed_ver');
  if(alreadyDismissed===APP_VERSION){
    document.getElementById('updateBanner').style.display='none';
  }

  // Si la versiÃ³n guardada no coincide â†’ navegar con cache-bust (recarga real en iOS)
  const stored=localStorage.getItem('golfeados_version');
  if(stored && stored !== APP_VERSION){
    localStorage.setItem('golfeados_version', APP_VERSION);
    doHardReload();
    return;
  }
  localStorage.setItem('golfeados_version', APP_VERSION);

  // Chequeo periÃ³dico: descarga el HTML y compara versiÃ³n
  async function checkForUpdate(){
    try{
      const res=await fetch(window.location.pathname+'?nc='+Date.now(),{
        cache:'no-store',
        headers:{'Cache-Control':'no-cache','Pragma':'no-cache'}
      });
      const text=await res.text();
      const match=text.match(/APP_VERSION\s*=\s*['"]([^'"]+)['"]/);
      if(match && match[1] && match[1] !== APP_VERSION){
        showUpdateBanner(match[1]);
      }
    }catch(e){ /* sin conexiÃ³n, silencioso */ }
  }

  // Chequear 4s despuÃ©s de entrar, luego cada 3 minutos
  setTimeout(checkForUpdate, 4000);
  setInterval(checkForUpdate, 3*60*1000);

  // Chequear al volver de segundo plano (iOS PWA)
  document.addEventListener('visibilitychange',()=>{
    if(document.visibilityState==='visible') setTimeout(checkForUpdate,1500);
  });

  // Chequear al recuperar conexiÃ³n
  window.addEventListener('online', ()=>setTimeout(checkForUpdate,2000));
}

function showUpdateBanner(newVer){
  const banner=document.getElementById('updateBanner');
  const sub=banner.querySelector('div div:last-child');
  if(sub) sub.textContent='VersiÃ³n '+newVer+' disponible â€” toca para instalar';
  banner.style.display='flex';
}

function doHardReload(){
  // iOS-compatible: navegar a la misma URL con parÃ¡metro nuevo (bypassa cachÃ©)
  const url=new URL(window.location.href);
  url.searchParams.set('bust', Date.now());
  window.location.replace(url.toString());
}

function forceUpdate(){
  // Limpiar cachÃ© del navegador si estÃ¡ disponible
  localStorage.setItem('golfeados_dismissed_ver', APP_VERSION);
  if('caches' in window){
    caches.keys().then(names=>{
      names.forEach(n=>caches.delete(n));
      // DespuÃ©s de limpiar, navegar
      setTimeout(doHardReload, 300);
    });
  } else {
    doHardReload();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function seedDatos(){
  const msg=document.getElementById('seedMsg');
  msg.style.display='block'; msg.textContent='â³ Cargando datos iniciales...';
  try{
    const batch=db.batch();
    batch.set(db.collection('torneos').doc('apertura2026'),{nombre:'Torneo Apertura 2026',estado:'Activo',jornadas_total:8,temporada:'2026',creado:firebase.firestore.FieldValue.serverTimestamp()});
    [
      {id:'badell',nombre:'Daniel Badell',alias:'Badell',foto:'DB'},
      {id:'jimeno',nombre:'Javi Jimeno',alias:'Jimeno',foto:'JJ'},
      {id:'padron',nombre:'Loor PadrÃ³n',alias:'Loor',foto:'LP'},
      {id:'kolman',nombre:'Juan Kolman',alias:'Kolman',foto:'JK'},
      {id:'aguiar',nombre:'JesÃºs Aguiar',alias:'J. Aguiar',foto:'JA'},
      {id:'soto',nombre:'Mauricio Soto',alias:'Soto',foto:'MS'},
      {id:'aguiar_r',nombre:'JesÃºs Aguiar Romero',alias:'Aguiar R.',foto:'JR'},
    ].forEach(j=>{const{id,...d}=j;batch.set(db.collection('jugadores').doc(id),{...d,creado:firebase.firestore.FieldValue.serverTimestamp()});});
    await batch.commit();
    const clubesSeed=[
      {nombre:'Izcaragua Country Club',ciudad:'Caracas'},
      {nombre:'Junko Golf Club',ciudad:'Caracas'},
      {nombre:'Lagunita Country Club',ciudad:'Caracas'},
      {nombre:'Valle Arriba Golf Club',ciudad:'Caracas'},
      {nombre:'Guataparo Country Club',ciudad:'Valencia'},
    ];
    for(const c of clubesSeed){
      await db.collection('clubes').add({...c,creado:firebase.firestore.FieldValue.serverTimestamp()});
    }
    msg.textContent='âœ… Â¡Datos cargados! Jugadores, partidas y clubes creados.';
  }catch(e){ msg.style.color='var(--red)'; msg.textContent='âŒ Error: '+e.message; }
}

// â”€â”€ Register static button handlers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Button is in static HTML above this script, so it already exists in DOM
(function(){
  const btnCrear=document.getElementById('btnCrearJugador');
  if(btnCrear){
    let _crearRunning=false;
    btnCrear.addEventListener('click', async function(e){
      e.preventDefault();
      e.stopPropagation();
      if(_crearRunning) return;
      _crearRunning=true;
      btnCrear.textContent='Creando...';
      btnCrear.disabled=true;
      try{
        await crearYAgregarJugador();
      }finally{
        _crearRunning=false;
        btnCrear.textContent='Crear y agregar al torneo ğŸŒï¸';
        btnCrear.disabled=false;
      }
    });
    console.log('[init] btnCrearJugador listener OK');
  } else {
    console.error('[init] btnCrearJugador NOT FOUND');
  }
})();
</script>

<script>
// Register Service Worker (required for PWA install prompt on Android)
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('/golfeados/sw.js')
      .then(reg => console.log('SW registered:', reg.scope))
      .catch(err => console.log('SW error:', err));
  });
}
</script>
</body>
</html>
